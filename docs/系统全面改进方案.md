# ç³»ç»Ÿå…¨é¢æ”¹è¿›æ–¹æ¡ˆ

## ğŸ“Š ç°çŠ¶åˆ†æ

åŸºäºå¯¹ä»£ç çš„å…¨é¢å®¡æŸ¥ï¼Œè¯†åˆ«å‡ºä»¥ä¸‹ä¸»è¦é—®é¢˜å’Œç¼ºå¤±åŠŸèƒ½ï¼š

---

## ğŸ”´ æ ¸å¿ƒé—®é¢˜åˆ†ç±»

### ä¸€ã€åç«¯æ£€æµ‹ç³»ç»Ÿé—®é¢˜

#### 1. æ£€æµ‹ç»“æœç¼ºä¹æŒä¹…åŒ– â­â­â­
**é—®é¢˜**:
- æ£€æµ‹ç»“æœåªåœ¨æ—¥å¿—ä¸­è¾“å‡ºï¼Œæ²¡æœ‰å­˜å…¥æ•°æ®åº“
- æ— æ³•æŸ¥è¯¢å†å²æ£€æµ‹è®°å½•
- æ— æ³•ç”Ÿæˆç»Ÿè®¡æŠ¥è¡¨

**å½±å“**:
```
ç”¨æˆ·æ— æ³•å›ç­”ï¼š
- ä»Šå¤©æ£€æµ‹åˆ°å¤šå°‘äººæ²¡æˆ´å‘ç½‘ï¼Ÿ
- è¿‡å»ä¸€å‘¨çš„æ´—æ‰‹æ¬¡æ•°ç»Ÿè®¡ï¼Ÿ
- å“ªä¸ªæ‘„åƒå¤´æ£€æµ‹åˆ°çš„è¿è§„æœ€å¤šï¼Ÿ
```

#### 2. æ£€æµ‹æ€§èƒ½æœªä¼˜åŒ– â­â­â­
**é—®é¢˜**:
- æ¯å¸§éƒ½è¿›è¡Œå®Œæ•´æ£€æµ‹ï¼ŒCPU/GPUå ç”¨é«˜
- æ²¡æœ‰æ™ºèƒ½è·³å¸§æœºåˆ¶
- æ‰¹å¤„ç†åŠŸèƒ½æœªå®é™…ä½¿ç”¨
- ç¼“å­˜æœºåˆ¶ä¸å®Œå–„

**å½±å“**:
```
- å•ä¸ªæ‘„åƒå¤´å ç”¨30-50% CPU
- å¤šæ‘„åƒå¤´åŒæ—¶è¿è¡Œç³»ç»Ÿå¡é¡¿
- å®æ—¶æ€§å·®ï¼Œå¤„ç†å»¶è¿Ÿå¤§
```

#### 3. è¿è§„äº‹ä»¶ç¼ºä¹æœ‰æ•ˆç®¡ç† â­â­
**é—®é¢˜**:
- è¿è§„æˆªå›¾åŠŸèƒ½å®ç°ä¸å®Œæ•´
- æ²¡æœ‰è¿è§„äº‹ä»¶è¡¨
- æ— æ³•è¿½è¸ªè¿è§„å¤„ç†çŠ¶æ€
- ç¼ºå°‘å‘Šè­¦é€šçŸ¥æœºåˆ¶

**å½“å‰ä»£ç **:
```python
# src/services/detection_service.py
def _capture_violation(session, frame, track_id, violation_type, bbox, cooldown_period=10):
    # åŠŸèƒ½å­˜åœ¨ä½†æœªå®Œå–„
    pass
```

#### 4. å¤šæ‘„åƒå¤´åè°ƒä¸è¶³ â­â­
**é—®é¢˜**:
- å„æ‘„åƒå¤´ç‹¬ç«‹è¿è¡Œï¼Œæ— ç»Ÿä¸€è°ƒåº¦
- èµ„æºåˆ†é…ä¸å‡è¡¡
- ç¼ºå°‘ä¼˜å…ˆçº§æœºåˆ¶
- GPUåˆ©ç”¨ç‡ä½

---

### äºŒã€å‰ç«¯åŠŸèƒ½ç¼ºå¤±

#### 1. å®æ—¶è§†é¢‘é¢„è§ˆç¼ºå¤± â­â­â­
**é—®é¢˜**:
- ç”¨æˆ·çœ‹ä¸åˆ°æ£€æµ‹è¿‡ç¨‹ä¸­çš„è§†é¢‘ç”»é¢
- æ— æ³•éªŒè¯æ‘„åƒå¤´æ˜¯å¦å¯¹å‡†æ­£ç¡®ä½ç½®
- ç¼ºå°‘å¯è§†åŒ–çš„æ£€æµ‹æ¡†

**æœŸæœ›åŠŸèƒ½**:
```
å‰ç«¯åº”è¯¥èƒ½å¤Ÿï¼š
âœ… æ˜¾ç¤ºå®æ—¶è§†é¢‘æµ
âœ… ç»˜åˆ¶æ£€æµ‹æ¡†ï¼ˆäººä½“ã€å‘ç½‘ã€æ‰‹éƒ¨ï¼‰
âœ… æ˜¾ç¤ºæ£€æµ‹ç½®ä¿¡åº¦
âœ… æ˜¾ç¤ºè¿è§„æ ‡è®°
```

#### 2. ç»Ÿè®¡æ•°æ®å±•ç¤ºä¸å®Œå–„ â­â­â­
**é—®é¢˜**:
- æ²¡æœ‰å®æ—¶æ£€æµ‹ç»Ÿè®¡
- ç¼ºå°‘è¶‹åŠ¿å›¾è¡¨
- æ— æ³•å¯¹æ¯”åˆ†æ
- æ•°æ®ç»´åº¦å•ä¸€

**å½“å‰çŠ¶æ€**:
```typescript
// frontend/src/views/Statistics.vue
// ç»„ä»¶å­˜åœ¨ä½†æ•°æ®ä¸å®Œæ•´
```

#### 3. å‘Šè­¦å’Œé€šçŸ¥ç³»ç»Ÿç¼ºå¤± â­â­
**é—®é¢˜**:
- å‘ç°è¿è§„æ²¡æœ‰å³æ—¶é€šçŸ¥
- æ— æ³•è®¾ç½®å‘Šè­¦è§„åˆ™
- ç¼ºå°‘æ¶ˆæ¯ä¸­å¿ƒ
- ç§»åŠ¨ç«¯æ¨é€ç¼ºå¤±

#### 4. å†å²è®°å½•æŸ¥è¯¢åŠŸèƒ½å¼± â­â­
**é—®é¢˜**:
- æ— æ³•æŸ¥çœ‹å†å²æ£€æµ‹è®°å½•
- ç¼ºå°‘è¿è§„è®°å½•åˆ—è¡¨
- æ— æ³•å›æ”¾æ£€æµ‹è¿‡ç¨‹
- å¯¼å‡ºåŠŸèƒ½ä¸å®Œå–„

---

### ä¸‰ã€ç³»ç»Ÿæ¶æ„é—®é¢˜

#### 1. WebSocket æœªå……åˆ†åˆ©ç”¨ â­â­
**é—®é¢˜**:
- WebSocket è¿æ¥å»ºç«‹ä½†åŠŸèƒ½ç®€å•
- æ²¡æœ‰å®æ—¶æ¨é€æ£€æµ‹ç»“æœ
- å‰åç«¯æ•°æ®åŒæ­¥é è½®è¯¢

**å½“å‰å®ç°**:
```python
# src/api/routers/websocket.py
# WebSocket ç«¯ç‚¹å­˜åœ¨ä½†ä»…ç”¨äºå•å¸§æ£€æµ‹
@router.websocket("/ws")
async def websocket_endpoint(websocket, manager):
    # åŠŸèƒ½è¾ƒå¼±ï¼Œåªå¤„ç†å•å¸§
    pass
```

#### 2. æ•°æ®åº“è®¾è®¡ä¸å®Œæ•´ â­â­â­
**é—®é¢˜**:
- ç¼ºå°‘æ ¸å¿ƒä¸šåŠ¡è¡¨
- æ²¡æœ‰æ£€æµ‹è®°å½•è¡¨
- è¿è§„äº‹ä»¶è¡¨ç¼ºå¤±
- ç»Ÿè®¡æ±‡æ€»è¡¨ç¼ºå¤±

**å½“å‰çŠ¶æ€**:
```sql
-- åªæœ‰åŸºç¡€çš„åˆå§‹åŒ–è„šæœ¬
-- ç¼ºå°‘ï¼š
-- detection_records (æ£€æµ‹è®°å½•)
-- violation_events (è¿è§„äº‹ä»¶)
-- alert_rules (å‘Šè­¦è§„åˆ™)
-- statistics_summary (ç»Ÿè®¡æ±‡æ€»)
```

#### 3. é…ç½®ç®¡ç†æ··ä¹± â­
**é—®é¢˜**:
- YAML å’Œ JSON é…ç½®æ··ç”¨
- ç¼ºå°‘é…ç½®éªŒè¯
- çƒ­æ›´æ–°ä¸æ”¯æŒ
- ç‰ˆæœ¬ç®¡ç†ç¼ºå¤±

#### 4. æ—¥å¿—å’Œç›‘æ§ä¸å®Œå–„ â­â­
**é—®é¢˜**:
- æ—¥å¿—æ ¼å¼ä¸ç»Ÿä¸€
- ç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—
- æ€§èƒ½æŒ‡æ ‡æ”¶é›†ä¸å…¨
- æ— é›†ä¸­å¼æ—¥å¿—ç®¡ç†

---

## ğŸ¯ æ”¹è¿›æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### ğŸ”¥ P0 - æ ¸å¿ƒåŠŸèƒ½å¿…é¡»å®ç°ï¼ˆ1-2å‘¨ï¼‰

#### 1. æ£€æµ‹ç»“æœæ•°æ®åº“æŒä¹…åŒ–
**ç›®æ ‡**: æ‰€æœ‰æ£€æµ‹ç»“æœå­˜å…¥æ•°æ®åº“ï¼Œæ”¯æŒæŸ¥è¯¢å’Œç»Ÿè®¡

**å®æ–½æ­¥éª¤**:

##### 1.1 è®¾è®¡æ•°æ®åº“è¡¨ç»“æ„
```sql
-- æ£€æµ‹è®°å½•è¡¨
CREATE TABLE detection_records (
    id BIGSERIAL PRIMARY KEY,
    camera_id VARCHAR(50) NOT NULL,
    timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    frame_number INTEGER,
    
    -- äººä½“æ£€æµ‹
    person_count INTEGER DEFAULT 0,
    person_detections JSONB,
    
    -- å‘ç½‘æ£€æµ‹
    hairnet_count INTEGER DEFAULT 0,
    hairnet_results JSONB,
    
    -- è¡Œä¸ºæ£€æµ‹
    handwash_count INTEGER DEFAULT 0,
    handwash_results JSONB,
    sanitize_count INTEGER DEFAULT 0,
    sanitize_results JSONB,
    
    -- æ€§èƒ½æŒ‡æ ‡
    processing_time FLOAT,
    fps FLOAT,
    
    -- ç´¢å¼•
    INDEX idx_camera_timestamp (camera_id, timestamp),
    INDEX idx_timestamp (timestamp)
);

-- è¿è§„äº‹ä»¶è¡¨
CREATE TABLE violation_events (
    id BIGSERIAL PRIMARY KEY,
    detection_id BIGINT REFERENCES detection_records(id),
    camera_id VARCHAR(50) NOT NULL,
    timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- è¿è§„ä¿¡æ¯
    violation_type VARCHAR(50) NOT NULL,  -- 'no_hairnet', 'no_handwash', etc.
    track_id INTEGER,
    confidence FLOAT,
    
    -- æˆªå›¾
    snapshot_path VARCHAR(500),
    bbox JSONB,
    
    -- å¤„ç†çŠ¶æ€
    status VARCHAR(20) DEFAULT 'pending',  -- pending, confirmed, false_positive, resolved
    handled_at TIMESTAMP,
    handled_by VARCHAR(100),
    notes TEXT,
    
    -- ç´¢å¼•
    INDEX idx_camera_timestamp (camera_id, timestamp),
    INDEX idx_violation_type (violation_type),
    INDEX idx_status (status)
);

-- ç»Ÿè®¡æ±‡æ€»è¡¨ï¼ˆæŒ‰å°æ—¶ï¼‰
CREATE TABLE statistics_hourly (
    id BIGSERIAL PRIMARY KEY,
    camera_id VARCHAR(50) NOT NULL,
    hour_start TIMESTAMP NOT NULL,
    
    -- æ£€æµ‹ç»Ÿè®¡
    total_frames INTEGER DEFAULT 0,
    total_persons INTEGER DEFAULT 0,
    total_hairnet_violations INTEGER DEFAULT 0,
    total_handwash_events INTEGER DEFAULT 0,
    total_sanitize_events INTEGER DEFAULT 0,
    
    -- æ€§èƒ½ç»Ÿè®¡
    avg_fps FLOAT,
    avg_processing_time FLOAT,
    
    -- å”¯ä¸€çº¦æŸ
    UNIQUE (camera_id, hour_start),
    INDEX idx_camera_hour (camera_id, hour_start)
);

-- å‘Šè­¦è§„åˆ™è¡¨
CREATE TABLE alert_rules (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    camera_id VARCHAR(50),  -- NULLè¡¨ç¤ºå…¨å±€è§„åˆ™
    
    -- è§„åˆ™é…ç½®
    rule_type VARCHAR(50) NOT NULL,  -- 'violation_threshold', 'continuous_violation', etc.
    conditions JSONB NOT NULL,
    
    -- é€šçŸ¥é…ç½®
    notification_channels JSONB,  -- ['email', 'websocket', 'webhook']
    enabled BOOLEAN DEFAULT true,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

##### 1.2 å®ç°æ•°æ®æŒä¹…åŒ–æœåŠ¡
```python
# src/services/database_service.py
from typing import Dict, Any, List
from datetime import datetime
import asyncpg
from src.core.detection_result import DetectionResult

class DatabaseService:
    def __init__(self, db_url: str):
        self.pool = None
        self.db_url = db_url
    
    async def init(self):
        """åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± """
        self.pool = await asyncpg.create_pool(self.db_url)
    
    async def save_detection_record(
        self,
        camera_id: str,
        frame_number: int,
        result: DetectionResult,
        fps: float = 0.0
    ) -> int:
        """ä¿å­˜æ£€æµ‹è®°å½•"""
        async with self.pool.acquire() as conn:
            record_id = await conn.fetchval(
                """
                INSERT INTO detection_records (
                    camera_id, frame_number,
                    person_count, person_detections,
                    hairnet_count, hairnet_results,
                    handwash_count, handwash_results,
                    sanitize_count, sanitize_results,
                    processing_time, fps
                ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
                RETURNING id
                """,
                camera_id, frame_number,
                len(result.person_detections), json.dumps(result.person_detections),
                len(result.hairnet_results), json.dumps(result.hairnet_results),
                len(result.handwash_results), json.dumps(result.handwash_results),
                len(result.sanitize_results), json.dumps(result.sanitize_results),
                sum(result.processing_times.values()), fps
            )
            return record_id
    
    async def save_violation_event(
        self,
        detection_id: int,
        camera_id: str,
        violation_type: str,
        track_id: int,
        confidence: float,
        snapshot_path: str = None,
        bbox: Dict = None
    ) -> int:
        """ä¿å­˜è¿è§„äº‹ä»¶"""
        async with self.pool.acquire() as conn:
            event_id = await conn.fetchval(
                """
                INSERT INTO violation_events (
                    detection_id, camera_id, violation_type,
                    track_id, confidence, snapshot_path, bbox
                ) VALUES ($1, $2, $3, $4, $5, $6, $7)
                RETURNING id
                """,
                detection_id, camera_id, violation_type,
                track_id, confidence, snapshot_path, json.dumps(bbox) if bbox else None
            )
            return event_id
    
    async def update_hourly_statistics(
        self,
        camera_id: str,
        hour_start: datetime,
        stats: Dict[str, Any]
    ):
        """æ›´æ–°å°æ—¶ç»Ÿè®¡"""
        async with self.pool.acquire() as conn:
            await conn.execute(
                """
                INSERT INTO statistics_hourly (
                    camera_id, hour_start, total_frames, total_persons,
                    total_hairnet_violations, total_handwash_events,
                    total_sanitize_events, avg_fps, avg_processing_time
                ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
                ON CONFLICT (camera_id, hour_start) DO UPDATE SET
                    total_frames = statistics_hourly.total_frames + EXCLUDED.total_frames,
                    total_persons = statistics_hourly.total_persons + EXCLUDED.total_persons,
                    total_hairnet_violations = statistics_hourly.total_hairnet_violations + EXCLUDED.total_hairnet_violations,
                    total_handwash_events = statistics_hourly.total_handwash_events + EXCLUDED.total_handwash_events,
                    total_sanitize_events = statistics_hourly.total_sanitize_events + EXCLUDED.total_sanitize_events,
                    avg_fps = (statistics_hourly.avg_fps + EXCLUDED.avg_fps) / 2,
                    avg_processing_time = (statistics_hourly.avg_processing_time + EXCLUDED.avg_processing_time) / 2
                """,
                camera_id, hour_start,
                stats.get('frames', 0), stats.get('persons', 0),
                stats.get('hairnet_violations', 0), stats.get('handwash_events', 0),
                stats.get('sanitize_events', 0),
                stats.get('fps', 0.0), stats.get('processing_time', 0.0)
            )
    
    async def get_recent_violations(
        self,
        camera_id: str = None,
        limit: int = 50,
        status: str = None
    ) -> List[Dict]:
        """è·å–æœ€è¿‘çš„è¿è§„äº‹ä»¶"""
        async with self.pool.acquire() as conn:
            query = """
                SELECT * FROM violation_events
                WHERE ($1::VARCHAR IS NULL OR camera_id = $1)
                  AND ($2::VARCHAR IS NULL OR status = $2)
                ORDER BY timestamp DESC
                LIMIT $3
            """
            rows = await conn.fetch(query, camera_id, status, limit)
            return [dict(row) for row in rows]
    
    async def get_statistics(
        self,
        camera_id: str,
        start_time: datetime,
        end_time: datetime
    ) -> Dict[str, Any]:
        """è·å–ç»Ÿè®¡æ•°æ®"""
        async with self.pool.acquire() as conn:
            result = await conn.fetchrow(
                """
                SELECT
                    SUM(total_frames) as total_frames,
                    SUM(total_persons) as total_persons,
                    SUM(total_hairnet_violations) as total_hairnet_violations,
                    SUM(total_handwash_events) as total_handwash_events,
                    SUM(total_sanitize_events) as total_sanitize_events,
                    AVG(avg_fps) as avg_fps,
                    AVG(avg_processing_time) as avg_processing_time
                FROM statistics_hourly
                WHERE camera_id = $1
                  AND hour_start >= $2
                  AND hour_start < $3
                """,
                camera_id, start_time, end_time
            )
            return dict(result) if result else {}
```

##### 1.3 ä¿®æ”¹æ£€æµ‹å¾ªç¯é›†æˆæ•°æ®åº“ä¿å­˜
```python
# main.py (_run_detection_loop)
async def _run_detection_loop_with_db(args, logger, pipeline, device):
    # åˆå§‹åŒ–æ•°æ®åº“æœåŠ¡
    db_service = DatabaseService(os.getenv('DATABASE_URL'))
    await db_service.init()
    
    frame_count = 0
    hour_stats = defaultdict(int)
    current_hour = datetime.now().replace(minute=0, second=0, microsecond=0)
    
    while not shutdown_requested["flag"]:
        ret, frame = cap.read()
        # ... è¯»å–å¸§é€»è¾‘
        
        # æ£€æµ‹
        result = pipeline.detect_comprehensive(frame, ...)
        
        # ä¿å­˜æ£€æµ‹è®°å½•ï¼ˆæ¯10å¸§ä¿å­˜ä¸€æ¬¡ï¼‰
        if frame_count % 10 == 0:
            record_id = await db_service.save_detection_record(
                camera_id=args.camera_id,
                frame_number=frame_count,
                result=result,
                fps=avg_fps
            )
            
            # æ£€æŸ¥è¿è§„å¹¶ä¿å­˜
            for hairnet_result in result.hairnet_results:
                if not hairnet_result.get('has_hairnet'):
                    await db_service.save_violation_event(
                        detection_id=record_id,
                        camera_id=args.camera_id,
                        violation_type='no_hairnet',
                        track_id=hairnet_result.get('track_id'),
                        confidence=hairnet_result.get('confidence'),
                        bbox=hairnet_result.get('bbox')
                    )
        
        # æ›´æ–°å°æ—¶ç»Ÿè®¡
        hour_stats['frames'] += 1
        hour_stats['persons'] += len(result.person_detections)
        # ... æ›´æ–°å…¶ä»–ç»Ÿè®¡
        
        # æ¯å°æ—¶å†™å…¥ä¸€æ¬¡ç»Ÿè®¡
        if datetime.now().hour != current_hour.hour:
            await db_service.update_hourly_statistics(
                camera_id=args.camera_id,
                hour_start=current_hour,
                stats=hour_stats
            )
            # é‡ç½®
            hour_stats.clear()
            current_hour = datetime.now().replace(minute=0, second=0, microsecond=0)
```

##### 1.4 æ–°å¢APIç«¯ç‚¹
```python
# src/api/routers/records.py
from fastapi import APIRouter, Query
from datetime import datetime, timedelta

router = APIRouter(prefix="/api/v1/records", tags=["records"])

@router.get("/violations")
async def get_violations(
    camera_id: str = None,
    status: str = None,
    limit: int = Query(50, le=1000),
    db: DatabaseService = Depends(get_db_service)
):
    """è·å–è¿è§„è®°å½•"""
    violations = await db.get_recent_violations(camera_id, limit, status)
    return {"violations": violations, "total": len(violations)}

@router.get("/statistics/{camera_id}")
async def get_camera_statistics(
    camera_id: str,
    start_time: datetime = Query(default=None),
    end_time: datetime = Query(default=None),
    db: DatabaseService = Depends(get_db_service)
):
    """è·å–æ‘„åƒå¤´ç»Ÿè®¡æ•°æ®"""
    if not start_time:
        start_time = datetime.now() - timedelta(days=7)
    if not end_time:
        end_time = datetime.now()
    
    stats = await db.get_statistics(camera_id, start_time, end_time)
    return stats

@router.put("/violations/{violation_id}/status")
async def update_violation_status(
    violation_id: int,
    status: str,
    notes: str = None,
    db: DatabaseService = Depends(get_db_service)
):
    """æ›´æ–°è¿è§„äº‹ä»¶çŠ¶æ€"""
    await db.update_violation_status(violation_id, status, notes)
    return {"ok": True}
```

**é¢„æœŸæˆæœ**:
- âœ… æ‰€æœ‰æ£€æµ‹ç»“æœæŒä¹…åŒ–å­˜å‚¨
- âœ… è¿è§„äº‹ä»¶å¯è¿½æº¯
- âœ… æ”¯æŒå†å²æ•°æ®æŸ¥è¯¢
- âœ… ç»Ÿè®¡æŠ¥è¡¨è‡ªåŠ¨ç”Ÿæˆ

---

#### 2. å®æ—¶è§†é¢‘æµæ¨é€ï¼ˆWebSocketï¼‰
**ç›®æ ‡**: å‰ç«¯èƒ½çœ‹åˆ°å®æ—¶æ£€æµ‹è§†é¢‘å’Œæ£€æµ‹æ¡†

**å®æ–½æ­¥éª¤**:

##### 2.1 åç«¯æ¨é€æ£€æµ‹å¸§
```python
# src/api/routers/websocket.py
@router.websocket("/ws/camera/{camera_id}")
async def camera_stream(
    websocket: WebSocket,
    camera_id: str,
    manager: ConnectionManager = Depends(get_connection_manager)
):
    """æ‘„åƒå¤´å®æ—¶æµ"""
    await websocket.accept()
    await manager.connect(websocket, camera_id)
    
    try:
        # è®¢é˜…è¯¥æ‘„åƒå¤´çš„æ£€æµ‹ç»“æœ
        async for detection_result in subscribe_camera_results(camera_id):
            # ç»˜åˆ¶æ£€æµ‹æ¡†
            annotated_frame = draw_detections(
                detection_result.frame,
                detection_result.persons,
                detection_result.hairnets,
                detection_result.handwash
            )
            
            # ç¼–ç ä¸ºJPEG
            _, buffer = cv2.imencode('.jpg', annotated_frame, [cv2.IMWRITE_JPEG_QUALITY, 80])
            frame_b64 = base64.b64encode(buffer).decode('utf-8')
            
            # å‘é€å¸§å’Œæ£€æµ‹ç»“æœ
            await websocket.send_json({
                "type": "frame",
                "camera_id": camera_id,
                "frame": frame_b64,
                "detections": {
                    "persons": len(detection_result.persons),
                    "hairnet_violations": sum(1 for h in detection_result.hairnets if not h['has_hairnet']),
                    "handwash_events": len(detection_result.handwash)
                },
                "timestamp": datetime.now().isoformat()
            })
            
            await asyncio.sleep(0.1)  # 10 FPS æ¨é€
    except WebSocketDisconnect:
        manager.disconnect(websocket)
```

##### 2.2 å‰ç«¯æ¥æ”¶å¹¶æ˜¾ç¤º
```typescript
// frontend/src/components/CameraLiveView.vue
<template>
  <n-card title="å®æ—¶ç›‘æ§">
    <div class="video-container">
      <img ref="videoImg" :src="currentFrame" alt="Live Feed" />
      
      <!-- æ£€æµ‹ç»Ÿè®¡å åŠ å±‚ -->
      <div class="overlay-stats">
        <n-space vertical size="small">
          <n-tag type="info">äººæ•°: {{ stats.persons }}</n-tag>
          <n-tag type="warning" v-if="stats.hairnetViolations > 0">
            æœªæˆ´å‘ç½‘: {{ stats.hairnetViolations }}
          </n-tag>
          <n-tag type="success" v-if="stats.handwashEvents > 0">
            æ´—æ‰‹: {{ stats.handwashEvents }}
          </n-tag>
        </n-space>
      </div>
    </div>
  </n-card>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'

const props = defineProps<{ cameraId: string }>()

const currentFrame = ref('')
const stats = ref({
  persons: 0,
  hairnetViolations: 0,
  handwashEvents: 0
})

let ws: WebSocket | null = null

onMounted(() => {
  connectWebSocket()
})

onUnmounted(() => {
  if (ws) {
    ws.close()
  }
})

function connectWebSocket() {
  const wsUrl = `ws://localhost:8000/ws/camera/${props.cameraId}`
  ws = new WebSocket(wsUrl)
  
  ws.onmessage = (event) => {
    const data = JSON.parse(event.data)
    if (data.type === 'frame') {
      currentFrame.value = `data:image/jpeg;base64,${data.frame}`
      stats.value = {
        persons: data.detections.persons,
        hairnetViolations: data.detections.hairnet_violations,
        handwashEvents: data.detections.handwash_events
      }
    }
  }
  
  ws.onerror = (error) => {
    console.error('WebSocket error:', error)
  }
  
  ws.onclose = () => {
    // 5ç§’åé‡è¿
    setTimeout(connectWebSocket, 5000)
  }
}
</script>

<style scoped>
.video-container {
  position: relative;
  width: 100%;
  max-width: 800px;
}

.video-container img {
  width: 100%;
  height: auto;
  border-radius: 8px;
}

.overlay-stats {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.7);
  padding: 10px;
  border-radius: 8px;
}
</style>
```

**é¢„æœŸæˆæœ**:
- âœ… å‰ç«¯å®æ—¶æ˜¾ç¤ºæ£€æµ‹è§†é¢‘
- âœ… æ£€æµ‹æ¡†å’Œæ ‡ç­¾å¯è§†åŒ–
- âœ… å®æ—¶ç»Ÿè®¡æ•°æ®å åŠ 
- âœ… æ–­çº¿è‡ªåŠ¨é‡è¿

---

#### 3. å‘Šè­¦å’Œé€šçŸ¥ç³»ç»Ÿ
**ç›®æ ‡**: å‘ç°è¿è§„ç«‹å³é€šçŸ¥ç›¸å…³äººå‘˜

**å®æ–½æ­¥éª¤**:

##### 3.1 å‘Šè­¦å¼•æ“
```python
# src/services/alert_service.py
from typing import List, Dict, Any
from datetime import datetime, timedelta

class AlertService:
    def __init__(self, db: DatabaseService):
        self.db = db
        self.alert_history = defaultdict(lambda: defaultdict(list))
    
    async def check_violations(
        self,
        camera_id: str,
        violation_type: str,
        track_id: int
    ) -> bool:
        """æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘å‘Šè­¦"""
        # è·å–è¯¥æ‘„åƒå¤´çš„å‘Šè­¦è§„åˆ™
        rules = await self.db.get_alert_rules(camera_id, violation_type)
        
        for rule in rules:
            if await self._evaluate_rule(rule, camera_id, violation_type, track_id):
                await self._trigger_alert(rule, camera_id, violation_type, track_id)
                return True
        return False
    
    async def _evaluate_rule(
        self,
        rule: Dict,
        camera_id: str,
        violation_type: str,
        track_id: int
    ) -> bool:
        """è¯„ä¼°å‘Šè­¦è§„åˆ™"""
        rule_type = rule['rule_type']
        conditions = rule['conditions']
        
        if rule_type == 'continuous_violation':
            # è¿ç»­è¿è§„æ£€æµ‹
            duration = conditions.get('duration_seconds', 10)
            history = self.alert_history[camera_id][track_id]
            
            # è®°å½•å½“å‰æ—¶é—´
            now = datetime.now()
            history.append(now)
            
            # æ¸…ç†æ—§è®°å½•
            cutoff = now - timedelta(seconds=duration)
            history[:] = [t for t in history if t > cutoff]
            
            # æ£€æŸ¥æ˜¯å¦æŒç»­è¿è§„
            if len(history) >= conditions.get('min_detections', 5):
                return True
        
        elif rule_type == 'threshold':
            # é˜ˆå€¼å‘Šè­¦
            count = await self.db.get_violation_count_last_hour(camera_id, violation_type)
            if count >= conditions.get('threshold', 10):
                return True
        
        return False
    
    async def _trigger_alert(
        self,
        rule: Dict,
        camera_id: str,
        violation_type: str,
        track_id: int
    ):
        """è§¦å‘å‘Šè­¦"""
        channels = rule.get('notification_channels', [])
        
        alert_data = {
            "rule_name": rule['name'],
            "camera_id": camera_id,
            "violation_type": violation_type,
            "track_id": track_id,
            "timestamp": datetime.now().isoformat()
        }
        
        for channel in channels:
            if channel == 'websocket':
                await self._send_websocket_alert(alert_data)
            elif channel == 'email':
                await self._send_email_alert(alert_data)
            elif channel == 'webhook':
                await self._send_webhook_alert(alert_data)
    
    async def _send_websocket_alert(self, alert_data: Dict):
        """é€šè¿‡ WebSocket å‘é€å‘Šè­¦"""
        manager = get_connection_manager()
        await manager.broadcast({
            "type": "alert",
            "data": alert_data
        })
    
    async def _send_email_alert(self, alert_data: Dict):
        """å‘é€é‚®ä»¶å‘Šè­¦"""
        # TODO: å®ç°é‚®ä»¶å‘é€
        pass
    
    async def _send_webhook_alert(self, alert_data: Dict):
        """å‘é€ Webhook å‘Šè­¦"""
        # TODO: å®ç° Webhook è°ƒç”¨
        pass
```

##### 3.2 å‰ç«¯å‘Šè­¦å±•ç¤º
```typescript
// frontend/src/components/AlertNotification.vue
<template>
  <n-notification-provider placement="top-right">
    <n-space vertical>
      <n-alert
        v-for="alert in activeAlerts"
        :key="alert.id"
        :type="getAlertType(alert.violation_type)"
        closable
        @close="dismissAlert(alert.id)"
      >
        <template #header>
          {{ getAlertTitle(alert.violation_type) }}
        </template>
        <n-space vertical size="small">
          <n-text>æ‘„åƒå¤´: {{ alert.camera_id }}</n-text>
          <n-text>æ—¶é—´: {{ formatTime(alert.timestamp) }}</n-text>
          <n-button size="small" @click="viewDetails(alert)">
            æŸ¥çœ‹è¯¦æƒ…
          </n-button>
        </n-space>
      </n-alert>
    </n-space>
  </n-notification-provider>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useNotification } from 'naive-ui'

const notification = useNotification()
const activeAlerts = ref([])

onMounted(() => {
  // è®¢é˜… WebSocket å‘Šè­¦
  const ws = new WebSocket('ws://localhost:8000/ws/alerts')
  
  ws.onmessage = (event) => {
    const data = JSON.parse(event.data)
    if (data.type === 'alert') {
      activeAlerts.value.push({
        id: Date.now(),
        ...data.data
      })
      
      // æ˜¾ç¤ºé€šçŸ¥
      notification.warning({
        title: getAlertTitle(data.data.violation_type),
        content: `æ‘„åƒå¤´ ${data.data.camera_id} æ£€æµ‹åˆ°è¿è§„`,
        duration: 5000
      })
      
      // æ’­æ”¾æç¤ºéŸ³
      playAlertSound()
    }
  }
})

function getAlertTitle(type: string) {
  const titles = {
    'no_hairnet': 'æœªä½©æˆ´å‘ç½‘å‘Šè­¦',
    'no_handwash': 'æœªæ´—æ‰‹å‘Šè­¦',
    // ...
  }
  return titles[type] || 'è¿è§„å‘Šè­¦'
}

function playAlertSound() {
  const audio = new Audio('/alert.mp3')
  audio.play()
}
</script>
```

**é¢„æœŸæˆæœ**:
- âœ… è¿è§„å®æ—¶å‘Šè­¦
- âœ… å¤šé€šé“é€šçŸ¥ï¼ˆWebSocketã€é‚®ä»¶ã€Webhookï¼‰
- âœ… å‰ç«¯å¼¹çª—æç¤º
- âœ… å£°éŸ³æé†’

---

### ğŸŸ¡ P1 - é‡è¦åŠŸèƒ½ä¼˜åŒ–ï¼ˆ2-3å‘¨ï¼‰

#### 4. æ£€æµ‹æ€§èƒ½ä¼˜åŒ–
- æ™ºèƒ½è·³å¸§ç®—æ³•
- GPUæ‰¹å¤„ç†ä¼˜åŒ–
- å¤šçº§ç¼“å­˜æœºåˆ¶
- åŠ¨æ€èµ„æºåˆ†é…

#### 5. ç»Ÿè®¡åˆ†æå¢å¼º
- å®æ—¶è¶‹åŠ¿å›¾è¡¨
- å¯¹æ¯”åˆ†æ
- è‡ªå®šä¹‰æŠ¥è¡¨
- æ•°æ®å¯¼å‡º

#### 6. ç”¨æˆ·æƒé™ç³»ç»Ÿ
- ç”¨æˆ·ç™»å½•/ç™»å‡º
- è§’è‰²æƒé™ç®¡ç†
- æ“ä½œæ—¥å¿—
- å¤šç§Ÿæˆ·æ”¯æŒ

---

### ğŸŸ¢ P2 - ä½“éªŒä¼˜åŒ–ï¼ˆ3-4å‘¨ï¼‰

#### 7. å‰ç«¯ UI/UX ä¼˜åŒ–
- å“åº”å¼å¸ƒå±€
- æš—é»‘æ¨¡å¼
- å¿«æ·é”®æ”¯æŒ
- ç§»åŠ¨ç«¯é€‚é…

#### 8. é…ç½®ç®¡ç†æ”¹è¿›
- åœ¨çº¿é…ç½®ç¼–è¾‘
- é…ç½®ç‰ˆæœ¬ç®¡ç†
- é…ç½®éªŒè¯
- çƒ­æ›´æ–°æ”¯æŒ

#### 9. é«˜çº§åŠŸèƒ½
- æ™ºèƒ½åˆ†æå»ºè®®
- è¶‹åŠ¿é¢„æµ‹
- å¼‚å¸¸æ£€æµ‹
- AIè¾…åŠ©å†³ç­–

---

## ğŸ“… å®æ–½è·¯çº¿å›¾

### ç¬¬1å‘¨
- [ ] è®¾è®¡å¹¶å®ç°æ•°æ®åº“è¡¨ç»“æ„
- [ ] å®ç° DatabaseService
- [ ] é›†æˆåˆ°æ£€æµ‹å¾ªç¯

### ç¬¬2å‘¨
- [ ] å®ç° WebSocket è§†é¢‘æµæ¨é€
- [ ] å¼€å‘å‰ç«¯å®æ—¶è§†é¢‘ç»„ä»¶
- [ ] æµ‹è¯•å’Œä¼˜åŒ–å»¶è¿Ÿ

### ç¬¬3å‘¨
- [ ] å®ç°å‘Šè­¦æœåŠ¡
- [ ] å¼€å‘å‰ç«¯å‘Šè­¦ç»„ä»¶
- [ ] æµ‹è¯•å‘Šè­¦è§„åˆ™

### ç¬¬4å‘¨
- [ ] å¼€å‘è¿è§„è®°å½•æŸ¥è¯¢API
- [ ] å¼€å‘ç»Ÿè®¡æ•°æ®API
- [ ] å‰ç«¯æ•°æ®å±•ç¤ºç»„ä»¶

### ç¬¬5-6å‘¨
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ‰¹å¤„ç†ä¼˜åŒ–
- [ ] ç¼“å­˜ä¼˜åŒ–

### ç¬¬7-8å‘¨
- [ ] ç»Ÿè®¡åˆ†æåŠŸèƒ½
- [ ] å›¾è¡¨ç»„ä»¶
- [ ] æŠ¥è¡¨å¯¼å‡º

### ç¬¬9-10å‘¨
- [ ] ç”¨æˆ·æƒé™ç³»ç»Ÿ
- [ ] ç™»å½•è®¤è¯
- [ ] æƒé™æ§åˆ¶

### ç¬¬11-12å‘¨
- [ ] UI/UX ä¼˜åŒ–
- [ ] ç§»åŠ¨ç«¯é€‚é…
- [ ] æ–‡æ¡£å®Œå–„

---

## ğŸ’¡ å¿«é€Ÿå†³ç­–å»ºè®®

### ç«‹å³å¼€å§‹ï¼ˆæœ¬å‘¨ï¼‰
1. **æ•°æ®åº“è®¾è®¡å’Œå®ç°** - è¿™æ˜¯å…¶ä»–åŠŸèƒ½çš„åŸºç¡€
2. **WebSocket è§†é¢‘æµ** - ç”¨æˆ·æœ€ç›´è§‚çš„éœ€æ±‚

### è¿‘æœŸå®æ–½ï¼ˆ2å‘¨å†…ï¼‰
3. **å‘Šè­¦ç³»ç»Ÿ** - æå‡ç³»ç»Ÿå®ç”¨æ€§
4. **è¿è§„è®°å½•æŸ¥è¯¢** - æ»¡è¶³è¿½æº¯éœ€æ±‚

### ä¸­æœŸè§„åˆ’ï¼ˆ1ä¸ªæœˆå†…ï¼‰
5. **æ€§èƒ½ä¼˜åŒ–** - è§£å†³ç³»ç»Ÿç“¶é¢ˆ
6. **ç»Ÿè®¡åˆ†æ** - æä¾›å†³ç­–æ”¯æŒ

### é•¿æœŸè§„åˆ’ï¼ˆ2-3ä¸ªæœˆï¼‰
7. **æƒé™ç³»ç»Ÿ** - ä¼ä¸šçº§éœ€æ±‚
8. **é«˜çº§åŠŸèƒ½** - å·®å¼‚åŒ–ç«äº‰åŠ›

---

## ğŸ¯ å…³é”®æˆåŠŸæŒ‡æ ‡ï¼ˆKPIï¼‰

1. **åŠŸèƒ½å®Œæ•´åº¦**: æ ¸å¿ƒåŠŸèƒ½å®ç°ç‡ â‰¥ 90%
2. **æ€§èƒ½æŒ‡æ ‡**: å•æ‘„åƒå¤´ CPU å ç”¨ < 20%
3. **å“åº”é€Ÿåº¦**: APIå“åº”æ—¶é—´ < 100ms
4. **ç¨³å®šæ€§**: 7x24å°æ—¶ç¨³å®šè¿è¡Œ
5. **ç”¨æˆ·æ»¡æ„åº¦**: â‰¥ 4.5/5.0

---

**å»ºè®®**: ä¼˜å…ˆå®æ–½ P0 åŠŸèƒ½ï¼Œå¿«é€Ÿè¿­ä»£ï¼Œè¾¹åšè¾¹ä¼˜åŒ–ã€‚

