# éƒ¨ç½²æµç¨‹å’Œè„šæœ¬é—®é¢˜åˆ†æ

## ğŸ” é—®é¢˜æ ¹æº

å½“å‰éƒ¨ç½²å­˜åœ¨**æ¶æ„ä¸ä¸€è‡´**çš„é—®é¢˜ï¼Œå¯¼è‡´ç™½å±ï¼š

### é—®é¢˜ 1: Docker Compose é…ç½®é”™è¯¯

**ä½ç½®**: `docker-compose.prod.yml` ç¬¬ 239 è¡Œ

```yaml
nginx:
  depends_on:
    - api
    - frontend  # âŒ é”™è¯¯ï¼šæœåŠ¡ååº”è¯¥æ˜¯ frontend-init
```

**é—®é¢˜**:
- æœåŠ¡åæ˜¯ `frontend-init`ï¼Œä½† `depends_on` å†™çš„æ˜¯ `frontend`
- è¿™ä¼šå¯¼è‡´ nginx å¯åŠ¨æ—¶æ‰¾ä¸åˆ° `frontend` æœåŠ¡ï¼Œä¾èµ–æ£€æŸ¥å¤±è´¥

**æ­£ç¡®é…ç½®**:
```yaml
nginx:
  depends_on:
    - api
    - frontend-init  # âœ… æ­£ç¡®
```

---

### é—®é¢˜ 2: æ¶æ„æ¨¡å¼æ··ç”¨

å½“å‰å­˜åœ¨ä¸¤ç§æ¶æ„æ¨¡å¼ï¼Œä½†é…ç½®ä¸ä¸€è‡´ï¼š

#### Scheme A: åŒå®¹å™¨æ¶æ„ï¼ˆæ—§æ–¹æ¡ˆï¼‰
- **å‰ç«¯å®¹å™¨**: `frontend` æœåŠ¡è¿è¡Œ Nginxï¼Œæä¾›é™æ€æ–‡ä»¶
- **åå‘ä»£ç†**: `nginx` æœåŠ¡é€šè¿‡ `proxy_pass http://frontend_backend/` ä»£ç†åˆ°å‰ç«¯å®¹å™¨
- **Nginx é…ç½®**: éœ€è¦ `upstream frontend_backend { server frontend:80; }`

#### Scheme B: å• Nginx æ¶æ„ï¼ˆæ–°æ–¹æ¡ˆï¼Œæ¨èï¼‰
- **å‰ç«¯åˆå§‹åŒ–å®¹å™¨**: `frontend-init` æœåŠ¡æå–é™æ€æ–‡ä»¶åˆ° `./frontend/dist`
- **åå‘ä»£ç†**: `nginx` æœåŠ¡ç›´æ¥æŒ‚è½½ `./frontend/dist:/usr/share/nginx/html:ro`
- **Nginx é…ç½®**: ä½¿ç”¨ `root /usr/share/nginx/html` å’Œ `try_files $uri $uri/ /index.html`

**å½“å‰çŠ¶æ€**:
- `docker-compose.prod.yml` ä½¿ç”¨çš„æ˜¯ **Scheme B**ï¼ˆå• Nginxï¼‰
- ä½†ç”¨æˆ·æ£€æŸ¥çš„ `nginx/nginx.conf` ä¸­æœ‰ `frontend_backend`ï¼Œè¿™æ˜¯ **Scheme A** çš„é…ç½®
- è¿™å¯¼è‡´ nginx å°è¯•ä»£ç†åˆ°ä¸å­˜åœ¨çš„ `frontend` æœåŠ¡ï¼Œè¿”å› 502 æˆ–ç™½å±

---

### é—®é¢˜ 3: prepare_minimal_deploy.sh è„šæœ¬é€»è¾‘

**ä½ç½®**: `scripts/prepare_minimal_deploy.sh` ç¬¬ 304-399 è¡Œ

**é—®é¢˜**:
1. è„šæœ¬æ£€æµ‹åˆ°å‰ç«¯é•œåƒå­˜åœ¨æ—¶ï¼Œç”Ÿæˆ **Scheme B** é…ç½®ï¼ˆå• Nginxï¼‰
2. ä½†ç”¨æˆ·å¯èƒ½å·²ç»æ‰‹åŠ¨ä¿®æ”¹äº† `nginx/nginx.conf`ï¼Œä½¿ç”¨äº† **Scheme A** é…ç½®
3. è„šæœ¬ä¸ä¼šå¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„é…ç½®æ–‡ä»¶ï¼ˆé™¤éä½¿ç”¨ `force overwrite`ï¼‰

**å½±å“**:
- å¦‚æœç”¨æˆ·ä¹‹å‰ä½¿ç”¨è¿‡ Scheme Aï¼Œé…ç½®æ–‡ä»¶ä¼šä¿ç•™ `frontend_backend`
- æ–°éƒ¨ç½²ä½¿ç”¨ Scheme Bï¼Œä½† nginx é…ç½®ä¸åŒ¹é…
- å¯¼è‡´ç™½å±

---

### é—®é¢˜ 4: è¯Šæ–­è„šæœ¬ä¸åŒ¹é…

**ä½ç½®**: `scripts/diagnose_frontend_whitescreen.sh`

**é—®é¢˜**:
- è¯Šæ–­è„šæœ¬æ£€æŸ¥çš„æ˜¯ `pepgmp-frontend-prod` å®¹å™¨ï¼ˆScheme Aï¼‰
- ä½†å®é™…éƒ¨ç½²ä½¿ç”¨çš„æ˜¯ `pepgmp-frontend-init` å®¹å™¨ï¼ˆScheme Bï¼‰
- è¯Šæ–­è„šæœ¬æ— æ³•æ­£ç¡®æ£€æµ‹ Scheme B çš„é—®é¢˜

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¿®å¤ Docker Compose é…ç½®ï¼ˆç«‹å³ä¿®å¤ï¼‰

ä¿®å¤ `docker-compose.prod.yml` ä¸­çš„ `depends_on` é”™è¯¯ï¼š

```yaml
nginx:
  depends_on:
    - api
    - frontend-init  # ä¿®å¤ï¼šæ”¹ä¸º frontend-init
```

### æ–¹æ¡ˆ 2: ç»Ÿä¸€ä½¿ç”¨ Scheme Bï¼ˆæ¨èï¼‰

**æ­¥éª¤ 1**: ç¡®ä¿ nginx é…ç½®æ˜¯ Scheme B

æ£€æŸ¥ `nginx/nginx.conf` åº”è¯¥åŒ…å«ï¼š
```nginx
server {
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

**ä¸åº”è¯¥æœ‰**:
```nginx
upstream frontend_backend {
    server frontend:80;
}
```

**æ­¥éª¤ 2**: ç¡®ä¿ `./frontend/dist` ç›®å½•å­˜åœ¨ä¸”æœ‰æ–‡ä»¶

```bash
# æ£€æŸ¥é™æ€æ–‡ä»¶
ls -la ~/projects/Pyt/frontend/dist/

# å¦‚æœä¸å­˜åœ¨ï¼Œè¿è¡Œ frontend-init å®¹å™¨æå–
docker-compose -f docker-compose.prod.yml --env-file .env.production up frontend-init
```

**æ­¥éª¤ 3**: é‡å¯ nginx

```bash
docker-compose -f docker-compose.prod.yml --env-file .env.production restart nginx
```

### æ–¹æ¡ˆ 3: æ›´æ–° prepare_minimal_deploy.sh

å¢å¼ºè„šæœ¬çš„æ¶æ„æ£€æµ‹å’Œé…ç½®éªŒè¯ï¼š

1. **æ£€æµ‹å½“å‰æ¶æ„æ¨¡å¼**ï¼ˆé€šè¿‡æ£€æŸ¥ nginx é…ç½®ï¼‰
2. **éªŒè¯é…ç½®ä¸€è‡´æ€§**ï¼ˆdocker-compose å’Œ nginx é…ç½®åŒ¹é…ï¼‰
3. **æä¾›ä¿®å¤å»ºè®®**ï¼ˆè‡ªåŠ¨ä¿®å¤æˆ–æç¤ºç”¨æˆ·ï¼‰

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

åœ¨éƒ¨ç½²å‰ï¼Œè¯·æ£€æŸ¥ï¼š

- [ ] `docker-compose.prod.yml` ä¸­ nginx çš„ `depends_on` æ˜¯ `frontend-init`ï¼ˆä¸æ˜¯ `frontend`ï¼‰
- [ ] `nginx/nginx.conf` ä½¿ç”¨ Scheme B é…ç½®ï¼ˆ`root /usr/share/nginx/html`ï¼Œæ²¡æœ‰ `frontend_backend`ï¼‰
- [ ] `./frontend/dist` ç›®å½•å­˜åœ¨ä¸”åŒ…å« `index.html`
- [ ] `frontend-init` å®¹å™¨å·²æˆåŠŸè¿è¡Œå¹¶æå–é™æ€æ–‡ä»¶
- [ ] nginx å®¹å™¨å¯ä»¥è®¿é—® `./frontend/dist` ç›®å½•ï¼ˆæƒé™æ­£ç¡®ï¼‰

---

## ğŸš€ å¿«é€Ÿä¿®å¤å‘½ä»¤

```bash
cd ~/projects/Pyt

# 1. ä¿®å¤ docker-compose.prod.ymlï¼ˆå¦‚æœè¿˜æ²¡ä¿®å¤ï¼‰
sed -i 's/- frontend$/- frontend-init/' docker-compose.prod.yml

# 2. æ£€æŸ¥å¹¶ä¿®å¤ nginx é…ç½®ï¼ˆå¦‚æœä½¿ç”¨ Scheme Bï¼‰
# ç¡®ä¿ nginx/nginx.conf æ²¡æœ‰ frontend_backend

# 3. ç¡®ä¿é™æ€æ–‡ä»¶å­˜åœ¨
docker-compose -f docker-compose.prod.yml --env-file .env.production up frontend-init

# 4. é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml --env-file .env.production restart nginx

# 5. éªŒè¯
curl http://localhost/health
curl http://localhost/
```

---

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒé—®é¢˜**:
1. Docker Compose é…ç½®é”™è¯¯ï¼š`depends_on` å†™é”™äº†æœåŠ¡å
2. æ¶æ„æ¨¡å¼æ··ç”¨ï¼šnginx é…ç½®å’Œ docker-compose ä¸åŒ¹é…
3. é™æ€æ–‡ä»¶ç¼ºå¤±ï¼š`./frontend/dist` å¯èƒ½ä¸å­˜åœ¨æˆ–ä¸ºç©º

**è§£å†³ä¼˜å…ˆçº§**:
1. **ç«‹å³ä¿®å¤**: `docker-compose.prod.yml` çš„ `depends_on`
2. **ç»Ÿä¸€æ¶æ„**: ç¡®ä¿ nginx é…ç½®å’Œ docker-compose éƒ½ä½¿ç”¨ Scheme B
3. **éªŒè¯æ–‡ä»¶**: ç¡®ä¿é™æ€æ–‡ä»¶å·²æ­£ç¡®æå–
