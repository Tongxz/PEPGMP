# 数据库初始化问题解决方案

**问题时间**: 2025-12-04
**问题描述**: 应用启动后出现表不存在的错误

---

## 🔍 问题分析

### 错误信息

从启动日志中发现以下错误：

1. **检测记录表不存在**:
   ```
   ERROR: relation "detection_records" does not exist
   ```

2. **告警历史表不存在**:
   ```
   ERROR: relation "alert_history" does not exist
   ```

3. **告警规则表不存在**:
   ```
   ERROR: relation "alert_rules" does not exist
   ```

### 问题原因

项目的数据库初始化采用**混合机制**：

1. **MLOps 表**（ORM 自动创建）:
   - `workflows`, `workflow_runs`, `datasets`, `deployments`, `model_registry`
   - 这些表在应用启动时通过 SQLAlchemy ORM 自动创建

2. **业务核心表**（需要 SQL 脚本）:
   - `detection_records`, `alert_history`, `alert_rules`, `violation_events`, `statistics_hourly`
   - 这些表需要通过执行 SQL 迁移脚本创建

**根本原因**: 只执行了 ORM 初始化，没有执行 SQL 迁移脚本。

---

## ✅ 解决方案

### 方法 1: 执行迁移脚本（推荐）

```bash
# 执行核心表创建脚本
docker exec -i pepgmp-postgres-dev psql -U pepgmp_dev -d pepgmp_development < scripts/migrations/001_create_core_tables.sql
```

### 方法 2: 使用数据库初始化脚本

```bash
# 使用 Python 初始化脚本（如果可用）
python scripts/init_database.py
```

---

## 📋 已创建的数据库表

### MLOps 表（ORM 自动创建）

- `workflows` - 工作流定义
- `workflow_runs` - 工作流运行记录
- `datasets` - 数据集管理
- `deployments` - 模型部署
- `model_registry` - 模型注册表

### 业务核心表（SQL 脚本创建）

- `detection_records` - 检测记录表
- `alert_history` - 告警历史表
- `alert_rules` - 告警规则表
- `violation_events` - 违规事件表
- `statistics_hourly` - 小时统计表

### 其他业务表

- `cameras` - 摄像头配置表
- `regions` - 区域配置表
- `alerts` - 告警记录表
- `behaviors` - 行为记录表
- `detections` - 检测结果表
- `users` - 用户表
- `system_configs` - 系统配置表

---

## 🚀 完整的数据库初始化流程

### 首次部署

```bash
# 1. 启动数据库容器
docker-compose up -d database

# 2. 等待数据库就绪
docker-compose ps

# 3. 执行 SQL 迁移脚本（创建核心业务表）
docker exec -i pepgmp-postgres-dev psql -U pepgmp_dev -d pepgmp_development < scripts/migrations/001_create_core_tables.sql

# 4. 启动应用（自动创建 ORM 表）
bash scripts/start_dev.sh
```

### 验证初始化

```bash
# 检查所有表
docker exec pepgmp-postgres-dev psql -U pepgmp_dev -d pepgmp_development -c "\dt"

# 检查特定表
docker exec pepgmp-postgres-dev psql -U pepgmp_dev -d pepgmp_development -c "\d detection_records"
docker exec pepgmp-postgres-dev psql -U pepgmp_dev -d pepgmp_development -c "\d alert_history"
docker exec pepgmp-postgres-dev psql -U pepgmp_dev -d pepgmp_development -c "\d alert_rules"
```

---

## ⚠️ 注意事项

### 1. 数据库用户和权限

确保数据库用户有创建表和索引的权限：

```sql
-- 检查用户权限
SELECT grantee, privilege_type
FROM information_schema.role_table_grants
WHERE grantee = 'pepgmp_dev';
```

### 2. 迁移脚本的执行顺序

- 必须先创建基础表（如 `detection_records`）
- 然后创建依赖表（如 `violation_events` 依赖 `detection_records`）
- 最后创建索引和视图

### 3. 数据迁移

如果数据库中有旧数据：
- 在执行迁移脚本前备份数据
- 检查表结构兼容性
- 可能需要数据迁移脚本

---

## 🔧 自动化初始化脚本

### 创建自动化脚本

```bash
#!/bin/bash
# scripts/init_core_tables.sh

set -e

CONTAINER_NAME="pepgmp-postgres-dev"
DB_USER="pepgmp_dev"
DB_NAME="pepgmp_development"
MIGRATION_FILE="scripts/migrations/001_create_core_tables.sql"

echo "🔄 初始化数据库核心表..."
echo ""

# 检查容器是否运行
if ! docker ps | grep -q "$CONTAINER_NAME"; then
    echo "❌ 错误: 容器 $CONTAINER_NAME 未运行"
    exit 1
fi

# 执行迁移脚本
echo "📝 执行迁移脚本: $MIGRATION_FILE"
docker exec -i "$CONTAINER_NAME" psql -U "$DB_USER" -d "$DB_NAME" < "$MIGRATION_FILE"

echo ""
echo "✅ 数据库核心表初始化完成"
echo ""
echo "📊 验证创建的表:"
docker exec "$CONTAINER_NAME" psql -U "$DB_USER" -d "$DB_NAME" -c "\dt" | grep -E "detection_records|alert_history|alert_rules|violation_events|statistics_hourly"
```

**使用方法**:
```bash
chmod +x scripts/init_core_tables.sh
./scripts/init_core_tables.sh
```

---

## 📚 相关文档

- [数据库初始化机制说明](DATABASE_INITIALIZATION.md)
- [数据库迁移指南](DATABASE_INITIALIZATION.md#推荐的首次部署流程)

---

## ✅ 验证结果

执行迁移脚本后，应该能看到：

```
✅ 数据库初始化完成！
   - 已创建 6 个核心表
   - 已创建 15 个索引
   - 已创建 2 个视图
   - 已创建 3 个触发器
   - 已插入 2 条默认告警规则
```

应用重新启动后，错误应该消失。
