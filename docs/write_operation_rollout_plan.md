# 写操作端点灰度发布计划

## 日期
2025-10-31

## 概述

本计划详细说明写操作端点 `PUT /api/v1/records/violations/{violation_id}/status` 的灰度发布流程。

## 端点信息

- **端点**: `PUT /api/v1/records/violations/{violation_id}/status`
- **功能**: 更新违规状态
- **参数**:
  - `violation_id` (path): 违规ID
  - `status` (query): 新状态（pending, confirmed, false_positive, resolved）
  - `notes` (query, optional): 备注信息
  - `handled_by` (query, optional): 处理人
  - `force_domain` (query, optional): 强制使用领域服务（测试用途）
- **响应**: `{"ok": true, "violation_id": int, "status": str}`

## 技术实现

### 1. 端点修改

已更新端点以支持灰度发布机制：
- 使用 `should_use_domain(force_domain)` 决定是否使用领域服务
- 支持 `ROLLOUT_PERCENT` 环境变量控制灰度比例
- 支持 `force_domain` 查询参数强制使用领域服务（测试用途）

### 2. 仓储支持

已在 `PostgreSQLDetectionRepository` 中添加 `update_violation_status()` 方法：
- 更新违规状态到数据库
- 更新 `handled_at` 时间戳
- 支持更新 `notes` 和 `handled_by` 字段
- 返回更新是否成功

### 3. 回退机制

- 如果领域服务失败或仓储不支持，自动回退到 `DatabaseService.update_violation_status()`
- 保证API可用性，不中断服务

## 灰度发布流程

### 阶段1: 5% 灰度（初始验证）

**环境变量**:
```bash
USE_DOMAIN_SERVICE=true
ROLLOUT_PERCENT=5
REPOSITORY_TYPE=postgresql
```

**验证内容**:
- ✅ 端点功能正常
- ✅ 状态更新成功
- ✅ 响应结构正确
- ✅ 回退机制正常

**观察期**: 10分钟

### 阶段2: 10% 灰度

**环境变量**:
```bash
ROLLOUT_PERCENT=10
```

**验证内容**:
- ✅ 端点功能正常
- ✅ 性能指标正常
- ✅ 无错误日志

**观察期**: 15分钟

### 阶段3: 25% 灰度

**环境变量**:
```bash
ROLLOUT_PERCENT=25
```

**验证内容**:
- ✅ 端点功能正常
- ✅ 性能指标正常
- ✅ 无错误日志
- ✅ 数据一致性验证

**观察期**: 30分钟

### 阶段4: 50% 灰度

**环境变量**:
```bash
ROLLOUT_PERCENT=50
```

**验证内容**:
- ✅ 端点功能正常
- ✅ 性能指标正常
- ✅ 无错误日志
- ✅ 数据一致性验证
- ✅ 与旧实现对比

**观察期**: 1小时

### 阶段5: 100% 灰度（全量发布）

**环境变量**:
```bash
ROLLOUT_PERCENT=100
```

**验证内容**:
- ✅ 端点功能正常
- ✅ 性能指标正常
- ✅ 无错误日志
- ✅ 数据一致性验证
- ✅ 稳定性验证（多次验证）

**观察期**: 2小时

## 验证脚本

创建了专门的验证脚本：`tools/rollout_verification_write_operations.sh`

**功能**:
- 测试更新违规状态（不同状态值）
- 测试无效状态值（错误处理）
- 测试回退机制
- 测试各个灰度阶段
- 最终稳定性验证

**使用方法**:
```bash
bash tools/rollout_verification_write_operations.sh
```

## 验证检查项

### 功能验证

1. ✅ **正常更新**: 更新违规状态为 `confirmed`
2. ✅ **所有状态值**: 测试 `pending`, `confirmed`, `false_positive`, `resolved`
3. ✅ **无效状态**: 拒绝无效状态值（返回400错误）
4. ✅ **不存在的违规**: 正确处理404错误
5. ✅ **参数验证**: `notes` 和 `handled_by` 参数正常工作

### 性能验证

1. ⏳ **响应时间**: 单次请求响应时间 < 100ms（写操作允许稍慢）
2. ⏳ **并发性能**: 支持至少10个并发更新请求
3. ⏳ **资源使用**: CPU和内存使用正常

### 数据一致性验证

1. ⏳ **状态更新**: 数据库中的状态正确更新
2. ⏳ **时间戳更新**: `handled_at` 正确更新
3. ⏳ **备注信息**: `notes` 和 `handled_by` 正确保存

### 回退机制验证

1. ✅ **仓储不支持**: 自动回退到旧实现
2. ✅ **领域服务失败**: 自动回退到旧实现
3. ✅ **错误处理**: 正确抛出HTTP异常

## 风险控制

### 写操作风险

1. **数据一致性风险**: ⚠️⚠️⚠️ 高
   - **缓解措施**:
     - 完整的事务支持
     - 数据验证
     - 回退机制

2. **性能风险**: ⚠️ 中
   - **缓解措施**:
     - 性能监控
     - 灰度发布逐步提升

3. **业务逻辑风险**: ⚠️⚠️ 中高
   - **缓解措施**:
     - 完整的状态验证
     - 业务规则检查
     - 测试覆盖

### 回滚方案

如果发现问题，可以快速回滚：

1. **紧急回滚**: 设置 `ROLLOUT_PERCENT=0` 或 `USE_DOMAIN_SERVICE=false`
2. **部分回滚**: 降低灰度比例到上一阶段
3. **数据修复**: 如果数据不一致，需要手动修复（低概率）

## 成功标准

### 功能标准

- ✅ 所有状态更新成功
- ✅ 响应结构正确
- ✅ 错误处理正确

### 性能标准

- ⏳ 响应时间 < 100ms（平均）
- ⏳ 响应时间 < 200ms（P95）
- ⏳ 支持至少10个并发请求

### 稳定性标准

- ⏳ 无异常堆栈或错误
- ⏳ 数据一致性100%
- ⏳ 回退机制正常

## 时间计划

- **阶段1 (5%)**: 10分钟
- **阶段2 (10%)**: 15分钟
- **阶段3 (25%)**: 30分钟
- **阶段4 (50%)**: 1小时
- **阶段5 (100%)**: 2小时

**总计**: 约4小时

## 后续步骤

### 短期（完成灰度后）

1. ⏳ **监控生产环境**: 持续监控24小时
2. ⏳ **性能分析**: 收集性能指标
3. ⏳ **数据一致性检查**: 验证数据一致性

### 中期（1周内）

1. ⏳ **性能优化**: 如有需要，优化性能
2. ⏳ **补充单元测试**: 覆盖写操作分支
3. ⏳ **文档更新**: 更新API文档

---

**状态**: ⏳ 准备中
**下一步**: 执行5%灰度验证
