# 实时监控大屏视频流问题调试指南

## 问题描述
启用了摄像头检测，但实时监控大屏内没有监控画面。

## 可能的原因

### 1. 摄像头检测进程未运行
- **症状**: WebSocket连接成功，但没有收到视频帧数据
- **检查**: 前往"相机配置"页面，查看摄像头运行状态
- **解决**: 点击"启动"按钮启动摄像头检测进程

### 2. 视频流未推送到后端
- **症状**: 摄像头正在运行，但WebSocket没有收到数据
- **检查**: 查看后端日志，确认是否有视频帧推送
- **可能原因**: 检测进程没有调用 `video_stream_manager.update_frame()` 方法

### 3. WebSocket连接失败
- **症状**: 显示"未连接"状态
- **检查**: 查看浏览器控制台的错误信息
- **可能原因**:
  - 后端服务未启动
  - WebSocket路径错误
  - 网络连接问题
  - 防火墙阻止连接

### 4. 视频流管理器未初始化
- **症状**: WebSocket连接成功，但后端没有推送数据
- **检查**: 查看后端日志中是否有 `VideoStreamManager` 相关错误

## 已添加的调试功能

### 1. 详细的连接日志
- ✅ 连接尝试日志
- ✅ 连接成功/失败日志
- ✅ WebSocket错误详情
- ✅ 连接关闭原因

### 2. 连接状态显示
- ✅ 显示连接状态（已连接/未连接）
- ✅ 显示等待数据状态
- ✅ 显示FPS和延迟信息
- ✅ 错误提示工具提示

### 3. 自动重连机制
- ✅ 连接异常关闭时自动重连（延迟5秒）
- ✅ 心跳检测（每30秒）

### 4. 摄像头运行状态检查
- ✅ 自动刷新摄像头运行状态
- ✅ 显示运行中的摄像头数量
- ✅ 提示未运行的摄像头

## 调试步骤

### 步骤1: 检查浏览器控制台
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签页
3. 查找以下日志：
   - `[VideoStreamCard] 正在连接摄像头...`
   - `[VideoStreamCard] WebSocket连接成功`
   - `[VideoStreamCard] WebSocket错误`
   - `[VideoStreamCard] WebSocket连接关闭`

### 步骤2: 检查摄像头运行状态
1. 前往"相机配置"页面
2. 查看摄像头列表中的"运行状态"
3. 如果状态为"已停止"，点击"启动"按钮

### 步骤3: 检查后端日志
1. 查看后端服务日志
2. 查找以下信息：
   - `WebSocket已连接: camera=xxx`
   - `更新帧失败`
   - `视频流管理器` 相关错误

### 步骤4: 检查WebSocket连接
1. 在浏览器控制台的 Network 标签页
2. 筛选 WS (WebSocket) 连接
3. 查看连接状态和消息

### 步骤5: 检查视频流API
1. 访问后端API文档或使用curl测试：
   ```bash
   curl http://localhost:8000/api/v1/video-stream/status/{camera_id}
   ```
2. 检查返回的状态信息

## 常见问题解决

### 问题1: WebSocket连接失败 (404)
**原因**: 后端路由未正确注册
**解决**: 检查 `src/api/app.py` 中是否包含了 `video_stream.router`

### 问题2: 连接成功但没有数据
**原因**: 检测进程没有推送帧数据
**解决**:
1. 检查检测进程是否正在运行
2. 检查检测进程是否调用了 `video_stream_manager.update_frame()`
3. 查看后端日志确认是否有帧数据推送

### 问题3: 连接频繁断开
**原因**: 网络不稳定或后端服务异常
**解决**:
1. 检查网络连接
2. 查看后端日志
3. 检查后端服务资源使用情况

## 下一步排查

如果以上步骤都无法解决问题，请提供：
1. 浏览器控制台的完整错误日志
2. 后端服务的日志
3. 摄像头运行状态截图
4. Network标签页中WebSocket连接的详细信息
