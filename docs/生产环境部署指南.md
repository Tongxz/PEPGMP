# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

> æœ¬æ–‡æ¡£é€‚ç”¨äºä» macOS å¼€å‘ç¯å¢ƒéƒ¨ç½²åˆ° WSL2 Ubuntu / åŸç”Ÿ Ubuntu ç”Ÿäº§ç¯å¢ƒçš„åœºæ™¯ã€‚

---

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
2. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
3. [è¯¦ç»†éƒ¨ç½²æ­¥éª¤](#è¯¦ç»†éƒ¨ç½²æ­¥éª¤)
4. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
5. [è¿ç»´å‘½ä»¤å‚è€ƒ](#è¿ç»´å‘½ä»¤å‚è€ƒ)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ç¯å¢ƒè¦æ±‚

### å¼€å‘æœºï¼ˆæ„å»ºç¯å¢ƒï¼‰

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|---------|------|
| Docker Desktop | 4.0+ | ç”¨äºæ„å»ºé•œåƒ |
| Bash | 4.0+ | æ‰§è¡Œæ„å»ºè„šæœ¬ |
| Git | 2.0+ | ä»£ç ç‰ˆæœ¬ç®¡ç† |

### ç”Ÿäº§æœåŠ¡å™¨

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|---------|------|
| Ubuntu | 22.04 LTS | æˆ– WSL2 Ubuntu |
| Docker | 24.0+ | å®¹å™¨è¿è¡Œæ—¶ |
| Docker Compose | 2.0+ | å®¹å™¨ç¼–æ’ |
| 1Panel | å¯é€‰ | å¯è§†åŒ–ç®¡ç†é¢æ¿ |

### ç¡¬ä»¶è¦æ±‚

| èµ„æº | æœ€ä½é…ç½® | æ¨èé…ç½® |
|------|---------|---------|
| CPU | 4 æ ¸ | 8 æ ¸ |
| å†…å­˜ | 8 GB | 16 GB |
| ç£ç›˜ | 50 GB | 100 GB |
| GPU | æ—  | NVIDIA GPUï¼ˆæ¨ç†åŠ é€Ÿï¼‰ |

---

## éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”Ÿäº§ç¯å¢ƒæ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚   Nginx     â”‚â”€â”€â”€â”€â–¶â”‚  Frontend   â”‚     â”‚  Prometheus â”‚                  â”‚
â”‚   â”‚   (åå‘ä»£ç†) â”‚     â”‚  (Vue3)     â”‚     â”‚  (ç›‘æ§)     â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚    API      â”‚â”€â”€â”€â”€â–¶â”‚  PostgreSQL â”‚     â”‚   Redis     â”‚                  â”‚
â”‚   â”‚  (FastAPI)  â”‚     â”‚  (æ•°æ®åº“)   â”‚     â”‚  (ç¼“å­˜)     â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Volume æŒ‚è½½:                                                        â”‚  â”‚
â”‚   â”‚  â€¢ ./config:/app/config:ro      (åªè¯»é…ç½®)                          â”‚  â”‚
â”‚   â”‚  â€¢ ./models:/app/models:ro      (åªè¯»æ¨¡å‹)                          â”‚  â”‚
â”‚   â”‚  â€¢ ./scripts/init_db.sql        (æ•°æ®åº“åˆå§‹åŒ–)                      â”‚  â”‚
â”‚   â”‚  â€¢ app_logs:/app/logs           (æ—¥å¿—æŒä¹…åŒ–)                        â”‚  â”‚
â”‚   â”‚  â€¢ postgres_prod_data           (æ•°æ®åº“æŒä¹…åŒ–)                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šå¼€å‘æœºå‡†å¤‡ï¼ˆmacOSï¼‰

#### æ­¥éª¤ 1.1ï¼šæ„å»º Docker é•œåƒ

```bash
cd /path/to/Pyt

# ä½¿ç”¨æ—¥æœŸä½œä¸ºç‰ˆæœ¬å·æ„å»ºé•œåƒ
bash scripts/build_prod_only.sh 20251202

# æ„å»ºæˆåŠŸåä¼šæ˜¾ç¤ºï¼š
# [SUCCESS] åç«¯APIé•œåƒæ„å»ºå®Œæˆ
# [SUCCESS] å‰ç«¯é•œåƒæ„å»ºå®Œæˆ
```

**è¾“å‡ºçš„é•œåƒï¼š**
- `pepgmp-backend:20251202`
- `pepgmp-backend:latest`
- `pepgmp-frontend:20251202`
- `pepgmp-frontend:latest`

#### æ­¥éª¤ 1.2ï¼šå¯¼å‡ºé•œåƒä¸º tar æ–‡ä»¶

```bash
# åˆ›å»ºå¯¼å‡ºç›®å½•
mkdir -p docker-images

# å¯¼å‡ºåç«¯é•œåƒ
docker save pepgmp-backend:20251202 -o docker-images/pepgmp-backend-20251202.tar

# å¯¼å‡ºå‰ç«¯é•œåƒ
docker save pepgmp-frontend:20251202 -o docker-images/pepgmp-frontend-20251202.tar

# æŸ¥çœ‹æ–‡ä»¶å¤§å°
ls -lh docker-images/
# pepgmp-backend-20251202.tar    çº¦ 2-3 GB
# pepgmp-frontend-20251202.tar   çº¦ 50 MB
```

#### æ­¥éª¤ 1.3ï¼šåŒæ­¥é…ç½®åˆ°éƒ¨ç½²ç›®å½•

```bash
# è¿è¡Œé…ç½®åŒæ­¥è„šæœ¬
bash scripts/prepare_minimal_deploy.sh ~/projects/Pyt

# è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
# âœ“ åˆ›å»ºç›®å½•ç»“æ„
# âœ“ å¤åˆ¶ docker-compose.prod.yml
# âœ“ å¤åˆ¶ config/ ç›®å½•
# âœ“ å¤åˆ¶ models/ ç›®å½•ï¼ˆå¢é‡åŒæ­¥ï¼‰
# âœ“ ç”Ÿæˆ nginx/nginx.conf
# âœ“ å¤åˆ¶éƒ¨ç½²è„šæœ¬
# âœ“ æç¤ºç”Ÿæˆ .env.productionï¼ˆé¦–æ¬¡éƒ¨ç½²æ—¶ï¼‰
```

#### æ­¥éª¤ 1.4ï¼šä¼ è¾“æ–‡ä»¶åˆ°ç”Ÿäº§æœåŠ¡å™¨

**æ–¹æ³• Aï¼šWSL2 å…±äº«æ–‡ä»¶ç³»ç»Ÿ**
```bash
# å¦‚æœç”Ÿäº§ç¯å¢ƒæ˜¯ WSL2ï¼Œå¯ä»¥é€šè¿‡ /mnt/ è®¿é—® Windows æ–‡ä»¶
# å°†æ–‡ä»¶å¤åˆ¶åˆ° Windows å¯è®¿é—®çš„ä½ç½®
cp -r docker-images /mnt/c/Users/YourName/
cp -r ~/projects/PEPGMP/mnt/c/Users/YourName/
```

**æ–¹æ³• Bï¼šSCP/RSYNC**
```bash
# ä½¿ç”¨ scp
scp -r docker-images user@server:~/

# ä½¿ç”¨ rsyncï¼ˆæ¨èï¼Œæ”¯æŒå¢é‡ä¼ è¾“ï¼‰
rsync -avz --progress docker-images/ user@server:~/docker-images/
rsync -avz --progress ~/projects/PEPGMP user@server:~/projects/PEPGMP
```

**æ–¹æ³• Cï¼šUç›˜/ç§»åŠ¨ç¡¬ç›˜**
```bash
# å¯¹äºç¦»çº¿ç¯å¢ƒï¼Œå¤åˆ¶åˆ°ç§»åŠ¨å­˜å‚¨è®¾å¤‡
cp -r docker-images /Volumes/USB/
cp -r ~/projects/PEPGMP/Volumes/USB/
```

---

### ç¬¬äºŒé˜¶æ®µï¼šç”Ÿäº§æœåŠ¡å™¨éƒ¨ç½²ï¼ˆWSL2/Ubuntuï¼‰

#### æ­¥éª¤ 2.1ï¼šå®‰è£…å¿…è¦å·¥å…·

```bash
# æ›´æ–°åŒ…åˆ—è¡¨
sudo apt-get update

# å®‰è£…å¿…è¦å·¥å…·
sudo apt-get install -y \
    dos2unix \
    rsync \
    curl \
    jq

# éªŒè¯ Docker å·²å®‰è£…
docker --version
docker compose version
```

#### æ­¥éª¤ 2.2ï¼šä¿®å¤è„šæœ¬è¡Œå°¾ç¬¦ï¼ˆä»… WSL2 éœ€è¦ï¼‰

```bash
# å¦‚æœè„šæœ¬ä» Windows æ–‡ä»¶ç³»ç»Ÿè¿è¡Œï¼Œéœ€è¦ä¿®å¤è¡Œå°¾ç¬¦
cd /mnt/f/code/PythonCode/Pyt  # æˆ–ä½ çš„é¡¹ç›®è·¯å¾„

# ä¿®å¤æ‰€æœ‰ shell è„šæœ¬
dos2unix scripts/*.sh scripts/lib/*.sh
```

#### æ­¥éª¤ 2.3ï¼šå¯¼å…¥ Docker é•œåƒ

```bash
# è¿›å…¥é•œåƒç›®å½•
cd ~/docker-images  # æˆ–ä½ å­˜æ”¾ tar æ–‡ä»¶çš„ä½ç½®

# å¯¼å…¥åç«¯é•œåƒ
docker load -i pepgmp-backend-20251202.tar

# å¯¼å…¥å‰ç«¯é•œåƒ
docker load -i pepgmp-frontend-20251202.tar

# éªŒè¯é•œåƒå·²å¯¼å…¥
docker images | grep pepgmp
# åº”æ˜¾ç¤ºï¼š
# pepgmp-backend    20251202    xxx    2.5GB
# pepgmp-frontend   20251202    xxx    50MB
```

#### æ­¥éª¤ 2.4ï¼šé…ç½®éƒ¨ç½²ç›®å½•

```bash
# è¿›å…¥éƒ¨ç½²ç›®å½•
cd ~/projects/Pyt

# å¦‚æœæ˜¯é¦–æ¬¡éƒ¨ç½²ï¼Œç”Ÿæˆé…ç½®æ–‡ä»¶
bash scripts/generate_production_config.sh

# è„šæœ¬ä¼šæç¤ºè¾“å…¥ï¼š
# - API ç«¯å£ [8000]
# - ç®¡ç†å‘˜ç”¨æˆ·å [admin]
# - CORS é…ç½® [*]
# - é•œåƒç‰ˆæœ¬ [latest]
#
# å¹¶è‡ªåŠ¨ç”Ÿæˆå¼ºéšæœºå¯†ç 
```

#### æ­¥éª¤ 2.5ï¼šæ›´æ–°é•œåƒç‰ˆæœ¬å·

```bash
cd ~/projects/Pyt

# æ›´æ–° .env.production ä¸­çš„ IMAGE_TAG
bash scripts/update_image_version.sh 20251202

# éªŒè¯ç‰ˆæœ¬å·å·²æ›´æ–°
grep "IMAGE_TAG" .env.production
# åº”æ˜¾ç¤ºï¼šIMAGE_TAG=20251202
```

#### æ­¥éª¤ 2.6ï¼šéªŒè¯é…ç½®

```bash
cd ~/projects/Pyt

# éªŒè¯ Docker Compose é…ç½®æ˜¯å¦æ­£ç¡®
docker compose -f docker-compose.prod.yml --env-file .env.production config

# æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
docker images | grep -E "pepgmp-(backend|frontend)"

# æ£€æŸ¥é…ç½®æ–‡ä»¶
ls -la config/
ls -la models/
ls -la nginx/
```

#### æ­¥éª¤ 2.7ï¼šå¯åŠ¨æœåŠ¡

**æ–¹æ³• Aï¼šå‘½ä»¤è¡Œå¯åŠ¨**
```bash
cd ~/projects/Pyt

# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
docker compose -f docker-compose.prod.yml --env-file .env.production up -d

# æŸ¥çœ‹å¯åŠ¨çŠ¶æ€
docker compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker compose -f docker-compose.prod.yml logs -f
```

**æ–¹æ³• Bï¼š1Panel å¯åŠ¨**
1. æ‰“å¼€ 1Panel ç®¡ç†ç•Œé¢
2. è¿›å…¥ã€Œå®¹å™¨ã€â†’ã€ŒComposeã€
3. ç‚¹å‡»ã€Œåˆ›å»º Compose é¡¹ç›®ã€
4. å¡«å†™é…ç½®ï¼š
   - **åç§°**ï¼š`pepgmp-prod`
   - **è·¯å¾„**ï¼š`/home/pep/projects/Pyt`ï¼ˆä½ çš„éƒ¨ç½²ç›®å½•ï¼‰
   - **Compose æ–‡ä»¶**ï¼š`docker-compose.prod.yml`
5. ç‚¹å‡»ã€Œç¯å¢ƒå˜é‡ã€ï¼Œé€‰æ‹©ã€Œä»æ–‡ä»¶åŠ è½½ã€â†’ `.env.production`
6. ç‚¹å‡»ã€Œéƒ¨ç½²ã€

#### æ­¥éª¤ 2.8ï¼šéªŒè¯éƒ¨ç½²

```bash
# ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆçº¦ 30-60 ç§’ï¼‰
sleep 30

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps

# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/v1/monitoring/health

# æ£€æŸ¥å‰ç«¯ï¼ˆé€šè¿‡ Nginxï¼‰
curl http://localhost/

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec pepgmp-api-prod python -c "from src.database.connection import get_pool; print('DB OK')"
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šShell è„šæœ¬æŠ¥é”™ `$'\r': command not found`

**åŸå› **ï¼šè„šæœ¬æ–‡ä»¶ä½¿ç”¨äº† Windows è¡Œå°¾ç¬¦ï¼ˆCRLFï¼‰è€Œé Unix è¡Œå°¾ç¬¦ï¼ˆLFï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å®‰è£… dos2unix
sudo apt-get install -y dos2unix

# ä¿®å¤æ‰€æœ‰è„šæœ¬
dos2unix scripts/*.sh scripts/lib/*.sh

# æˆ–ä½¿ç”¨ sed
sed -i 's/\r$//' scripts/prepare_minimal_deploy.sh
```

---

### é—®é¢˜ 2ï¼šDocker é•œåƒæ‰¾ä¸åˆ°

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error response from daemon: No such image: pepgmp-backend:20251202
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥é•œåƒæ˜¯å¦å¯¼å…¥
docker images | grep pepgmp

# å¦‚æœæ²¡æœ‰ï¼Œé‡æ–°å¯¼å…¥
docker load -i pepgmp-backend-20251202.tar

# æ£€æŸ¥ .env.production ä¸­çš„ç‰ˆæœ¬å·æ˜¯å¦åŒ¹é…
grep IMAGE_TAG .env.production
```

---

### é—®é¢˜ 3ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
connection refused / Connection timed out
```

**å¯èƒ½åŸå› **ï¼š
1. æ•°æ®åº“å®¹å™¨æœªå¯åŠ¨
2. ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯
3. ç½‘ç»œé…ç½®é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æ•°æ®åº“å®¹å™¨çŠ¶æ€
docker ps | grep postgres

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker logs pepgmp-postgres-prod

# éªŒè¯æ•°æ®åº“è¿æ¥é…ç½®
grep DATABASE .env.production

# æµ‹è¯•æ•°æ®åº“è¿æ¥
docker exec pepgmp-postgres-prod pg_isready -U pepgmp_prod -d pepgmp_production
```

---

### é—®é¢˜ 4ï¼šRedis å¥åº·æ£€æŸ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
NOAUTH Authentication required
```

**åŸå› **ï¼šRedis å¥åº·æ£€æŸ¥æœªä½¿ç”¨å¯†ç 

**è§£å†³æ–¹æ¡ˆ**ï¼š
è¿™ä¸ªé—®é¢˜å·²åœ¨ `docker-compose.prod.yml` ä¸­ä¿®å¤ã€‚ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶ï¼š
```yaml
healthcheck:
  test: ["CMD-SHELL", "redis-cli -a $${REDIS_PASSWORD} ping | grep -q PONG"]
```

---

### é—®é¢˜ 5ï¼šNginx é…ç½®é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
nginx: [emerg] open() "/etc/nginx/nginx.conf" failed
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ nginx ç›®å½•ç»“æ„
ls -la ~/projects/PEPGMPnginx/

# ç¡®ä¿ nginx.conf æ˜¯æ–‡ä»¶è€Œéç›®å½•
file ~/projects/PEPGMPnginx/nginx.conf

# å¦‚æœæ˜¯ç›®å½•ï¼Œåˆ é™¤å¹¶é‡æ–°ç”Ÿæˆ
rm -rf ~/projects/PEPGMPnginx/nginx.conf
bash scripts/prepare_minimal_deploy.sh ~/projects/PEPGMPyes
```

---

### é—®é¢˜ 6ï¼šæ¨¡å‹æ–‡ä»¶æœªæŒ‚è½½

**ç—‡çŠ¶**ï¼šAPI å¯åŠ¨ä½†æ£€æµ‹åŠŸèƒ½ä¸å·¥ä½œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æ¨¡å‹ç›®å½•
ls -la ~/projects/PEPGMPmodels/

# ç¡®è®¤æ¨¡å‹æ–‡ä»¶å­˜åœ¨
find ~/projects/PEPGMPmodels -name "*.pt" -o -name "*.onnx"

# æ£€æŸ¥å®¹å™¨å†…æ¨¡å‹ç›®å½•
docker exec pepgmp-api-prod ls -la /app/models/
```

---

### é—®é¢˜ 7ï¼šæƒé™é—®é¢˜

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Permission denied / Operation not permitted
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä¿®å¤ç›®å½•æƒé™
sudo chown -R $USER:$USER ~/projects/Pyt

# è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
chmod +x ~/projects/PEPGMPscripts/*.sh

# è®¾ç½®é…ç½®æ–‡ä»¶æƒé™
chmod 600 ~/projects/PEPGMP.env.production
```

---

### é—®é¢˜ 8ï¼šç«¯å£è¢«å ç”¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
bind: address already in use
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo lsof -i :8000
sudo lsof -i :80

# åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo kill -9 <PID>

# æˆ–ä¿®æ”¹ .env.production ä½¿ç”¨å…¶ä»–ç«¯å£
API_PORT=8001
```

---

### é—®é¢˜ 9ï¼šç£ç›˜ç©ºé—´ä¸è¶³

**é”™è¯¯ä¿¡æ¯**ï¼š
```
no space left on device
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ¸…ç† Docker æœªä½¿ç”¨çš„èµ„æº
docker system prune -a

# æ¸…ç†æ—§é•œåƒ
docker image prune -a

# æ¸…ç†æ—§æ—¥å¿—
sudo truncate -s 0 /var/log/*.log
```

---

### é—®é¢˜ 10ï¼šå®¹å™¨å†…å­˜ä¸è¶³

**é”™è¯¯ä¿¡æ¯**ï¼š
```
OOMKilled / Out of memory
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# ä¿®æ”¹ docker-compose.prod.yml å¢åŠ å†…å­˜é™åˆ¶
# deploy:
#   resources:
#     limits:
#       memory: 8G  # å¢åŠ åˆ° 8GB
```

---

## è¿ç»´å‘½ä»¤å‚è€ƒ

### æœåŠ¡ç®¡ç†

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose -f docker-compose.prod.yml --env-file .env.production up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker compose -f docker-compose.prod.yml down

# é‡å¯å•ä¸ªæœåŠ¡
docker compose -f docker-compose.prod.yml restart api

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker compose -f docker-compose.prod.yml logs -f api
docker compose -f docker-compose.prod.yml logs --tail=100 api
```

### æ•°æ®åº“ç®¡ç†

```bash
# è¿›å…¥æ•°æ®åº“å®¹å™¨
docker exec -it pepgmp-postgres-prod psql -U pepgmp_prod -d pepgmp_production

# å¤‡ä»½æ•°æ®åº“
docker exec pepgmp-postgres-prod pg_dump -U pepgmp_prod pepgmp_production > backup.sql

# æ¢å¤æ•°æ®åº“
cat backup.sql | docker exec -i pepgmp-postgres-prod psql -U pepgmp_prod -d pepgmp_production
```

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹ API æ—¥å¿—
docker exec pepgmp-api-prod cat /app/logs/error.log

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker logs -f pepgmp-api-prod

# å¯¼å‡ºæ—¥å¿—
docker logs pepgmp-api-prod > api.log 2>&1
```

### é•œåƒæ›´æ–°

```bash
# 1. åœ¨å¼€å‘æœºæ„å»ºæ–°é•œåƒ
bash scripts/build_prod_only.sh 20251203

# 2. å¯¼å‡ºé•œåƒ
docker save pepgmp-backend:20251203 -o docker-images/pepgmp-backend-20251203.tar

# 3. ä¼ è¾“åˆ°ç”Ÿäº§æœåŠ¡å™¨
rsync -avz docker-images/ user@server:~/docker-images/

# 4. åœ¨ç”Ÿäº§æœåŠ¡å™¨å¯¼å…¥
docker load -i pepgmp-backend-20251203.tar

# 5. æ›´æ–°ç‰ˆæœ¬å·
bash scripts/update_image_version.sh 20251203

# 6. é‡å¯æœåŠ¡
docker compose -f docker-compose.prod.yml --env-file .env.production up -d
```

---

## æ•…éšœæ’æŸ¥

### è¯Šæ–­å‘½ä»¤

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a

# æ£€æŸ¥å®¹å™¨æ—¥å¿—
docker logs pepgmp-api-prod --tail=50

# æ£€æŸ¥å®¹å™¨èµ„æºä½¿ç”¨
docker stats --no-stream

# æ£€æŸ¥ç½‘ç»œè¿æ¥
docker network ls
docker network inspect pepgmp_backend

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it pepgmp-api-prod bash

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec pepgmp-api-prod env | grep -E "DATABASE|REDIS|API"
```

### å¥åº·æ£€æŸ¥

```bash
# API å¥åº·æ£€æŸ¥
curl -s http://localhost:8000/api/v1/monitoring/health | jq .

# æ•°æ®åº“å¥åº·æ£€æŸ¥
docker exec pepgmp-postgres-prod pg_isready -U pepgmp_prod

# Redis å¥åº·æ£€æŸ¥
docker exec pepgmp-redis-prod redis-cli -a $REDIS_PASSWORD ping

# å‰ç«¯å¥åº·æ£€æŸ¥
curl -s http://localhost/health
```

### æ€§èƒ½ç›‘æ§

```bash
# æŸ¥çœ‹å®¹å™¨ CPU/å†…å­˜ä½¿ç”¨
docker stats

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
docker inspect pepgmp-api-prod

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
docker system df
```

---

## é™„å½•

### éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] Docker å’Œ Docker Compose å·²å®‰è£…
- [ ] é•œåƒå·²å¯¼å…¥ï¼ˆ`docker images | grep pepgmp`ï¼‰
- [ ] é…ç½®æ–‡ä»¶å·²ç”Ÿæˆï¼ˆ`.env.production`ï¼‰
- [ ] ç‰ˆæœ¬å·å·²æ›´æ–°ï¼ˆ`IMAGE_TAG`ï¼‰
- [ ] æ¨¡å‹æ–‡ä»¶å·²å¤åˆ¶ï¼ˆ`models/`ï¼‰
- [ ] é…ç½®æ–‡ä»¶å·²å¤åˆ¶ï¼ˆ`config/`ï¼‰
- [ ] Nginx é…ç½®æ­£ç¡®ï¼ˆ`nginx/nginx.conf`ï¼‰
- [ ] æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬å­˜åœ¨ï¼ˆ`scripts/init_db.sql`ï¼‰
- [ ] æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨ï¼ˆ`docker compose ps`ï¼‰
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡

### é‡è¦æ–‡ä»¶è·¯å¾„

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| Docker Compose | `docker-compose.prod.yml` | æœåŠ¡ç¼–æ’é…ç½® |
| ç¯å¢ƒå˜é‡ | `.env.production` | å¯†ç å’Œé…ç½® |
| å‡­æ®å¤‡ä»½ | `.env.production.credentials` | å¯†ç å¤‡ä»½ï¼ˆéƒ¨ç½²ååˆ é™¤ï¼‰ |
| Nginx é…ç½® | `nginx/nginx.conf` | åå‘ä»£ç†é…ç½® |
| æ•°æ®åº“åˆå§‹åŒ– | `scripts/init_db.sql` | è¡¨ç»“æ„å’Œåˆå§‹æ•°æ® |
| åº”ç”¨é…ç½® | `config/cameras.yaml` | æ‘„åƒå¤´é…ç½® |
| æ¨¡å‹æ–‡ä»¶ | `models/*.pt` | AI æ¨¡å‹ |

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼š1.0*
*æœ€åæ›´æ–°ï¼š2025-12-02*
