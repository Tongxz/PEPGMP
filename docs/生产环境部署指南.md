# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å‰ç½®è¦æ±‚](#å‰ç½®è¦æ±‚)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è¯¦ç»†é…ç½®](#è¯¦ç»†é…ç½®)
- [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
- [ç»´æŠ¤ç®¡ç†](#ç»´æŠ¤ç®¡ç†)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä½¿ç”¨ç§æœ‰ Registry éƒ¨ç½²å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒï¼ŒåŒ…æ‹¬ï¼š
- ğŸš€ åç«¯ APIï¼ˆåŸºäº CUDA GPUï¼‰
- ğŸ¨ å‰ç«¯ç•Œé¢ï¼ˆNginx + Vue3ï¼‰
- ğŸ’¾ PostgreSQL æ•°æ®åº“
- âš¡ Redis ç¼“å­˜

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nginx (Frontend)                      â”‚
â”‚                   192.168.30.83:5433                     â”‚
â”‚                   /pyt-frontend:prod                     â”‚
â”‚                        :8080                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ /api/* â†’ proxy
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI (Backend)                       â”‚
â”‚                192.168.30.83:5433                        â”‚
â”‚                  /pyt-api:prod                           â”‚
â”‚                     :8000                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL     â”‚  â”‚      Redis       â”‚
â”‚   :16-alpine     â”‚  â”‚    :7-alpine     â”‚
â”‚     :5432        â”‚  â”‚      :6379       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å‰ç½®è¦æ±‚

### ç¡¬ä»¶è¦æ±‚

- **CPU**: 4æ ¸å¿ƒåŠä»¥ä¸Š
- **å†…å­˜**: 16GB åŠä»¥ä¸Š
- **GPU**: NVIDIA GPUï¼ˆæ”¯æŒ CUDA 12.4ï¼‰
- **å­˜å‚¨**: 50GB å¯ç”¨ç©ºé—´

### è½¯ä»¶è¦æ±‚

```bash
# å¿…éœ€
- Docker Engine 24.0+
- Docker Compose 2.20+
- NVIDIA Docker Runtimeï¼ˆGPU æ”¯æŒï¼‰

# å¯é€‰
- curlï¼ˆå¥åº·æ£€æŸ¥ï¼‰
- jqï¼ˆJSON å¤„ç†ï¼‰
```

### ç½‘ç»œè¦æ±‚

- èƒ½è®¿é—®ç§æœ‰ Registry: `192.168.30.83:5433`
- å¼€æ”¾ç«¯å£: 8000 (API), 8080 (Frontend), 5432 (PostgreSQL), 6379 (Redis)

---

## å¿«é€Ÿå¼€å§‹

### 1. é…ç½®ç§æœ‰ Registry

ç¼–è¾‘ `/etc/docker/daemon.json` (Linux) æˆ– Docker Desktop Settings (macOS/Windows):

```json
{
  "insecure-registries": ["192.168.30.83:5433"]
}
```

é‡å¯ Docker:
```bash
# Linux
sudo systemctl restart docker

# macOS/Windows
# åœ¨ Docker Desktop ä¸­é‡å¯
```

### 2. éªŒè¯ Registry è¿æ¥

```bash
# æŸ¥çœ‹å¯ç”¨é•œåƒ
curl http://192.168.30.83:5433/v2/_catalog

# åº”è¯¥çœ‹åˆ°ä»¥ä¸‹é•œåƒ:
# - pyt-api
# - pyt-frontend
# - postgres
# - redis
# - nginx
# - node
# - nvidia/cuda
```

### 3. åˆ›å»ºé…ç½®æ–‡ä»¶

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹
cp config/production.env.example config/production.env

# ç¼–è¾‘é…ç½®ï¼ˆä¿®æ”¹å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ï¼‰
vim config/production.env
```

### 4. ä¸€é”®å¯åŠ¨

```bash
# ä½¿ç”¨å®Œæ•´é…ç½®å¯åŠ¨ï¼ˆåŒ…å«æ•°æ®åº“ï¼‰
docker-compose -f docker-compose.prod.full.yml --env-file config/production.env up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.full.yml logs -f

# æŸ¥çœ‹çŠ¶æ€
docker-compose -f docker-compose.prod.full.yml ps
```

### 5. éªŒè¯éƒ¨ç½²

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health          # åç«¯ API
curl http://localhost:8080/                 # å‰ç«¯ç•Œé¢
curl http://localhost:8080/api/v1/health   # å‰ç«¯ä»£ç†åˆ°åç«¯

# æ•°æ®åº“è¿æ¥æµ‹è¯•
docker exec -it pyt-postgres-prod psql -U pyt_user -d pyt_production -c "SELECT version();"

# Redis æµ‹è¯•
docker exec -it pyt-redis-prod redis-cli -a your_redis_password ping
```

---

## è¯¦ç»†é…ç½®

### ç¯å¢ƒå˜é‡è¯´æ˜

#### å¿…é¡»ä¿®æ”¹çš„é…ç½®

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `POSTGRES_PASSWORD` | PostgreSQL å¯†ç  | è‡³å°‘ 16 ä½å¼ºå¯†ç  |
| `REDIS_PASSWORD` | Redis å¯†ç  | è‡³å°‘ 16 ä½å¼ºå¯†ç  |
| `SECRET_KEY` | åº”ç”¨å¯†é’¥ | è‡³å°‘ 32 ä½éšæœºå­—ç¬¦ä¸² |
| `JWT_SECRET` | JWT ç­¾åå¯†é’¥ | è‡³å°‘ 32 ä½éšæœºå­—ç¬¦ä¸² |

#### ç”Ÿæˆå¼ºå¯†ç 

```bash
# ç”Ÿæˆ 32 ä½éšæœºå¯†ç 
openssl rand -base64 32

# æˆ–ä½¿ç”¨ Python
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

### æŒä¹…åŒ–æ•°æ®

æ•°æ®å·é…ç½®:
```yaml
volumes:
  postgres_data:      # PostgreSQL æ•°æ®
  redis_data:         # Redis æŒä¹…åŒ–æ•°æ®
```

é»˜è®¤ä½ç½®:
```bash
# Linux
/var/lib/docker/volumes/

# æŸ¥çœ‹å·
docker volume ls
docker volume inspect <volume_name>
```

---

## éƒ¨ç½²æ­¥éª¤

### ç”Ÿäº§ç¯å¢ƒå®Œæ•´éƒ¨ç½²

#### æ­¥éª¤ 1: å‡†å¤‡ç¯å¢ƒ

```bash
# 1. åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /opt/pyt-production
cd /opt/pyt-production

# 2. æ‹‰å–é…ç½®æ–‡ä»¶
git clone <your-repo> .

# æˆ–è€…ä» tar åŒ…åŠ è½½é•œåƒï¼ˆç¦»çº¿ç¯å¢ƒï¼‰
docker load -i pyt-api_prod_20251011.tar
docker load -i pyt-frontend_prod_20251011.tar
```

#### æ­¥éª¤ 2: é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®
cp config/production.env.example config/production.env

# ç”Ÿæˆå¯†é’¥
export SECRET_KEY=$(openssl rand -base64 32)
export JWT_SECRET=$(openssl rand -base64 32)
export POSTGRES_PASSWORD=$(openssl rand -base64 24)
export REDIS_PASSWORD=$(openssl rand -base64 24)

# å†™å…¥é…ç½®æ–‡ä»¶
cat >> config/production.env << EOF
SECRET_KEY=${SECRET_KEY}
JWT_SECRET=${JWT_SECRET}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
REDIS_PASSWORD=${REDIS_PASSWORD}
EOF
```

#### æ­¥éª¤ 3: åˆå§‹åŒ–æ•°æ®åº“

```bash
# å¯åŠ¨æ•°æ®åº“æœåŠ¡
docker-compose -f docker-compose.prod.full.yml --env-file config/production.env up -d database redis

# ç­‰å¾…æ•°æ®åº“å°±ç»ª
until docker exec pyt-postgres-prod pg_isready -U pyt_user; do
  echo "ç­‰å¾… PostgreSQL å¯åŠ¨..."
  sleep 2
done

# æ•°æ®åº“ä¼šè‡ªåŠ¨æ‰§è¡Œ scripts/init_db.sql åˆå§‹åŒ–
```

#### æ­¥éª¤ 4: å¯åŠ¨åº”ç”¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.full.yml --env-file config/production.env up -d

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose -f docker-compose.prod.full.yml logs -f api frontend
```

#### æ­¥éª¤ 5: éªŒè¯éƒ¨ç½²

```bash
# æ‰§è¡Œå¥åº·æ£€æŸ¥è„šæœ¬
./scripts/health_check.sh

# æˆ–æ‰‹åŠ¨æ£€æŸ¥
curl -f http://localhost:8000/health || echo "åç«¯å¤±è´¥"
curl -f http://localhost:8080/ || echo "å‰ç«¯å¤±è´¥"
```

---

## ç»´æŠ¤ç®¡ç†

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose -f docker-compose.prod.full.yml logs

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡
docker-compose -f docker-compose.prod.full.yml logs api

# å®æ—¶è·Ÿè¸ª
docker-compose -f docker-compose.prod.full.yml logs -f --tail=100

# å¯¼å‡ºæ—¥å¿—
docker-compose -f docker-compose.prod.full.yml logs --no-color > logs/production_$(date +%Y%m%d).log
```

### å¤‡ä»½ä¸æ¢å¤

#### æ•°æ®åº“å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p backups/postgres

# å¤‡ä»½æ•°æ®åº“
docker exec pyt-postgres-prod pg_dump \
  -U pyt_user \
  -d pyt_production \
  -F c \
  -f /tmp/backup.dump

# å¤åˆ¶åˆ°ä¸»æœº
docker cp pyt-postgres-prod:/tmp/backup.dump \
  backups/postgres/pyt_production_$(date +%Y%m%d_%H%M%S).dump
```

#### æ•°æ®åº“æ¢å¤

```bash
# å¤åˆ¶å¤‡ä»½åˆ°å®¹å™¨
docker cp backups/postgres/pyt_production_20251011.dump \
  pyt-postgres-prod:/tmp/restore.dump

# æ¢å¤æ•°æ®åº“
docker exec pyt-postgres-prod pg_restore \
  -U pyt_user \
  -d pyt_production \
  -c \
  /tmp/restore.dump
```

#### Redis å¤‡ä»½

```bash
# Redis è‡ªåŠ¨æŒä¹…åŒ–ï¼ˆAOFï¼‰
# æ‰‹åŠ¨è§¦å‘ä¿å­˜
docker exec pyt-redis-prod redis-cli -a ${REDIS_PASSWORD} BGSAVE

# å¤åˆ¶ RDB æ–‡ä»¶
docker cp pyt-redis-prod:/data/dump.rdb \
  backups/redis/dump_$(date +%Y%m%d_%H%M%S).rdb
```

### æ›´æ–°éƒ¨ç½²

```bash
# 1. æ‹‰å–æœ€æ–°é•œåƒ
docker pull 192.168.30.83:5433/pyt-api:prod
docker pull 192.168.30.83:5433/pyt-frontend:prod

# 2. åœæ­¢æ—§æœåŠ¡
docker-compose -f docker-compose.prod.full.yml stop api frontend

# 3. å¯åŠ¨æ–°æœåŠ¡
docker-compose -f docker-compose.prod.full.yml up -d api frontend

# 4. éªŒè¯
curl http://localhost:8000/health
```

### ç›‘æ§æ£€æŸ¥

```bash
# å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.full.yml ps

# èµ„æºä½¿ç”¨
docker stats pyt-api-prod pyt-frontend-prod pyt-postgres-prod pyt-redis-prod

# ç£ç›˜ä½¿ç”¨
docker system df
docker volume ls
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. å®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose -f docker-compose.prod.full.yml logs <service_name>

# æ£€æŸ¥é…ç½®
docker-compose -f docker-compose.prod.full.yml config

# æ£€æŸ¥èµ„æº
docker stats
df -h
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
docker exec pyt-postgres-prod pg_isready

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker logs pyt-postgres-prod

# æµ‹è¯•è¿æ¥
docker exec -it pyt-postgres-prod psql -U pyt_user -d pyt_production
```

#### 3. GPU ä¸å¯ç”¨

```bash
# æ£€æŸ¥ NVIDIA é©±åŠ¨
nvidia-smi

# æ£€æŸ¥ Docker GPU æ”¯æŒ
docker run --rm --gpus all nvidia/cuda:12.4.0-runtime-ubuntu22.04 nvidia-smi

# é‡å¯å®¹å™¨
docker-compose -f docker-compose.prod.full.yml restart api
```

#### 4. ç½‘ç»œé—®é¢˜

```bash
# æ£€æŸ¥ç½‘ç»œ
docker network ls
docker network inspect pyt-prod-network

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep -E '(8000|8080|5432|6379)'

# æµ‹è¯•æœåŠ¡é—´è¿é€šæ€§
docker exec pyt-api-prod ping database
docker exec pyt-api-prod ping redis
```

### æ€§èƒ½ä¼˜åŒ–

#### PostgreSQL ä¼˜åŒ–

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 10;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename))
FROM pg_tables ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- åˆ›å»ºç´¢å¼•ç¤ºä¾‹
CREATE INDEX idx_detections_timestamp ON detections(timestamp);
```

#### Redis ä¼˜åŒ–

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
docker exec pyt-redis-prod redis-cli -a ${REDIS_PASSWORD} INFO memory

# æŸ¥çœ‹æ…¢æ—¥å¿—
docker exec pyt-redis-prod redis-cli -a ${REDIS_PASSWORD} SLOWLOG GET 10

# æ¸…ç†è¿‡æœŸé”®
docker exec pyt-redis-prod redis-cli -a ${REDIS_PASSWORD} --scan --pattern "cache:*" | xargs docker exec pyt-redis-prod redis-cli -a ${REDIS_PASSWORD} DEL
```

---

## å®‰å…¨å»ºè®®

1. **å®šæœŸæ›´æ–°å¯†ç **
2. **å¯ç”¨é˜²ç«å¢™ï¼Œé™åˆ¶ç«¯å£è®¿é—®**
3. **å®šæœŸå¤‡ä»½æ•°æ®**
4. **ç›‘æ§å¼‚å¸¸è®¿é—®**
5. **ä½¿ç”¨ HTTPS/TLS**
6. **å®šæœŸæ›´æ–°é•œåƒå’Œä¾èµ–**

---

## è”ç³»æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- é¡¹ç›®æ–‡æ¡£: `docs/`
- API æ–‡æ¡£: `docs/API_æ–‡æ¡£.md`
- æ„å»ºè„šæœ¬: `scripts/README_PROD_BUILD.md`
