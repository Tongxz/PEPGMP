# 深度学习训练工作流实施规划

## 1. 目标与范围

1. 建立覆盖核心检测能力的端到端训练工作流（数据采集→数据清洗→训练→评估→注册/部署）。
2. 用真实的深度学习训练替换当前占位的逻辑回归方案，支撑线上模型持续迭代。
3. 统一数据与模型的版本管理、日志与监控，确保可追溯与可回滚。

当前重点关注三类检测任务：
- **发网佩戴检测（Hairnet Detection）**
- **洗手合规检测（Handwash Compliance）**
- **通用人体行为检测（如未佩戴口罩、越界等）**

## 2. 现状评估

| 检测任务 | 数据采集 | 数据集生成 | 模型训练 | 评估/报告 | 部署现状 |
|----------|----------|------------|----------|------------|----------|
| 发网检测 | 已通过快照、数据集生成工作流接通 | 已实现（CSV + images） | 占位逻辑回归 | 轻量 JSON 报告 | 手动部署 |
| 洗手检测 | 快照/视频尚未统一管理 | 未实现 | 现有传统 ML 模型 | 无统一报告 | 线下使用 |
| 行为检测 | 数据标签不统一 | 未实现 | 步骤未建立 | 无 | 无 |

## 3. 目标工作流模板

### 3.1 发网佩戴检测（Hairnet Workflow）

1. **Data Collection**：摄像头违规/正常快照 → 快照存储。
2. **Data Cleaning**：人工抽检、自动去重（可嵌入步骤），输出审核通过列表。
3. **Dataset Generation**：已有 `DatasetGenerationService` 输出 `images/` + `annotations.csv`。
4. **Model Training (YOLO)**：
   - 使用 Ultralytics YOLOv8。
   - 支持超参数：epochs、img size、pretrained weights、augmentations。
   - 支持 GPU 调度。
5. **Model Evaluation**：生成 mAP、Precision、Recall、混淆矩阵、PR 曲线。
6. **Model Registry**：保存权重 (`weights/best.pt`)、评估报告、模型元数据。
7. **Deployment/Notification**（后续扩展）：灰度发布、版本回滚。

### 3.2 洗手合规检测（Handwash Workflow）

1. **Video Ingestion**：采集洗手视频段，拆分步骤。
2. **Labeling & Segmentation**：按动作步骤标注（自动/人工）。
3. **Feature Extraction**：
   - 方案 A：人体姿态识别（YOLOv8-Pose + Temporal CNN）。
   - 方案 B：CV + 传统 ML 特征（过渡方案）。
4. **Model Training**：时序模型训练（支持 LSTM/Temporal CNN/Transformer）。
5. **Evaluation**：每步骤召回率，流程合规率。
6. **Model Registry**：保存模型参数、性能报告。

### 3.3 行为检测（Multi-Behavior Workflow）

1. **Data Capture**：标记 `violation_type`（口罩、越界等）。
2. **Dataset Generation**：扩展生成服务，输出带类别 ID 的标注。
3. **Model Training**：多类别 YOLO/DETR/RT-DETR。
4. **Evaluation**：类别级指标、混淆矩阵。
5. **Registry**：支持多模型版本管理。

## 4. 实施路线图

### 阶段 0：准备（1 周）
- 明确 GPU / 训练环境配置（Dockerfile、CUDA 驱动）。
- 补充数据目录规范、权限、存储监控。
- 建立 `ModelRegistry` 数据表（模型版本、路径、性能、状态）。

### 阶段 1：发网检测工作流（2-3 周）
1. **Week 1**
   - 接入 YOLO 训练脚本至 `ModelTrainingService`。
   - 扩展工作流：新增训练参数表单、日志输出。
   - 引入长任务执行方案（FastAPI Background Tasks → Celery/Redis）。
2. **Week 2**
   - 评估指标生成（mAP、混淆矩阵）。
   - 模型注册接口：写入模型表、保存权重与报告。
   - 前端展示训练结果（模型列表、指标可视化）。
3. **Week 3**
   - 自定义数据清洗步骤（人工复核入口）。
   - 端到端验证、文档整理。

### 阶段 2：洗手检测工作流（3-4 周）
- **数据准备**：统一洗手视频存储、标签规范。
- **特征提取**：选择姿态估计/手部关键点方案。
- **训练**：实现时序模型训练服务；
  - 输出每步骤指标、合规率统计。
- **评估/报告**：提供错误示例、步骤遗漏统计。
- **前端/工作流集成**：新增流程模板、超参数表单。

### 阶段 3：多行为检测工作流（3-4 周）
- **标签规范**：统一 `violation_type` / 类别 ID。
- **数据集生成扩展**：支持多类别标注格式（YOLO txt、COCO JSON）。
- **训练**：多类别检测模型训练；若 GPU 资源紧张可按类别拆分。
- **评估**：类别级 PR、混淆矩阵、样本占比。
- **注册与部署**：同发网工作流。

### 阶段 4：统一运维与迭代（持续）
- **自动调度**：基于 Cron 触发周期性训练。
- **监控与告警**：训练失败告警、指标变动提醒。
- **清理策略**：结合 `mlops-monitoring-cleanup` 任务，定期清理历史数据集、模型。
- **持续改进**：引入模型对比、A/B 测试、在线性能监控。

## 5. 关键交付物

1. `ModelTrainingService` 深度学习实现（YOLO、时序模型）。
2. 工作流模板（发网、洗手、多行为）与前端配置界面。
3. 模型注册与管理 API/index（包含版本、指标、路径、状态）。
4. 训练日志与报告标准（JSON + 可视化）。
5. 文档：操作指南、监控策略、容灾与回滚方案。

## 6. 风险与依赖

| 风险 | 说明 | 应对策略 |
|------|------|----------|
| GPU 资源不足 | 深度学习训练依赖 GPU | 提前规划 GPU 节点；支持 CPU 训练 fallback（慢但可用） |
| 数据质量 | 自动采集数据可能误标 | 引入审核步骤、抽样检查、数据统计 |
| 训练耗时长 | 前端同步等待会超时 | 使用后台队列 + 状态轮询 |
| 模型效果达不到预期 | 数据不平衡或标注不准确 | 数据增强、类别抽样、持续评估 |
| 存储增长 | 快照/模型持续增多 | 实施清理策略、S3/OSS 外部存储 |

## 7. 后续行动

1. 组建专项小组（后端、前端、算法、运维）确定资源与时间表。
2. 以发网检测为试点，进入阶段 1 的开发与验证。
3. 完成阶段 1 后复盘，再推进洗手检测与多行为检测。
4. 定期更新本计划文档，记录里程碑与指标。

---

如需调整优先级或增加新的检测类型，可在以上框架下增添工作流模板与训练服务，实现快速扩展。***
