# å‰ç«¯æ„å»ºæµç¨‹åˆ†æ

## ğŸ“‹ æ„å»ºæµç¨‹æ¦‚è§ˆ

### 1. **Docker Compose é…ç½®ï¼ˆdocker-compose.prod.ymlï¼‰**

**å…³é”®å‘ç°**ï¼š
- âŒ `docker-compose.prod.yml` **ä¸æ„å»ºå‰ç«¯é•œåƒ**
- âœ… `frontend-init` æœåŠ¡åªä½¿ç”¨**å·²å­˜åœ¨çš„é•œåƒ**
- âœ… é•œåƒé€šè¿‡ `scripts/build_prod_only.sh` **é¢„å…ˆæ„å»º**

### 2. **å‰ç«¯æœåŠ¡é…ç½®**

```yaml
frontend-init:
  # ä½¿ç”¨å·²æ„å»ºçš„é•œåƒï¼ˆä¸æ„å»ºï¼‰
  image: ${IMAGE_REGISTRY:-}pepgmp-frontend:${IMAGE_TAG:-latest}
  # ä»é•œåƒä¸­æå–é™æ€æ–‡ä»¶åˆ° ./frontend/dist
  volumes:
    - ./frontend/dist:/target
  # æå–å®Œæˆåè‡ªåŠ¨é€€å‡º
  restart: "no"
```

**æµç¨‹**ï¼š
1. ä½¿ç”¨å·²å­˜åœ¨çš„ `pepgmp-frontend:${IMAGE_TAG:-latest}` é•œåƒ
2. ä»é•œåƒä¸­æå–é™æ€æ–‡ä»¶åˆ° `./frontend/dist`
3. è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
4. å®Œæˆåè‡ªåŠ¨é€€å‡º

### 3. **Dockerfile.frontend ä½¿ç”¨æ–¹å¼**

**Dockerfile.frontend ä¸æ˜¯ç›´æ¥åœ¨ docker-compose ä¸­ä½¿ç”¨**ï¼Œè€Œæ˜¯é€šè¿‡æ„å»ºè„šæœ¬ä½¿ç”¨ï¼š

```bash
# ä½¿ç”¨æ„å»ºè„šæœ¬
bash scripts/build_prod_only.sh [VERSION_TAG]

# è„šæœ¬å†…éƒ¨ä½¿ç”¨ Dockerfile.frontend
docker build -f Dockerfile.frontend \
  --build-arg VITE_API_BASE=/api/v1 \
  --build-arg BASE_URL=/ \
  --build-arg SKIP_TYPE_CHECK=true \
  -t pepgmp-frontend:${VERSION_TAG} \
  -t pepgmp-frontend:latest \
  .
```

---

## ğŸ” å¦‚ä½•éªŒè¯æ„å»ºæ˜¯å¦æ­£ç¡®

### æ–¹æ³• 1: æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨

```bash
# æ£€æŸ¥å‰ç«¯é•œåƒ
docker images | grep pepgmp-frontend

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# pepgmp-frontend   20251204   xxx   20 minutes ago   79.6MB
# pepgmp-frontend   latest     xxx   20 minutes ago   79.6MB
```

### æ–¹æ³• 2: æ£€æŸ¥é•œåƒå†…å®¹

```bash
# è¿è¡Œä¸´æ—¶å®¹å™¨æ£€æŸ¥é•œåƒå†…å®¹
docker run --rm pepgmp-frontend:latest ls -la /usr/share/nginx/html

# åº”è¯¥çœ‹åˆ°ï¼š
# index.html
# assets/
# 50x.html
```

### æ–¹æ³• 3: æµ‹è¯•æå–é™æ€æ–‡ä»¶

```bash
# æ‰‹åŠ¨è¿è¡Œ frontend-init å®¹å™¨
docker run --rm \
  -v $(pwd)/frontend/dist:/target \
  -e HOST_UID=$(id -u) \
  -e HOST_GID=$(id -g) \
  pepgmp-frontend:latest \
  sh -c "cp -r /usr/share/nginx/html/* /target/ && chown -R \${HOST_UID}:\${HOST_GID} /target && ls -la /target/ | head -10"
```

### æ–¹æ³• 4: æ£€æŸ¥æ„å»ºäº§ç‰©

```bash
# æ£€æŸ¥æœ¬åœ°æ„å»ºäº§ç‰©ï¼ˆå¦‚æœæœ¬åœ°æ„å»ºï¼‰
cd frontend
ls -la dist/
ls -la dist/assets/js/
ls -la dist/assets/css/

# æ£€æŸ¥ index.html
cat dist/index.html | grep -E "vendor|modulepreload"
```

---

## ğŸ› æœ¬åœ°æ„å»ºé—®é¢˜åˆ†æ

### é—®é¢˜ï¼šTypeScript ç±»å‹æ£€æŸ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Found 130 errors in 8 files.
```

**åŸå› **ï¼š
- `npm run build` åŒ…å« `vue-tsc --noEmit` ç±»å‹æ£€æŸ¥
- ç±»å‹é”™è¯¯ä¼šé˜»æ­¢æ„å»º

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### æ–¹æ¡ˆ 1: è·³è¿‡ç±»å‹æ£€æŸ¥ï¼ˆç”Ÿäº§æ„å»ºæ¨èï¼‰

```bash
cd frontend

# ç›´æ¥ä½¿ç”¨ vite buildï¼ˆè·³è¿‡ç±»å‹æ£€æŸ¥ï¼‰
npx vite build

# æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡
SKIP_TYPE_CHECK=true npx vite build
```

#### æ–¹æ¡ˆ 2: ä½¿ç”¨ Docker æ„å»ºï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨æ„å»ºè„šæœ¬ï¼ˆè‡ªåŠ¨è·³è¿‡ç±»å‹æ£€æŸ¥ï¼‰
cd /Users/zhou/Code/Pyt
bash scripts/build_prod_only.sh 20251204

# æˆ–ç›´æ¥ä½¿ç”¨ docker build
docker build -f Dockerfile.frontend \
  --build-arg VITE_API_BASE=/api/v1 \
  --build-arg BASE_URL=/ \
  --build-arg SKIP_TYPE_CHECK=true \
  -t pepgmp-frontend:20251204 \
  -t pepgmp-frontend:latest \
  .
```

#### æ–¹æ¡ˆ 3: ä¿®å¤ç±»å‹é”™è¯¯ï¼ˆå¼€å‘æ—¶æ¨èï¼‰

```bash
# ä¿®å¤æ‰€æœ‰ç±»å‹é”™è¯¯
cd frontend
npm run build

# æˆ–ä½¿ç”¨ IDE çš„è‡ªåŠ¨ä¿®å¤åŠŸèƒ½
```

---

## âœ… å®Œæ•´çš„æ„å»ºå’ŒéªŒè¯æµç¨‹

### æ­¥éª¤ 1: æ„å»ºå‰ç«¯é•œåƒ

```bash
cd /Users/zhou/Code/Pyt

# ä½¿ç”¨æ„å»ºè„šæœ¬ï¼ˆæ¨èï¼‰
bash scripts/build_prod_only.sh 20251204

# æˆ–æ‰‹åŠ¨æ„å»º
export DOCKER_BUILDKIT=1
docker build -f Dockerfile.frontend \
  --build-arg VITE_API_BASE=/api/v1 \
  --build-arg BASE_URL=/ \
  --build-arg SKIP_TYPE_CHECK=true \
  -t pepgmp-frontend:20251204 \
  -t pepgmp-frontend:latest \
  .
```

### æ­¥éª¤ 2: éªŒè¯é•œåƒ

```bash
# æ£€æŸ¥é•œåƒ
docker images | grep pepgmp-frontend

# æ£€æŸ¥é•œåƒå†…å®¹
docker run --rm pepgmp-frontend:latest ls -la /usr/share/nginx/html

# æ£€æŸ¥æ„å»ºäº§ç‰©å¤§å°
docker images pepgmp-frontend:latest --format "{{.Size}}"
```

### æ­¥éª¤ 3: æµ‹è¯•æå–é™æ€æ–‡ä»¶

```bash
# æ¸…ç†æ—§çš„ dist ç›®å½•
rm -rf frontend/dist

# æ‰‹åŠ¨æå–é™æ€æ–‡ä»¶
docker run --rm \
  -v $(pwd)/frontend/dist:/target \
  -e HOST_UID=$(id -u) \
  -e HOST_GID=$(id -g) \
  pepgmp-frontend:latest \
  sh -c "cp -r /usr/share/nginx/html/* /target/ && chown -R \${HOST_UID}:\${HOST_GID} /target"

# æ£€æŸ¥æå–çš„æ–‡ä»¶
ls -la frontend/dist/
cat frontend/dist/index.html | head -20
```

### æ­¥éª¤ 4: ä½¿ç”¨ Docker Compose å¯åŠ¨

```bash
# ç¡®ä¿ .env.production ä¸­è®¾ç½®äº†æ­£ç¡®çš„é•œåƒç‰ˆæœ¬
echo "IMAGE_TAG=20251204" >> .env.production

# å¯åŠ¨æœåŠ¡
docker compose -f docker-compose.prod.yml --env-file .env.production up -d

# æ£€æŸ¥ frontend-init å®¹å™¨æ—¥å¿—
docker logs pepgmp-frontend-init

# æ£€æŸ¥ nginx å®¹å™¨
docker logs pepgmp-nginx-prod | tail -20
```

### æ­¥éª¤ 5: éªŒè¯å‰ç«¯è®¿é—®

```bash
# æµ‹è¯•å‰ç«¯è®¿é—®
curl -I http://localhost/

# åº”è¯¥è¿”å› 200 OK
# æ£€æŸ¥å“åº”å¤´
curl -v http://localhost/ 2>&1 | grep -E "HTTP|Content-Type"
```

---

## ğŸ”§ æœ¬åœ°å¼€å‘æµ‹è¯•ï¼ˆè·³è¿‡ç±»å‹æ£€æŸ¥ï¼‰

### å¿«é€Ÿæµ‹è¯•æ„å»º

```bash
cd frontend

# æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
rm -rf dist

# ä½¿ç”¨ vite buildï¼ˆè·³è¿‡ç±»å‹æ£€æŸ¥ï¼‰
npx vite build

# æ£€æŸ¥æ„å»ºäº§ç‰©
ls -la dist/
ls -la dist/assets/js/ | head -10

# æœ¬åœ°é¢„è§ˆ
npx vite preview --port 4173
```

### æ£€æŸ¥æ„å»ºäº§ç‰©

```bash
# æ£€æŸ¥ç”Ÿæˆçš„ JS æ–‡ä»¶
find frontend/dist/assets/js -name "*.js" -type f | head -10

# æ£€æŸ¥æ–‡ä»¶å¤§å°
find frontend/dist/assets/js -name "*.js" -type f -exec ls -lh {} \; | awk '{print $9, $5}'

# æ£€æŸ¥ index.html
cat frontend/dist/index.html | grep -E "vendor|modulepreload" | head -5
```

---

## ğŸ“ æ€»ç»“

### å…³é”®ç‚¹

1. **docker-compose.prod.yml ä¸æ„å»ºå‰ç«¯é•œåƒ**
   - åªä½¿ç”¨å·²å­˜åœ¨çš„é•œåƒ
   - é€šè¿‡ `frontend-init` å®¹å™¨æå–é™æ€æ–‡ä»¶

2. **Dockerfile.frontend é€šè¿‡æ„å»ºè„šæœ¬ä½¿ç”¨**
   - `scripts/build_prod_only.sh` ä½¿ç”¨ `Dockerfile.frontend`
   - æ„å»ºæ—¶è‡ªåŠ¨è·³è¿‡ç±»å‹æ£€æŸ¥ï¼ˆ`SKIP_TYPE_CHECK=true`ï¼‰

3. **æœ¬åœ°æ„å»ºé—®é¢˜**
   - `npm run build` åŒ…å«ç±»å‹æ£€æŸ¥ï¼Œä¼šå¤±è´¥
   - ä½¿ç”¨ `npx vite build` è·³è¿‡ç±»å‹æ£€æŸ¥
   - æˆ–ä½¿ç”¨ Docker æ„å»ºï¼ˆæ¨èï¼‰

### æ¨èå·¥ä½œæµ

1. **å¼€å‘æ—¶**ï¼šä½¿ç”¨ `npm run dev` æˆ–ä¿®å¤ç±»å‹é”™è¯¯
2. **ç”Ÿäº§æ„å»º**ï¼šä½¿ç”¨ `bash scripts/build_prod_only.sh` æˆ– Docker æ„å»º
3. **éªŒè¯**ï¼šæ£€æŸ¥é•œåƒã€æå–é™æ€æ–‡ä»¶ã€æµ‹è¯•è®¿é—®

---

**æœ€åæ›´æ–°**: 2025-12-04
