# è§£å‹éƒ¨ç½²ç›®å½•å†²çªè§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

å½“ç›®æ ‡ç›®å½•å·²å­˜åœ¨åŒåç›®å½•æ—¶ï¼Œ`mv` å‘½ä»¤ä¼šå¤±è´¥ï¼š
```
mv: cannot move 'PEPGMP-20251212/config' to '/home/ubuntu/projects/PEPGMP/config': Directory not empty
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä½¿ç”¨ cp å¤åˆ¶å¹¶è¦†ç›–ï¼ˆæ¨èï¼‰

```bash
VERSION_TAG=20251212
DEPLOY_DIR=~/projects/PEPGMP

# è§£å‹åˆ°ä¸´æ—¶ç›®å½•
cd /tmp
tar -xzf PEPGMP-${VERSION_TAG}.tar.gz

# ä½¿ç”¨ cp -r å¤åˆ¶å¹¶è¦†ç›–ï¼ˆä¿ç•™å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œè¦†ç›–åŒåæ–‡ä»¶ï¼‰
cp -r PEPGMP-${VERSION_TAG}/* $DEPLOY_DIR/

# æ¸…ç†ä¸´æ—¶ç›®å½•
rm -rf PEPGMP-${VERSION_TAG}
```

**ä¼˜ç‚¹**:
- âœ… ä¿ç•™ç›®æ ‡ç›®å½•ä¸­å·²å­˜åœ¨çš„æ–‡ä»¶
- âœ… è¦†ç›–åŒåæ–‡ä»¶
- âœ… ä¸ä¼šä¸¢å¤±æ•°æ®

---

### æ–¹æ¡ˆ 2: ä½¿ç”¨ rsync åˆå¹¶ï¼ˆæ¨èç”¨äºå¢é‡æ›´æ–°ï¼‰

```bash
VERSION_TAG=20251212
DEPLOY_DIR=~/projects/PEPGMP

# è§£å‹åˆ°ä¸´æ—¶ç›®å½•
cd /tmp
tar -xzf PEPGMP-${VERSION_TAG}.tar.gz

# ä½¿ç”¨ rsync åˆå¹¶ï¼ˆæ›´æ–°å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œæ·»åŠ æ–°æ–‡ä»¶ï¼‰
rsync -av PEPGMP-${VERSION_TAG}/ $DEPLOY_DIR/

# æ¸…ç†ä¸´æ—¶ç›®å½•
rm -rf PEPGMP-${VERSION_TAG}
```

**ä¼˜ç‚¹**:
- âœ… æ™ºèƒ½åˆå¹¶ï¼Œåªæ›´æ–°å˜æ›´çš„æ–‡ä»¶
- âœ… ä¿ç•™ç›®æ ‡ç›®å½•ä¸­çš„é¢å¤–æ–‡ä»¶
- âœ… æ˜¾ç¤ºä¼ è¾“è¿›åº¦

---

### æ–¹æ¡ˆ 3: å…ˆå¤‡ä»½å†æ›¿æ¢ï¼ˆå®‰å…¨ä½†ä¼šåˆ é™¤æ—§æ–‡ä»¶ï¼‰

```bash
VERSION_TAG=20251212
DEPLOY_DIR=~/projects/PEPGMP

# å¤‡ä»½ç°æœ‰ç›®å½•
if [ -d "$DEPLOY_DIR" ]; then
    BACKUP_DIR="${DEPLOY_DIR}.backup.$(date +%Y%m%d_%H%M%S)"
    echo "å¤‡ä»½ç°æœ‰ç›®å½•åˆ°: $BACKUP_DIR"
    mv $DEPLOY_DIR $BACKUP_DIR
fi

# åˆ›å»ºæ–°ç›®å½•
mkdir -p $DEPLOY_DIR

# è§£å‹å¹¶ç§»åŠ¨
cd /tmp
tar -xzf PEPGMP-${VERSION_TAG}.tar.gz
mv PEPGMP-${VERSION_TAG}/* $DEPLOY_DIR/
rmdir PEPGMP-${VERSION_TAG}
```

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨æ›¿æ¢ï¼Œç¡®ä¿å¹²å‡€
- âœ… æœ‰å¤‡ä»½ï¼Œå¯ä»¥æ¢å¤

**ç¼ºç‚¹**:
- âš ï¸ ä¼šåˆ é™¤ç›®æ ‡ç›®å½•ä¸­çš„é¢å¤–æ–‡ä»¶

---

### æ–¹æ¡ˆ 4: é€ä¸ªç›®å½•å¤„ç†ï¼ˆç²¾ç»†æ§åˆ¶ï¼‰

```bash
VERSION_TAG=20251212
DEPLOY_DIR=~/projects/PEPGMP

# è§£å‹åˆ°ä¸´æ—¶ç›®å½•
cd /tmp
tar -xzf PEPGMP-${VERSION_TAG}.tar.gz

# é€ä¸ªå¤„ç†ç›®å½•å’Œæ–‡ä»¶
cd PEPGMP-${VERSION_TAG}

# å¤„ç†æ–‡ä»¶ï¼ˆéç›®å½•ï¼‰
find . -maxdepth 1 -type f -exec cp {} $DEPLOY_DIR/ \;

# å¤„ç†ç›®å½•ï¼ˆé€ä¸ªå¤åˆ¶ï¼‰
for dir in */; do
    dirname=$(basename "$dir")
    if [ -d "$DEPLOY_DIR/$dirname" ]; then
        echo "ç›®å½• $dirname å·²å­˜åœ¨ï¼Œåˆå¹¶å†…å®¹..."
        cp -r "$dir"* "$DEPLOY_DIR/$dirname/"
    else
        echo "å¤åˆ¶æ–°ç›®å½• $dirname..."
        cp -r "$dir" "$DEPLOY_DIR/"
    fi
done

# æ¸…ç†ä¸´æ—¶ç›®å½•
cd /tmp
rm -rf PEPGMP-${VERSION_TAG}
```

---

## ğŸš€ æ¨èæ“ä½œæ­¥éª¤

### å¿«é€Ÿè§£å†³ï¼ˆä½¿ç”¨æ–¹æ¡ˆ 1ï¼‰

```bash
# åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
VERSION_TAG=20251212
DEPLOY_DIR=~/projects/PEPGMP

cd /tmp
tar -xzf PEPGMP-${VERSION_TAG}.tar.gz
cp -r PEPGMP-${VERSION_TAG}/* $DEPLOY_DIR/
rm -rf PEPGMP-${VERSION_TAG}

# éªŒè¯
cd $DEPLOY_DIR
ls -la
```

### å¢é‡æ›´æ–°ï¼ˆä½¿ç”¨æ–¹æ¡ˆ 2ï¼‰

```bash
# åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
VERSION_TAG=20251212
DEPLOY_DIR=~/projects/PEPGMP

cd /tmp
tar -xzf PEPGMP-${VERSION_TAG}.tar.gz
rsync -av PEPGMP-${VERSION_TAG}/ $DEPLOY_DIR/
rm -rf PEPGMP-${VERSION_TAG}

# éªŒè¯
cd $DEPLOY_DIR
ls -la
```

---

## ğŸ” éªŒè¯æ­¥éª¤

```bash
# æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
cd ~/projects/PEPGMP

# æ£€æŸ¥é…ç½®æ–‡ä»¶
ls -la docker-compose*.yml
ls -la .env.production

# æ£€æŸ¥ç›®å½•ç»“æ„
ls -la config/
ls -la scripts/
ls -la models/ 2>/dev/null || echo "models ç›®å½•ä¸å­˜åœ¨ï¼ˆå¯é€‰ï¼‰"
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½é‡è¦æ•°æ®**: å¦‚æœç›®æ ‡ç›®å½•ä¸­æœ‰é‡è¦é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `.env.production`ï¼‰ï¼Œå»ºè®®å…ˆå¤‡ä»½
2. **æ£€æŸ¥æ–‡ä»¶æƒé™**: å¤åˆ¶åæ£€æŸ¥æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®
3. **éªŒè¯é…ç½®**: æ›´æ–°åéªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®

---

## ğŸ“ å®Œæ•´æ“ä½œç¤ºä¾‹

```bash
# 1. SSH åˆ°æœåŠ¡å™¨
ssh ubuntu@192.168.31.131

# 2. è®¾ç½®å˜é‡
VERSION_TAG=20251212
DEPLOY_DIR=~/projects/PEPGMP

# 3. å¤‡ä»½é‡è¦é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
if [ -f "$DEPLOY_DIR/.env.production" ]; then
    cp $DEPLOY_DIR/.env.production $DEPLOY_DIR/.env.production.backup
    echo "å·²å¤‡ä»½ .env.production"
fi

# 4. è§£å‹å¹¶åˆå¹¶
cd /tmp
tar -xzf PEPGMP-${VERSION_TAG}.tar.gz

# ä½¿ç”¨ rsync åˆå¹¶ï¼ˆæ¨èï¼‰
rsync -av PEPGMP-${VERSION_TAG}/ $DEPLOY_DIR/

# æˆ–ä½¿ç”¨ cp è¦†ç›–
# cp -r PEPGMP-${VERSION_TAG}/* $DEPLOY_DIR/

# 5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf PEPGMP-${VERSION_TAG}

# 6. è¿›å…¥éƒ¨ç½²ç›®å½•
cd $DEPLOY_DIR

# 7. æ¢å¤é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
if [ -f .env.production.backup ]; then
    mv .env.production.backup .env.production
    echo "å·²æ¢å¤ .env.production"
fi

# 8. æ›´æ–°é•œåƒæ ‡ç­¾
sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=$VERSION_TAG/" .env.production 2>/dev/null || \
    echo "IMAGE_TAG=$VERSION_TAG" >> .env.production

# 9. å¯åŠ¨æœåŠ¡
docker compose -f docker-compose.prod.yml --env-file .env.production up -d

# 10. æŸ¥çœ‹çŠ¶æ€
docker compose -f docker-compose.prod.yml --env-file .env.production ps
```
