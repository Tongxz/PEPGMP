# éƒ¨ç½²åŒ…è§£å‹åæ“ä½œæ­¥éª¤

## ğŸ“‹ å‰ææ¡ä»¶

âœ… éƒ¨ç½²åŒ…å·²è§£å‹åˆ°ç›®æ ‡ç›®å½•ï¼ˆå¦‚ `~/projects/PEPGMP`ï¼‰
âœ… é•œåƒæ–‡ä»¶å·²ä¼ è¾“åˆ° `/tmp/`ï¼ˆå¦‚ `/tmp/pepgmp-backend-20251212.tar`ï¼‰

---

## ğŸš€ å®Œæ•´æ“ä½œæ­¥éª¤

### æ­¥éª¤ 1: è¿›å…¥éƒ¨ç½²ç›®å½•

```bash
DEPLOY_DIR=~/projects/PEPGMP  # æ ¹æ®å®é™…è·¯å¾„ä¿®æ”¹
cd $DEPLOY_DIR

# éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la
# åº”è¯¥çœ‹åˆ°ï¼šdocker-compose.prod.ymlã€config/ã€scripts/ ç­‰
```

---

### æ­¥éª¤ 2: å¯¼å…¥ Docker é•œåƒï¼ˆå¦‚æœè¿˜æ²¡å¯¼å…¥ï¼‰

```bash
VERSION_TAG=20251212  # æ›¿æ¢ä¸ºå®é™…ç‰ˆæœ¬å·

# å¯¼å…¥åç«¯é•œåƒ
docker load -i /tmp/pepgmp-backend-${VERSION_TAG}.tar

# å¯¼å…¥å‰ç«¯é•œåƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
docker load -i /tmp/pepgmp-frontend-${VERSION_TAG}.tar 2>/dev/null || echo "å‰ç«¯é•œåƒä¸å­˜åœ¨ï¼Œè·³è¿‡"

# éªŒè¯é•œåƒ
docker images | grep pepgmp
# åº”è¯¥çœ‹åˆ°ï¼š
# pepgmp-backend:20251212
# pepgmp-frontend:20251212ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
```

---

### æ­¥éª¤ 3: ç”Ÿæˆç”Ÿäº§é…ç½®æ–‡ä»¶

```bash
cd $DEPLOY_DIR

# æ–¹å¼ 1: ä½¿ç”¨é…ç½®ç”Ÿæˆè„šæœ¬ï¼ˆæ¨èï¼‰
if [ -f scripts/generate_production_config.sh ]; then
    bash scripts/generate_production_config.sh
else
    echo "é…ç½®æ–‡ä»¶ç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨"
fi
```

**å¦‚æœè„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨åˆ›å»º `.env.production`ï¼š**

```bash
cat > .env.production << 'EOF'
ENVIRONMENT=production
API_PORT=8000

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://pepgmp_prod:your_password@pepgmp-postgres-prod:5432/pepgmp_production
POSTGRES_DB=pepgmp_production
POSTGRES_USER=pepgmp_prod
POSTGRES_PASSWORD=your_secure_password

# Redis é…ç½®
REDIS_URL=redis://:your_redis_password@pepgmp-redis-prod:6379/0
REDIS_PASSWORD=your_redis_password

# é•œåƒç‰ˆæœ¬
IMAGE_TAG=20251212

# å…¶ä»–é…ç½®...
EOF

# è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 .env.production
```

---

### æ­¥éª¤ 4: æ›´æ–°é•œåƒæ ‡ç­¾

```bash
cd $DEPLOY_DIR
VERSION_TAG=20251212  # æ›¿æ¢ä¸ºå®é™…ç‰ˆæœ¬å·

# æ›´æ–°æˆ–æ·»åŠ  IMAGE_TAG
if grep -q "IMAGE_TAG=" .env.production; then
    sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=$VERSION_TAG/" .env.production
    echo "âœ“ å·²æ›´æ–° IMAGE_TAG ä¸º $VERSION_TAG"
else
    echo "IMAGE_TAG=$VERSION_TAG" >> .env.production
    echo "âœ“ å·²æ·»åŠ  IMAGE_TAG=$VERSION_TAG"
fi

# éªŒè¯
grep "IMAGE_TAG=" .env.production
```

---

### æ­¥éª¤ 5: æ£€æŸ¥ Docker Compose æ–‡ä»¶

```bash
cd $DEPLOY_DIR

# æ£€æŸ¥ docker-compose æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la docker-compose*.yml

# å¯èƒ½æ˜¯ä»¥ä¸‹æ–‡ä»¶åä¹‹ä¸€ï¼š
# - docker-compose.prod.ymlï¼ˆæ¨èï¼‰
# - docker-compose.yml
# - docker-compose.prod.1panel.yml
```

---

### æ­¥éª¤ 6: æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼ˆå¯é€‰ï¼‰

```bash
# æ£€æŸ¥å¸¸ç”¨ç«¯å£
sudo netstat -tulpn | grep -E ":(80|8000|5432|6379)" || echo "ç«¯å£æœªè¢«å ç”¨"

# æˆ–ä½¿ç”¨ ss
ss -tulpn | grep -E ":(80|8000|5432|6379)" || echo "ç«¯å£æœªè¢«å ç”¨"
```

---

### æ­¥éª¤ 7: å¯åŠ¨æœåŠ¡

```bash
cd $DEPLOY_DIR

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose -f docker-compose.prod.yml --env-file .env.production up -d

# æˆ–è€…å¦‚æœæ–‡ä»¶åä¸º docker-compose.yml
# docker compose -f docker-compose.yml --env-file .env.production up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆçº¦ 30-60 ç§’ï¼‰..."
sleep 30
```

---

### æ­¥éª¤ 8: æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
cd $DEPLOY_DIR

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker compose -f docker-compose.prod.yml --env-file .env.production ps

# åº”è¯¥çœ‹åˆ°æ‰€æœ‰æœåŠ¡éƒ½æ˜¯ "Up" çŠ¶æ€
```

---

### æ­¥éª¤ 9: æŸ¥çœ‹æ—¥å¿—ï¼ˆå¦‚æœ‰é—®é¢˜ï¼‰

```bash
cd $DEPLOY_DIR

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker compose -f docker-compose.prod.yml --env-file .env.production logs

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker compose -f docker-compose.prod.yml --env-file .env.production logs -f api

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker compose -f docker-compose.prod.yml --env-file .env.production logs -f database
```

---

### æ­¥éª¤ 10: éªŒè¯æœåŠ¡

```bash
# ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–ï¼ˆé¦–æ¬¡éƒ¨ç½²éœ€è¦ 60-70 ç§’ï¼‰
echo "ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–..."
sleep 60

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/v1/monitoring/health

# æˆ–æµ‹è¯•å‰ç«¯
curl http://localhost/

# æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯
curl http://localhost:8000/api/v1/system/info
```

---

### æ­¥éª¤ 11: æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

```bash
# æ¸…ç†ä¼ è¾“çš„é•œåƒæ–‡ä»¶
rm -f /tmp/pepgmp-*.tar
rm -f /tmp/PEPGMP-*.tar.gz

echo "âœ“ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
```

---

## ğŸ”§ ä¸€é”®æ‰§è¡Œè„šæœ¬

å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸ºè„šæœ¬ï¼Œä¸€é”®æ‰§è¡Œï¼š

```bash
#!/bin/bash
set -e

VERSION_TAG=20251212  # æ›¿æ¢ä¸ºå®é™…ç‰ˆæœ¬å·
DEPLOY_DIR=~/projects/PEPGMP  # æ›¿æ¢ä¸ºå®é™…éƒ¨ç½²ç›®å½•

echo "========================================================================="
echo "éƒ¨ç½²åé…ç½®å’Œå¯åŠ¨"
echo "========================================================================="
echo ""

# è¿›å…¥éƒ¨ç½²ç›®å½•
cd $DEPLOY_DIR

# 1. å¯¼å…¥é•œåƒ
echo "[1/6] å¯¼å…¥ Docker é•œåƒ..."
docker load -i /tmp/pepgmp-backend-${VERSION_TAG}.tar 2>/dev/null || echo "åç«¯é•œåƒå¯èƒ½å·²å¯¼å…¥"
docker load -i /tmp/pepgmp-frontend-${VERSION_TAG}.tar 2>/dev/null || echo "å‰ç«¯é•œåƒå¯èƒ½å·²å¯¼å…¥æˆ–ä¸å­˜åœ¨"
echo "âœ“ é•œåƒå¯¼å…¥å®Œæˆ"
echo ""

# 2. ç”Ÿæˆé…ç½®
echo "[2/6] ç”Ÿæˆç”Ÿäº§é…ç½®..."
if [ ! -f .env.production ]; then
    if [ -f scripts/generate_production_config.sh ]; then
        bash scripts/generate_production_config.sh
    else
        echo "âš ï¸  è¯·æ‰‹åŠ¨åˆ›å»º .env.production æ–‡ä»¶"
        exit 1
    fi
else
    echo "âœ“ é…ç½®æ–‡ä»¶å·²å­˜åœ¨"
fi
echo ""

# 3. æ›´æ–°é•œåƒæ ‡ç­¾
echo "[3/6] æ›´æ–°é•œåƒæ ‡ç­¾..."
if grep -q "IMAGE_TAG=" .env.production; then
    sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=$VERSION_TAG/" .env.production
else
    echo "IMAGE_TAG=$VERSION_TAG" >> .env.production
fi
echo "âœ“ IMAGE_TAG å·²æ›´æ–°ä¸º $VERSION_TAG"
echo ""

# 4. æ£€æŸ¥ Docker Compose æ–‡ä»¶
echo "[4/6] æ£€æŸ¥ Docker Compose æ–‡ä»¶..."
COMPOSE_FILE=""
if [ -f "docker-compose.prod.yml" ]; then
    COMPOSE_FILE="docker-compose.prod.yml"
elif [ -f "docker-compose.yml" ]; then
    COMPOSE_FILE="docker-compose.yml"
elif [ -f "docker-compose.prod.1panel.yml" ]; then
    COMPOSE_FILE="docker-compose.prod.1panel.yml"
else
    echo "âŒ æœªæ‰¾åˆ° docker-compose æ–‡ä»¶"
    exit 1
fi
echo "âœ“ ä½¿ç”¨é…ç½®æ–‡ä»¶: $COMPOSE_FILE"
echo ""

# 5. å¯åŠ¨æœåŠ¡
echo "[5/6] å¯åŠ¨æœåŠ¡..."
docker compose -f $COMPOSE_FILE --env-file .env.production up -d
echo "âœ“ æœåŠ¡å·²å¯åŠ¨"
echo ""

# 6. ç­‰å¾…å¹¶æ£€æŸ¥çŠ¶æ€
echo "[6/6] ç­‰å¾…æœåŠ¡å°±ç»ª..."
sleep 30
docker compose -f $COMPOSE_FILE --env-file .env.production ps
echo ""

echo "========================================================================="
echo "éƒ¨ç½²å®Œæˆï¼"
echo "========================================================================="
echo ""
echo "è®¿é—®åœ°å€:"
echo "  å‰ç«¯: http://localhost/"
echo "  API:  http://localhost:8000/api/v1/monitoring/health"
echo ""
echo "å¸¸ç”¨å‘½ä»¤:"
echo "  æŸ¥çœ‹æ—¥å¿—: docker compose -f $COMPOSE_FILE --env-file .env.production logs -f"
echo "  åœæ­¢æœåŠ¡: docker compose -f $COMPOSE_FILE --env-file .env.production down"
echo "  é‡å¯æœåŠ¡: docker compose -f $COMPOSE_FILE --env-file .env.production restart"
```

---

## ğŸ“ å¿«é€Ÿå‚è€ƒå‘½ä»¤

```bash
# è®¾ç½®å˜é‡
VERSION_TAG=20251212
DEPLOY_DIR=~/projects/PEPGMP

# å¯¼å…¥é•œåƒ
docker load -i /tmp/pepgmp-backend-${VERSION_TAG}.tar

# è¿›å…¥ç›®å½•å¹¶ç”Ÿæˆé…ç½®
cd $DEPLOY_DIR
[ -f scripts/generate_production_config.sh ] && bash scripts/generate_production_config.sh

# æ›´æ–°é•œåƒæ ‡ç­¾
sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=$VERSION_TAG/" .env.production 2>/dev/null || echo "IMAGE_TAG=$VERSION_TAG" >> .env.production

# å¯åŠ¨æœåŠ¡
docker compose -f docker-compose.prod.yml --env-file .env.production up -d

# æŸ¥çœ‹çŠ¶æ€
sleep 30
docker compose -f docker-compose.prod.yml --env-file .env.production ps

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/v1/monitoring/health
```

---

## âœ… éªŒè¯æ¸…å•

- [ ] é•œåƒå·²å¯¼å…¥æˆåŠŸ
- [ ] é…ç½®æ–‡ä»¶å·²ç”Ÿæˆï¼ˆ.env.productionï¼‰
- [ ] é•œåƒæ ‡ç­¾å·²æ›´æ–°
- [ ] Docker Compose æ–‡ä»¶å­˜åœ¨
- [ ] æœåŠ¡å·²å¯åŠ¨
- [ ] å®¹å™¨çŠ¶æ€æ­£å¸¸
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] å¯ä»¥è®¿é—®å‰ç«¯å’Œ API

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¦‚æœæœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
cd $DEPLOY_DIR
docker compose -f docker-compose.prod.yml --env-file .env.production logs

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat .env.production

# æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
docker images | grep pepgmp
```

### å¦‚æœæ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®åº“å®¹å™¨æ˜¯å¦è¿è¡Œ
docker ps | grep postgres

# æ£€æŸ¥æ•°æ®åº“æ—¥å¿—
docker compose -f docker-compose.prod.yml --env-file .env.production logs database
```

### å¦‚æœç«¯å£è¢«å ç”¨

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tulpn | grep -E ":(80|8000)"
```
