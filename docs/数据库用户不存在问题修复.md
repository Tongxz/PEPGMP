# æ•°æ®åº“ç”¨æˆ·ä¸å­˜åœ¨é—®é¢˜ä¿®å¤

## ğŸ“‹ é—®é¢˜ç°è±¡

```bash
docker exec -it pepgmp-postgres-prod psql -U postgres
# é”™è¯¯ï¼šrole "postgres" does not exist

docker exec -it pepgmp-postgres-prod psql -U pepgmp_prod -d pepgmp_production
# é”™è¯¯ï¼šrole "pepgmp_prod" does not exist
```

---

## ğŸ” æ ¹æœ¬åŸå› 

1. **æ•°æ®åº“å·²ç”¨æ—§é…ç½®åˆå§‹åŒ–**
   - æ•°æ®åº“åœ¨ 2024å¹´10æœˆ20æ—¥ åˆå§‹åŒ–
   - å½“æ—¶ä½¿ç”¨çš„ç”¨æˆ·é…ç½®ä¸ç°åœ¨ä¸åŒ
   - PostgreSQL ä¸ä¼šé‡æ–°åˆå§‹åŒ–å·²å­˜åœ¨çš„æ•°æ®åº“

2. **å½“å‰é…ç½®ä¸åŒ¹é…**
   - `docker-compose.prod.yml` é…ç½®çš„ç”¨æˆ·ï¼š`pepgmp_prod`
   - æ•°æ®åº“ä¸­çš„å®é™…ç”¨æˆ·ï¼šæœªçŸ¥ï¼ˆå¯èƒ½æ˜¯å…¶ä»–ç”¨æˆ·åï¼‰

3. **PostgreSQL åˆå§‹åŒ–æœºåˆ¶**
   - å¦‚æœæ•°æ®ç›®å½•å·²å­˜åœ¨ï¼Œä¼šè·³è¿‡åˆå§‹åŒ–
   - ç¯å¢ƒå˜é‡æ”¹å˜ä¸ä¼šå½±å“å·²åˆå§‹åŒ–çš„æ•°æ®åº“

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šåˆ é™¤ Volume é‡æ–°åˆå§‹åŒ–ï¼ˆæ¨èç”¨äºå¼€å‘/æµ‹è¯•ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å¼€å‘/æµ‹è¯•ç¯å¢ƒ
- å¯ä»¥æ¥å—æ•°æ®ä¸¢å¤±
- éœ€è¦å¿«é€Ÿæ¢å¤

**æ­¥éª¤**ï¼š

```bash
# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
cd /Users/zhou/projects/Pyt
docker compose -f docker-compose.prod.yml down

# 2. åˆ é™¤æ•°æ®åº“ volume
docker volume rm pyt_postgres_prod_data

# 3. ç¡®è®¤ volume å·²åˆ é™¤
docker volume ls | grep postgres

# 4. é‡æ–°å¯åŠ¨æœåŠ¡ï¼ˆä¼šè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“ï¼‰
docker compose -f docker-compose.prod.yml up -d

# 5. ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼ˆçº¦ 10-30 ç§’ï¼‰
docker compose -f docker-compose.prod.yml logs -f database

# 6. éªŒè¯æ•°æ®åº“è¿æ¥
docker exec -e PGPASSWORD='gvbW0-Abbtmb9Iu5f-KaHjuKsH43Kkz73NsuSi9MxE4' \
  pepgmp-api-prod psql -h database -U pepgmp_prod -d pepgmp_production -c "SELECT 1;"
```

**é¢„æœŸç»“æœ**ï¼š
- æ•°æ®åº“ä½¿ç”¨æ–°é…ç½®åˆå§‹åŒ–
- ç”¨æˆ· `pepgmp_prod` è¢«åˆ›å»º
- å¯†ç åŒ¹é… `.env.production` ä¸­çš„é…ç½®

---

### æ–¹æ¡ˆ 2ï¼šä¿ç•™æ•°æ®ï¼Œæ‰‹åŠ¨ä¿®å¤ï¼ˆé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- ç”Ÿäº§ç¯å¢ƒ
- æœ‰é‡è¦æ•°æ®éœ€è¦ä¿ç•™
- éœ€è¦å…ˆå¤‡ä»½æ•°æ®

**æ­¥éª¤**ï¼š

#### 2.1 å¤‡ä»½æ•°æ®

```bash
# åœæ­¢ API æœåŠ¡ï¼ˆé¿å…å†™å…¥ï¼‰
docker compose -f docker-compose.prod.yml stop api

# å¤‡ä»½æ•°æ®åº“ volume
docker run --rm \
  -v pyt_postgres_prod_data:/data \
  -v $(pwd)/backups:/backup \
  alpine tar czf /backup/postgres_backup_$(date +%Y%m%d_%H%M%S).tar.gz /data
```

#### 2.2 å°è¯•æ‰¾åˆ°æ•°æ®åº“ä¸­çš„å®é™…ç”¨æˆ·

ç”±äºæ— æ³•ç›´æ¥è¿æ¥ï¼Œéœ€è¦ï¼š

1. **æ£€æŸ¥æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬**
   ```bash
   cat scripts/init_db.sql
   ```

2. **æ£€æŸ¥å†å²é…ç½®**
   ```bash
   git log --all --oneline -- scripts/init_db.sql
   git log --all --oneline -- docker-compose.prod.yml
   ```

#### 2.3 åˆ›å»ºæ–°ç”¨æˆ·æˆ–ä¿®æ”¹é…ç½®

å¦‚æœèƒ½æ‰¾åˆ°æ—§ç”¨æˆ·åï¼Œå¯ä»¥ï¼š

```bash
# ä½¿ç”¨æ—§ç”¨æˆ·åè¿æ¥ï¼ˆå‡è®¾æ˜¯ old_userï¼‰
docker exec -it pepgmp-postgres-prod psql -U old_user -d postgres

# åœ¨ psql ä¸­åˆ›å»ºæ–°ç”¨æˆ·
CREATE USER pepgmp_prod WITH PASSWORD 'gvbW0-Abbtmb9Iu5f-KaHjuKsH43Kkz73NsuSi9MxE4';
ALTER USER pepgmp_prod CREATEDB;
GRANT ALL PRIVILEGES ON DATABASE pepgmp_production TO pepgmp_prod;
```

---

### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ PostgreSQL å•ç”¨æˆ·æ¨¡å¼ï¼ˆé«˜çº§ï¼‰

å¦‚æœæ— æ³•æ‰¾åˆ°æ—§ç”¨æˆ·åï¼Œå¯ä»¥ï¼š

1. **åœæ­¢æ•°æ®åº“å®¹å™¨**
   ```bash
   docker compose -f docker-compose.prod.yml stop database
   ```

2. **ä½¿ç”¨å•ç”¨æˆ·æ¨¡å¼å¯åŠ¨**
   ```bash
   docker run --rm -it \
     -v pyt_postgres_prod_data:/var/lib/postgresql/data \
     postgres:16-alpine \
     postgres --single -D /var/lib/postgresql/data
   ```

3. **åœ¨å•ç”¨æˆ·æ¨¡å¼ä¸‹åˆ›å»ºç”¨æˆ·**
   ```sql
   CREATE USER pepgmp_prod WITH PASSWORD 'gvbW0-Abbtmb9Iu5f-KaHjuKsH43Kkz73NsuSi9MxE4';
   ALTER USER pepgmp_prod CREATEDB;
   ```

**æ³¨æ„**ï¼šå•ç”¨æˆ·æ¨¡å¼éœ€è¦æ·±å…¥äº†è§£ PostgreSQLï¼Œä¸æ¨èæ–°æ‰‹ä½¿ç”¨ã€‚

---

## ğŸ”§ éªŒè¯æ­¥éª¤

ä¿®å¤åï¼ŒéªŒè¯ï¼š

```bash
# 1. æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·
docker exec -e PGPASSWORD='gvbW0-Abbtmb9Iu5f-KaHjuKsH43Kkz73NsuSi9MxE4' \
  pepgmp-postgres-prod psql -U pepgmp_prod -d pepgmp_production -c "\du"

# 2. æµ‹è¯• API è¿æ¥
docker exec -e PGPASSWORD='gvbW0-Abbtmb9Iu5f-KaHjuKsH43Kkz73NsuSi9MxE4' \
  pepgmp-api-prod psql -h database -U pepgmp_prod -d pepgmp_production -c "SELECT 1;"

# 3. æ£€æŸ¥ API å¥åº·çŠ¶æ€
curl http://localhost:8000/api/v1/monitoring/health
# åº”è¯¥è¿”å› "status":"ok"ï¼ˆä¸å†æ˜¯ "degraded"ï¼‰
```

---

## ğŸ“ é¢„é˜²æªæ–½

1. **ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†æ•°æ®åº“é…ç½®**
   - å°† `docker-compose.prod.yml` å’Œ `.env.production` çº³å…¥ç‰ˆæœ¬æ§åˆ¶
   - é…ç½®å˜æ›´æ—¶è®°å½•å˜æ›´æ—¥å¿—

2. **å®šæœŸå¤‡ä»½æ•°æ®åº“**
   ```bash
   # åˆ›å»ºå¤‡ä»½è„šæœ¬
   docker exec pepgmp-postgres-prod pg_dump -U pepgmp_prod pepgmp_production > backup_$(date +%Y%m%d).sql
   ```

3. **ä½¿ç”¨æ•°æ®åº“è¿ç§»å·¥å…·**
   - ä½¿ç”¨ Alembic ç®¡ç†æ•°æ®åº“ schema
   - é¿å…æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“ç»“æ„

---

## ğŸ¯ å¿«é€Ÿä¿®å¤å‘½ä»¤ï¼ˆå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰

```bash
cd /Users/zhou/projects/Pyt
docker compose -f docker-compose.prod.yml down
docker volume rm pyt_postgres_prod_data
docker compose -f docker-compose.prod.yml up -d
```

---

**é—®é¢˜å‘ç°æ—¥æœŸ**: 2025-12-04
**çŠ¶æ€**: âš ï¸ å¾…ä¿®å¤
**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆ 1ï¼ˆåˆ é™¤ volume é‡æ–°åˆå§‹åŒ–ï¼‰
