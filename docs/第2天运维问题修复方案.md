# ç¬¬2å¤©è¿ç»´é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ¸…å•

1. âœ… æ–‡ä»¶æƒé™é—®é¢˜ (Permission Issues)
2. âœ… æ•°æ®åº“è¿ç§» (Schema Migrations)
3. âœ… æµè§ˆå™¨ç¼“å­˜é—®é¢˜ (Browser Caching)
4. âœ… æ—¥å¿—è½®è½¬ (Log Rotation)
5. âœ… Alpine é•œåƒé—®é¢˜ (å·²è§£å†³ï¼šä½¿ç”¨ Debian Slim)
6. âœ… Nginx é…ç½®ä¼˜åŒ–

---

## 1. æ–‡ä»¶æƒé™é—®é¢˜ä¿®å¤

### é—®é¢˜æè¿°

`frontend-init` å®¹å™¨ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œæå–çš„é™æ€æ–‡ä»¶æ‰€æœ‰è€…æ˜¯ rootï¼Œå¯¼è‡´ï¼š
- å®¿ä¸»æœºæ™®é€šç”¨æˆ·æ— æ³•åˆ é™¤/ä¿®æ”¹æ–‡ä»¶
- Nginx å®¹å™¨å†…ç”¨æˆ·å¯èƒ½æ— æ³•è¯»å–ï¼ˆè™½ç„¶ Docker æŒ‚è½½é€šå¸¸å…è®¸è¯»ï¼‰

### è§£å†³æ–¹æ¡ˆ

åœ¨ `frontend-init` å‘½ä»¤ä¸­æ·»åŠ æ–‡ä»¶æƒé™ä¿®å¤ï¼š

```yaml
frontend-init:
  environment:
    - HOST_UID=${HOST_UID:-1000}  # å®¿ä¸»æœºç”¨æˆ· UIDï¼ˆé»˜è®¤ 1000ï¼‰
    - HOST_GID=${HOST_GID:-1000}  # å®¿ä¸»æœºç”¨æˆ· GIDï¼ˆé»˜è®¤ 1000ï¼‰
  command: >
    sh -c "
      mkdir -p /target &&
      cp -r /usr/share/nginx/html/* /target/ &&
      chown -R $${HOST_UID}:$${HOST_GID} /target &&
      chmod -R 755 /target &&
      echo '[OK] Static files extracted with correct permissions'
    "
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
# åœ¨ .env.production ä¸­è®¾ç½®ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 1000ï¼‰
HOST_UID=1000
HOST_GID=1000

# æˆ–å¯åŠ¨æ—¶æŒ‡å®š
HOST_UID=$(id -u) HOST_GID=$(id -g) docker-compose up frontend-init
```

---

## 2. æ•°æ®åº“è¿ç§»æ”¯æŒ

### é—®é¢˜æè¿°

å½“å‰æ–¹æ¡ˆåªæœ‰é¦–æ¬¡åˆå§‹åŒ–ï¼ˆ`init_db.sql`ï¼‰ï¼Œç¼ºå°‘ç‰ˆæœ¬å‡çº§æ—¶çš„æ•°æ®åº“è¿ç§»æœºåˆ¶ã€‚

### è§£å†³æ–¹æ¡ˆ Aï¼šAPI å¯åŠ¨æ—¶è‡ªåŠ¨è¿ç§»ï¼ˆæ¨èï¼‰

åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼Œåœ¨ API å¯åŠ¨å‰æ‰§è¡Œè¿ç§»ï¼š

**åˆ›å»º `scripts/docker-entrypoint.sh`**ï¼š
```bash
#!/bin/bash
set -e

echo "========================================================================="
echo "API Container Entrypoint"
echo "========================================================================="

# ç­‰å¾…æ•°æ®åº“å°±ç»ª
echo "Waiting for database to be ready..."
until pg_isready -h database -U ${POSTGRES_USER:-pepgmp_prod} -d ${POSTGRES_DB:-pepgmp_production} >/dev/null 2>&1; do
  echo "Database is unavailable - sleeping"
  sleep 1
done
echo "Database is ready!"

# æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœä½¿ç”¨ Alembicï¼‰
if [ -f "alembic.ini" ] && command -v alembic >/dev/null 2>&1; then
    echo "Running database migrations..."
    alembic upgrade head
    echo "Database migrations completed"
else
    echo "No Alembic migration found, skipping..."
fi

# æ‰§è¡Œåº”ç”¨å¯åŠ¨å‘½ä»¤
exec "$@"
```

**æ›´æ–° Dockerfile.prod**ï¼š
```dockerfile
# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY --chown=appuser:appuser scripts/docker-entrypoint.sh /app/docker-entrypoint.sh
RUN chmod +x /app/docker-entrypoint.sh

# ä½¿ç”¨ entrypoint
ENTRYPOINT ["/app/docker-entrypoint.sh"]
CMD ["gunicorn", "src.api.app:app", ...]
```

### è§£å†³æ–¹æ¡ˆ Bï¼šç‹¬ç«‹è¿ç§»å®¹å™¨ï¼ˆæ›´å®‰å…¨ï¼‰

åˆ›å»ºç‹¬ç«‹çš„è¿ç§»å®¹å™¨ï¼Œåœ¨ API å¯åŠ¨å‰è¿è¡Œï¼š

```yaml
migration:
  image: pepgmp-backend:${IMAGE_TAG:-latest}
  container_name: pepgmp-migration
  env_file:
    - .env.production
  command: >
    sh -c "
      echo 'Running database migrations...' &&
      alembic upgrade head &&
      echo 'Migrations completed'
    "
  depends_on:
    database:
      condition: service_healthy
  restart: "no"

api:
  depends_on:
    - database
    - redis
    - migration  # ç­‰å¾…è¿ç§»å®Œæˆ
```

---

## 3. æµè§ˆå™¨ç¼“å­˜é—®é¢˜ä¿®å¤

### é—®é¢˜æè¿°

`index.html` å¿…é¡»ç¦ç”¨ç¼“å­˜ï¼Œå¦åˆ™ç”¨æˆ·å¯èƒ½åŠ è½½æ—§ç‰ˆæœ¬ï¼Œå¯¼è‡´ç™½å±ã€‚

### è§£å†³æ–¹æ¡ˆ

æ›´æ–° Nginx é…ç½®ï¼Œé’ˆå¯¹ `index.html` ç¦ç”¨ç¼“å­˜ï¼š

```nginx
# index.html ç¦ç”¨ç¼“å­˜ï¼ˆå¿…é¡»ï¼‰
location = /index.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires 0;
    try_files $uri /index.html;
}

# å…¶ä»–é™æ€èµ„æºï¼ˆå¸¦ hashï¼‰ä½¿ç”¨å¼ºç¼“å­˜
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

---

## 4. æ—¥å¿—è½®è½¬é…ç½®

### Docker å±‚æ—¥å¿—è½®è½¬ï¼ˆå·²é…ç½®ï¼‰

`docker-compose.prod.yml` ä¸­å·²é…ç½®ï¼š
```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

### åº”ç”¨å±‚æ—¥å¿—è½®è½¬

éœ€è¦åœ¨ Python ä»£ç ä¸­é…ç½® `RotatingFileHandler`ï¼š

**æ£€æŸ¥ `src/api/app.py`**ï¼š
```python
from logging.handlers import RotatingFileHandler

# é…ç½®æ—¥å¿—è½®è½¬
api_file_handler = RotatingFileHandler(
    "/app/logs/api.log",
    maxBytes=10 * 1024 * 1024,  # 10MB
    backupCount=5,  # ä¿ç•™5ä¸ªå¤‡ä»½
    encoding="utf-8",
)
```

**Gunicorn æ—¥å¿—è½®è½¬**ï¼š
```python
# Dockerfile.prod ä¸­çš„ CMD
CMD ["gunicorn", "src.api.app:app",
    "--access-logfile", "/app/logs/access.log",
    "--error-logfile", "/app/logs/error.log",
    "--log-level", "info"]
```

**æ³¨æ„**ï¼šGunicorn çš„æ—¥å¿—æ–‡ä»¶éœ€è¦åº”ç”¨å±‚è½®è½¬ï¼ˆä½¿ç”¨ `logrotate` æˆ– Python `RotatingFileHandler`ï¼‰ã€‚

---

## 5. Alpine é•œåƒé—®é¢˜ï¼ˆå·²è§£å†³ï¼‰

### å½“å‰çŠ¶æ€

- **åç«¯é•œåƒ**ï¼š`python:3.10-slim-bookworm` âœ…ï¼ˆDebian åŸºç¡€ï¼Œä¸æ˜¯ Alpineï¼‰
- **æ•°æ®åº“é•œåƒ**ï¼š`postgres:16-alpine` âš ï¸ï¼ˆå»ºè®®æ”¹ä¸ºæ ‡å‡†ç‰ˆï¼‰

### å»ºè®®

å¦‚æœæ•°æ®é‡å¤§æˆ–éœ€è¦æ›´å¥½çš„æ€§èƒ½ï¼Œå»ºè®®å°†æ•°æ®åº“é•œåƒæ”¹ä¸ºï¼š
```yaml
database:
  image: postgres:16  # æ ‡å‡†ç‰ˆï¼Œä¸æ˜¯ alpine
```

**åŸå› **ï¼š
- Alpine çš„ musl libc åœ¨å¤„ç† locales æ—¶å¯èƒ½æœ‰å…¼å®¹æ€§é—®é¢˜
- æ ‡å‡†ç‰ˆæ€§èƒ½æ›´ç¨³å®šï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ

---

## 6. Nginx é…ç½®ä¼˜åŒ–

### å½“å‰é…ç½®é—®é¢˜

1. ç¼ºå°‘ `index.html` ç¼“å­˜æ§åˆ¶
2. Gzip é…ç½®å¯ä»¥ä¼˜åŒ–
3. ç¼ºå°‘å®‰å…¨å¤´
4. `client_max_body_size` å¯ä»¥è°ƒæ•´

### ä¼˜åŒ–åçš„é…ç½®

```nginx
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    sendfile on;
    keepalive_timeout 65;

    # é™åˆ¶ä¸Šä¼ æ–‡ä»¶å¤§å°ï¼ˆé˜²æ­¢æ¶æ„å¤§æ–‡ä»¶ä¸Šä¼ ï¼‰
    client_max_body_size 10M;

    # Gzip å‹ç¼©ä¼˜åŒ–
    gzip on;
    gzip_min_length 1k;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/xml+rss;
    gzip_vary on;
    gzip_proxied any;

    upstream api_backend {
        server api:8000;
    }

    server {
        listen 80;
        server_name _;

        root /usr/share/nginx/html;
        index index.html;

        # å®‰å…¨å¤´
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # API ä»£ç†
        location /api/ {
            proxy_pass http://api_backend/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        location /api/v1/monitoring/health {
            proxy_pass http://api_backend/api/v1/monitoring/health;
            access_log off;
        }

        # index.html ç¦ç”¨ç¼“å­˜ï¼ˆå…³é”®ï¼ï¼‰
        location = /index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires 0;
            try_files $uri /index.html;
        }

        # é™æ€èµ„æºï¼ˆå¸¦ hashï¼‰ä½¿ç”¨å¼ºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # å‰ç«¯é™æ€æ–‡ä»¶ï¼ˆæ”¯æŒ Vue Router history æ¨¡å¼ï¼‰
        location / {
            try_files $uri $uri/ /index.html;
        }

        # å¥åº·æ£€æŸ¥ç«¯ç‚¹
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # é”™è¯¯é¡µé¢
        error_page 404 /index.html;
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
```

---

## å®æ–½æ­¥éª¤

### æ­¥éª¤ 1: ä¿®å¤æ–‡ä»¶æƒé™

æ›´æ–° `docker-compose.prod.yml` ä¸­çš„ `frontend-init` æœåŠ¡ã€‚

### æ­¥éª¤ 2: æ·»åŠ æ•°æ®åº“è¿ç§»

é€‰æ‹©æ–¹æ¡ˆ Aï¼ˆå¯åŠ¨æ—¶è‡ªåŠ¨è¿ç§»ï¼‰æˆ–æ–¹æ¡ˆ Bï¼ˆç‹¬ç«‹è¿ç§»å®¹å™¨ï¼‰ã€‚

### æ­¥éª¤ 3: æ›´æ–° Nginx é…ç½®

æ›´æ–° `scripts/prepare_minimal_deploy.sh` ä¸­çš„ Nginx é…ç½®æ¨¡æ¿ã€‚

### æ­¥éª¤ 4: éªŒè¯æ—¥å¿—è½®è½¬

æ£€æŸ¥åº”ç”¨å±‚æ—¥å¿—è½®è½¬é…ç½®ã€‚

### æ­¥éª¤ 5: æµ‹è¯•

éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒï¼ŒéªŒè¯æ‰€æœ‰ä¿®å¤ã€‚

---

## æ£€æŸ¥æ¸…å•

- [ ] `frontend-init` æ·»åŠ äº† `HOST_UID`/`HOST_GID` ç¯å¢ƒå˜é‡
- [ ] `frontend-init` å‘½ä»¤ä¸­æ·»åŠ äº† `chown` æ“ä½œ
- [ ] æ•°æ®åº“è¿ç§»æœºåˆ¶å·²å®ç°ï¼ˆentrypoint æˆ–ç‹¬ç«‹å®¹å™¨ï¼‰
- [ ] Nginx é…ç½®ä¸­ `index.html` ç¦ç”¨ç¼“å­˜
- [ ] Nginx é…ç½®ä¸­é™æ€èµ„æºä½¿ç”¨å¼ºç¼“å­˜
- [ ] Nginx é…ç½®ä¸­æ·»åŠ äº†å®‰å…¨å¤´
- [ ] åº”ç”¨å±‚æ—¥å¿—è½®è½¬å·²é…ç½®
- [ ] æ•°æ®åº“é•œåƒè€ƒè™‘ä½¿ç”¨æ ‡å‡†ç‰ˆï¼ˆé Alpineï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-18
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
