# é”™è¯¯å¤„ç†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ¯ æ¦‚è¿°

æœ¬é¡¹ç›®çš„ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„å¼‚å¸¸ç®¡ç†ã€é”™è¯¯æ¢å¤ã€ç›‘æ§å‘Šè­¦å’Œå¥åº·æ£€æŸ¥åŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **ç»Ÿä¸€é”™è¯¯å¤„ç†å™¨** (`src/utils/error_handler.py`)
   - é”™è¯¯åˆ†ç±»å’Œä¸¥é‡ç¨‹åº¦è¯„ä¼°
   - è‡ªåŠ¨é”™è¯¯æ¢å¤ç­–ç•¥
   - é”™è¯¯è·Ÿè¸ªå’Œç»Ÿè®¡

2. **é”™è¯¯ç›‘æ§å™¨** (`src/utils/error_monitor.py`)
   - å®æ—¶é”™è¯¯ç›‘æ§
   - å‘Šè­¦è§„åˆ™ç®¡ç†
   - å¤šæ¸ é“å‘Šè­¦é€šçŸ¥

3. **APIä¸­é—´ä»¶** (`src/api/middleware/error_middleware.py`)
   - è¯·æ±‚é”™è¯¯å¤„ç†
   - æ€§èƒ½ç›‘æ§
   - å®‰å…¨é˜²æŠ¤

4. **ç›‘æ§API** (`src/api/routers/error_monitoring.py`)
   - é”™è¯¯ç»Ÿè®¡æŸ¥è¯¢
   - å¥åº·çŠ¶æ€æ£€æŸ¥
   - å‘Šè­¦ç®¡ç†

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€é”™è¯¯å¤„ç†

```python
from src.utils.error_handler import handle_error, error_handler, ErrorContext

# ç®€å•é”™è¯¯å¤„ç†
try:
    result = some_risky_operation()
except Exception as e:
    error_info = handle_error(e)
    print(f"é”™è¯¯ID: {error_info.error_id}")

# ä½¿ç”¨è£…é¥°å™¨
@error_handler(
    severity=ErrorSeverity.MEDIUM,
    category=ErrorCategory.DETECTION,
    retry_count=2,
    fallback_value=[]
)
def detect_objects(image):
    # æ£€æµ‹é€»è¾‘
    pass

# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
from src.utils.error_handler import error_context

with error_context("detect_objects", "detector.py") as ctx:
    result = risky_detection()
```

### 2. å¯åŠ¨é”™è¯¯ç›‘æ§

```python
from src.utils.error_monitor import start_error_monitoring, get_system_health

# å¯åŠ¨ç›‘æ§
start_error_monitoring()

# è·å–ç³»ç»Ÿå¥åº·çŠ¶æ€
health = get_system_health()
print(f"å¥åº·åˆ†æ•°: {health['overall_health']['health_score']}")
```

### 3. APIé›†æˆ

é”™è¯¯å¤„ç†ä¸­é—´ä»¶å·²è‡ªåŠ¨é›†æˆåˆ°FastAPIåº”ç”¨ä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

## ğŸ“Š é”™è¯¯åˆ†ç±»ç³»ç»Ÿ

### é”™è¯¯ä¸¥é‡ç¨‹åº¦

| çº§åˆ« | æè¿° | å¤„ç†ç­–ç•¥ |
|------|------|----------|
| `LOW` | ä½ä¸¥é‡æ€§ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ | è®°å½•æ—¥å¿—ï¼Œç»§ç»­è¿è¡Œ |
| `MEDIUM` | ä¸­ç­‰ä¸¥é‡æ€§ï¼Œå½±å“éƒ¨åˆ†åŠŸèƒ½ | å°è¯•æ¢å¤ï¼Œè®°å½•å‘Šè­¦ |
| `HIGH` | é«˜ä¸¥é‡æ€§ï¼Œå½±å“æ ¸å¿ƒåŠŸèƒ½ | è‡ªåŠ¨æ¢å¤ï¼Œå‘é€å‘Šè­¦ |
| `CRITICAL` | ä¸¥é‡é”™è¯¯ï¼Œç³»ç»Ÿå¯èƒ½ä¸å¯ç”¨ | ç´§æ€¥æ¢å¤ï¼Œç«‹å³å‘Šè­¦ |

### é”™è¯¯åˆ†ç±»

| åˆ†ç±» | æè¿° | æ¢å¤ç­–ç•¥ |
|------|------|----------|
| `DETECTION` | æ£€æµ‹ç›¸å…³é”™è¯¯ | ä½¿ç”¨å¤‡ç”¨æ£€æµ‹å™¨ |
| `MODEL` | æ¨¡å‹ç›¸å…³é”™è¯¯ | é‡æ–°åŠ è½½æ¨¡å‹ï¼Œä½¿ç”¨å¤‡ç”¨æ¨¡å‹ |
| `GPU` | GPUç›¸å…³é”™è¯¯ | åˆ‡æ¢åˆ°CPUæ¨¡å¼ |
| `NETWORK` | ç½‘ç»œç›¸å…³é”™è¯¯ | é‡è¯•ï¼Œç¦»çº¿æ¨¡å¼ |
| `DATABASE` | æ•°æ®åº“ç›¸å…³é”™è¯¯ | é‡è¯•ï¼Œå¤‡ç”¨æ•°æ®åº“ |
| `FILE_IO` | æ–‡ä»¶IOé”™è¯¯ | é‡è¯•ï¼Œä¸´æ—¶æ–‡ä»¶ |
| `CONFIGURATION` | é…ç½®ç›¸å…³é”™è¯¯ | ä½¿ç”¨é»˜è®¤é…ç½® |
| `VALIDATION` | éªŒè¯ç›¸å…³é”™è¯¯ | è¿”å›éªŒè¯é”™è¯¯ |
| `TIMEOUT` | è¶…æ—¶é”™è¯¯ | é‡è¯•ï¼Œå»¶é•¿è¶…æ—¶ |
| `RESOURCE` | èµ„æºç›¸å…³é”™è¯¯ | æ¸…ç†èµ„æºï¼Œç­‰å¾…é‡Šæ”¾ |

## ğŸ”§ é«˜çº§åŠŸèƒ½

### 1. è‡ªå®šä¹‰é”™è¯¯æ¢å¤ç­–ç•¥

```python
from src.utils.error_handler import ErrorRecoveryStrategy, ErrorCategory

class CustomRecoveryStrategy(ErrorRecoveryStrategy):
    def _recovery_custom_logic(self, error_info):
        """è‡ªå®šä¹‰æ¢å¤é€»è¾‘"""
        if "specific_error" in str(error_info.exception):
            # æ‰§è¡Œç‰¹å®šæ¢å¤é€»è¾‘
            return True
        return False

# æ³¨å†Œè‡ªå®šä¹‰ç­–ç•¥
strategy = CustomRecoveryStrategy()
strategy.strategies[ErrorCategory.CUSTOM] = [strategy._recovery_custom_logic]
```

### 2. å‘Šè­¦è§„åˆ™é…ç½®

```python
from src.utils.error_monitor import AlertRule, AlertLevel

# åˆ›å»ºè‡ªå®šä¹‰å‘Šè­¦è§„åˆ™
custom_rule = AlertRule(
    name="custom_error_threshold",
    condition="category == 'detection'",
    threshold=10,
    time_window=300,  # 5åˆ†é’Ÿ
    alert_level=AlertLevel.WARNING,
    cooldown=600  # 10åˆ†é’Ÿå†·å´
)

# æ·»åŠ å‘Šè­¦è§„åˆ™
error_monitor = get_error_monitor()
error_monitor.add_alert_rule(custom_rule)
```

### 3. å‘Šè­¦é€šé“é…ç½®

```python
from src.utils.error_monitor import EmailAlertChannel, WebhookAlertChannel

# é‚®ä»¶å‘Šè­¦
email_channel = EmailAlertChannel(
    smtp_server="smtp.gmail.com",
    smtp_port=587,
    username="your_email@gmail.com",
    password="your_password",
    from_email="alerts@yourcompany.com",
    to_emails=["admin@yourcompany.com", "dev@yourcompany.com"]
)

# Webhookå‘Šè­¦
webhook_channel = WebhookAlertChannel(
    webhook_url="https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK",
    headers={"Content-Type": "application/json"}
)

# æ·»åŠ å‘Šè­¦é€šé“
error_monitor.add_alert_channel(email_channel)
error_monitor.add_alert_channel(webhook_channel)
```

### 4. ç†”æ–­å™¨ä½¿ç”¨

```python
from src.utils.error_handler import CircuitBreaker

# åˆ›å»ºç†”æ–­å™¨
circuit_breaker = CircuitBreaker(failure_threshold=5, timeout=60.0)

# ä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤å‡½æ•°è°ƒç”¨
try:
    result = circuit_breaker.call(risky_function, arg1, arg2)
except Exception as e:
    print(f"ç†”æ–­å™¨ä¿æŠ¤: {e}")
```

## ğŸ“ˆ ç›‘æ§å’Œå‘Šè­¦

### 1. é”™è¯¯ç»Ÿè®¡API

```bash
# è·å–é”™è¯¯ç»Ÿè®¡
GET /api/v1/monitoring/errors/stats

# æ ¹æ®åˆ†ç±»è·å–é”™è¯¯
GET /api/v1/monitoring/errors/by-category/gpu?limit=50

# æ ¹æ®ä¸¥é‡ç¨‹åº¦è·å–é”™è¯¯
GET /api/v1/monitoring/errors/by-severity/high?limit=20
```

### 2. å¥åº·æ£€æŸ¥API

```bash
# è·å–ç³»ç»Ÿå¥åº·çŠ¶æ€
GET /api/v1/monitoring/health

# è·å–è¯¦ç»†å¥åº·æ£€æŸ¥
GET /api/v1/monitoring/health/detailed
```

### 3. å‘Šè­¦ç®¡ç†API

```bash
# è·å–æ´»è·ƒå‘Šè­¦
GET /api/v1/monitoring/alerts/active

# è·å–å‘Šè­¦å†å²
GET /api/v1/monitoring/alerts/history?limit=100

# è§£å†³å‘Šè­¦
POST /api/v1/monitoring/alerts/{alert_id}/resolve
```

### 4. ç›‘æ§æ§åˆ¶API

```bash
# å¯åŠ¨ç›‘æ§
POST /api/v1/monitoring/monitoring/start

# åœæ­¢ç›‘æ§
POST /api/v1/monitoring/monitoring/stop

# è·å–ç›‘æ§çŠ¶æ€
GET /api/v1/monitoring/monitoring/status
```

## ğŸ¨ ä½¿ç”¨ç¤ºä¾‹

### 1. æ£€æµ‹å™¨é”™è¯¯å¤„ç†

```python
from src.utils.error_handler import handle_detection_error, error_context

@handle_detection_error
def detect_humans(image):
    """äººä½“æ£€æµ‹ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
    with error_context("detect_humans", "human_detector.py") as ctx:
        # æ£€æµ‹é€»è¾‘
        results = yolo_model(image)
        return results

# ä½¿ç”¨ç¤ºä¾‹
try:
    detections = detect_humans(image)
    if not detections:
        logger.warning("æœªæ£€æµ‹åˆ°äººä½“")
except Exception as e:
    logger.error(f"æ£€æµ‹å¤±è´¥: {e}")
```

### 2. æ¨¡å‹åŠ è½½é”™è¯¯å¤„ç†

```python
from src.utils.error_handler import handle_model_error

@handle_model_error
def load_model(model_path):
    """æ¨¡å‹åŠ è½½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
    try:
        model = torch.load(model_path)
        return model
    except Exception as e:
        # å°è¯•å¤‡ç”¨æ¨¡å‹
        backup_path = model_path.replace('.pt', '_backup.pt')
        if os.path.exists(backup_path):
            return torch.load(backup_path)
        raise e
```

### 3. GPUé”™è¯¯å¤„ç†

```python
from src.utils.error_handler import handle_gpu_error

@handle_gpu_error
def gpu_inference(model, data):
    """GPUæ¨ç†ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
    try:
        return model(data.cuda())
    except RuntimeError as e:
        if "CUDA" in str(e):
            # è‡ªåŠ¨åˆ‡æ¢åˆ°CPU
            logger.warning("GPUä¸å¯ç”¨ï¼Œåˆ‡æ¢åˆ°CPU")
            return model(data.cpu())
        raise e
```

### 4. ç½‘ç»œè¯·æ±‚é”™è¯¯å¤„ç†

```python
from src.utils.error_handler import handle_network_error

@handle_network_error
def api_request(url, data):
    """APIè¯·æ±‚ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰"""
    import requests

    for attempt in range(3):
        try:
            response = requests.post(url, json=data, timeout=10)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            if attempt == 2:  # æœ€åä¸€æ¬¡å°è¯•
                raise e
            time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é”™è¯¯ç›‘æ§æœªå¯åŠ¨**
   ```python
   # æ£€æŸ¥ç›‘æ§çŠ¶æ€
   from src.utils.error_monitor import get_error_monitor
   monitor = get_error_monitor()
   print(f"ç›‘æ§çŠ¶æ€: {monitor.monitoring}")
   ```

2. **å‘Šè­¦æœªå‘é€**
   ```python
   # æ£€æŸ¥å‘Šè­¦é€šé“
   for channel in monitor.alert_channels:
       print(f"é€šé“: {type(channel).__name__}")
   ```

3. **é”™è¯¯æ¢å¤å¤±è´¥**
   ```python
   # æ£€æŸ¥æ¢å¤ç­–ç•¥
   error_info = handle_error(exception)
   print(f"æ¢å¤å°è¯•: {error_info.recovery_attempted}")
   print(f"æ¢å¤æˆåŠŸ: {error_info.recovery_successful}")
   ```

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   ```python
   import logging
   logging.getLogger('src.utils.error_handler').setLevel(logging.DEBUG)
   logging.getLogger('src.utils.error_monitor').setLevel(logging.DEBUG)
   ```

2. **æŸ¥çœ‹é”™è¯¯ç»Ÿè®¡**
   ```python
   from src.utils.error_handler import get_error_handler
   stats = get_error_handler().get_error_report()
   print(json.dumps(stats, indent=2))
   ```

3. **æµ‹è¯•å‘Šè­¦è§„åˆ™**
   ```python
   # æ‰‹åŠ¨è§¦å‘é”™è¯¯æµ‹è¯•å‘Šè­¦
   try:
       raise Exception("æµ‹è¯•é”™è¯¯")
   except Exception as e:
       handle_error(e)
   ```

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†åŸåˆ™

- **å¿«é€Ÿå¤±è´¥**: å°½æ—©å‘ç°å’Œå¤„ç†é”™è¯¯
- **ä¼˜é›…é™çº§**: æä¾›å¤‡ç”¨æ–¹æ¡ˆ
- **è¯¦ç»†è®°å½•**: è®°å½•è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- **è‡ªåŠ¨æ¢å¤**: å°½å¯èƒ½è‡ªåŠ¨ä¿®å¤é—®é¢˜

### 2. å‘Šè­¦è®¾è®¡åŸåˆ™

- **åˆ†çº§å‘Šè­¦**: æ ¹æ®ä¸¥é‡ç¨‹åº¦åˆ†çº§
- **é¿å…å‘Šè­¦é£æš´**: è®¾ç½®åˆç†çš„å†·å´æ—¶é—´
- **å¤šæ¸ é“é€šçŸ¥**: ç¡®ä¿å‘Šè­¦èƒ½å¤ŸåŠæ—¶é€è¾¾
- **å¯æ“ä½œå‘Šè­¦**: å‘Šè­¦ä¿¡æ¯åº”è¯¥åŒ…å«è§£å†³å»ºè®®

### 3. ç›‘æ§æŒ‡æ ‡

- **é”™è¯¯ç‡**: å•ä½æ—¶é—´å†…çš„é”™è¯¯æ•°é‡
- **æ¢å¤æ—¶é—´**: ä»é”™è¯¯å‘ç”Ÿåˆ°æ¢å¤çš„æ—¶é—´
- **å‘Šè­¦å“åº”**: å‘Šè­¦å‘å‡ºåˆ°å¤„ç†çš„æ—¶é—´
- **ç³»ç»Ÿå¥åº·**: ç»¼åˆå¥åº·è¯„åˆ†

### 4. æ€§èƒ½è€ƒè™‘

- **å¼‚æ­¥å¤„ç†**: é”™è¯¯å¤„ç†ä¸åº”é˜»å¡ä¸»æµç¨‹
- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡å¤„ç†é”™è¯¯å’Œå‘Šè­¦
- **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜é”™è¯¯ç»Ÿè®¡å’Œå¥åº·çŠ¶æ€
- **èµ„æºé™åˆ¶**: é™åˆ¶é”™è¯¯è®°å½•å’Œå‘Šè­¦æ•°é‡

## ğŸ”„ æŒç»­æ”¹è¿›

### 1. é”™è¯¯åˆ†æ

å®šæœŸåˆ†æé”™è¯¯æ¨¡å¼ï¼Œè¯†åˆ«ç³»ç»Ÿè–„å¼±ç¯èŠ‚ï¼š

```python
# åˆ†æé”™è¯¯è¶‹åŠ¿
def analyze_error_trends():
    error_handler = get_error_handler()
    stats = error_handler.get_error_report()

    # åˆ†æé”™è¯¯åˆ†ç±»åˆ†å¸ƒ
    category_dist = stats['category_counts']
    print("é”™è¯¯åˆ†ç±»åˆ†å¸ƒ:", category_dist)

    # åˆ†æä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ
    severity_dist = stats['severity_counts']
    print("ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ:", severity_dist)
```

### 2. å‘Šè­¦ä¼˜åŒ–

æ ¹æ®å®é™…è¿è¡Œæƒ…å†µè°ƒæ•´å‘Šè­¦è§„åˆ™ï¼š

```python
# åŠ¨æ€è°ƒæ•´å‘Šè­¦é˜ˆå€¼
def adjust_alert_thresholds():
    monitor = get_error_monitor()

    # æ ¹æ®å†å²æ•°æ®è°ƒæ•´é˜ˆå€¼
    for rule_name, rule in monitor.alert_rules.items():
        if rule_name == "high_error_rate":
            # æ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´
            rule.threshold = calculate_dynamic_threshold()
```

### 3. æ¢å¤ç­–ç•¥ä¼˜åŒ–

æ ¹æ®é”™è¯¯æ¢å¤æ•ˆæœä¼˜åŒ–ç­–ç•¥ï¼š

```python
# åˆ†ææ¢å¤æˆåŠŸç‡
def analyze_recovery_success():
    error_handler = get_error_handler()
    errors = list(error_handler.error_tracker.errors)

    recovery_stats = {}
    for error in errors:
        category = error.category.value
        if category not in recovery_stats:
            recovery_stats[category] = {'total': 0, 'successful': 0}

        recovery_stats[category]['total'] += 1
        if error.recovery_successful:
            recovery_stats[category]['successful'] += 1

    # è®¡ç®—æ¢å¤æˆåŠŸç‡
    for category, stats in recovery_stats.items():
        success_rate = stats['successful'] / stats['total'] * 100
        print(f"{category} æ¢å¤æˆåŠŸç‡: {success_rate:.1f}%")
```

é€šè¿‡è¿™å¥—å®Œæ•´çš„é”™è¯¯å¤„ç†ç³»ç»Ÿï¼Œæ‚¨å¯ä»¥ï¼š

- **æé«˜ç³»ç»Ÿç¨³å®šæ€§**: è‡ªåŠ¨é”™è¯¯æ¢å¤å’Œä¼˜é›…é™çº§
- **å¿«é€Ÿé—®é¢˜å®šä½**: è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’Œä¸Šä¸‹æ–‡ä¿¡æ¯
- **åŠæ—¶å‘Šè­¦é€šçŸ¥**: å¤šæ¸ é“å‘Šè­¦å’Œæ™ºèƒ½è§„åˆ™
- **æŒç»­ç³»ç»Ÿä¼˜åŒ–**: åŸºäºé”™è¯¯æ•°æ®çš„æ”¹è¿›å»ºè®®

è¿™å¥—ç³»ç»Ÿå·²ç»é›†æˆåˆ°æ‚¨çš„é¡¹ç›®ä¸­ï¼Œå¯ä»¥ç«‹å³å¼€å§‹ä½¿ç”¨ï¼
