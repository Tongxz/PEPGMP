# 手动解压部署步骤

## 📋 前提条件

假设您已经通过脚本传输了以下文件到 Ubuntu 服务器：
- 镜像文件：`/tmp/pepgmp-backend-20251205.tar`
- 镜像文件：`/tmp/pepgmp-frontend-20251205.tar`（如果存在）
- 部署包：`/tmp/PEPGMP-20251205.tar.gz`

---

## 🚀 手动部署步骤

### 步骤 1: SSH 到 Ubuntu 服务器

```bash
ssh ubuntu@192.168.31.131
```

---

### 步骤 2: 检查传输的文件

```bash
# 检查镜像文件
ls -lh /tmp/pepgmp-*.tar

# 检查部署包
ls -lh /tmp/PEPGMP-*.tar.gz

# 示例输出：
# /tmp/pepgmp-backend-20251205.tar    (约 2-3 GB)
# /tmp/pepgmp-frontend-20251205.tar   (约 100-200 MB，如果存在)
# /tmp/PEPGMP-20251205.tar.gz         (部署包)
```

---

### 步骤 3: 导入 Docker 镜像

```bash
# 导入后端镜像
docker load -i /tmp/pepgmp-backend-20251205.tar

# 导入前端镜像（如果存在）
docker load -i /tmp/pepgmp-frontend-20251205.tar

# 验证镜像是否导入成功
docker images | grep pepgmp

# 应该看到：
# pepgmp-backend:20251205
# pepgmp-frontend:20251205（如果存在）
```

---

### 步骤 4: 创建部署目录

```bash
# 创建部署目录（根据您的实际需要修改路径）
DEPLOY_DIR=~/projects/PEPGMP
mkdir -p $DEPLOY_DIR
cd $DEPLOY_DIR
```

---

### 步骤 5: 解压部署包

```bash
# 如果部署包在 /tmp/PEPGMP-20251205.tar.gz

# 方式 1: 解压到临时目录，然后移动到目标目录
cd /tmp
tar -xzf PEPGMP-20251205.tar.gz
mv PEPGMP-20251205/* $DEPLOY_DIR/
rmdir PEPGMP-20251205

# 方式 2: 直接解压到目标目录（如果 tar 包结构允许）
cd $DEPLOY_DIR
tar -xzf /tmp/PEPGMP-20251205.tar.gz --strip-components=1
```

**如果解压失败，可以尝试：**

```bash
# 检查 tar 包内容
tar -tzf /tmp/PEPGMP-20251205.tar.gz | head -20

# 根据实际结构调整解压命令
# 如果 tar 包包含 PEPGMP-20251205/ 目录：
cd $DEPLOY_DIR
tar -xzf /tmp/PEPGMP-20251205.tar.gz
mv PEPGMP-20251205/* .
rmdir PEPGMP-20251205

# 如果 tar 包直接包含文件：
cd $DEPLOY_DIR
tar -xzf /tmp/PEPGMP-20251205.tar.gz
```

---

### 步骤 6: 验证部署包内容

```bash
cd $DEPLOY_DIR

# 检查关键文件是否存在
ls -la

# 应该看到：
# - docker-compose.prod.yml（或 docker-compose.yml）
# - config/ 目录
# - models/ 目录（如果存在）
# - scripts/ 目录
```

---

### 步骤 7: 生成生产配置文件

```bash
cd $DEPLOY_DIR

# 如果 scripts/generate_production_config.sh 存在
if [ -f scripts/generate_production_config.sh ]; then
    bash scripts/generate_production_config.sh
else
    echo "配置文件生成脚本不存在，需要手动创建 .env.production"
fi
```

**或者手动创建 `.env.production` 文件：**

```bash
cat > .env.production << 'EOF'
ENVIRONMENT=production
API_PORT=8000

# 数据库配置
DATABASE_URL=postgresql://pepgmp_prod:your_password@pepgmp-postgres-prod:5432/pepgmp_production
POSTGRES_DB=pepgmp_production
POSTGRES_USER=pepgmp_prod
POSTGRES_PASSWORD=your_secure_password

# Redis 配置
REDIS_URL=redis://:your_redis_password@pepgmp-redis-prod:6379/0
REDIS_PASSWORD=your_redis_password

# 镜像版本
IMAGE_TAG=20251205

# 其他配置...
EOF

# 设置文件权限
chmod 600 .env.production
```

---

### 步骤 8: 更新镜像标签

```bash
cd $DEPLOY_DIR

# 如果 .env.production 已存在，更新 IMAGE_TAG
VERSION_TAG=20251205  # 替换为实际版本

if [ -f .env.production ]; then
    if grep -q "IMAGE_TAG=" .env.production; then
        sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=$VERSION_TAG/" .env.production
    else
        echo "IMAGE_TAG=$VERSION_TAG" >> .env.production
    fi
fi
```

---

### 步骤 9: 启动服务

```bash
cd $DEPLOY_DIR

# 使用 docker compose 启动服务
docker compose -f docker-compose.prod.yml --env-file .env.production up -d

# 或者如果文件名为 docker-compose.yml
docker compose -f docker-compose.yml --env-file .env.production up -d
```

---

### 步骤 10: 检查服务状态

```bash
cd $DEPLOY_DIR

# 查看容器状态
docker compose -f docker-compose.prod.yml --env-file .env.production ps

# 查看日志
docker compose -f docker-compose.prod.yml --env-file .env.production logs -f

# 或者查看特定服务的日志
docker compose -f docker-compose.prod.yml --env-file .env.production logs -f api
```

---

### 步骤 11: 验证服务

```bash
# 等待服务启动（约 30-60 秒）
sleep 30

# 测试健康检查
curl http://localhost:8000/api/v1/monitoring/health

# 或测试前端
curl http://localhost/
```

---

### 步骤 12: 清理临时文件（可选）

```bash
# 清理传输的临时文件
rm -f /tmp/pepgmp-*.tar
rm -f /tmp/PEPGMP-*.tar.gz
```

---

## 🔧 故障排查

### 问题 1: 镜像导入失败

```bash
# 检查 Docker 是否运行
docker info

# 检查磁盘空间
df -h

# 重新尝试导入
docker load -i /tmp/pepgmp-backend-20251205.tar
```

### 问题 2: 解压失败

```bash
# 检查 tar 包是否完整
file /tmp/PEPGMP-20251205.tar.gz

# 检查 tar 包内容
tar -tzf /tmp/PEPGMP-20251205.tar.gz | head -20

# 尝试解压到临时目录查看结构
cd /tmp
mkdir -p test-extract
cd test-extract
tar -xzf /tmp/PEPGMP-20251205.tar.gz
ls -la
```

### 问题 3: 服务启动失败

```bash
# 查看详细日志
docker compose -f docker-compose.prod.yml --env-file .env.production logs

# 检查配置文件
cat .env.production

# 检查 docker-compose 文件
cat docker-compose.prod.yml | head -50
```

### 问题 4: 端口被占用

```bash
# 检查端口占用
sudo netstat -tulpn | grep -E ":(80|8000|5432|6379)"

# 或使用 ss
ss -tulpn | grep -E ":(80|8000|5432|6379)"
```

---

## 📝 快速参考命令

```bash
# 一键执行（假设 VERSION_TAG=20251205, DEPLOY_DIR=~/projects/PEPGMP）
VERSION_TAG=20251205
DEPLOY_DIR=~/projects/PEPGMP

# 导入镜像
docker load -i /tmp/pepgmp-backend-$VERSION_TAG.tar
docker load -i /tmp/pepgmp-frontend-$VERSION_TAG.tar 2>/dev/null || echo "前端镜像不存在，跳过"

# 创建目录并解压
mkdir -p $DEPLOY_DIR
cd /tmp && tar -xzf PEPGMP-$VERSION_TAG.tar.gz && mv PEPGMP-$VERSION_TAG/* $DEPLOY_DIR/ && rmdir PEPGMP-$VERSION_TAG

# 进入部署目录
cd $DEPLOY_DIR

# 生成配置（如果脚本存在）
[ -f scripts/generate_production_config.sh ] && bash scripts/generate_production_config.sh

# 更新镜像标签
sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=$VERSION_TAG/" .env.production 2>/dev/null || echo "IMAGE_TAG=$VERSION_TAG" >> .env.production

# 启动服务
docker compose -f docker-compose.prod.yml --env-file .env.production up -d

# 查看状态
docker compose -f docker-compose.prod.yml --env-file .env.production ps
```

---

## ✅ 验证清单

- [ ] 镜像已成功导入
- [ ] 部署包已解压到目标目录
- [ ] 配置文件已创建或更新
- [ ] 镜像标签已更新
- [ ] 服务已启动
- [ ] 容器状态正常
- [ ] 健康检查通过
- [ ] 临时文件已清理（可选）

---

## 📚 相关文档

- [WSL2 生产部署详细步骤](./WSL2生产部署详细步骤.md)
- [WSL2/Ubuntu 部署完整指南](./WSL2_Ubuntu部署完整指南.md)
