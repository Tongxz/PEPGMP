# 前端构建测试指南

## 📋 测试方法概览

### 方法 1: 使用自动化测试脚本（推荐）

```bash
# 运行完整测试
bash scripts/test_frontend_build.sh
```

**功能**：
- ✅ 检查构建产物完整性
- ✅ 验证文件引用正确性
- ✅ 启动预览服务器
- ✅ 测试 HTTP 访问
- ✅ 检查资源文件可访问性
- ✅ 自动生成测试报告

**使用说明**：
1. 脚本会自动检查所有必要的文件
2. 启动预览服务器在 `http://localhost:4173`
3. 保持运行直到按 `Ctrl+C` 停止
4. 停止时会自动清理预览服务器

---

### 方法 2: 手动测试步骤

#### 步骤 1: 检查构建产物

```bash
cd frontend

# 检查关键文件
ls -la dist/
ls -la dist/assets/js/ | head -10
ls -la dist/assets/css/ | head -5

# 检查 index.html
cat dist/index.html

# 检查文件大小
du -sh dist/
```

**预期结果**：
- ✅ `dist/index.html` 存在
- ✅ `dist/assets/js/` 目录存在且包含 JS 文件
- ✅ `dist/assets/css/` 目录存在且包含 CSS 文件
- ✅ 构建产物大小约 1-3MB（压缩后）

#### 步骤 2: 验证文件引用

```bash
cd frontend

# 检查 index.html 中引用的文件是否存在
JS_FILE=$(grep -o 'src="[^"]*"' dist/index.html | sed 's/src="//;s/"//' | sed 's|^/||')
CSS_FILE=$(grep -o 'href="[^"]*\.css[^"]*"' dist/index.html | sed 's/href="//;s/"//' | sed 's|^/||')

[ -f "dist/$JS_FILE" ] && echo "✅ JS 文件存在" || echo "❌ JS 文件不存在"
[ -f "dist/$CSS_FILE" ] && echo "✅ CSS 文件存在" || echo "❌ CSS 文件不存在"
```

#### 步骤 3: 启动预览服务器

```bash
cd frontend

# 启动预览服务器
npx vite preview --port 4173

# 或指定 host（允许外部访问）
npx vite preview --port 4173 --host 0.0.0.0
```

**预期输出**：
```
  ➜  Local:   http://localhost:4173/
  ➜  Network: use --host to expose
```

#### 步骤 4: 浏览器测试

1. **打开浏览器**
   - 访问: `http://localhost:4173`

2. **打开开发者工具** (F12)
   - 切换到 **Console** 标签
   - 检查是否有错误（红色）
   - 检查是否有警告（黄色）

3. **检查 Network 标签**
   - 刷新页面 (F5)
   - 确认所有资源都返回 `200 OK`
   - 检查是否有 `404` 或 `500` 错误
   - 确认 JS 和 CSS 文件都成功加载

4. **测试页面功能**
   - 检查页面是否正常显示
   - 测试路由导航
   - 测试 API 调用（如果有）
   - 测试交互功能

#### 步骤 5: 命令行测试

```bash
# 测试 HTTP 响应
curl -I http://localhost:4173/

# 应该返回: HTTP/1.1 200 OK

# 测试 index.html 内容
curl http://localhost:4173/ | head -20

# 测试 JS 文件（需要先获取文件名）
JS_FILE=$(grep -o 'src="[^"]*"' frontend/dist/index.html | sed 's/src="//;s/"//' | sed 's|^/||')
curl -I http://localhost:4173/$JS_FILE

# 应该返回: HTTP/1.1 200 OK
```

---

### 方法 3: 快速验证（一键测试）

```bash
cd frontend

# 检查关键文件
[ -f dist/index.html ] && echo "✅ index.html 存在" || echo "❌ 不存在"
[ -d dist/assets ] && echo "✅ assets 目录存在" || echo "❌ 不存在"

# 启动预览并测试
npx vite preview --port 4173 &
sleep 3
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4173/)

if [ "$HTTP_CODE" = "200" ]; then
    echo "✅ HTTP 访问正常 (状态码: $HTTP_CODE)"
else
    echo "❌ HTTP 访问失败 (状态码: $HTTP_CODE)"
fi

# 停止预览服务器
pkill -f "vite preview"
```

---

## 🔍 常见问题排查

### 问题 1: 构建产物不存在

**症状**：
```
❌ dist 目录不存在
```

**解决方案**：
```bash
cd frontend
rm -rf dist
npx vite build
```

### 问题 2: 文件引用错误

**症状**：
```
❌ 引用的文件不存在: assets/js/index-xxx.js
```

**可能原因**：
- 构建不完整
- 文件路径错误

**解决方案**：
```bash
# 重新构建
cd frontend
rm -rf dist
npx vite build

# 检查构建日志是否有错误
```

### 问题 3: 预览服务器无法启动

**症状**：
```
Error: Port 4173 is already in use
```

**解决方案**：
```bash
# 使用其他端口
npx vite preview --port 4174

# 或停止占用端口的进程
lsof -ti:4173 | xargs kill -9
```

### 问题 4: 浏览器控制台有错误

**常见错误**：

1. **`ReferenceError: Cannot access 'X' before initialization`**
   - 原因：循环依赖或代码分割问题
   - 解决：检查 `vite.config.ts` 的代码分割策略

2. **`Failed to load resource: 404`**
   - 原因：文件路径错误或文件不存在
   - 解决：检查 `dist/` 目录中的文件

3. **`CORS error`**
   - 原因：跨域问题（通常在生产环境）
   - 解决：检查 API 代理配置

---

## ✅ 测试检查清单

### 构建产物检查
- [ ] `dist/index.html` 存在
- [ ] `dist/assets/js/` 目录存在
- [ ] `dist/assets/css/` 目录存在
- [ ] 所有引用的文件都存在
- [ ] 构建产物大小合理（1-3MB）

### 预览服务器检查
- [ ] 预览服务器成功启动
- [ ] HTTP 访问返回 200
- [ ] index.html 内容正确
- [ ] JS 文件可访问
- [ ] CSS 文件可访问

### 浏览器检查
- [ ] 页面正常显示
- [ ] 控制台无错误
- [ ] Network 标签所有资源返回 200
- [ ] 路由导航正常
- [ ] API 调用正常（如果有）
- [ ] 交互功能正常

---

## 📊 当前构建状态

根据最新检查：

✅ **构建产物完整**
- `dist/index.html` 存在
- `dist/assets/` 目录存在
- 21 个 JS 文件
- 13 个 CSS 文件
- 总大小: 2.1MB

✅ **文件引用正确**
- 入口 JS: `assets/js/index-CWl9j-AW.js`
- Vendor chunk: `assets/js/vendor-QkdCTaBJ.js`（简化策略）
- CSS: `assets/css/index-BMBby1Zw.css`

✅ **代码分割策略**
- 使用简化策略（所有第三方库在一个 vendor chunk）
- 避免循环依赖问题

---

## 🚀 下一步操作

1. **运行完整测试**：
   ```bash
   bash scripts/test_frontend_build.sh
   ```

2. **浏览器验证**：
   - 访问 `http://localhost:4173`
   - 检查控制台和网络请求

3. **如果测试通过**：
   - 可以继续部署到生产环境
   - 或构建 Docker 镜像

---

**最后更新**: 2025-12-04
