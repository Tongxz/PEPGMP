# 阶段二和阶段三接口灰度发布计划

## 日期
2025-10-31

## 概述

本计划详细说明阶段二（中优先级读操作接口）和阶段三（写操作接口）的灰度发布步骤和验证方法。

## 📋 灰度发布计划

### 阶段二接口（读操作）- 3个接口

**接口列表**:
1. `GET /api/v1/system/info` - 系统信息接口
2. `GET /api/v1/alerts/history-db` - 告警历史接口
3. `GET /api/v1/alerts/rules` - 告警规则列表接口

**灰度发布步骤**:

| 步骤 | 灰度比例 | 持续时间 | 验证内容 |
|------|----------|----------|----------|
| 1 | 10% | 30分钟 | 功能验证、错误率监控 |
| 2 | 25% | 1小时 | 性能对比、稳定性监控 |
| 3 | 50% | 2小时 | 全量功能验证、性能监控 |
| 4 | 100% | 持续 | 全量发布、持续监控 |

### 阶段三接口（写操作）- 3个接口

**接口列表**:
1. `POST /api/v1/cameras` - 创建摄像头接口
2. `PUT /api/v1/cameras/{camera_id}` - 更新摄像头接口
3. `DELETE /api/v1/cameras/{camera_id}` - 删除摄像头接口

**灰度发布步骤**（更谨慎）:

| 步骤 | 灰度比例 | 持续时间 | 验证内容 |
|------|----------|----------|----------|
| 1 | 5% | 1小时 | 功能验证、数据一致性检查 |
| 2 | 10% | 2小时 | 性能对比、错误率监控 |
| 3 | 25% | 4小时 | 全量功能验证、稳定性监控 |
| 4 | 50% | 8小时 | 性能监控、数据一致性验证 |
| 5 | 100% | 持续 | 全量发布、持续监控 |

## 🔧 灰度发布操作步骤

### 步骤1: 10%灰度（阶段二接口）

```bash
# 设置环境变量
export USE_DOMAIN_SERVICE=true
export ROLLOUT_PERCENT=10

# 重启后端服务（如果需要）
# ...

# 验证灰度发布
bash tools/rollout_phase2_3.sh

# 监控指标
# - 错误率
# - 响应时间
# - 领域服务使用率
```

**验证内容**:
- ✅ 接口功能正常
- ✅ 响应结构正确
- ✅ 错误率 < 1%
- ✅ 响应时间无明显增加

**观察时间**: 30分钟

### 步骤2: 25%灰度（阶段二接口）

```bash
# 提升灰度比例
export ROLLOUT_PERCENT=25

# 重启后端服务（如果需要）
# ...

# 验证灰度发布
bash tools/rollout_phase2_3.sh
```

**验证内容**:
- ✅ 功能验证
- ✅ 性能对比（新旧实现）
- ✅ 稳定性监控

**观察时间**: 1小时

### 步骤3: 50%灰度（阶段二接口）

```bash
# 提升灰度比例
export ROLLOUT_PERCENT=50

# 重启后端服务（如果需要）
# ...

# 验证灰度发布
bash tools/rollout_phase2_3.sh
```

**验证内容**:
- ✅ 全量功能验证
- ✅ 性能监控
- ✅ 错误率监控

**观察时间**: 2小时

### 步骤4: 100%全量发布（阶段二接口）

```bash
# 全量发布
export ROLLOUT_PERCENT=100

# 重启后端服务（如果需要）
# ...

# 验证全量发布
bash tools/rollout_phase2_3.sh
```

**验证内容**:
- ✅ 全量功能验证
- ✅ 性能验证
- ✅ 持续监控

### 步骤5: 阶段三接口灰度发布（5%）

**前提条件**: 阶段二接口灰度发布成功且稳定

```bash
# 设置5%灰度（写操作需要更谨慎）
export ROLLOUT_PERCENT=5

# 验证灰度发布
bash tools/rollout_phase2_3.sh
```

**验证内容**:
- ✅ 功能验证
- ✅ 数据一致性检查（数据库和YAML同步）
- ✅ 错误率监控

**观察时间**: 1小时

### 步骤6: 阶段三接口灰度发布（10%）

```bash
# 提升灰度比例
export ROLLOUT_PERCENT=10

# 验证灰度发布
bash tools/rollout_phase2_3.sh
```

**验证内容**:
- ✅ 功能验证
- ✅ 性能对比
- ✅ 错误率监控

**观察时间**: 2小时

### 步骤7: 阶段三接口灰度发布（25%）

```bash
# 提升灰度比例
export ROLLOUT_PERCENT=25

# 验证灰度发布
bash tools/rollout_phase2_3.sh
```

**验证内容**:
- ✅ 全量功能验证
- ✅ 稳定性监控
- ✅ 数据一致性验证

**观察时间**: 4小时

### 步骤8: 阶段三接口灰度发布（50%）

```bash
# 提升灰度比例
export ROLLOUT_PERCENT=50

# 验证灰度发布
bash tools/rollout_phase2_3.sh
```

**验证内容**:
- ✅ 性能监控
- ✅ 数据一致性验证
- ✅ 错误率监控

**观察时间**: 8小时

### 步骤9: 阶段三接口全量发布（100%）

```bash
# 全量发布
export ROLLOUT_PERCENT=100

# 验证全量发布
bash tools/rollout_phase2_3.sh
```

**验证内容**:
- ✅ 全量功能验证
- ✅ 性能验证
- ✅ 持续监控

## 📊 监控指标

### 关键指标

1. **错误率**
   - 目标: < 1%
   - 阈值: 如果错误率 > 5%，立即回退

2. **响应时间**
   - 目标: P95延迟无明显增加
   - 阈值: 如果P95延迟增加 > 50%，需要检查

3. **成功率**
   - 目标: > 99%
   - 阈值: 如果成功率 < 95%，立即回退

4. **领域服务使用率**
   - 目标: 与ROLLOUT_PERCENT匹配
   - 允许误差: ±10%

### 数据一致性（写操作）

对于写操作接口，需要特别关注：

1. **数据库和YAML同步**
   - 验证创建/更新/删除操作是否正确同步到数据库和YAML文件

2. **事务完整性**
   - 验证操作是否具有原子性
   - 验证失败回滚是否正常

3. **数据完整性**
   - 验证数据是否正确保存
   - 验证数据是否正确更新

## 🚨 回退方案

### 回退条件

如果出现以下情况，立即回退：

1. 错误率 > 5%
2. 成功率 < 95%
3. P95延迟增加 > 50%
4. 数据不一致
5. 严重业务影响

### 回退步骤

```bash
# 关闭领域服务
export USE_DOMAIN_SERVICE=false

# 或设置灰度比例为0
export ROLLOUT_PERCENT=0

# 重启后端服务（如果需要）
# ...
```

## ✅ 验证清单

### 阶段二接口（读操作）

- [ ] 10%灰度验证通过
- [ ] 25%灰度验证通过
- [ ] 50%灰度验证通过
- [ ] 100%全量发布验证通过
- [ ] 性能对比正常
- [ ] 错误率监控正常
- [ ] 响应时间监控正常

### 阶段三接口（写操作）

- [ ] 5%灰度验证通过
- [ ] 10%灰度验证通过
- [ ] 25%灰度验证通过
- [ ] 50%灰度验证通过
- [ ] 100%全量发布验证通过
- [ ] 数据一致性验证通过
- [ ] 事务完整性验证通过
- [ ] 性能监控正常
- [ ] 错误率监控正常

## 📈 成功标准

### 阶段二接口

- ✅ 功能验证100%通过
- ✅ 错误率 < 1%
- ✅ 性能无明显下降
- ✅ 响应时间稳定

### 阶段三接口

- ✅ 功能验证100%通过
- ✅ 数据一致性100%正确
- ✅ 错误率 < 1%
- ✅ 性能无明显下降
- ✅ 事务完整性100%正确

## 🎯 总结

本计划详细说明了阶段二和阶段三接口的灰度发布步骤。建议按照计划逐步推进，确保每个阶段都经过充分验证后再进入下一阶段。

---

**状态**: ✅ **计划已制定**  
**下一步**: 开始10%灰度发布验证

