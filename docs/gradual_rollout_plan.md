# 灰度发布计划

## 日期
2025-10-31

## 📊 灰度发布概述

### 发布范围

**告警规则写操作**（2个端点）:
- `POST /api/v1/alerts/rules` - 创建告警规则
- `PUT /api/v1/alerts/rules/{rule_id}` - 更新告警规则

**摄像头操作端点**（11个端点）:
- `POST /api/v1/cameras/{camera_id}/start` - 启动摄像头
- `POST /api/v1/cameras/{camera_id}/stop` - 停止摄像头
- `POST /api/v1/cameras/{camera_id}/restart` - 重启摄像头
- `GET /api/v1/cameras/{camera_id}/status` - 获取状态
- `POST /api/v1/cameras/batch-status` - 批量状态查询
- `POST /api/v1/cameras/{camera_id}/activate` - 激活摄像头
- `POST /api/v1/cameras/{camera_id}/deactivate` - 停用摄像头
- `PUT /api/v1/cameras/{camera_id}/auto-start` - 切换自动启动
- `GET /api/v1/cameras/{camera_id}/logs` - 获取日志
- `POST /api/v1/cameras/refresh` - 刷新所有摄像头

**总计**: 13个端点

## 🎯 灰度发布策略

### 灰度比例控制

**方法**: 使用 `ROLLOUT_PERCENT` 环境变量控制灰度比例

**实现**: 在 `src/api/utils/rollout.py` 中的 `should_use_domain` 函数

**控制逻辑**:
- `ROLLOUT_PERCENT=10`: 10% 的请求使用新实现
- `ROLLOUT_PERCENT=25`: 25% 的请求使用新实现
- `ROLLOUT_PERCENT=50`: 50% 的请求使用新实现
- `ROLLOUT_PERCENT=100`: 100% 的请求使用新实现

### 灰度发布阶段

**阶段一：10%灰度** (1-2天)
- 目标: 小范围验证
- 配置: `ROLLOUT_PERCENT=10`
- 监控: 密切监控错误率和性能
- 验证: 功能正确性验证

**阶段二：25%灰度** (3-5天)
- 目标: 扩大范围
- 配置: `ROLLOUT_PERCENT=25`
- 监控: 继续监控
- 验证: 修复发现的问题

**阶段三：50%灰度** (1周)
- 目标: 半数用户
- 配置: `ROLLOUT_PERCENT=50`
- 监控: 深入验证
- 验证: 准备全量发布

**阶段四：100%全量** (1-2周)
- 目标: 所有用户使用新实现
- 配置: `ROLLOUT_PERCENT=100`
- 监控: 持续监控
- 验证: 稳定运行

## 📋 灰度发布检查清单

### 发布前检查

- [x] 代码集成完成 ✅
- [x] 单元测试通过 ✅
- [x] 集成测试通过 ✅
- [x] 功能对比测试通过 ✅
- [x] 灰度开关验证通过 ✅
- [x] 回滚机制验证通过 ✅
- [x] 监控端点可用 ✅
- [x] 监控配置完成 ✅

### 发布过程检查

- [ ] 10%灰度启动
- [ ] 监控错误率和性能
- [ ] 验证功能正确性
- [ ] 收集用户反馈
- [ ] 准备提升到25%

### 发布后检查

- [ ] 错误率正常（< 1%）
- [ ] 响应时间正常（无显著增加）
- [ ] 成功率正常（> 99%）
- [ ] 领域服务使用率符合预期
- [ ] 无用户投诉

## 🚀 灰度发布执行步骤

### 阶段一：10%灰度发布

**时间**: Day 1-2

**步骤**:
1. **配置环境变量**
   ```bash
   export USE_DOMAIN_SERVICE=true
   export ROLLOUT_PERCENT=10
   ```

2. **重启后端服务**
   ```bash
   # 停止当前服务
   pkill -f "uvicorn.*app:app"
   
   # 启动服务（已配置环境变量）
   source venv/bin/activate
   export DATABASE_URL="postgresql://..."
   export REDIS_URL="redis://..."
   export USE_DOMAIN_SERVICE=true
   export ROLLOUT_PERCENT=10
   python -m uvicorn src.api.app:app --host 0.0.0.0 --port 8000 --reload
   ```

3. **验证灰度生效**
   ```bash
   # 检查环境变量
   ./tools/rollout_preparation_check.sh
   
   # 测试端点（可能使用新实现，概率10%）
   curl "http://localhost:8000/api/v1/alerts/rules"
   ```

4. **监控指标**
   ```bash
   # 查看监控指标
   curl "http://localhost:8000/api/v1/monitoring/metrics" | jq
   ```

5. **观察时间**: 1-2天

**监控指标**:
- 错误率: 目标 < 1%
- 响应时间: P95延迟无明显增加
- 成功率: 目标 > 99%
- 领域服务使用率: 约10%

**决策标准**:
- ✅ 错误率 < 1%
- ✅ 响应时间无显著增加
- ✅ 成功率 > 99%
- ✅ 无用户投诉

**如果通过**: 继续提升到25%

**如果未通过**: 
- 分析问题原因
- 修复问题
- 重新10%灰度或回滚

### 阶段二：25%灰度发布

**时间**: Day 3-7

**步骤**:
1. **提升灰度比例**
   ```bash
   export ROLLOUT_PERCENT=25
   # 重启服务
   ```

2. **继续监控和验证**

3. **观察时间**: 3-5天

**监控指标**:
- 错误率: 目标 < 1%
- 响应时间: P95延迟无明显增加
- 成功率: 目标 > 99%
- 领域服务使用率: 约25%

**决策标准**: 同阶段一

**如果通过**: 继续提升到50%

### 阶段三：50%灰度发布

**时间**: Week 2

**步骤**:
1. **提升灰度比例**
   ```bash
   export ROLLOUT_PERCENT=50
   # 重启服务
   ```

2. **深入验证**

3. **观察时间**: 1周

**监控指标**:
- 错误率: 目标 < 1%
- 响应时间: P95延迟无明显增加
- 成功率: 目标 > 99%
- 领域服务使用率: 约50%

**决策标准**: 同阶段一

**如果通过**: 继续提升到100%

### 阶段四：100%全量发布

**时间**: Week 3-4

**步骤**:
1. **全量发布**
   ```bash
   export ROLLOUT_PERCENT=100
   # 重启服务
   ```

2. **持续监控**

3. **观察时间**: 1-2周

**监控指标**:
- 错误率: 目标 < 1%
- 响应时间: P95延迟无明显增加
- 成功率: 目标 > 99%
- 领域服务使用率: 100%

**决策标准**: 同阶段一

**如果通过**: 灰度发布完成

## 📊 监控指标

### 关键指标

1. **错误率**
   - 目标: < 1%
   - 阈值: > 5% 立即告警
   - 监控: 实时

2. **响应时间**
   - 目标: P95延迟无明显增加
   - 阈值: > 50% 需要检查
   - 监控: 实时

3. **成功率**
   - 目标: > 99%
   - 阈值: < 95% 立即告警
   - 监控: 实时

4. **领域服务使用率**
   - 目标: 符合灰度比例
   - 监控: 实时

### 监控端点

- `GET /api/v1/monitoring/health` - 健康检查
- `GET /api/v1/monitoring/metrics` - 监控指标

### 监控脚本

```bash
# 查看监控指标
curl "http://localhost:8000/api/v1/monitoring/metrics" | jq

# 查看健康检查
curl "http://localhost:8000/api/v1/monitoring/health" | jq
```

## 🚨 回滚方案

### 回滚触发条件

以下情况应立即回滚：
- 错误率 > 5%
- 成功率 < 95%
- P95延迟增加 > 50%
- 发现严重功能问题
- 数据一致性问题

### 回滚方法

**方法一：环境变量回滚**（全局生效）
```bash
export USE_DOMAIN_SERVICE=false
export ROLLOUT_PERCENT=0
# 重启后端服务
```

**方法二：查询参数回滚**（即时生效）
```bash
# 在请求中添加 force_domain=false
curl "http://localhost:8000/api/v1/alerts/rules?force_domain=false"
```

**回滚脚本**:
```bash
source /tmp/quick_rollback.sh
# 然后重启后端服务
```

### 回滚验证

回滚后应验证：
- [ ] 所有端点使用旧实现
- [ ] 功能正常
- [ ] 错误率恢复正常
- [ ] 性能恢复正常

## 📈 预期结果

### 成功指标

- ✅ 错误率 < 1%
- ✅ 响应时间无显著增加
- ✅ 成功率 > 99%
- ✅ 领域服务使用率符合预期
- ✅ 无用户投诉
- ✅ 功能正确性验证通过

### 风险控制

- ✅ 灰度发布可随时回滚
- ✅ 监控指标实时跟踪
- ✅ 问题及时发现和处理
- ✅ 逐步扩大范围，降低风险

## 💡 执行建议

### 立即执行（今天）

1. **启动10%灰度发布** ⭐⭐⭐
   - 配置环境变量
   - 重启后端服务
   - 验证灰度生效

2. **监控指标** ⭐⭐⭐
   - 实时监控错误率和性能
   - 验证功能正确性

### 本周执行（Day 1-5）

1. **10%灰度观察** (1-2天)
   - 密切监控
   - 收集反馈

2. **提升到25%灰度** (Day 3-7)
   - 继续监控
   - 修复问题

### 下周执行（Week 2）

1. **50%灰度发布** (1周)
   - 深入验证
   - 准备全量发布

2. **100%全量发布** (Week 3-4)
   - 所有用户使用新实现
   - 持续监控

## ✅ 总结

### 灰度发布计划

- ✅ **准备完成**: 所有检查和验证已完成
- ✅ **监控配置**: 监控端点和指标已配置
- ✅ **回滚方案**: 回滚机制已验证

### 执行步骤

1. **10%灰度发布** (1-2天) - 立即执行
2. **25%灰度发布** (3-5天) - 本周执行
3. **50%灰度发布** (1周) - 下周执行
4. **100%全量发布** (1-2周) - 后续执行

### 关键要点

- ✅ 逐步扩大范围
- ✅ 密切监控指标
- ✅ 及时处理问题
- ✅ 可随时回滚

---

**状态**: ⏳ **准备开始灰度发布**  
**下一步**: 启动10%灰度发布  
**详细计划**: 请查看本文档

