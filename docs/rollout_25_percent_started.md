# 25%灰度发布已启动

## 日期
2025-10-31

## 📊 灰度发布状态

### ✅ 已提升

**灰度比例**: 25%（从10%提升）

**环境变量**:
- `USE_DOMAIN_SERVICE=true`
- `ROLLOUT_PERCENT=25`

**发布端点**: 13个端点
- 告警规则写操作: 2个端点
- 摄像头操作端点: 11个端点

### ⏳ 观察期

**时间**: 3-5天

**监控指标**:
- 错误率: 目标 < 1%
- 响应时间: P95延迟无明显增加
- 成功率: 目标 > 99%
- 领域服务使用率: 约25%

## 📋 监控检查清单

### 立即检查（今天）

- [ ] 服务正常运行
- [ ] 监控端点可用
- [ ] 错误率正常（< 1%）
- [ ] 响应时间正常（无显著增加）
- [ ] 成功率正常（> 99%）

### 持续监控（3-5天）

- [ ] 每小时检查错误率
- [ ] 每小时检查响应时间
- [ ] 每小时检查成功率
- [ ] 收集用户反馈
- [ ] 验证功能正确性

## 🎯 下一步行动

### 如果正常（3-5天后）

1. **提升到50%灰度**
   ```bash
   ./tools/start_rollout.sh 50
   ```

2. **继续观察1周**

### 如果异常

1. **分析问题原因**
   - 查看日志: `tail -f /tmp/backend.log`
   - 查看监控指标: `curl http://localhost:8000/api/v1/monitoring/metrics | jq`

2. **修复问题**

3. **回滚到10%或完全回滚**
   ```bash
   # 回滚到10%
   ./tools/start_rollout.sh 10

   # 或完全回滚
   source /tmp/quick_rollback.sh
   # 然后重启服务
   ```

## 📊 监控命令

### 查看监控指标
```bash
curl http://localhost:8000/api/v1/monitoring/metrics | jq
```

### 查看健康检查
```bash
curl http://localhost:8000/api/v1/monitoring/health | jq
```

### 查看日志
```bash
tail -f /tmp/backend.log
```

### 测试端点（可能使用新实现，概率25%）
```bash
curl "http://localhost:8000/api/v1/alerts/rules"
```

## 🚨 告警阈值

### 立即告警（需要回滚）

- 错误率 > 5%
- 成功率 < 95%
- P95延迟增加 > 50%
- 发现严重功能问题

### 需要关注

- 错误率 > 1%
- 成功率 < 99%
- P95延迟增加 > 20%

## 📈 灰度发布进度

### 已完成阶段

- ✅ **10%灰度发布**: 已完成（1-2天观察期）
- ✅ **25%灰度发布**: 已启动

### 待完成阶段

- ⏳ **50%灰度发布**: 待执行（3-5天后）
- ⏳ **100%全量发布**: 待执行（Week 3-4）

## ✅ 总结

### 当前状态

- ✅ **灰度发布已提升**: 25%
- ✅ **服务正常运行**: 已验证
- ⏳ **观察期**: 3-5天
- ⏳ **监控中**: 持续监控指标

### 下一步

1. **持续监控** (3-5天)
   - 监控错误率和性能
   - 收集用户反馈
   - 验证功能正确性

2. **决策** (3-5天后)
   - 如果正常: 提升到50%灰度
   - 如果异常: 分析并修复，或回滚到10%

---

**状态**: ✅ **25%灰度发布已启动**
**观察期**: 3-5天
**下一步**: 持续监控，准备提升到50%
**详细计划**: 请查看 `docs/gradual_rollout_plan.md`
