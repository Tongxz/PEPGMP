# ç³»ç»Ÿæ¶æ„æ·±åº¦åˆ†æ - å¯åŠ¨æ£€æµ‹å®Œæ•´æµç¨‹

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¶æ„æ€»è§ˆ](#ç³»ç»Ÿæ¶æ„æ€»è§ˆ)
2. [å¯åŠ¨æ£€æµ‹å®Œæ•´æµç¨‹](#å¯åŠ¨æ£€æµ‹å®Œæ•´æµç¨‹)
3. [å‰ç«¯æ¨¡å—è¯¦è§£](#å‰ç«¯æ¨¡å—è¯¦è§£)
4. [åç«¯æ¨¡å—è¯¦è§£](#åç«¯æ¨¡å—è¯¦è§£)
5. [æ£€æµ‹æ‰§è¡Œæ¨¡å—è¯¦è§£](#æ£€æµ‹æ‰§è¡Œæ¨¡å—è¯¦è§£)
6. [æ•°æ®æµåˆ†æ](#æ•°æ®æµåˆ†æ)
7. [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)

---

## ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### ğŸ—ï¸ æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æµè§ˆå™¨                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Vue 3 å‰ç«¯åº”ç”¨ (Port: 5173)              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚  Views  â”‚â†’ â”‚  Stores  â”‚â†’ â”‚  API Services  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚(UIå±‚)   â”‚  â”‚(çŠ¶æ€ç®¡ç†)â”‚  â”‚  (HTTPè¯·æ±‚)    â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP/WebSocket
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI åç«¯æœåŠ¡ (Port: 8000)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   API è·¯ç”±å±‚                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚ Cameras  â”‚  â”‚Security â”‚  â”‚ Statistics   â”‚       â”‚    â”‚
â”‚  â”‚  â”‚ Router   â”‚  â”‚Middlewareâ”‚  â”‚ Router       â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  æœåŠ¡å±‚                               â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚Process       â”‚  â”‚Detection   â”‚  â”‚Region     â”‚   â”‚    â”‚
â”‚  â”‚  â”‚Manager       â”‚  â”‚Service     â”‚  â”‚Service    â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ subprocess.Popen
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ£€æµ‹å­è¿›ç¨‹ (ç‹¬ç«‹Pythonè¿›ç¨‹)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  main.py                              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚  run_detection()                            â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â”œâ”€ åŠ è½½é…ç½®                              â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â”œâ”€ åˆå§‹åŒ–æ£€æµ‹ç®¡çº¿                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â””â”€ _run_detection_loop()                â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              OptimizedDetectionPipeline              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚   Human     â”‚â†’â”‚   Hairnet    â”‚â†’â”‚  Behavior   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  Detector   â”‚ â”‚   Detector   â”‚ â”‚ Recognizer  â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
                    è§†é¢‘æº/æ‘„åƒå¤´
```

---

## å¯åŠ¨æ£€æµ‹å®Œæ•´æµç¨‹

### ğŸ”„ æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant V as Vueç»„ä»¶
    participant S as Pinia Store
    participant A as API Service
    participant R as FastAPI Router
    participant PM as ProcessManager
    participant SP as æ£€æµ‹å­è¿›ç¨‹
    participant P as DetectionPipeline
    participant C as æ‘„åƒå¤´/è§†é¢‘

    U->>V: 1. ç‚¹å‡»"å¯åŠ¨"æŒ‰é’®
    V->>V: 2. startCamera(id)
    V->>S: 3. cameraStore.startCamera(id)
    S->>A: 4. cameraApi.startCamera(id)
    A->>R: 5. POST /api/v1/cameras/{id}/start
    R->>R: 6. éªŒè¯æƒé™å’Œå‚æ•°
    R->>PM: 7. process_manager.start(id)
    PM->>PM: 8. è¯»å–æ‘„åƒå¤´é…ç½®
    PM->>PM: 9. æ„å»ºå¯åŠ¨å‘½ä»¤
    PM->>SP: 10. subprocess.Popen(cmd)
    SP->>SP: 11. main.py å…¥å£
    SP->>SP: 12. run_detection()
    SP->>SP: 13. åŠ è½½é…ç½®æ–‡ä»¶
    SP->>SP: 14. åˆå§‹åŒ–æ£€æµ‹å™¨
    SP->>P: 15. åˆ›å»º DetectionPipeline
    P->>P: 16. åˆå§‹åŒ–å„æ£€æµ‹æ¨¡å—
    SP->>SP: 17. _run_detection_loop()
    SP->>C: 18. æ‰“å¼€è§†é¢‘æº
    loop æ£€æµ‹å¾ªç¯
        SP->>C: 19. è¯»å–å¸§
        SP->>P: 20. pipeline.detect()
        P->>P: 21. äººä½“æ£€æµ‹
        P->>P: 22. å‘ç½‘æ£€æµ‹
        P->>P: 23. è¡Œä¸ºè¯†åˆ«
        P-->>SP: 24. è¿”å›æ£€æµ‹ç»“æœ
        SP->>SP: 25. ç»Ÿè®¡&æ—¥å¿—
    end
    PM-->>R: 26. è¿”å›è¿›ç¨‹ä¿¡æ¯
    R-->>A: 27. JSONå“åº”
    A-->>S: 28. è§£æå“åº”
    S->>S: 29. æ›´æ–°çŠ¶æ€
    S-->>V: 30. è§¦å‘UIæ›´æ–°
    V->>U: 31. æ˜¾ç¤º"è¿è¡Œä¸­"
```

---

## å‰ç«¯æ¨¡å—è¯¦è§£

### ğŸ“± 1. è§†å›¾å±‚ (Views)

#### **æ–‡ä»¶**: `frontend/src/views/CameraConfig.vue`

**åŠŸèƒ½**: æ‘„åƒå¤´ç®¡ç†ç•Œé¢

**å…³é”®ä»£ç **:

```vue
<!-- æ¨¡æ¿éƒ¨åˆ† -->
<template>
  <!-- æ‘„åƒå¤´åˆ—è¡¨è¡¨æ ¼ -->
  <n-data-table :columns="columns" :data="filteredCameras" />
</template>

<script setup lang="ts">
// è¡¨æ ¼åˆ—å®šä¹‰
const columns = [
  // ... å…¶ä»–åˆ—
  {
    title: 'æ“ä½œ',
    key: 'actions',
    width: 350,
    render: (row: any) => {
      return h(NSpace, { size: 'small' }, {
        default: () => [
          // æŸ¥çœ‹ç»Ÿè®¡æŒ‰é’®
          h(NButton, {
            size: 'small',
            type: 'info',
            onClick: () => openStatsModal(row.id)
          }, { default: () => 'æŸ¥çœ‹ç»Ÿè®¡' }),
          
          // å¯åŠ¨æŒ‰é’® â­ å…³é”®ç‚¹1
          h(NButton, {
            size: 'small',
            type: 'primary',
            loading: loading.value,
            onClick: () => startCamera(row.id)  // è§¦å‘å¯åŠ¨
          }, { default: () => 'å¯åŠ¨' }),
          
          // åœæ­¢æŒ‰é’®
          h(NButton, {
            size: 'small',
            type: 'default',
            loading: loading.value,
            onClick: () => stopCamera(row.id)
          }, { default: () => 'åœæ­¢' }),
        ]
      })
    }
  }
]

// å¯åŠ¨æ‘„åƒå¤´å‡½æ•° â­ å…³é”®ç‚¹2
async function startCamera(id: string) {
  try {
    loading.value = true
    // è°ƒç”¨ Pinia Store çš„æ–¹æ³•
    await cameraStore.startCamera(id)
    message.success('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ')
  } catch (error: any) {
    message.error('å¯åŠ¨å¤±è´¥: ' + (error.message || error))
  } finally {
    loading.value = false
  }
}
</script>
```

**æ‰§è¡Œæµç¨‹**:
1. ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨"æŒ‰é’®
2. è§¦å‘ `onClick: () => startCamera(row.id)`
3. æ‰§è¡Œ `startCamera` å‡½æ•°
4. è®¾ç½® `loading.value = true` (æ˜¾ç¤ºåŠ è½½åŠ¨ç”»)
5. è°ƒç”¨ Store å±‚çš„ `cameraStore.startCamera(id)`
6. ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
7. æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥æ¶ˆæ¯
8. è®¾ç½® `loading.value = false` (éšè—åŠ è½½åŠ¨ç”»)

---

### ğŸ“¦ 2. çŠ¶æ€ç®¡ç†å±‚ (Stores)

#### **æ–‡ä»¶**: `frontend/src/stores/camera.ts`

**åŠŸèƒ½**: ç®¡ç†æ‘„åƒå¤´çŠ¶æ€å’Œæ•°æ®

**å…³é”®ä»£ç **:

```typescript
import { defineStore } from 'pinia'
import { ref } from 'vue'
import { cameraApi } from '@/api/camera'

export const useCameraStore = defineStore('camera', () => {
  // çŠ¶æ€
  const cameras = ref<Camera[]>([])
  const loading = ref(false)
  const error = ref('')

  // å¯åŠ¨æ‘„åƒå¤´ â­ å…³é”®ç‚¹3
  async function startCamera(id: string) {
    loading.value = true
    error.value = ''
    
    try {
      // è°ƒç”¨ API å±‚
      await cameraApi.startCamera(id)
      
      // é‡æ–°è·å–åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€ â­ å…³é”®ç‚¹4
      await fetchCameras()
    } catch (e: any) {
      error.value = e.message || 'å¯åŠ¨æ‘„åƒå¤´å¤±è´¥'
      throw e
    } finally {
      loading.value = false
    }
  }

  // è·å–æ‘„åƒå¤´åˆ—è¡¨
  async function fetchCameras() {
    try {
      const data = await cameraApi.getCameras()
      cameras.value = data
    } catch (e: any) {
      error.value = e.message || 'è·å–æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥'
    }
  }

  return {
    cameras,
    loading,
    error,
    startCamera,
    fetchCameras,
    // ... å…¶ä»–æ–¹æ³•
  }
})
```

**æ‰§è¡Œæµç¨‹**:
1. æ¥æ”¶æ¥è‡ª View å±‚çš„ `id` å‚æ•°
2. è®¾ç½® `loading = true`ï¼Œæ¸…ç©º `error`
3. è°ƒç”¨ API å±‚çš„ `cameraApi.startCamera(id)`
4. ç­‰å¾… API è¯·æ±‚å®Œæˆ
5. è°ƒç”¨ `fetchCameras()` åˆ·æ–°æ‘„åƒå¤´åˆ—è¡¨
6. æ›´æ–° Vue å“åº”å¼çŠ¶æ€
7. UI è‡ªåŠ¨æ›´æ–°ï¼ˆVue å“åº”å¼ç³»ç»Ÿï¼‰

**è®¾è®¡äº®ç‚¹**:
- é›†ä¸­ç®¡ç†çŠ¶æ€ï¼Œé¿å…ç»„ä»¶é—´æ•°æ®ä¸ä¸€è‡´
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨ï¼Œç¡®ä¿UIæ˜¾ç¤ºæœ€æ–°çŠ¶æ€

---

### ğŸŒ 3. APIæœåŠ¡å±‚ (API Services)

#### **æ–‡ä»¶**: `frontend/src/api/camera.ts`

**åŠŸèƒ½**: å°è£…HTTPè¯·æ±‚

**å…³é”®ä»£ç **:

```typescript
import { http } from '@/lib/http'

export const cameraApi = {
  /**
   * å¯åŠ¨æ‘„åƒå¤´ â­ å…³é”®ç‚¹5
   * @param id æ‘„åƒå¤´ID
   */
  async startCamera(id: string) {
    // å‘é€ POST è¯·æ±‚åˆ°åç«¯
    return await http.post(`/cameras/${encodeURIComponent(id)}/start`)
  },

  /**
   * è·å–æ‘„åƒå¤´ç»Ÿè®¡ä¿¡æ¯ (æ–°å¢)
   */
  async getCameraStats(id: string) {
    const response = await http.get(`/cameras/${encodeURIComponent(id)}/stats`)
    return response.data
  },

  /**
   * è·å–æ‘„åƒå¤´æ—¥å¿— (æ–°å¢)
   */
  async getCameraLogs(id: string, lines: number = 100) {
    const response = await http.get(`/cameras/${encodeURIComponent(id)}/logs`, {
      params: { lines }
    })
    return response.data
  }
}
```

**HTTPå®¢æˆ·ç«¯é…ç½®**: `frontend/src/lib/http.ts`

```typescript
import axios from 'axios'

// åŠ¨æ€è·å–APIåŸºç¡€URL
const baseURL = (import.meta.env.VITE_API_BASE ?? '').trim()

// åˆ›å»ºaxioså®ä¾‹
export const http = axios.create({
  baseURL,              // å¼€å‘ç¯å¢ƒ: /api/v1, ç”Ÿäº§ç¯å¢ƒ: http://server:8000/api/v1
  timeout: 15000,       // 15ç§’è¶…æ—¶
  headers: {
    'Content-Type': 'application/json'
  }
})

// è¯·æ±‚æ‹¦æˆªå™¨
http.interceptors.request.use(
  config => {
    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è®¤è¯token
    return config
  },
  error => Promise.reject(error)
)

// å“åº”æ‹¦æˆªå™¨
http.interceptors.response.use(
  response => response,
  error => {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    const message = error.response?.data?.detail || error.message
    return Promise.reject(new Error(message))
  }
)
```

**æ‰§è¡Œæµç¨‹**:
1. æ¥æ”¶ `id` å‚æ•°
2. æ„é€ è¯·æ±‚URL: `/cameras/vid1/start`
3. å®Œæ•´URL: `http://localhost:8000/api/v1/cameras/vid1/start` (å¼€å‘ç¯å¢ƒé€šè¿‡Viteä»£ç†)
4. å‘é€ POST è¯·æ±‚
5. ç­‰å¾…åç«¯å“åº”
6. è¿”å›å“åº”æ•°æ®æˆ–æŠ›å‡ºé”™è¯¯

**è®¾è®¡äº®ç‚¹**:
- URLç¼–ç é˜²æ­¢ç‰¹æ®Šå­—ç¬¦é—®é¢˜
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- ç¯å¢ƒå˜é‡é…ç½®ï¼Œæ”¯æŒå¼€å‘/ç”Ÿäº§ç¯å¢ƒ

---

## åç«¯æ¨¡å—è¯¦è§£

### ğŸ›£ï¸ 4. è·¯ç”±å±‚ (API Router)

#### **æ–‡ä»¶**: `src/api/routers/cameras.py`

**åŠŸèƒ½**: å¤„ç†HTTPè¯·æ±‚ï¼Œå®šä¹‰APIç«¯ç‚¹

**å…³é”®ä»£ç **:

```python
from fastapi import APIRouter, Path, HTTPException
from typing import Dict, Any
import logging

router = APIRouter()
logger = logging.getLogger(__name__)

@router.post("/cameras/{camera_id}/start")
def start_camera(camera_id: str = Path(...)) -> Dict[str, Any]:
    """å¯åŠ¨æŒ‡å®šæ‘„åƒå¤´çš„æ£€æµ‹è¿›ç¨‹ â­ å…³é”®ç‚¹6
    
    Args:
        camera_id: ç›®æ ‡æ‘„åƒå¤´çš„ID (ä»URLè·¯å¾„æå–)
    
    Returns:
        åŒ…å«æ“ä½œç»“æœå’Œè¿›ç¨‹ä¿¡æ¯çš„å­—å…¸
        
    Raises:
        HTTPException: å¯åŠ¨å¤±è´¥æ—¶æŠ›å‡º400é”™è¯¯
    """
    # è·å–è¿›ç¨‹ç®¡ç†å™¨å•ä¾‹
    from src.services.process_manager import get_process_manager
    pm = get_process_manager()
    
    # è°ƒç”¨è¿›ç¨‹ç®¡ç†å™¨å¯åŠ¨æ‘„åƒå¤´ â­ å…³é”®ç‚¹7
    res = pm.start(camera_id)
    
    # æ£€æŸ¥å¯åŠ¨ç»“æœ
    if not res.get("ok"):
        logger.error(f"Failed to start camera {camera_id}: {res}")
        raise HTTPException(
            status_code=400, 
            detail=res.get("error") or "Failed to start camera"
        )
    
    # è®°å½•æˆåŠŸæ—¥å¿—
    logger.info(
        f"Started camera {camera_id}: "
        f"pid={res.get('pid')} log={res.get('log')}"
    )
    
    # è¿”å›æˆåŠŸå“åº”
    return res


@router.get("/cameras/{camera_id}/stats")
def get_camera_stats(camera_id: str = Path(...)) -> Dict[str, Any]:
    """è·å–æŒ‡å®šæ‘„åƒå¤´çš„è¯¦ç»†æ£€æµ‹ç»Ÿè®¡ä¿¡æ¯ (æ–°å¢)
    
    ä»æ—¥å¿—æ–‡ä»¶ä¸­è§£ææå–ç»Ÿè®¡æ•°æ®
    """
    import re
    from pathlib import Path as FilePath
    from src.services.process_manager import get_process_manager
    
    pm = get_process_manager()
    status = pm.status(camera_id)
    
    # åˆå§‹åŒ–ç»Ÿè®¡ç»“æ„
    stats = {
        "camera_id": camera_id,
        "running": status.get("running", False),
        "pid": status.get("pid", 0),
        "log_file": status.get("log", ""),
        "stats": {
            "total_frames": 0,
            "processed_frames": 0,
            "detected_persons": 0,
            "detected_hairnets": 0,
            "detected_handwash": 0,
            "avg_fps": 0.0,
            "avg_detection_time": 0.0,
            "last_detection_time": None,
        }
    }
    
    # å¦‚æœè¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œä»æ—¥å¿—ä¸­æå–ç»Ÿè®¡ä¿¡æ¯ â­ å…³é”®ç‚¹8
    if status.get("running") and status.get("log"):
        log_path = FilePath(status["log"])
        if log_path.exists():
            try:
                with open(log_path, 'r', encoding='utf-8') as f:
                    lines = f.readlines()
                    recent_lines = lines[-100:] if len(lines) > 100 else lines
                    
                    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å…³é”®ä¿¡æ¯
                    for line in reversed(recent_lines):
                        # æå–æ£€æµ‹ç»“æœ
                        match = re.search(r'æ£€æµ‹: äºº=(\d+), å‘ç½‘=(\d+), æ´—æ‰‹=(\d+)', line)
                        if match:
                            stats["stats"]["detected_persons"] = int(match.group(1))
                            stats["stats"]["detected_hairnets"] = int(match.group(2))
                            stats["stats"]["detected_handwash"] = int(match.group(3))
                        
                        # æå–FPS
                        match_fps = re.search(r'å¤„ç†FPS: ([\d.]+)', line)
                        if match_fps:
                            stats["stats"]["avg_fps"] = float(match_fps.group(1))
                        
                        # ... å…¶ä»–ç»Ÿè®¡æ•°æ®æå–
            except Exception as e:
                logger.warning(f"Failed to parse log file for {camera_id}: {e}")
    
    return stats
```

**æ‰§è¡Œæµç¨‹**:
1. FastAPIæ¥æ”¶åˆ° `POST /api/v1/cameras/vid1/start`
2. è·¯ç”±åŒ¹é…åˆ° `start_camera` å‡½æ•°
3. ä»URLè·¯å¾„æå– `camera_id = "vid1"`
4. è°ƒç”¨ `get_process_manager()` è·å–è¿›ç¨‹ç®¡ç†å™¨
5. è°ƒç”¨ `pm.start("vid1")`
6. æ£€æŸ¥è¿”å›ç»“æœ
7. æˆåŠŸï¼šè¿”å›è¿›ç¨‹ä¿¡æ¯ï¼ˆPIDã€æ—¥å¿—è·¯å¾„ç­‰ï¼‰
8. å¤±è´¥ï¼šæŠ›å‡ºHTTP 400é”™è¯¯

**è®¾è®¡äº®ç‚¹**:
- è·¯å¾„å‚æ•°è‡ªåŠ¨æå–å’ŒéªŒè¯
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’ŒHTTPçŠ¶æ€ç 
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- ç±»å‹æ³¨è§£å¢å¼ºä»£ç å¯è¯»æ€§

---

### âš™ï¸ 5. è¿›ç¨‹ç®¡ç†å±‚ (Process Manager)

#### **æ–‡ä»¶**: `src/services/process_manager.py`

**åŠŸèƒ½**: ç®¡ç†æ£€æµ‹å­è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ

**å…³é”®ä»£ç **:

```python
import os
import subprocess
import sys
import signal
import time
from typing import Dict, Any, List
from pathlib import Path
import yaml

class ProcessManager:
    def __init__(self):
        self.project_root = Path(__file__).parent.parent.parent
        self.cameras_path = self.project_root / "config" / "cameras.yaml"
    
    def start(self, camera_id: str) -> Dict[str, Any]:
        """å¯åŠ¨æŒ‡å®šæ‘„åƒå¤´çš„æ£€æµ‹è¿›ç¨‹ â­ å…³é”®ç‚¹9
        
        Args:
            camera_id: æ‘„åƒå¤´ID
            
        Returns:
            {
                "ok": True/False,
                "running": True/False,
                "pid": è¿›ç¨‹ID,
                "log": æ—¥å¿—æ–‡ä»¶è·¯å¾„,
                "cmd": å¯åŠ¨å‘½ä»¤
            }
        """
        # 1. è¯»å–æ‘„åƒå¤´é…ç½® â­ å…³é”®ç‚¹10
        cams = self.list_cameras()
        cam = next((c for c in cams if str(c.get("id")) == str(camera_id)), None)
        
        if not cam:
            return {"ok": False, "error": "Camera not found"}
        
        # 2. æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å·²åœ¨è¿è¡Œ
        pid_path = self._pid_file(camera_id)
        if os.path.exists(pid_path):
            try:
                with open(pid_path, 'r') as f:
                    pid = int(f.read().strip() or "0")
                if self._is_process_alive(pid):
                    return {
                        "ok": True,
                        "running": True,
                        "pid": pid,
                        "log": self._log_file(camera_id),
                    }
            except Exception:
                pass
        
        # 3. æ„å»ºå¯åŠ¨å‘½ä»¤ â­ å…³é”®ç‚¹11
        cmd = self._build_command(cam)
        
        # 4. å‡†å¤‡æ—¥å¿—æ–‡ä»¶
        log_path = self._log_file(camera_id)
        stdout = open(log_path, "a", encoding="utf-8")
        stderr = stdout
        
        # 5. å¯åŠ¨å­è¿›ç¨‹ â­ å…³é”®ç‚¹12
        creationflags = 0
        if os.name == "nt":  # Windows
            creationflags = subprocess.CREATE_NEW_PROCESS_GROUP
        
        proc = subprocess.Popen(
            cmd,
            cwd=self.project_root,
            stdout=stdout,
            stderr=stderr,
            stdin=subprocess.DEVNULL,
            creationflags=creationflags,
            close_fds=(os.name != "nt"),
        )
        
        # 6. ä¿å­˜PID
        with open(pid_path, "w") as pf:
            pf.write(str(proc.pid))
        
        # 7. è¿”å›æˆåŠŸä¿¡æ¯
        return {
            "ok": True,
            "running": True,
            "pid": proc.pid,
            "log": log_path,
            "cmd": cmd,
        }
    
    def _build_command(self, cam: Dict[str, Any]) -> List[str]:
        """æ„å»ºæ£€æµ‹è¿›ç¨‹å¯åŠ¨å‘½ä»¤ â­ å…³é”®ç‚¹13
        
        æ ¹æ®æ‘„åƒå¤´é…ç½®ç”Ÿæˆå®Œæ•´çš„å‘½ä»¤è¡Œå‚æ•°
        """
        python_exe = sys.executable  # å½“å‰Pythonè§£é‡Šå™¨è·¯å¾„
        main_py = self.project_root / "main.py"
        
        # æå–é…ç½®å‚æ•°
        camera_id = str(cam.get("id"))
        source = str(cam.get("source"))
        regions_file = str(cam.get("regions_file", "config/regions.json"))
        profile = str(cam.get("profile", "accurate"))
        device = str(cam.get("device", "auto"))
        imgsz = str(cam.get("imgsz", "auto"))
        
        # æ„å»ºå‘½ä»¤
        cmd = [
            python_exe,
            str(main_py),
            "--mode", "detection",
            "--source", source,
            "--regions-file", regions_file,
            "--profile", profile,
            "--camera-id", camera_id,
        ]
        
        # å¯é€‰å‚æ•°
        if device and device != "auto":
            cmd += ["--device", device]
        if imgsz and imgsz != "auto":
            cmd += ["--imgsz", str(imgsz)]
        
        # æ—¥å¿—é™æµï¼šæ¯120å¸§è¾“å‡ºä¸€æ¬¡
        cmd += ["--log-interval", "120"]
        
        return cmd
    
    def list_cameras(self) -> List[Dict[str, Any]]:
        """è¯»å–æ‘„åƒå¤´é…ç½®æ–‡ä»¶"""
        if not self.cameras_path.exists():
            return []
        
        with open(self.cameras_path, 'r', encoding='utf-8') as f:
            data = yaml.safe_load(f) or {}
        
        return data.get("cameras", [])
    
    def _is_process_alive(self, pid: int) -> bool:
        """æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜æ´»"""
        if pid <= 0:
            return False
        try:
            # ä¼˜å…ˆä½¿ç”¨ psutil
            import psutil
            return psutil.pid_exists(pid) and \
                   (psutil.Process(pid).status() != psutil.STATUS_ZOMBIE)
        except:
            # å›é€€åˆ° os.kill
            try:
                os.kill(pid, 0)
                return True
            except:
                return False
    
    def _pid_file(self, camera_id: str) -> str:
        """PIDæ–‡ä»¶è·¯å¾„"""
        pids_dir = self.project_root / "logs" / "pids"
        pids_dir.mkdir(parents=True, exist_ok=True)
        return str(pids_dir / f"{camera_id}.pid")
    
    def _log_file(self, camera_id: str) -> str:
        """æ—¥å¿—æ–‡ä»¶è·¯å¾„"""
        logs_dir = self.project_root / "logs"
        logs_dir.mkdir(parents=True, exist_ok=True)
        return str(logs_dir / f"detect_{camera_id}.log")


# å•ä¾‹æ¨¡å¼
_manager: ProcessManager = None

def get_process_manager() -> ProcessManager:
    """è·å–è¿›ç¨‹ç®¡ç†å™¨å•ä¾‹"""
    global _manager
    if _manager is None:
        _manager = ProcessManager()
    return _manager
```

**æ‰§è¡Œæµç¨‹**:

1. **è¯»å–é…ç½®** (`list_cameras()`)
   - æ‰“å¼€ `config/cameras.yaml`
   - è§£æYAMLæ–‡ä»¶
   - æŸ¥æ‰¾åŒ¹é…çš„æ‘„åƒå¤´é…ç½®

2. **æ£€æŸ¥è¿›ç¨‹çŠ¶æ€**
   - è¯»å– PID æ–‡ä»¶ `logs/pids/vid1.pid`
   - æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜æ´»
   - å¦‚å·²è¿è¡Œï¼Œç›´æ¥è¿”å›

3. **æ„å»ºå¯åŠ¨å‘½ä»¤** (`_build_command()`)
   ```bash
   /path/to/python main.py \
     --mode detection \
     --source tests/fixtures/videos/20250724072708.mp4 \
     --regions-file config/regions.json \
     --profile accurate \
     --camera-id vid1 \
     --log-interval 120
   ```

4. **å¯åŠ¨å­è¿›ç¨‹** (`subprocess.Popen`)
   - è®¾ç½®å·¥ä½œç›®å½•
   - é‡å®šå‘stdout/stderråˆ°æ—¥å¿—æ–‡ä»¶
   - è®¾ç½®è¿›ç¨‹æ ‡å¿—ï¼ˆWindowséœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
   - æ‰§è¡Œå‘½ä»¤

5. **ä¿å­˜è¿›ç¨‹ä¿¡æ¯**
   - å†™å…¥PIDåˆ°æ–‡ä»¶
   - è¿”å›è¿›ç¨‹ä¿¡æ¯

**è®¾è®¡äº®ç‚¹**:
- **è¿›ç¨‹éš”ç¦»**: æ¯ä¸ªæ‘„åƒå¤´ç‹¬ç«‹è¿›ç¨‹ï¼Œäº’ä¸å½±å“
- **å•ä¾‹æ¨¡å¼**: å…¨å±€å”¯ä¸€çš„è¿›ç¨‹ç®¡ç†å™¨å®ä¾‹
- **é”™è¯¯æ¢å¤**: æ£€æµ‹åƒµå°¸è¿›ç¨‹ï¼Œè‡ªåŠ¨æ¸…ç†
- **è·¨å¹³å°**: å…¼å®¹Windows/Linux/macOS

---

## æ£€æµ‹æ‰§è¡Œæ¨¡å—è¯¦è§£

### ğŸ¬ 6. ä¸»å…¥å£ (main.py)

#### **æ–‡ä»¶**: `main.py`

**åŠŸèƒ½**: æ£€æµ‹è¿›ç¨‹çš„å…¥å£ç‚¹

**å…³é”®ä»£ç **:

```python
#!/usr/bin/env python3
import argparse
import sys
from pathlib import Path

# æ·»åŠ srcç›®å½•åˆ°è·¯å¾„
src_path = Path(__file__).parent / "src"
sys.path.insert(0, str(src_path))

def create_argument_parser():
    """åˆ›å»ºå‘½ä»¤è¡Œå‚æ•°è§£æå™¨"""
    parser = argparse.ArgumentParser(description="äººä½“è¡Œä¸ºæ£€æµ‹ç³»ç»Ÿ")
    
    parser.add_argument(
        "--mode",
        choices=["detection", "api", "training", "demo", "supervisor"],
        default="detection",
        help="è¿è¡Œæ¨¡å¼"
    )
    parser.add_argument("--source", type=str, default="0", 
                       help="è¾“å…¥æº: æ‘„åƒå¤´ç´¢å¼•æˆ–è§†é¢‘æ–‡ä»¶è·¯å¾„")
    parser.add_argument("--camera-id", type=str, 
                       help="æ‘„åƒå¤´IDï¼ˆç”¨äºæ—¥å¿—æ ‡è¯†ï¼‰")
    parser.add_argument("--regions-file", type=str, 
                       default="config/regions.json",
                       help="åŒºåŸŸé…ç½®æ–‡ä»¶è·¯å¾„")
    parser.add_argument("--profile", type=str, 
                       default="accurate",
                       help="æ£€æµ‹é…ç½®profile")
    parser.add_argument("--device", type=str, 
                       help="è®¾å¤‡ç±»å‹: cpu/cuda/mps")
    parser.add_argument("--log-interval", type=int, default=120,
                       help="æ—¥å¿—è¾“å‡ºé—´éš”ï¼ˆå¸§æ•°ï¼‰")
    # ... æ›´å¤šå‚æ•°
    
    return parser


def main():
    """ä¸»å…¥å£å‡½æ•° â­ å…³é”®ç‚¹14"""
    # 1. è§£æå‘½ä»¤è¡Œå‚æ•°
    parser = create_argument_parser()
    args = parser.parse_args()
    
    # 2. è®¾ç½®æ—¥å¿—
    from utils.logger import setup_project_logger
    logger = setup_project_logger(
        "HumanBehaviorDetection",
        log_level=args.log_level
    )
    
    # 3. åˆå§‹åŒ–GPUåŠ é€Ÿ
    from utils.gpu_acceleration import initialize_gpu_acceleration
    gpu_status = initialize_gpu_acceleration()
    logger.info(f"GPUçŠ¶æ€: {gpu_status}")
    
    # 4. æ ¹æ®æ¨¡å¼åˆ†å‘ â­ å…³é”®ç‚¹15
    logger.info(f"è¿è¡Œæ¨¡å¼: {args.mode}")
    
    if args.mode == "detection":
        run_detection(args, logger)
    elif args.mode == "api":
        run_api_server(args, logger)
    elif args.mode == "supervisor":
        run_supervisor(args, logger)
    # ... å…¶ä»–æ¨¡å¼


def run_detection(args, logger):
    """è¿è¡Œæ£€æµ‹æ¨¡å¼ â­ å…³é”®ç‚¹16"""
    logger.info(f"å¼€å§‹æ£€æµ‹ï¼Œè¾“å…¥æº: {args.source}")
    
    # 1. åŠ è½½ç»Ÿä¸€å‚æ•°é…ç½®
    from config.unified_params import get_unified_params, load_unified_params
    effective = load_unified_params(args, logger)
    if not effective:
        return
    
    # 2. åº”ç”¨ç¡¬ä»¶è‡ªé€‚åº”ä¼˜åŒ–
    from utils.hardware_probe import apply_adaptive_optimizations
    if not apply_adaptive_optimizations(args, logger):
        logger.warning("è‡ªé€‚åº”ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
    
    # 3. é€‰æ‹©è®¾å¤‡
    device = select_device(args, logger)
    logger.info(f"Device selected: {device}")
    
    # 4. è¾“å‡ºé…ç½®æ‘˜è¦
    hd = effective.get("human_detection", {})
    weights = hd.get("model_path", "models/yolo/yolov8m.pt")
    logger.info(f"é…ç½®æ‘˜è¦: device={device}, weights={weights}")
    
    # 5. åˆå§‹åŒ–æ£€æµ‹å™¨ â­ å…³é”®ç‚¹17
    try:
        from src.core.behavior import BehaviorRecognizer
        from src.core.optimized_detection_pipeline import OptimizedDetectionPipeline
        from src.detection.detector import HumanDetector
        from src.detection.pose_detector import PoseDetectorFactory
        from src.detection.yolo_hairnet_detector import YOLOHairnetDetector
        
        # äººä½“æ£€æµ‹å™¨
        human_detector = HumanDetector(model_path=weights, device=device)
        
        # å§¿æ€æ£€æµ‹å™¨
        params = get_unified_params()
        pose_backend = params.pose_detection.backend
        if pose_backend == "auto":
            pose_backend = "yolov8" if str(device).lower() == "cuda" else "mediapipe"
        
        pose_detector = PoseDetectorFactory.create(
            backend=pose_backend,
            device=device
        )
        logger.info(f"å§¿æ€æ£€æµ‹å™¨åç«¯: {pose_backend}, è®¾å¤‡: {device}")
        
        # è¡Œä¸ºè¯†åˆ«å™¨
        behavior_recognizer = BehaviorRecognizer()
        
        # å‘ç½‘æ£€æµ‹å™¨
        hairnet_detector = YOLOHairnetDetector(device=device)
        
        # 6. åˆ›å»ºä¼˜åŒ–æ£€æµ‹ç®¡çº¿ â­ å…³é”®ç‚¹18
        cascade_cfg = effective.get("cascade", {})
        
        pipeline = OptimizedDetectionPipeline(
            human_detector=human_detector,
            hairnet_detector=hairnet_detector,
            behavior_recognizer=behavior_recognizer,
            pose_detector=pose_detector,
            enable_cache=True,        # å¯ç”¨ç¼“å­˜
            cache_size=50,             # ç¼“å­˜50å¸§
            cache_ttl=20.0,            # ç¼“å­˜20ç§’
            cascade_config=cascade_cfg
        )
        
        logger.info("æ£€æµ‹ç®¡çº¿åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹å¤„ç†...")
        
        # 7. æ‰§è¡Œæ£€æµ‹å¾ªç¯ â­ å…³é”®ç‚¹19
        _run_detection_loop(args, logger, pipeline, device)
        
    except Exception as e:
        logger.error(f"æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        if args.debug:
            import traceback
            traceback.print_exc()


def _run_detection_loop(args, logger, pipeline, device):
    """æ‰§è¡Œè§†é¢‘æ£€æµ‹å¾ªç¯ â­ å…³é”®ç‚¹20
    
    è¿™æ˜¯æ£€æµ‹çš„æ ¸å¿ƒå¾ªç¯ï¼Œè´Ÿè´£ï¼š
    1. æ‰“å¼€è§†é¢‘æº
    2. å¾ªç¯è¯»å–å¸§
    3. è°ƒç”¨æ£€æµ‹ç®¡çº¿
    4. ç»Ÿè®¡å’Œæ—¥å¿—
    5. ä¼˜é›…é€€å‡º
    """
    import signal
    import cv2
    import time
    
    # 1. è®¾ç½®ä¿¡å·å¤„ç†å™¨ â­ å…³é”®ç‚¹21
    shutdown_requested = {"flag": False}
    
    def signal_handler(signum, frame):
        """å¤„ç†é€€å‡ºä¿¡å·"""
        logger.info(f"æ”¶åˆ°ä¿¡å· {signum}ï¼Œå‡†å¤‡é€€å‡º...")
        shutdown_requested["flag"] = True
    
    signal.signal(signal.SIGTERM, signal_handler)
    signal.signal(signal.SIGINT, signal_handler)
    
    # 2. æ‰“å¼€è§†é¢‘æº â­ å…³é”®ç‚¹22
    source = args.source
    try:
        source = int(source)  # å°è¯•è½¬æ¢ä¸ºæ•´æ•°ï¼ˆæ‘„åƒå¤´ç´¢å¼•ï¼‰
    except (ValueError, TypeError):
        pass  # ä¿æŒä¸ºå­—ç¬¦ä¸²ï¼ˆæ–‡ä»¶è·¯å¾„ï¼‰
    
    cap = cv2.VideoCapture(source)
    if not cap.isOpened():
        logger.error(f"æ— æ³•æ‰“å¼€è§†é¢‘æº: {args.source}")
        return
    
    # 3. è·å–è§†é¢‘ä¿¡æ¯
    fps = int(cap.get(cv2.CAP_PROP_FPS)) or 30
    width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
    height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))
    total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
    
    logger.info(
        f"è§†é¢‘ä¿¡æ¯: {width}x{height} @ {fps}FPS, "
        f"æ€»å¸§æ•°: {total_frames if total_frames > 0 else 'æœªçŸ¥(å®æ—¶æµ)'}"
    )
    
    # 4. è®¾ç½®æ—¥å¿—é—´éš”ï¼ˆå¸§è·³è¿‡ï¼‰
    log_interval = getattr(args, 'log_interval', None) or 1
    if log_interval > 1:
        logger.info(f"å¯ç”¨å¸§è·³è¿‡: æ¯ {log_interval} å¸§å¤„ç† 1 å¸§")
    
    frame_count = 0
    process_count = 0
    start_time = time.time()
    last_log_time = start_time
    
    try:
        logger.info("å¼€å§‹è§†é¢‘å¤„ç†å¾ªç¯...")
        
        # 5. ä¸»æ£€æµ‹å¾ªç¯ â­ å…³é”®ç‚¹23
        while not shutdown_requested["flag"]:
            # 5.1 è¯»å–å¸§
            ret, frame = cap.read()
            if not ret:
                # è§†é¢‘æ–‡ä»¶æ’­æ”¾å®Œæˆï¼Œå¾ªç¯æ’­æ”¾ â­ å…³é”®ç‚¹24
                if total_frames > 0:
                    logger.info("è§†é¢‘æ–‡ä»¶æ’­æ”¾å®Œæˆï¼Œé‡æ–°å¼€å§‹å¾ªç¯æ’­æ”¾...")
                    cap.set(cv2.CAP_PROP_POS_FRAMES, 0)
                    frame_count = 0
                    continue
                else:
                    logger.warning("è§†é¢‘æµè¯»å–å¤±è´¥")
                    break
            
            frame_count += 1
            
            # 5.2 å¸§è·³è¿‡é€»è¾‘
            if log_interval > 1 and frame_count % log_interval != 0:
                continue
            
            process_count += 1
            detection_start = time.time()
            
            try:
                # 5.3 è°ƒç”¨æ£€æµ‹ç®¡çº¿ â­ å…³é”®ç‚¹25
                result = pipeline.detect_comprehensive(
                    frame,
                    enable_hairnet=True,
                    enable_handwash=True,
                    enable_sanitize=True
                )
                
                detection_time = time.time() - detection_start
                
                # 5.4 æå–æ£€æµ‹ç»“æœ
                person_count = len(result.person_detections)
                hairnet_count = len(result.hairnet_results)
                handwash_count = len(result.handwash_results)
                sanitize_count = len(result.sanitize_results)
                
                # 5.5 å®šæœŸæ‰“å°ç»Ÿè®¡ä¿¡æ¯
                current_time = time.time()
                should_log = (
                    process_count % 10 == 0 or 
                    (current_time - last_log_time) >= 5.0
                )
                
                if should_log:
                    elapsed = current_time - start_time
                    avg_fps = process_count / elapsed if elapsed > 0 else 0
                    progress = f"{frame_count}/{total_frames}" if total_frames > 0 else str(frame_count)
                    
                    logger.info(
                        f"å¸§ {progress} | "
                        f"æ£€æµ‹: äºº={person_count}, å‘ç½‘={hairnet_count}, "
                        f"æ´—æ‰‹={handwash_count}, æ¶ˆæ¯’={sanitize_count} | "
                        f"è€—æ—¶: {detection_time:.3f}s | "
                        f"å¤„ç†FPS: {avg_fps:.2f}"
                    )
                    last_log_time = current_time
                
            except Exception as e:
                logger.error(f"å¤„ç†ç¬¬ {frame_count} å¸§æ—¶å‡ºé”™: {e}")
                continue
        
        # 6. æ‰“å°æœ€ç»ˆç»Ÿè®¡ â­ å…³é”®ç‚¹26
        total_time = time.time() - start_time
        logger.info("=" * 60)
        logger.info("æ£€æµ‹å®Œæˆç»Ÿè®¡:")
        logger.info(f"  æ€»å¸§æ•°: {frame_count}")
        logger.info(f"  å¤„ç†å¸§æ•°: {process_count}")
        logger.info(f"  æ€»è€—æ—¶: {total_time:.2f}s")
        logger.info(f"  å¹³å‡å¤„ç†FPS: {process_count / total_time:.2f}")
        
        # ç®¡çº¿ç»Ÿè®¡
        if hasattr(pipeline, "stats"):
            logger.info(f"  ç®¡çº¿ç»Ÿè®¡: {pipeline.stats}")
        logger.info("=" * 60)
        
    except KeyboardInterrupt:
        logger.info("æ¥æ”¶åˆ°é”®ç›˜ä¸­æ–­ï¼Œæ­£åœ¨é€€å‡º...")
    
    finally:
        # 7. èµ„æºæ¸…ç†
        logger.info("é‡Šæ”¾èµ„æº...")
        cap.release()
        cv2.destroyAllWindows()
        logger.info("èµ„æºé‡Šæ”¾å®Œæˆ")


if __name__ == "__main__":
    main()
```

**æ‰§è¡Œæµç¨‹è¯¦è§£**:

1. **å‘½ä»¤è¡Œå‚æ•°è§£æ**
   - æ¥æ”¶ä» ProcessManager ä¼ æ¥çš„å‚æ•°
   - éªŒè¯å‚æ•°åˆæ³•æ€§

2. **ç¯å¢ƒåˆå§‹åŒ–**
   - è®¾ç½®æ—¥å¿—ç³»ç»Ÿ
   - åˆå§‹åŒ–GPUåŠ é€Ÿ
   - åŠ è½½é…ç½®æ–‡ä»¶

3. **æ£€æµ‹å™¨åˆå§‹åŒ–**
   - åŠ è½½YOLOæ¨¡å‹ï¼ˆ~2ç§’ï¼‰
   - åˆå§‹åŒ–å§¿æ€æ£€æµ‹ï¼ˆ~1ç§’ï¼‰
   - åˆ›å»ºè¡Œä¸ºè¯†åˆ«å™¨
   - æ„å»ºæ£€æµ‹ç®¡çº¿

4. **è§†é¢‘å¤„ç†å¾ªç¯**
   - æ‰“å¼€è§†é¢‘æº
   - å¾ªç¯è¯»å–å¸§
   - æ¯120å¸§å¤„ç†1å¸§ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
   - è°ƒç”¨æ£€æµ‹ç®¡çº¿
   - è®°å½•ç»Ÿè®¡ä¿¡æ¯

5. **ä¼˜é›…é€€å‡º**
   - æ¥æ”¶SIGTERMä¿¡å·
   - é‡Šæ”¾è§†é¢‘æ•è·
   - ä¿å­˜ç»Ÿè®¡ä¿¡æ¯

---

### ğŸ” 7. æ£€æµ‹ç®¡çº¿ (Detection Pipeline)

#### **æ–‡ä»¶**: `src/core/optimized_detection_pipeline.py`

**åŠŸèƒ½**: åè°ƒå„æ£€æµ‹æ¨¡å—ï¼Œä¼˜åŒ–æ€§èƒ½

**å…³é”®ä»£ç **:

```python
import time
from typing import Dict, List, Any, Optional
from dataclasses import dataclass
import numpy as np
import logging

logger = logging.getLogger(__name__)

@dataclass
class DetectionResult:
    """ç»Ÿä¸€çš„æ£€æµ‹ç»“æœæ•°æ®ç»“æ„"""
    person_detections: List[Dict]      # äººä½“æ£€æµ‹ç»“æœ
    hairnet_results: List[Dict]        # å‘ç½‘æ£€æµ‹ç»“æœ
    handwash_results: List[Dict]       # æ´—æ‰‹æ£€æµ‹ç»“æœ
    sanitize_results: List[Dict]       # æ¶ˆæ¯’æ£€æµ‹ç»“æœ
    processing_times: Dict[str, float] # å„é˜¶æ®µè€—æ—¶
    annotated_image: Optional[np.ndarray] = None


class OptimizedDetectionPipeline:
    """ä¼˜åŒ–çš„æ£€æµ‹ç®¡é“ â­ å…³é”®ç‚¹27"""
    
    def __init__(
        self,
        human_detector=None,
        hairnet_detector=None,
        behavior_recognizer=None,
        pose_detector=None,
        enable_cache: bool = True,
        cache_size: int = 100,
        cache_ttl: float = 30.0,
        cascade_config: Optional[Dict[str, Any]] = None,
    ):
        """åˆå§‹åŒ–ä¼˜åŒ–æ£€æµ‹ç®¡é“
        
        Args:
            human_detector: äººä½“æ£€æµ‹å™¨
            hairnet_detector: å‘ç½‘æ£€æµ‹å™¨
            behavior_recognizer: è¡Œä¸ºè¯†åˆ«å™¨
            pose_detector: å§¿æ€æ£€æµ‹å™¨
            enable_cache: æ˜¯å¦å¯ç”¨ç¼“å­˜
            cache_size: ç¼“å­˜å¤§å°
            cache_ttl: ç¼“å­˜ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰
            cascade_config: çº§è”æ£€æµ‹é…ç½®
        """
        # ä¿å­˜æ£€æµ‹å™¨å®ä¾‹
        self.human_detector = human_detector
        self.hairnet_detector = hairnet_detector
        self.behavior_recognizer = behavior_recognizer
        self.pose_detector = pose_detector
        
        # ç¼“å­˜é…ç½®
        self.enable_cache = enable_cache
        self.frame_cache = FrameCache(cache_size, cache_ttl) if enable_cache else None
        
        # ç»Ÿè®¡ä¿¡æ¯
        self.stats = {
            "total_detections": 0,
            "cache_hits": 0,
            "cache_misses": 0,
            "avg_processing_time": 0.0,
        }
        
        logger.info("ä¼˜åŒ–æ£€æµ‹ç®¡é“åˆå§‹åŒ–å®Œæˆï¼Œç¼“å­˜: {'å¯ç”¨' if enable_cache else 'ç¦ç”¨'}")
    
    def detect_comprehensive(
        self,
        image: np.ndarray,
        enable_hairnet: bool = True,
        enable_handwash: bool = True,
        enable_sanitize: bool = True,
        force_refresh: bool = False,
    ) -> DetectionResult:
        """ç»¼åˆæ£€æµ‹ - ç»Ÿä¸€å…¥å£ç‚¹ â­ å…³é”®ç‚¹28
        
        Args:
            image: è¾“å…¥å›¾åƒï¼ˆBGRæ ¼å¼ï¼Œæ¥è‡ªOpenCVï¼‰
            enable_hairnet: æ˜¯å¦å¯ç”¨å‘ç½‘æ£€æµ‹
            enable_handwash: æ˜¯å¦å¯ç”¨æ´—æ‰‹æ£€æµ‹
            enable_sanitize: æ˜¯å¦å¯ç”¨æ¶ˆæ¯’æ£€æµ‹
            force_refresh: æ˜¯å¦å¼ºåˆ¶åˆ·æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
        
        Returns:
            DetectionResult: ç»¼åˆæ£€æµ‹ç»“æœ
        """
        start_time = time.time()
        
        # 1. æ£€æŸ¥ç¼“å­˜ â­ å…³é”®ç‚¹29
        if self.enable_cache and self.frame_cache and not force_refresh:
            cached_result = self.frame_cache.get(image)
            if cached_result is not None:
                self.stats["cache_hits"] += 1
                logger.debug("ä½¿ç”¨ç¼“å­˜çš„æ£€æµ‹ç»“æœ")
                return cached_result
            else:
                self.stats["cache_misses"] += 1
        
        # 2. æ‰§è¡Œæ£€æµ‹æµæ°´çº¿ â­ å…³é”®ç‚¹30
        result = self._execute_detection_pipeline(
            image, enable_hairnet, enable_handwash, enable_sanitize
        )
        
        # 3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        total_time = time.time() - start_time
        self.stats["total_detections"] += 1
        self.stats["avg_processing_time"] = (
            self.stats["avg_processing_time"] * (self.stats["total_detections"] - 1)
            + total_time
        ) / self.stats["total_detections"]
        
        # 4. å­˜å…¥ç¼“å­˜
        if self.enable_cache and self.frame_cache:
            self.frame_cache.put(image, result)
        
        return result
    
    def _execute_detection_pipeline(
        self,
        image: np.ndarray,
        enable_hairnet: bool,
        enable_handwash: bool,
        enable_sanitize: bool,
    ) -> DetectionResult:
        """æ‰§è¡Œæ£€æµ‹æµæ°´çº¿ â­ å…³é”®ç‚¹31
        
        æ£€æµ‹é¡ºåºä¼˜åŒ–ï¼š
        1. äººä½“æ£€æµ‹ï¼ˆåŸºç¡€ï¼Œå…¶ä»–æ£€æµ‹ä¾èµ–æ­¤ç»“æœï¼‰
        2. å‘ç½‘æ£€æµ‹ï¼ˆä¾èµ–äººä½“æ£€æµ‹çš„å¤´éƒ¨åŒºåŸŸï¼‰
        3. è¡Œä¸ºæ£€æµ‹ï¼ˆæ´—æ‰‹ã€æ¶ˆæ¯’ï¼Œä¾èµ–äººä½“æ£€æµ‹ç»“æœï¼‰
        """
        processing_times = {}
        
        # é˜¶æ®µ1: äººä½“æ£€æµ‹ â­ å…³é”®ç‚¹32
        person_start = time.time()
        person_detections = self._detect_persons(image)
        processing_times["person_detection"] = time.time() - person_start
        
        logger.info(f"äººä½“æ£€æµ‹å®Œæˆ: æ£€æµ‹åˆ° {len(person_detections)} ä¸ªäºº")
        
        # é˜¶æ®µ2: å‘ç½‘æ£€æµ‹ â­ å…³é”®ç‚¹33
        hairnet_results = []
        if enable_hairnet and len(person_detections) > 0:
            hairnet_start = time.time()
            hairnet_results = self._detect_hairnets(image, person_detections)
            processing_times["hairnet_detection"] = time.time() - hairnet_start
            logger.debug(f"å‘ç½‘æ£€æµ‹å®Œæˆ: {len(hairnet_results)} ä¸ªç»“æœ")
        
        # é˜¶æ®µ3: è¡Œä¸ºæ£€æµ‹ â­ å…³é”®ç‚¹34
        handwash_results = []
        sanitize_results = []
        
        if (enable_handwash or enable_sanitize) and len(person_detections) > 0:
            behavior_start = time.time()
            behavior_results = self._detect_behaviors(
                image, person_detections,
                enable_handwash, enable_sanitize
            )
            processing_times["behavior_detection"] = time.time() - behavior_start
            
            handwash_results = behavior_results.get("handwash", [])
            sanitize_results = behavior_results.get("sanitize", [])
        
        # æ„å»ºç»“æœ
        return DetectionResult(
            person_detections=person_detections,
            hairnet_results=hairnet_results,
            handwash_results=handwash_results,
            sanitize_results=sanitize_results,
            processing_times=processing_times,
        )
    
    def _detect_persons(self, image: np.ndarray) -> List[Dict]:
        """äººä½“æ£€æµ‹ â­ å…³é”®ç‚¹35"""
        if self.human_detector is None:
            return []
        
        try:
            results = self.human_detector.detect(image)
            return results
        except Exception as e:
            logger.error(f"äººä½“æ£€æµ‹å¤±è´¥: {e}")
            return []
    
    def _detect_hairnets(
        self, image: np.ndarray, person_detections: List[Dict]
    ) -> List[Dict]:
        """å‘ç½‘æ£€æµ‹ â­ å…³é”®ç‚¹36"""
        if self.hairnet_detector is None:
            return []
        
        results = []
        for person in person_detections:
            try:
                # æå–å¤´éƒ¨åŒºåŸŸ
                bbox = person.get("bbox")
                if not bbox:
                    continue
                
                x1, y1, x2, y2 = bbox
                person_height = y2 - y1
                head_height = int(person_height * 0.3)  # å¤´éƒ¨å èº«é«˜30%
                head_region = image[y1:y1 + head_height, x1:x2]
                
                if head_region.size == 0:
                    continue
                
                # å‘ç½‘æ£€æµ‹
                hairnet_result = self.hairnet_detector.detect(head_region)
                if hairnet_result:
                    hairnet_result["person_id"] = person.get("id")
                    results.append(hairnet_result)
            except Exception as e:
                logger.error(f"å‘ç½‘æ£€æµ‹å¤±è´¥: {e}")
                continue
        
        return results
    
    def _detect_behaviors(
        self,
        image: np.ndarray,
        person_detections: List[Dict],
        enable_handwash: bool,
        enable_sanitize: bool
    ) -> Dict[str, List]:
        """è¡Œä¸ºæ£€æµ‹ â­ å…³é”®ç‚¹37"""
        if self.behavior_recognizer is None:
            return {"handwash": [], "sanitize": []}
        
        try:
            # è°ƒç”¨è¡Œä¸ºè¯†åˆ«å™¨
            behaviors = self.behavior_recognizer.recognize(
                image, person_detections, self.pose_detector
            )
            
            results = {
                "handwash": [] if not enable_handwash else behaviors.get("handwash", []),
                "sanitize": [] if not enable_sanitize else behaviors.get("sanitize", [])
            }
            
            return results
        except Exception as e:
            logger.error(f"è¡Œä¸ºæ£€æµ‹å¤±è´¥: {e}")
            return {"handwash": [], "sanitize": []}
```

**æ‰§è¡Œæµç¨‹**:

1. **ç¼“å­˜æ£€æŸ¥**
   - è®¡ç®—å¸§çš„å“ˆå¸Œå€¼
   - æŸ¥æ‰¾ç¼“å­˜
   - å‘½ä¸­ï¼šç›´æ¥è¿”å›
   - æœªå‘½ä¸­ï¼šç»§ç»­æ£€æµ‹

2. **äººä½“æ£€æµ‹** (150-300ms)
   - YOLOæ¨¡å‹æ¨ç†
   - éæå¤§å€¼æŠ‘åˆ¶(NMS)
   - è¿‡æ»¤ä½ç½®ä¿¡åº¦ç»“æœ
   - è¿”å›è¾¹ç•Œæ¡†å’Œç½®ä¿¡åº¦

3. **å‘ç½‘æ£€æµ‹** (30-50ms)
   - æå–å¤´éƒ¨åŒºåŸŸ
   - å‘ç½‘åˆ†ç±»æ¨¡å‹æ¨ç†
   - è¿”å›ä½©æˆ´çŠ¶æ€

4. **è¡Œä¸ºè¯†åˆ«** (50-100ms)
   - å§¿æ€æ£€æµ‹ï¼ˆå…³é”®ç‚¹æå–ï¼‰
   - æ‰‹éƒ¨åŒºåŸŸå®šä½
   - åŠ¨ä½œåºåˆ—åˆ†æ
   - è¿”å›è¡Œä¸ºæ ‡ç­¾

5. **ç»“æœæ±‡æ€»**
   - æ„é€  DetectionResult å¯¹è±¡
   - æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
   - å­˜å…¥ç¼“å­˜

**æ€§èƒ½ä¼˜åŒ–**:
- **å¸§ç¼“å­˜**: ç›¸ä¼¼å¸§å¤ç”¨ç»“æœ
- **æ—©æœŸé€€å‡º**: æ— äººæ—¶è·³è¿‡åç»­æ£€æµ‹
- **ROIä¼˜åŒ–**: åªå¤„ç†æ„Ÿå…´è¶£åŒºåŸŸ
- **æ‰¹å¤„ç†**: å¤šäººåŒæ—¶æ£€æµ‹

---

## æ•°æ®æµåˆ†æ

### ğŸ“Š å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯å±‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 1. ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨"
                       â”‚ { camera_id: "vid1" }
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ View Layer (CameraConfig.vue)                                â”‚
â”‚   startCamera(id: "vid1")                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 2. è°ƒç”¨ Store
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State Layer (Pinia Store)                                    â”‚
â”‚   cameraStore.startCamera("vid1")                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 3. è°ƒç”¨ API
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Layer (camera.ts)                                        â”‚
â”‚   http.post("/cameras/vid1/start")                           â”‚
â”‚   â†’ http://localhost:8000/api/v1/cameras/vid1/start         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 4. HTTP POST
                       â”‚ Content-Type: application/json
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åç«¯å±‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 5. è·¯ç”±åŒ¹é…
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Router Layer (cameras.py)                                    â”‚
â”‚   @router.post("/cameras/{camera_id}/start")                â”‚
â”‚   start_camera(camera_id="vid1")                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 6. è°ƒç”¨è¿›ç¨‹ç®¡ç†å™¨
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service Layer (ProcessManager)                               â”‚
â”‚   pm.start("vid1")                                           â”‚
â”‚                                                               â”‚
â”‚   â”œâ”€ 1. è¯»å–é…ç½®: config/cameras.yaml                       â”‚
â”‚   â”‚    {                                                      â”‚
â”‚   â”‚      "id": "vid1",                                       â”‚
â”‚   â”‚      "source": "tests/videos/xxx.mp4",                  â”‚
â”‚   â”‚      "profile": "accurate",                             â”‚
â”‚   â”‚      ...                                                 â”‚
â”‚   â”‚    }                                                      â”‚
â”‚   â”‚                                                           â”‚
â”‚   â”œâ”€ 2. æ„å»ºå‘½ä»¤                                            â”‚
â”‚   â”‚    [                                                      â”‚
â”‚   â”‚      "python", "main.py",                                â”‚
â”‚   â”‚      "--mode", "detection",                              â”‚
â”‚   â”‚      "--source", "tests/videos/xxx.mp4",                â”‚
â”‚   â”‚      "--camera-id", "vid1",                              â”‚
â”‚   â”‚      ...                                                  â”‚
â”‚   â”‚    ]                                                      â”‚
â”‚   â”‚                                                           â”‚
â”‚   â””â”€ 3. å¯åŠ¨å­è¿›ç¨‹                                           â”‚
â”‚        subprocess.Popen(cmd)                                  â”‚
â”‚        â†’ PID: 3931                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 7. è¿”å›è¿›ç¨‹ä¿¡æ¯
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response                                                      â”‚
â”‚ {                                                             â”‚
â”‚   "ok": true,                                                â”‚
â”‚   "running": true,                                           â”‚
â”‚   "pid": 3931,                                               â”‚
â”‚   "log": "/path/to/detect_vid1.log",                        â”‚
â”‚   "cmd": [...]                                               â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 8. HTTP 200 OK
                       â”‚ JSON Response
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯æ¥æ”¶å“åº”                                                   â”‚
â”‚   â”œâ”€ API Layer: è§£æ JSON                                   â”‚
â”‚   â”œâ”€ Store Layer: æ›´æ–°çŠ¶æ€, åˆ·æ–°åˆ—è¡¨                         â”‚
â”‚   â””â”€ View Layer: æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯, æ›´æ–°UI                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ£€æµ‹å­è¿›ç¨‹ (PID: 3931)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 9. è¿›ç¨‹å¯åŠ¨
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py                                                       â”‚
â”‚   â”œâ”€ 1. è§£æå‚æ•°                                             â”‚
â”‚   â”œâ”€ 2. åˆå§‹åŒ–æ—¥å¿—                                           â”‚
â”‚   â”œâ”€ 3. åŠ è½½é…ç½®                                             â”‚
â”‚   â”œâ”€ 4. åˆå§‹åŒ–GPU                                            â”‚
â”‚   â””â”€ 5. run_detection()                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 10. åˆå§‹åŒ–æ£€æµ‹å™¨
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detection Initialization                                      â”‚
â”‚   â”œâ”€ HumanDetector (YOLO)    : 200MB, ~2s åŠ è½½             â”‚
â”‚   â”œâ”€ PoseDetector (YOLOv8)   : 50MB,  ~1s åŠ è½½             â”‚
â”‚   â”œâ”€ HairnetDetector          : 50MB,  ~1s åŠ è½½             â”‚
â”‚   â”œâ”€ BehaviorRecognizer       : 10MB,  ~0.5s åŠ è½½          â”‚
â”‚   â””â”€ OptimizedDetectionPipeline: æ„å»ºç®¡çº¿                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 11. è¿›å…¥æ£€æµ‹å¾ªç¯
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _run_detection_loop()                                         â”‚
â”‚                                                               â”‚
â”‚   â”Œâ”€ æ‰“å¼€è§†é¢‘æº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  cv2.VideoCapture("tests/videos/xxx.mp4")   â”‚          â”‚
â”‚   â”‚  â†’ 1920x1080 @ 25FPS, 807 frames             â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                               â”‚
â”‚   â”Œâ”€ ä¸»å¾ªç¯ (while not shutdown) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚                                               â”‚          â”‚
â”‚   â”‚  1. è¯»å–å¸§: cap.read() â†’ frame (1920x1080)  â”‚          â”‚
â”‚   â”‚                                               â”‚          â”‚
â”‚   â”‚  2. å¸§è·³è¿‡: frame_count % 120 == 0?         â”‚          â”‚
â”‚   â”‚     å¦ â†’ continue                            â”‚          â”‚
â”‚   â”‚     æ˜¯ â†’ ç»§ç»­å¤„ç†                            â”‚          â”‚
â”‚   â”‚                                               â”‚          â”‚
â”‚   â”‚  3. è°ƒç”¨æ£€æµ‹ç®¡çº¿:                            â”‚          â”‚
â”‚   â”‚     result = pipeline.detect_comprehensive(  â”‚          â”‚
â”‚   â”‚         frame,                                â”‚          â”‚
â”‚   â”‚         enable_hairnet=True,                 â”‚          â”‚
â”‚   â”‚         enable_handwash=True,                â”‚          â”‚
â”‚   â”‚         enable_sanitize=True                 â”‚          â”‚
â”‚   â”‚     )                                         â”‚          â”‚
â”‚   â”‚                                               â”‚          â”‚
â”‚   â”‚  4. æå–ç»“æœ:                                â”‚          â”‚
â”‚   â”‚     persons = len(result.person_detections)  â”‚          â”‚
â”‚   â”‚     hairnets = len(result.hairnet_results)   â”‚          â”‚
â”‚   â”‚     handwash = len(result.handwash_results)  â”‚          â”‚
â”‚   â”‚                                               â”‚          â”‚
â”‚   â”‚  5. æ—¥å¿—è¾“å‡º (æ¯10å¸§æˆ–5ç§’):                  â”‚          â”‚
â”‚   â”‚     "å¸§ 120/807 | æ£€æµ‹: äºº=2, å‘ç½‘=1,       â”‚          â”‚
â”‚   â”‚      æ´—æ‰‹=0, æ¶ˆæ¯’=0 | è€—æ—¶: 0.27s |          â”‚          â”‚
â”‚   â”‚      å¤„ç†FPS: 4.14"                           â”‚          â”‚
â”‚   â”‚                                               â”‚          â”‚
â”‚   â”‚  6. è§†é¢‘ç»“æŸå¤„ç†:                            â”‚          â”‚
â”‚   â”‚     cap.set(CAP_PROP_POS_FRAMES, 0)         â”‚          â”‚
â”‚   â”‚     â†’ å¾ªç¯æ’­æ”¾                                â”‚          â”‚
â”‚   â”‚                                               â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                               â”‚
â”‚   â”Œâ”€ ä¼˜é›…é€€å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚  SIGTERM/SIGINT â†’ shutdown_requested=True  â”‚           â”‚
â”‚   â”‚  é‡Šæ”¾èµ„æº: cap.release()                    â”‚           â”‚
â”‚   â”‚  æ‰“å°ç»Ÿè®¡: æ€»å¸§ã€å¤„ç†å¸§ã€FPSã€ç®¡çº¿ç»Ÿè®¡     â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 12. æ—¥å¿—å†™å…¥
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ logs/detect_vid1.log                                          â”‚
â”‚                                                               â”‚
â”‚ 2025-10-13 15:04:04 - INFO - å¸§ 120/807 | ...              â”‚
â”‚ 2025-10-13 15:04:04 - INFO - è§†é¢‘æ–‡ä»¶æ’­æ”¾å®Œæˆ...            â”‚
â”‚ 2025-10-13 15:04:05 - INFO - å¸§ 240/807 | ...              â”‚
â”‚ ...                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 13. å‰ç«¯æŸ¥è¯¢ç»Ÿè®¡
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /api/v1/cameras/vid1/stats                               â”‚
â”‚   â”œâ”€ è¯»å–æ—¥å¿—æ–‡ä»¶æœ€å100è¡Œ                                   â”‚
â”‚   â”œâ”€ æ­£åˆ™åŒ¹é…æå–ç»Ÿè®¡æ•°æ®                                     â”‚
â”‚   â””â”€ è¿”å› JSON                                               â”‚
â”‚                                                               â”‚
â”‚ Response:                                                     â”‚
â”‚ {                                                             â”‚
â”‚   "running": true,                                           â”‚
â”‚   "pid": 3931,                                               â”‚
â”‚   "stats": {                                                 â”‚
â”‚     "detected_persons": 2,                                   â”‚
â”‚     "detected_hairnets": 1,                                  â”‚
â”‚     "avg_fps": 4.14,                                         â”‚
â”‚     "processed_frames": 240,                                 â”‚
â”‚     ...                                                       â”‚
â”‚   }                                                           â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 14. å‰ç«¯æ˜¾ç¤º
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CameraStatsModal (ç»Ÿè®¡å¼¹çª—)                                   â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚  ğŸŸ¢ è¿è¡Œä¸­ (PID: 3931)              [åˆ·æ–°]    â”‚          â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚ â”‚  æ£€æµ‹ç»Ÿè®¡:                                      â”‚          â”‚
â”‚ â”‚    æ£€æµ‹äººæ•°: 2    å‘ç½‘æ£€æµ‹: 1                  â”‚          â”‚
â”‚ â”‚    æ´—æ‰‹æ£€æµ‹: 0    å¤„ç†å¸§æ•°: 240                â”‚          â”‚
â”‚ â”‚    å¤„ç†FPS: 4.14  å¹³å‡æ£€æµ‹æ—¶é—´: 0.27s          â”‚          â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚ â”‚  å®æ—¶æ—¥å¿—:                                      â”‚          â”‚
â”‚ â”‚    2025-10-13 15:04:04 - å¸§ 120/807 | ...    â”‚          â”‚
â”‚ â”‚    2025-10-13 15:04:04 - è§†é¢‘æ’­æ”¾å®Œæˆ...      â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                               â”‚
â”‚ [è‡ªåŠ¨åˆ·æ–° â—]                              [å…³é—­]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®æŠ€æœ¯ç‚¹

### ğŸ” 1. è¿›ç¨‹éš”ç¦»ä¸ç®¡ç†

**ä¸ºä»€ä¹ˆä½¿ç”¨å­è¿›ç¨‹ï¼Ÿ**

```python
# æ–¹å¼1: çº¿ç¨‹ï¼ˆâŒ ä¸é€‚åˆï¼‰
# - Python GILé™åˆ¶ï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸
# - å´©æºƒå½±å“ä¸»è¿›ç¨‹
# - èµ„æºéš¾ä»¥éš”ç¦»

# æ–¹å¼2: å­è¿›ç¨‹ï¼ˆâœ… æ¨èï¼‰
# - å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“
# - å¯ä»¥å¼ºåˆ¶ç»ˆæ­¢
# - ç‹¬ç«‹çš„èµ„æºç®¡ç†
subprocess.Popen(cmd)
```

**è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†**:

```python
# å¯åŠ¨
proc = subprocess.Popen(cmd, ...)
pid = proc.pid

# ç›‘æ§
is_alive = psutil.pid_exists(pid)

# ä¼˜é›…åœæ­¢
os.kill(pid, signal.SIGTERM)
time.sleep(5)  # ç­‰å¾…è¿›ç¨‹è‡ªè¡Œé€€å‡º

# å¼ºåˆ¶åœæ­¢
if psutil.pid_exists(pid):
    os.kill(pid, signal.SIGKILL)
```

---

### ğŸš€ 2. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### **å¸§è·³è¿‡ï¼ˆFrame Skippingï¼‰**

```python
# åŸå§‹: æ¯å¸§éƒ½å¤„ç† (25 FPS)
# â†’ 25 æ¬¡/ç§’ Ã— 0.27ç§’/æ¬¡ = 6.75 ç§’è®¡ç®—æ—¶é—´/ç§’ âŒ æ— æ³•å®æ—¶

# ä¼˜åŒ–: æ¯120å¸§å¤„ç†1å¸§
if frame_count % 120 == 0:
    pipeline.detect(frame)
# â†’ 0.21 æ¬¡/ç§’ Ã— 0.27ç§’/æ¬¡ = 0.057 ç§’è®¡ç®—æ—¶é—´/ç§’ âœ… å¯å®æ—¶
```

#### **ç¼“å­˜æœºåˆ¶**

```python
# è§†é¢‘æµç‰¹ç‚¹: ç›¸é‚»å¸§ç›¸ä¼¼åº¦é«˜

class FrameCache:
    def get(self, frame):
        frame_hash = self._hash(frame)
        if frame_hash in self.cache:
            return self.cache[frame_hash]  # ç¼“å­˜å‘½ä¸­ï¼ŒèŠ‚çœ ~0.27s
        return None
    
    def put(self, frame, result):
        frame_hash = self._hash(frame)
        self.cache[frame_hash] = result
```

**ç¼“å­˜å‘½ä¸­ç‡**:
- é™æ€åœºæ™¯ï¼ˆæ— äººï¼‰: ~80-90%
- åŠ¨æ€åœºæ™¯ï¼ˆæœ‰äººç§»åŠ¨ï¼‰: ~20-30%

#### **çº§è”æ£€æµ‹ï¼ˆCascade Detectionï¼‰**

```python
# 1. å¿«é€Ÿæ£€æµ‹ï¼ˆä½åˆ†è¾¨ç‡ã€ä½ç½®ä¿¡åº¦ï¼‰
quick_results = yolo_n.detect(image, imgsz=320, conf=0.3)

# 2. å¯¹ä½ç½®ä¿¡åº¦ç»“æœè¿›è¡Œç²¾ç»†æ£€æµ‹
for result in quick_results:
    if 0.3 < result.confidence < 0.6:
        # ç²¾ç»†æ£€æµ‹ï¼ˆé«˜åˆ†è¾¨ç‡ã€é«˜ç½®ä¿¡åº¦ï¼‰
        refined = yolo_m.detect(crop_region, imgsz=640, conf=0.5)
```

---

### ğŸ”„ 3. å¼‚æ­¥é€šä¿¡æ¨¡å¼

**å½“å‰å®ç°: è½®è¯¢ï¼ˆPollingï¼‰**

```javascript
// å‰ç«¯æ¯5ç§’ä¸»åŠ¨æŸ¥è¯¢
setInterval(async () => {
    const stats = await http.get(`/cameras/${id}/stats`)
    updateUI(stats)
}, 5000)
```

**ä¼˜ç‚¹**: 
- å®ç°ç®€å•
- å…¼å®¹æ€§å¥½
- æ— è¿æ¥çŠ¶æ€ç»´æŠ¤

**ç¼ºç‚¹**:
- å»¶è¿Ÿé«˜ï¼ˆæœ€å¤š5ç§’ï¼‰
- èµ„æºæµªè´¹ï¼ˆå³ä½¿æ— å˜åŒ–ä¹ŸæŸ¥è¯¢ï¼‰

**æœªæ¥ä¼˜åŒ–: WebSocketæ¨é€**

```python
# åç«¯: æ£€æµ‹ç»“æœä¸»åŠ¨æ¨é€
async def detection_loop():
    while True:
        result = pipeline.detect(frame)
        await websocket.send_json({
            "camera_id": "vid1",
            "stats": extract_stats(result)
        })

# å‰ç«¯: å®æ—¶æ¥æ”¶
ws.onmessage = (event) => {
    const stats = JSON.parse(event.data)
    updateUI(stats)  // å®æ—¶æ›´æ–°ï¼Œæ— å»¶è¿Ÿ
}
```

---

### ğŸ“Š 4. æ—¥å¿—è§£æç­–ç•¥

**ä¸ºä»€ä¹ˆä»æ—¥å¿—æå–ç»Ÿè®¡ï¼Ÿ**

```python
# æ–¹å¼1: æ•°æ®åº“å­˜å‚¨ (âŒ å¤æ‚)
# - éœ€è¦é¢å¤–çš„æ•°æ®åº“
# - éœ€è¦å®šæœŸæ¸…ç†
# - éœ€è¦åŒæ­¥æœºåˆ¶

# æ–¹å¼2: å…±äº«å†…å­˜ (âŒ å¤æ‚)
# - è¿›ç¨‹é—´é€šä¿¡å¤æ‚
# - éœ€è¦é”æœºåˆ¶
# - è·¨å¹³å°é—®é¢˜

# æ–¹å¼3: æ—¥å¿—æ–‡ä»¶ (âœ… ç®€å•)
# - å·²æœ‰æ—¥å¿—ç³»ç»Ÿ
# - æ˜“äºè°ƒè¯•
# - æ— éœ€é¢å¤–å­˜å‚¨
```

**æ­£åˆ™è¡¨è¾¾å¼æå–**:

```python
import re

log_line = "å¸§ 120/807 | æ£€æµ‹: äºº=2, å‘ç½‘=1, æ´—æ‰‹=0, æ¶ˆæ¯’=0 | è€—æ—¶: 0.27s | å¤„ç†FPS: 4.14"

# æå–æ£€æµ‹ç»“æœ
match = re.search(r'æ£€æµ‹: äºº=(\d+), å‘ç½‘=(\d+), æ´—æ‰‹=(\d+)', log_line)
persons = int(match.group(1))  # 2
hairnets = int(match.group(2))  # 1
handwash = int(match.group(3))  # 0

# æå–FPS
match_fps = re.search(r'å¤„ç†FPS: ([\d.]+)', log_line)
fps = float(match_fps.group(1))  # 4.14
```

**æ€§èƒ½**: 
- è¯»å–æœ€å100è¡Œ: ~5-10ms
- æ­£åˆ™åŒ¹é…: ~1-2ms
- **æ€»è®¡**: ~10-20msï¼ˆå¯æ¥å—ï¼‰

---

### ğŸ¯ 5. é”™è¯¯å¤„ç†ä¸æ¢å¤

**å¤šå±‚é”™è¯¯æ•è·**:

```python
# å±‚çº§1: å•å¸§é”™è¯¯ï¼ˆä¸å½±å“æ•´ä½“ï¼‰
try:
    result = pipeline.detect(frame)
except Exception as e:
    logger.error(f"å¤„ç†ç¬¬ {frame_count} å¸§æ—¶å‡ºé”™: {e}")
    continue  # è·³è¿‡å½“å‰å¸§ï¼Œç»§ç»­ä¸‹ä¸€å¸§

# å±‚çº§2: æ£€æµ‹å™¨é”™è¯¯ï¼ˆé™çº§ï¼‰
try:
    hairnet_result = hairnet_detector.detect(head_region)
except Exception as e:
    logger.error(f"å‘ç½‘æ£€æµ‹å¤±è´¥: {e}")
    hairnet_result = None  # é™çº§ä¸ºæ— ç»“æœ

# å±‚çº§3: ç®¡çº¿é”™è¯¯ï¼ˆé‡å¯ï¼‰
try:
    _run_detection_loop(...)
except Exception as e:
    logger.error(f"æ£€æµ‹å¾ªç¯å¼‚å¸¸: {e}")
    # å¯ä»¥è§¦å‘è‡ªåŠ¨é‡å¯æœºåˆ¶
```

**åƒµå°¸è¿›ç¨‹æ¸…ç†**:

```python
def _is_process_alive(self, pid: int) -> bool:
    try:
        import psutil
        proc = psutil.Process(pid)
        # æ£€æŸ¥æ˜¯å¦ä¸ºåƒµå°¸è¿›ç¨‹
        return proc.status() != psutil.STATUS_ZOMBIE
    except psutil.NoSuchProcess:
        return False
```

---

## ğŸ“ æ€»ç»“

### ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **æ¨¡å—åŒ–**: æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤
2. **å¯é æ€§**: å¤šå±‚é”™è¯¯å¤„ç†ï¼Œè¿›ç¨‹éš”ç¦»
3. **æ€§èƒ½**: ç¼“å­˜ã€è·³å¸§ã€çº§è”ä¼˜åŒ–
4. **å¯è§‚æµ‹**: è¯¦ç»†æ—¥å¿—ã€å®æ—¶ç»Ÿè®¡
5. **ç”¨æˆ·å‹å¥½**: ç›´è§‚çš„UIåé¦ˆ

### ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| å•å¸§æ£€æµ‹æ—¶é—´ | 250-500ms | CPUæ¨¡å¼ |
| å®é™…ååé‡ | 2-4 FPS | è·³å¸§å |
| å†…å­˜å ç”¨ | 400-900MB | æ¯ä¸ªæ£€æµ‹è¿›ç¨‹ |
| APIå“åº”æ—¶é—´ | 10-50ms | ç»Ÿè®¡æŸ¥è¯¢ |
| å‰ç«¯åˆ·æ–°å»¶è¿Ÿ | 5ç§’ | è½®è¯¢é—´éš” |

### ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **WebSocketæ¨é€**: å®æ—¶æ€§ä»5ç§’é™åˆ°<100ms
2. **GPUåŠ é€Ÿ**: æ€§èƒ½æå‡5-10å€
3. **åˆ†å¸ƒå¼éƒ¨ç½²**: æ”¯æŒå¤šæœºå™¨è´Ÿè½½å‡è¡¡
4. **ç»“æœæŒä¹…åŒ–**: æ•°æ®åº“å­˜å‚¨é•¿æœŸç»Ÿè®¡
5. **æ™ºèƒ½è°ƒåº¦**: åŠ¨æ€è°ƒæ•´å¸§è·³è¿‡å‚æ•°

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

é€šè¿‡"å¯åŠ¨æ£€æµ‹"è¿™ä¸ªå®Œæ•´æµç¨‹ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ï¼š

1. **å‰ç«¯ä¸‰å±‚æ¶æ„**ï¼ˆView â†’ Store â†’ APIï¼‰çš„æ¸…æ™°èŒè´£åˆ’åˆ†
2. **åç«¯åˆ†å±‚è®¾è®¡**ï¼ˆRouter â†’ Service â†’ Coreï¼‰çš„è§£è€¦æ€æƒ³
3. **è¿›ç¨‹ç®¡ç†**çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸæ§åˆ¶
4. **æ£€æµ‹ç®¡çº¿**çš„ä¼˜åŒ–ç­–ç•¥å’Œæ€§èƒ½è€ƒé‡
5. **æ—¥å¿—é©±åŠ¨**çš„ç»Ÿè®¡æ•°æ®æå–æ–¹æ¡ˆ
6. **å®æ—¶ç›‘æ§**çš„å‰åç«¯åä½œæœºåˆ¶

è¿™äº›è®¾è®¡ä¸ä»…è§£å†³äº†å½“å‰é—®é¢˜ï¼Œè¿˜ä¸ºç³»ç»Ÿçš„æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ä¼˜åŒ–æ‰“ä¸‹äº†åšå®åŸºç¡€ã€‚

