# å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆè¯´æ˜

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [éƒ¨ç½²æ¶æ„ï¼ˆScheme Bï¼šå•Nginxï¼‰](#éƒ¨ç½²æ¶æ„scheme-bå•nginx)
3. [æœåŠ¡ç»„ä»¶](#æœåŠ¡ç»„ä»¶)
4. [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
5. [é…ç½®æ–‡ä»¶è¯´æ˜](#é…ç½®æ–‡ä»¶è¯´æ˜)
6. [é•œåƒæ„å»ºä¸ç‰ˆæœ¬ç®¡ç†](#é•œåƒæ„å»ºä¸ç‰ˆæœ¬ç®¡ç†)
7. [æ•°æ®æŒä¹…åŒ–](#æ•°æ®æŒä¹…åŒ–)
8. [ç½‘ç»œæ¶æ„](#ç½‘ç»œæ¶æ„)
9. [å¥åº·æ£€æŸ¥ä¸ç›‘æ§](#å¥åº·æ£€æŸ¥ä¸ç›‘æ§)
10. [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)

---

## æ¶æ„æ¦‚è¿°

å½“å‰ç”Ÿäº§ç¯å¢ƒé‡‡ç”¨ **Scheme Bï¼ˆå•Nginxæ¶æ„ï¼‰**ï¼Œè¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–çš„éƒ¨ç½²æ–¹æ¡ˆï¼š

### æ ¸å¿ƒç‰¹ç‚¹

- âœ… **å•ä¸€å…¥å£**ï¼šæ‰€æœ‰è¯·æ±‚é€šè¿‡ä¸€ä¸ª Nginx å®¹å™¨ç»Ÿä¸€å¤„ç†
- âœ… **èµ„æºé«˜æ•ˆ**ï¼šåªéœ€ä¸€ä¸ª Nginx è¿›ç¨‹ï¼Œå‡å°‘èµ„æºæ¶ˆè€—
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šé™æ€æ–‡ä»¶ç›´æ¥ç”± Nginx æœåŠ¡ï¼Œæ— éœ€äºŒæ¬¡ä»£ç†
- âœ… **é…ç½®ç®€å•**ï¼šåªéœ€ç»´æŠ¤ä¸€ä¸ª Nginx é…ç½®æ–‡ä»¶
- âœ… **æ˜“äºç»´æŠ¤**ï¼šæ¶æ„æ¸…æ™°ï¼Œé—®é¢˜æ’æŸ¥ç®€å•

---

## éƒ¨ç½²æ¶æ„ï¼ˆScheme Bï¼šå•Nginxï¼‰

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æµè§ˆå™¨                                                  â”‚
â”‚  è®¿é—®: http://localhost/ æˆ– http://<server-ip>/            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx å®¹å™¨ (pepgmp-nginx-prod)                             â”‚
â”‚  - ç›‘å¬: 80 (HTTP), 443 (HTTPS)                             â”‚
â”‚  - åŠŸèƒ½:                                                      â”‚
â”‚    â€¢ é™æ€æ–‡ä»¶æœåŠ¡: /usr/share/nginx/html (æŒ‚è½½ ./frontend/dist)â”‚
â”‚    â€¢ API ä»£ç†: /api/* â†’ api:8000                            â”‚
â”‚    â€¢ å¥åº·æ£€æŸ¥: /health                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â”‚
       â”‚ /api/*                        â”‚ / (é™æ€æ–‡ä»¶)
       â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API å®¹å™¨         â”‚         â”‚  é™æ€æ–‡ä»¶ç›®å½•                 â”‚
â”‚  (pepgmp-api-prod)â”‚         â”‚  ./frontend/dist/             â”‚
â”‚  - ç«¯å£: 8000     â”‚         â”‚  (ç”± frontend-init æå–)      â”‚
â”‚  - Gunicorn +     â”‚         â”‚  - index.html                 â”‚
â”‚    Uvicorn        â”‚         â”‚  - assets/                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ æ•°æ®åº“è¿æ¥
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯ç½‘ç»œ (backend - internal)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚ Redis        â”‚                         â”‚
â”‚  â”‚ (database)    â”‚  â”‚ (redis)      â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯·æ±‚æµç¨‹

1. **é™æ€æ–‡ä»¶è¯·æ±‚** (`/`, `/assets/*`, etc.)
   ```
   æµè§ˆå™¨ â†’ Nginx (80) â†’ ./frontend/dist/ â†’ è¿”å›é™æ€æ–‡ä»¶
   ```

2. **API è¯·æ±‚** (`/api/*`)
   ```
   æµè§ˆå™¨ â†’ Nginx (80) â†’ ä»£ç†åˆ° api:8000 â†’ è¿”å› JSON
   ```

3. **å¥åº·æ£€æŸ¥** (`/health`)
   ```
   æµè§ˆå™¨ â†’ Nginx (80) â†’ è¿”å› "healthy"
   ```

---

## æœåŠ¡ç»„ä»¶

### 1. æ•°æ®åº“æœåŠ¡ (database)

**å®¹å™¨å**: `pepgmp-postgres-prod`
**é•œåƒ**: `postgres:16-alpine`
**ç½‘ç»œ**: `backend` (å†…éƒ¨ç½‘ç»œï¼Œä¸æš´éœ²)
**æ•°æ®æŒä¹…åŒ–**: `postgres_prod_data` (å‘½å volume)

**é…ç½®**:
- æ•°æ®åº“å: `pepgmp_production`
- ç”¨æˆ·å: `pepgmp_prod`
- å¯†ç : ä» `.env.production` çš„ `DATABASE_PASSWORD` è¯»å–
- åˆå§‹åŒ–: é¦–æ¬¡å¯åŠ¨æ—¶æ‰§è¡Œ `./scripts/init_db.sql`

**å¥åº·æ£€æŸ¥**:
```yaml
test: ["CMD-SHELL", "pg_isready -U pepgmp_prod -d pepgmp_production"]
interval: 10s
timeout: 5s
retries: 5
```

---

### 2. Redis ç¼“å­˜æœåŠ¡ (redis)

**å®¹å™¨å**: `pepgmp-redis-prod`
**é•œåƒ**: `redis:7-alpine`
**ç½‘ç»œ**: `backend` (å†…éƒ¨ç½‘ç»œï¼Œä¸æš´éœ²)
**æ•°æ®æŒä¹…åŒ–**: `redis_prod_data` (å‘½å volume)

**é…ç½®**:
- å¯†ç : ä» `.env.production` çš„ `REDIS_PASSWORD` è¯»å–
- AOF æŒä¹…åŒ–: å¯ç”¨ (`--appendonly yes`)
- å†…å­˜é™åˆ¶: 512MB
- æ·˜æ±°ç­–ç•¥: `allkeys-lru`

**å¥åº·æ£€æŸ¥**:
```yaml
test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping | grep -q PONG"]
interval: 10s
timeout: 5s
retries: 5
```

---

### 3. API æœåŠ¡ (api)

**å®¹å™¨å**: `pepgmp-api-prod`
**é•œåƒ**: `pepgmp-backend:${IMAGE_TAG:-latest}`
**ç½‘ç»œ**: `frontend` + `backend` (åŒç½‘ç»œ)
**ç«¯å£**: 8000 (å®¹å™¨å†…ï¼Œä¸æš´éœ²åˆ°ä¸»æœº)

**é…ç½®**:
- å·¥ä½œè¿›ç¨‹: Gunicorn + 4 ä¸ª Uvicorn Workers
- ç¯å¢ƒå˜é‡: ä» `.env.production` åŠ è½½
- æ—¥å¿—: `/app/logs/` (æŒ‚è½½åˆ° `app_logs` volume)
- è¾“å‡º: `/app/output/` (æŒ‚è½½åˆ° `app_output` volume)

**Volume æŒ‚è½½**:
```yaml
volumes:
  - app_logs:/app/logs          # æ—¥å¿—ï¼ˆå‘½å volumeï¼‰
  - app_output:/app/output      # è¾“å‡ºï¼ˆå‘½å volumeï¼‰
  - ./config:/app/config:ro     # é…ç½®ï¼ˆåªè¯»ï¼Œbind mountï¼‰
  - ./models:/app/models:ro     # æ¨¡å‹ï¼ˆåªè¯»ï¼Œbind mountï¼‰
  - ./data:/app/data            # æ•°æ®ï¼ˆå¯è¯»å†™ï¼Œbind mountï¼‰
```

**å¥åº·æ£€æŸ¥**:
```yaml
test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/monitoring/health"]
interval: 30s
timeout: 10s
retries: 3
start_period: 40s
```

---

### 4. å‰ç«¯åˆå§‹åŒ–å®¹å™¨ (frontend-init)

**å®¹å™¨å**: `pepgmp-frontend-init`
**é•œåƒ**: `pepgmp-frontend:${IMAGE_TAG:-latest}`
**åŠŸèƒ½**: ä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œæå–é™æ€æ–‡ä»¶åˆ°ä¸»æœºç›®å½•

**å·¥ä½œæµç¨‹**:
1. å¯åŠ¨å®¹å™¨ï¼ŒæŒ‚è½½ `./frontend/dist:/target`
2. ä»é•œåƒçš„ `/usr/share/nginx/html` å¤åˆ¶é™æ€æ–‡ä»¶åˆ° `/target`
3. è®¾ç½®æ–‡ä»¶æƒé™
4. è¾“å‡ºæ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
5. å®¹å™¨è‡ªåŠ¨é€€å‡ºï¼ˆ`restart: "no"`ï¼‰

**Volume æŒ‚è½½**:
```yaml
volumes:
  - ./frontend/dist:/target  # æŒ‚è½½ä¸»æœºç›®å½•
```

**æ‰§è¡Œæ—¶æœº**:
- é¦–æ¬¡éƒ¨ç½²æ—¶è‡ªåŠ¨è¿è¡Œ
- æ›´æ–°å‰ç«¯é•œåƒåéœ€è¦é‡æ–°è¿è¡Œ
- Nginx å¯åŠ¨å‰å¿…é¡»å®Œæˆï¼ˆé€šè¿‡ `depends_on` ç¡®ä¿ï¼‰

---

### 5. Nginx ç»Ÿä¸€æœåŠ¡ (nginx)

**å®¹å™¨å**: `pepgmp-nginx-prod`
**é•œåƒ**: `nginx:alpine`
**ç½‘ç»œ**: `frontend`
**ç«¯å£**: `80:80`, `443:443` (æš´éœ²åˆ°ä¸»æœº)

**åŠŸèƒ½**:
1. **é™æ€æ–‡ä»¶æœåŠ¡**: ç›´æ¥æœåŠ¡ `./frontend/dist` ç›®å½•
2. **API ä»£ç†**: å°† `/api/*` è¯·æ±‚ä»£ç†åˆ° `api:8000`
3. **å¥åº·æ£€æŸ¥**: æä¾› `/health` ç«¯ç‚¹

**Volume æŒ‚è½½**:
```yaml
volumes:
  - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro  # Nginx é…ç½®
  - ./nginx/ssl:/etc/nginx/ssl:ro                 # SSL è¯ä¹¦ï¼ˆå¯é€‰ï¼‰
  - ./frontend/dist:/usr/share/nginx/html:ro     # é™æ€æ–‡ä»¶ï¼ˆåªè¯»ï¼‰
```

**ä¾èµ–å…³ç³»**:
```yaml
depends_on:
  - api              # ç­‰å¾… API æœåŠ¡å¯åŠ¨
  - frontend-init    # ç­‰å¾…é™æ€æ–‡ä»¶æå–å®Œæˆ
```

**å¥åº·æ£€æŸ¥**:
```yaml
test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
interval: 30s
timeout: 5s
retries: 3
start_period: 10s
```

---

### 6. ç›‘æ§æœåŠ¡ï¼ˆå¯é€‰ï¼‰

#### Prometheus
- **å®¹å™¨å**: `pyt-prometheus`
- **ç«¯å£**: 9090 (å†…éƒ¨)
- **æ•°æ®æŒä¹…åŒ–**: `prometheus_data` volume

#### Grafana
- **å®¹å™¨å**: `pyt-grafana`
- **ç«¯å£**: `3000:3000` (æš´éœ²åˆ°ä¸»æœº)
- **æ•°æ®æŒä¹…åŒ–**: `grafana_data` volume

---

## éƒ¨ç½²æµç¨‹

### é˜¶æ®µ 1: å¼€å‘ç¯å¢ƒå‡†å¤‡

#### 1.1 æ„å»ºç”Ÿäº§é•œåƒ

```bash
# åœ¨å¼€å‘æœºä¸Šæ„å»ºæ‰€æœ‰ç”Ÿäº§é•œåƒ
cd /path/to/project

# æ„å»ºåç«¯é•œåƒ
docker build -f Dockerfile.prod -t pepgmp-backend:20250118 .

# æ„å»ºå‰ç«¯é•œåƒï¼ˆè·³è¿‡ç±»å‹æ£€æŸ¥ï¼‰
docker build -f Dockerfile.frontend \
  --build-arg SKIP_TYPE_CHECK=true \
  -t pepgmp-frontend:20250118 .
```

#### 1.2 å¯¼å‡ºé•œåƒï¼ˆå†…ç½‘éƒ¨ç½²ï¼‰

```bash
# å¯¼å‡ºé•œåƒåˆ° tar æ–‡ä»¶
docker save pepgmp-backend:20250118 -o docker-images/pepgmp-backend-20250118.tar
docker save pepgmp-frontend:20250118 -o docker-images/pepgmp-frontend-20250118.tar

# æˆ–ä½¿ç”¨è„šæœ¬
bash scripts/build_prod_images.sh 20250118
```

---

### é˜¶æ®µ 2: ç”Ÿäº§æœåŠ¡å™¨å‡†å¤‡

#### 2.1 å‡†å¤‡éƒ¨ç½²ç›®å½•

```bash
# åœ¨ WSL2 æˆ– Linux æœåŠ¡å™¨ä¸Š
cd ~/projects

# ä½¿ç”¨ prepare_minimal_deploy.sh å‡†å¤‡éƒ¨ç½²åŒ…
bash /path/to/project/scripts/prepare_minimal_deploy.sh ~/projects/Pyt
```

**è„šæœ¬åŠŸèƒ½**:
- åˆ›å»ºç›®å½•ç»“æ„ (`config/`, `models/`, `data/`, `logs/`, `nginx/`, `frontend/dist/`)
- å¤åˆ¶ Docker Compose é…ç½®æ–‡ä»¶
- å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè„šæœ¬
- ç”Ÿæˆ Nginx é…ç½®ï¼ˆScheme Bï¼‰
- æ£€æŸ¥å¹¶å¤åˆ¶å‰ç«¯é™æ€æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

#### 2.2 å¯¼å…¥é•œåƒï¼ˆå†…ç½‘éƒ¨ç½²ï¼‰

```bash
cd ~/projects/Pyt

# å¯¼å…¥é•œåƒ
docker load -i docker-images/pepgmp-backend-20250118.tar
docker load -i pepgmp-frontend-20250118.tar

# éªŒè¯
docker images | grep pepgmp
```

#### 2.3 ç”Ÿæˆé…ç½®æ–‡ä»¶

```bash
cd ~/projects/Pyt

# ç”Ÿæˆ .env.production
bash scripts/generate_production_config.sh

# æ£€æŸ¥é…ç½®
cat .env.production
```

**å…³é”®é…ç½®é¡¹**:
- `IMAGE_TAG=20250118` - é•œåƒç‰ˆæœ¬æ ‡ç­¾
- `DATABASE_PASSWORD=...` - æ•°æ®åº“å¯†ç 
- `REDIS_PASSWORD=...` - Redis å¯†ç 
- `SECRET_KEY=...` - åº”ç”¨å¯†é’¥

---

### é˜¶æ®µ 3: å¯åŠ¨æœåŠ¡

#### 3.1 é¦–æ¬¡å¯åŠ¨ï¼ˆåŒ…å«æ•°æ®åº“åˆå§‹åŒ–ï¼‰

```bash
cd ~/projects/Pyt

# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬ frontend-initï¼‰
docker-compose -f docker-compose.prod.yml --env-file .env.production up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f
```

**å¯åŠ¨é¡ºåº**:
1. `database` å’Œ `redis` å¯åŠ¨å¹¶ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡
2. `frontend-init` è¿è¡Œå¹¶æå–é™æ€æ–‡ä»¶ï¼ˆå®Œæˆåé€€å‡ºï¼‰
3. `api` å¯åŠ¨å¹¶ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡
4. `nginx` å¯åŠ¨ï¼ˆä¾èµ– `api` å’Œ `frontend-init`ï¼‰

#### 3.2 éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost/health

# æµ‹è¯• API
curl http://localhost/api/v1/monitoring/health

# æµ‹è¯•å‰ç«¯
curl http://localhost/
```

---

### é˜¶æ®µ 4: æ›´æ–°éƒ¨ç½²

#### 4.1 æ›´æ–°é•œåƒç‰ˆæœ¬

```bash
# 1. å¯¼å…¥æ–°é•œåƒ
docker load -i docker-images/pepgmp-backend-20250119.tar
docker load -i docker-images/pepgmp-frontend-20250119.tar

# 2. æ›´æ–° .env.production ä¸­çš„ IMAGE_TAG
# æˆ–ä½¿ç”¨è„šæœ¬
bash scripts/update_image_version.sh 20250119

# 3. é‡æ–°æå–å‰ç«¯é™æ€æ–‡ä»¶ï¼ˆå¦‚æœå‰ç«¯æ›´æ–°ï¼‰
docker-compose -f docker-compose.prod.yml --env-file .env.production up frontend-init

# 4. é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml --env-file .env.production restart api nginx
```

#### 4.2 æ»šåŠ¨æ›´æ–°ï¼ˆé›¶åœæœºï¼‰

```bash
# 1. æ›´æ–°åç«¯é•œåƒ
docker-compose -f docker-compose.prod.yml --env-file .env.production up -d --no-deps api

# 2. ç­‰å¾…æ–°å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡
docker-compose -f docker-compose.prod.yml ps api

# 3. å¦‚æœå‰ç«¯æ›´æ–°ï¼Œé‡æ–°æå–é™æ€æ–‡ä»¶
docker-compose -f docker-compose.prod.yml --env-file .env.production up frontend-init

# 4. é‡æ–°åŠ è½½ Nginxï¼ˆä¸é‡å¯å®¹å™¨ï¼‰
docker exec pepgmp-nginx-prod nginx -s reload
```

---

## é…ç½®æ–‡ä»¶è¯´æ˜

### 1. docker-compose.prod.yml

**ç”¨é€”**: ç”Ÿäº§ç¯å¢ƒæœåŠ¡ç¼–æ’

**å…³é”®é…ç½®**:
- æœåŠ¡å®šä¹‰ï¼ˆdatabase, redis, api, frontend-init, nginxï¼‰
- ç½‘ç»œé…ç½®ï¼ˆfrontend, backendï¼‰
- Volume é…ç½®ï¼ˆæ•°æ®æŒä¹…åŒ–ï¼‰
- å¥åº·æ£€æŸ¥é…ç½®
- èµ„æºé™åˆ¶

**ç‰ˆæœ¬ç®¡ç†**:
- ä½¿ç”¨ `${IMAGE_TAG:-latest}` ç¯å¢ƒå˜é‡æŒ‡å®šé•œåƒç‰ˆæœ¬
- ä» `.env.production` è¯»å– `IMAGE_TAG`

---

### 2. docker-compose.prod.1panel.yml

**ç”¨é€”**: 1Panel ä¸“ç”¨ç‰ˆæœ¬ï¼ˆç§»é™¤ build éƒ¨åˆ†ï¼‰

**åŒºåˆ«**:
- ä¸åŒ…å« `build:` éƒ¨åˆ†
- ç›´æ¥ä½¿ç”¨å·²å¯¼å…¥çš„é•œåƒ
- é€‚åˆé€šè¿‡ 1Panel ç®¡ç† Docker Compose

---

### 3. .env.production

**ç”¨é€”**: ç”Ÿäº§ç¯å¢ƒç¯å¢ƒå˜é‡é…ç½®

**å…³é”®å˜é‡**:
```bash
# é•œåƒç‰ˆæœ¬
IMAGE_TAG=20250118
IMAGE_REGISTRY=  # ç§æœ‰ä»“åº“å‰ç¼€ï¼ˆå¯é€‰ï¼‰

# æ•°æ®åº“é…ç½®
DATABASE_PASSWORD=strong_random_password
POSTGRES_DB=pepgmp_production
POSTGRES_USER=pepgmp_prod

# Redis é…ç½®
REDIS_PASSWORD=strong_random_password

# åº”ç”¨é…ç½®
SECRET_KEY=strong_random_secret_key
ENVIRONMENT=production
```

**ç”Ÿæˆæ–¹å¼**:
```bash
bash scripts/generate_production_config.sh
```

---

### 4. nginx/nginx.conf

**ç”¨é€”**: Nginx ç»Ÿä¸€æœåŠ¡é…ç½®ï¼ˆScheme Bï¼‰

**å…³é”®é…ç½®**:
```nginx
server {
    listen 80;
    server_name _;

    # é™æ€æ–‡ä»¶æ ¹ç›®å½•
    root /usr/share/nginx/html;
    index index.html;

    # API ä»£ç†
    location /api/ {
        proxy_pass http://api_backend/api/;
        # ... ä»£ç†å¤´è®¾ç½®
    }

    # å‰ç«¯é™æ€æ–‡ä»¶ï¼ˆæ”¯æŒ Vue Router history æ¨¡å¼ï¼‰
    location / {
        try_files $uri $uri/ /index.html;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

**ç‰¹ç‚¹**:
- ä½¿ç”¨ `root` æŒ‡ä»¤ç›´æ¥æœåŠ¡é™æ€æ–‡ä»¶ï¼ˆä¸æ˜¯ `proxy_pass`ï¼‰
- æ”¯æŒ Vue Router history æ¨¡å¼ï¼ˆ`try_files`ï¼‰
- é™æ€èµ„æºç¼“å­˜é…ç½®
- Gzip å‹ç¼©é…ç½®

---

## é•œåƒæ„å»ºä¸ç‰ˆæœ¬ç®¡ç†

### é•œåƒå‘½åè§„èŒƒ

- **åç«¯é•œåƒ**: `pepgmp-backend:<version>`
- **å‰ç«¯é•œåƒ**: `pepgmp-frontend:<version>`
- **ç‰ˆæœ¬æ ‡ç­¾**: ä½¿ç”¨æ—¥æœŸæ ¼å¼ `YYYYMMDD`ï¼ˆå¦‚ `20250118`ï¼‰

### æ„å»ºè„šæœ¬

#### build_prod_only.sh
```bash
# æ„å»ºç”Ÿäº§é•œåƒï¼ˆä¸æ¨é€ï¼‰
bash scripts/build_prod_only.sh [VERSION_TAG]

# ç¤ºä¾‹
bash scripts/build_prod_only.sh 20250118
```

#### build_prod_images.sh
```bash
# æ„å»ºã€æ¨é€ã€å¯¼å‡ºé•œåƒ
bash scripts/build_prod_images.sh [VERSION_TAG]

# ç¤ºä¾‹
bash scripts/build_prod_images.sh 20250118
```

### ç‰ˆæœ¬æ›´æ–°

```bash
# è‡ªåŠ¨æ›´æ–° .env.production ä¸­çš„ IMAGE_TAG
bash scripts/update_image_version.sh 20250119
```

---

## æ•°æ®æŒä¹…åŒ–

### å‘½å Volumesï¼ˆDocker ç®¡ç†ï¼‰

| Volume åç§° | ç”¨é€” | æœåŠ¡ |
|------------|------|------|
| `postgres_prod_data` | PostgreSQL æ•°æ® | database |
| `redis_prod_data` | Redis æ•°æ® | redis |
| `app_logs` | åº”ç”¨æ—¥å¿— | api |
| `app_output` | åº”ç”¨è¾“å‡º | api |
| `prometheus_data` | Prometheus æ•°æ® | prometheus |
| `grafana_data` | Grafana æ•°æ® | grafana |

**ç‰¹ç‚¹**:
- ç”± Docker ç®¡ç†ï¼Œä½ç½®åœ¨ `/var/lib/docker/volumes/`
- å®¹å™¨åˆ é™¤åæ•°æ®ä¿ç•™
- é€‚åˆæ—¥å¿—ã€è¾“å‡ºç­‰ä¸éœ€è¦ç›´æ¥è®¿é—®çš„æ•°æ®

### Bind Mountsï¼ˆä¸»æœºç›®å½•ï¼‰

| ä¸»æœºè·¯å¾„ | å®¹å™¨è·¯å¾„ | ç”¨é€” | æœåŠ¡ |
|---------|---------|------|------|
| `./config` | `/app/config` | é…ç½®æ–‡ä»¶ | api |
| `./models` | `/app/models` | æ¨¡å‹æ–‡ä»¶ | api |
| `./data` | `/app/data` | æ•°æ®ç›®å½• | api |
| `./frontend/dist` | `/usr/share/nginx/html` | é™æ€æ–‡ä»¶ | nginx |
| `./nginx/nginx.conf` | `/etc/nginx/nginx.conf` | Nginx é…ç½® | nginx |
| `./scripts/init_db.sql` | `/docker-entrypoint-initdb.d/init_db.sql` | æ•°æ®åº“åˆå§‹åŒ– | database |

**ç‰¹ç‚¹**:
- ç›´æ¥æ˜ å°„åˆ°ä¸»æœºç›®å½•ï¼Œä¾¿äºè®¿é—®å’Œå¤‡ä»½
- é€‚åˆé…ç½®æ–‡ä»¶ã€é™æ€æ–‡ä»¶ç­‰éœ€è¦ç›´æ¥ç®¡ç†çš„æ•°æ®

---

## ç½‘ç»œæ¶æ„

### ç½‘ç»œè®¾è®¡

#### frontend ç½‘ç»œï¼ˆå¤–éƒ¨å¯è®¿é—®ï¼‰
- **ç±»å‹**: bridge
- **ç”¨é€”**: è¿æ¥ Nginx å’Œ APIï¼Œå…è®¸å¤–éƒ¨è®¿é—®
- **æœåŠ¡**: `nginx`, `api`

#### backend ç½‘ç»œï¼ˆå†…éƒ¨ç½‘ç»œï¼‰
- **ç±»å‹**: bridge, **internal: true**
- **ç”¨é€”**: æ•°æ®åº“å’Œç¼“å­˜ï¼Œä¸æš´éœ²åˆ°å¤–éƒ¨
- **æœåŠ¡**: `database`, `redis`, `api`

### ç½‘ç»œéš”ç¦»

```
å¤–éƒ¨è®¿é—®
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ frontend    â”‚  â† å¤–éƒ¨å¯è®¿é—®
â”‚ network     â”‚
â”‚             â”‚
â”‚  nginx      â”‚
â”‚  api        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ å†…éƒ¨é€šä¿¡
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ backend     â”‚  â† å†…éƒ¨ç½‘ç»œï¼ˆä¸æš´éœ²ï¼‰
â”‚ network     â”‚
â”‚             â”‚
â”‚  database   â”‚
â”‚  redis      â”‚
â”‚  api        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®‰å…¨ä¼˜åŠ¿**:
- æ•°æ®åº“å’Œ Redis ä¸æš´éœ²åˆ°å¤–éƒ¨ç½‘ç»œ
- åªèƒ½é€šè¿‡ API æœåŠ¡è®¿é—®
- å‡å°‘æ”»å‡»é¢

---

## å¥åº·æ£€æŸ¥ä¸ç›‘æ§

### å¥åº·æ£€æŸ¥é…ç½®

#### æ•°æ®åº“
- **æ£€æŸ¥å‘½ä»¤**: `pg_isready -U pepgmp_prod -d pepgmp_production`
- **é—´éš”**: 10s
- **è¶…æ—¶**: 5s
- **é‡è¯•**: 5 æ¬¡

#### Redis
- **æ£€æŸ¥å‘½ä»¤**: `redis-cli -a ${REDIS_PASSWORD} ping | grep -q PONG`
- **é—´éš”**: 10s
- **è¶…æ—¶**: 5s
- **é‡è¯•**: 5 æ¬¡

#### API
- **æ£€æŸ¥å‘½ä»¤**: `curl -f http://localhost:8000/api/v1/monitoring/health`
- **é—´éš”**: 30s
- **è¶…æ—¶**: 10s
- **é‡è¯•**: 3 æ¬¡
- **å¯åŠ¨ç­‰å¾…**: 40s

#### Nginx
- **æ£€æŸ¥å‘½ä»¤**: `wget --no-verbose --tries=1 --spider http://localhost/health`
- **é—´éš”**: 30s
- **è¶…æ—¶**: 5s
- **é‡è¯•**: 3 æ¬¡
- **å¯åŠ¨ç­‰å¾…**: 10s

### ç›‘æ§æœåŠ¡ï¼ˆå¯é€‰ï¼‰

- **Prometheus**: æŒ‡æ ‡æ”¶é›†ï¼ˆç«¯å£ 9090ï¼Œå†…éƒ¨ï¼‰
- **Grafana**: å¯è§†åŒ–ï¼ˆç«¯å£ 3000ï¼Œæš´éœ²åˆ°ä¸»æœºï¼‰

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. ç™½å±é—®é¢˜

**ç—‡çŠ¶**: è®¿é—® `http://localhost/` æ˜¾ç¤ºç©ºç™½é¡µé¢

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. è¿è¡Œè¯Šæ–­è„šæœ¬
bash scripts/diagnose_scheme_b.sh ~/projects/Pyt

# 2. æ£€æŸ¥é™æ€æ–‡ä»¶
ls -la ~/projects/Pyt/frontend/dist/

# 3. æ£€æŸ¥ frontend-init æ˜¯å¦æˆåŠŸè¿è¡Œ
docker logs pepgmp-frontend-init

# 4. æ£€æŸ¥ Nginx é…ç½®
docker exec pepgmp-nginx-prod nginx -t

# 5. æ£€æŸ¥ Nginx æ—¥å¿—
docker logs pepgmp-nginx-prod
```

**å¸¸è§åŸå› **:
- `./frontend/dist` ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º
- `frontend-init` å®¹å™¨æœªè¿è¡Œæˆ–å¤±è´¥
- Nginx é…ç½®é”™è¯¯ï¼ˆä½¿ç”¨äº† Scheme A é…ç½®ï¼‰
- æ–‡ä»¶æƒé™é—®é¢˜

---

### 2. API æ— æ³•è®¿é—®

**ç—‡çŠ¶**: `/api/*` è¯·æ±‚è¿”å› 502 æˆ– 503

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥ API å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps api

# 2. æ£€æŸ¥ API æ—¥å¿—
docker logs pepgmp-api-prod

# 3. æ£€æŸ¥ API å¥åº·æ£€æŸ¥
docker exec pepgmp-api-prod curl -f http://localhost:8000/api/v1/monitoring/health

# 4. æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec pepgmp-api-prod env | grep DATABASE

# 5. æ£€æŸ¥ç½‘ç»œè¿æ¥
docker exec pepgmp-nginx-prod wget -qO- http://api:8000/api/v1/monitoring/health
```

---

### 3. æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: API æ—¥å¿—æ˜¾ç¤ºæ•°æ®åº“è¿æ¥é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥æ•°æ®åº“å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps database

# 2. æ£€æŸ¥æ•°æ®åº“æ—¥å¿—
docker logs pepgmp-postgres-prod

# 3. æ£€æŸ¥æ•°æ®åº“å¥åº·æ£€æŸ¥
docker exec pepgmp-postgres-prod pg_isready -U pepgmp_prod -d pepgmp_production

# 4. æ£€æŸ¥ç¯å¢ƒå˜é‡
grep DATABASE_PASSWORD .env.production

# 5. æµ‹è¯•æ•°æ®åº“è¿æ¥
docker exec -it pepgmp-postgres-prod psql -U pepgmp_prod -d pepgmp_production
```

---

### 4. é™æ€æ–‡ä»¶æ›´æ–°ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**: æ›´æ–°å‰ç«¯ä»£ç åï¼Œé¡µé¢æ²¡æœ‰å˜åŒ–

**è§£å†³æ­¥éª¤**:
```bash
# 1. é‡æ–°æ„å»ºå‰ç«¯é•œåƒ
docker build -f Dockerfile.frontend --build-arg SKIP_TYPE_CHECK=true -t pepgmp-frontend:20250119 .

# 2. æ›´æ–° .env.production ä¸­çš„ IMAGE_TAG
bash scripts/update_image_version.sh 20250119

# 3. é‡æ–°æå–é™æ€æ–‡ä»¶
docker-compose -f docker-compose.prod.yml --env-file .env.production up frontend-init

# 4. é‡æ–°åŠ è½½ Nginxï¼ˆä¸é‡å¯ï¼‰
docker exec pepgmp-nginx-prod nginx -s reload
```

---

## æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **å•ä¸€å…¥å£**: æ‰€æœ‰è¯·æ±‚é€šè¿‡ä¸€ä¸ª Nginx å®¹å™¨
2. **èµ„æºé«˜æ•ˆ**: åªéœ€ä¸€ä¸ª Nginx è¿›ç¨‹
3. **æ€§èƒ½ä¼˜åŒ–**: é™æ€æ–‡ä»¶ç›´æ¥æœåŠ¡ï¼Œæ— äºŒæ¬¡ä»£ç†
4. **é…ç½®ç®€å•**: åªéœ€ç»´æŠ¤ä¸€ä¸ª Nginx é…ç½®
5. **æ˜“äºç»´æŠ¤**: æ¶æ„æ¸…æ™°ï¼Œé—®é¢˜æ’æŸ¥ç®€å•
6. **å®‰å…¨éš”ç¦»**: æ•°æ®åº“å’Œ Redis ä¸æš´éœ²åˆ°å¤–éƒ¨

### å…³é”®è¦ç‚¹

1. **å‰ç«¯é™æ€æ–‡ä»¶**: é€šè¿‡ `frontend-init` å®¹å™¨æå–åˆ° `./frontend/dist`
2. **Nginx ç›´æ¥æœåŠ¡**: æŒ‚è½½ `./frontend/dist` åˆ° `/usr/share/nginx/html`
3. **ç‰ˆæœ¬ç®¡ç†**: ä½¿ç”¨æ—¥æœŸæ ‡ç­¾ç®¡ç†é•œåƒç‰ˆæœ¬
4. **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨å‘½å volumes å’Œ bind mounts
5. **ç½‘ç»œéš”ç¦»**: åç«¯æœåŠ¡ä¸æš´éœ²åˆ°å¤–éƒ¨

### éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] é•œåƒå·²æ„å»ºå¹¶å¯¼å…¥
- [ ] `.env.production` å·²ç”Ÿæˆ
- [ ] `./frontend/dist` ç›®å½•å­˜åœ¨ä¸”æœ‰æ–‡ä»¶
- [ ] `nginx/nginx.conf` ä½¿ç”¨ Scheme B é…ç½®
- [ ] `docker-compose.prod.yml` ä¸­ nginx çš„ `depends_on` æ˜¯ `frontend-init`
- [ ] æ‰€æœ‰æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] å¯ä»¥è®¿é—® `/health` ç«¯ç‚¹
- [ ] å¯ä»¥è®¿é—® `/api/v1/monitoring/health` ç«¯ç‚¹
- [ ] å‰ç«¯é¡µé¢æ­£å¸¸æ˜¾ç¤º

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-01-18
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
