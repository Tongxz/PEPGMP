# ç¬¬2å¤©è¿ç»´é—®é¢˜ä¿®å¤å®æ–½æ€»ç»“

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 0. Nginx å¯åŠ¨ç«äº‰æ¡ä»¶ä¿®å¤ âœ…

**é—®é¢˜**: Nginx å¯èƒ½åœ¨ `frontend-init` å®¹å™¨è¿˜åœ¨å¤åˆ¶æ–‡ä»¶æ—¶å°±å¯åŠ¨ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–åŠ è½½ä¸å®Œæ•´çš„æ–‡ä»¶ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- âœ… æ›´æ–°äº† `docker-compose.prod.yml` å’Œ `docker-compose.prod.1panel.yml` ä¸­çš„ nginx `depends_on`
- âœ… ä½¿ç”¨ `service_completed_successfully` æ¡ä»¶ç¡®ä¿ `frontend-init` å®Œæˆåå†å¯åŠ¨ Nginx
- âœ… ä½¿ç”¨ `service_healthy` æ¡ä»¶ç¡®ä¿ API æœåŠ¡å°±ç»ªåå†å¯åŠ¨ Nginx

**é…ç½®**:
```yaml
nginx:
  depends_on:
    api:
      condition: service_healthy  # ç­‰å¾… API æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
    frontend-init:
      condition: service_completed_successfully  # å…³é”®ï¼å¿…é¡»ç­‰å¾… frontend-init è¿è¡Œå®Œæˆå¹¶æˆåŠŸé€€å‡º
```

**æ•ˆæœ**: æ¶ˆé™¤äº†ç«äº‰æ¡ä»¶ï¼Œç¡®ä¿é™æ€æ–‡ä»¶å®Œå…¨å°±ç»ªå Nginx æ‰å¯åŠ¨ã€‚

---

### 1. æ–‡ä»¶æƒé™é—®é¢˜ä¿®å¤ âœ…

**é—®é¢˜**: `frontend-init` å®¹å™¨ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œæå–çš„æ–‡ä»¶æ‰€æœ‰è€…æ˜¯ rootï¼Œå¯¼è‡´å®¿ä¸»æœºæ™®é€šç”¨æˆ·æ— æ³•åˆ é™¤/ä¿®æ”¹ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- âœ… åœ¨ `docker-compose.prod.yml` å’Œ `docker-compose.prod.1panel.yml` ä¸­æ·»åŠ äº† `HOST_UID` å’Œ `HOST_GID` ç¯å¢ƒå˜é‡
- âœ… åœ¨ `frontend-init` å‘½ä»¤ä¸­æ·»åŠ äº† `chown -R $${HOST_UID:-1000}:$${HOST_GID:-1000} /target`
- âœ… åœ¨ `scripts/generate_production_config.sh` ä¸­æ·»åŠ äº† `HOST_UID` å’Œ `HOST_GID` é…ç½®ï¼ˆé»˜è®¤ 1000ï¼‰

**ä½¿ç”¨æ–¹å¼**:
```bash
# åœ¨ .env.production ä¸­è®¾ç½®ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 1000ï¼‰
HOST_UID=1000
HOST_GID=1000

# æˆ–å¯åŠ¨æ—¶æŒ‡å®š
HOST_UID=$(id -u) HOST_GID=$(id -g) docker-compose up frontend-init
```

---

### 2. æ•°æ®åº“è¿ç§»æ”¯æŒ âœ…

**é—®é¢˜**: ç¼ºå°‘ç‰ˆæœ¬å‡çº§æ—¶çš„æ•°æ®åº“è¿ç§»æœºåˆ¶ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- âœ… åˆ›å»ºäº† `scripts/docker-entrypoint.sh` å¯åŠ¨è„šæœ¬
- âœ… è„šæœ¬åŠŸèƒ½ï¼š
  - ç­‰å¾…æ•°æ®åº“å°±ç»ªï¼ˆæœ€å¤š 30 æ¬¡é‡è¯•ï¼‰
  - è‡ªåŠ¨æ‰§è¡Œ Alembic è¿ç§»ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  - **Fail Fast ç­–ç•¥**ï¼šå¦‚æœè¿ç§»å¤±è´¥ï¼Œå®¹å™¨ç«‹å³é€€å‡ºï¼ˆexit 1ï¼‰
- âœ… æ›´æ–°äº† `Dockerfile.prod`ï¼š
  - å¤åˆ¶ `docker-entrypoint.sh` åˆ°é•œåƒ
  - å®‰è£… PostgreSQL å®¢æˆ·ç«¯ï¼ˆ`postgresql-client`ï¼‰
  - è®¾ç½® `ENTRYPOINT` ä½¿ç”¨å¯åŠ¨è„šæœ¬

**å·¥ä½œæµç¨‹**:
```
API å®¹å™¨å¯åŠ¨
  â†“
docker-entrypoint.sh æ‰§è¡Œ
  â†“
ç­‰å¾…æ•°æ®åº“å°±ç»ªï¼ˆpg_isreadyï¼‰
  â†“
æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆalembic upgrade headï¼Œå¦‚æœå­˜åœ¨ï¼‰
  â†“
  æˆåŠŸ â†’ å¯åŠ¨åº”ç”¨ï¼ˆgunicornï¼‰âœ…
  å¤±è´¥ â†’ å®¹å™¨é€€å‡ºï¼ˆexit 1ï¼‰âŒ
```

**Fail Fast ç­–ç•¥**:
- âœ… è¿ç§»å¤±è´¥æ—¶å®¹å™¨ç«‹å³é€€å‡ºï¼Œé¿å…åº”ç”¨åœ¨é”™è¯¯çš„æ•°æ®åº“ç»“æ„ä¸‹è¿è¡Œ
- âœ… Docker Compose ä¼šæ ‡è®°å®¹å™¨ä¸º Unhealthyï¼Œè¿ç»´äººå‘˜èƒ½ç«‹å³å‘ç°é—®é¢˜
- âœ… é˜²æ­¢æ•°æ®æŸåå’Œè„æ•°æ®å†™å…¥
- âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

**æ³¨æ„**: å¦‚æœé¡¹ç›®ä¸ä½¿ç”¨ Alembicï¼Œè¿ç§»æ­¥éª¤ä¼šè¢«è·³è¿‡ï¼ˆéè‡´å‘½ï¼‰ã€‚

---

### 3. æµè§ˆå™¨ç¼“å­˜é—®é¢˜ä¿®å¤ âœ…

**é—®é¢˜**: `index.html` å¯èƒ½è¢«æµè§ˆå™¨ç¼“å­˜ï¼Œå¯¼è‡´ç”¨æˆ·åŠ è½½æ—§ç‰ˆæœ¬ï¼Œå‡ºç°ç™½å±ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- âœ… æ›´æ–°äº† `scripts/prepare_minimal_deploy.sh` ä¸­çš„ Nginx é…ç½®æ¨¡æ¿
- âœ… æ·»åŠ äº† `index.html` çš„ç¼“å­˜æ§åˆ¶ï¼š
  ```nginx
  location = /index.html {
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires 0;
      try_files $uri /index.html;
  }
  ```
- âœ… é™æ€èµ„æºï¼ˆJS/CSS/å›¾ç‰‡ï¼‰ä½¿ç”¨å¼ºç¼“å­˜ï¼ˆ1å¹´ï¼‰

**æ•ˆæœ**:
- `index.html` æ¯æ¬¡è¯·æ±‚éƒ½ä¼šé‡æ–°è·å–ï¼ˆç¦ç”¨ç¼“å­˜ï¼‰
- é™æ€èµ„æºï¼ˆå¸¦ hashï¼‰ä½¿ç”¨å¼ºç¼“å­˜ï¼Œæé«˜æ€§èƒ½

---

### 4. Nginx é…ç½®ä¼˜åŒ– âœ…

**ä¼˜åŒ–å†…å®¹**:
- âœ… æ·»åŠ äº†å®‰å…¨å¤´ï¼š
  - `X-Frame-Options: SAMEORIGIN`
  - `X-Content-Type-Options: nosniff`
  - `X-XSS-Protection: 1; mode=block`
- âœ… ä¼˜åŒ–äº† Gzip é…ç½®ï¼š
  - `gzip_min_length 1k`ï¼ˆæœ€å°å‹ç¼©æ–‡ä»¶å¤§å°ï¼‰
  - æ›´è¯¦ç»†çš„ `gzip_types` åˆ—è¡¨
- âœ… è°ƒæ•´äº† `client_max_body_size` ä¸º 10Mï¼ˆé˜²æ­¢æ¶æ„å¤§æ–‡ä»¶ä¸Šä¼ ï¼‰

---

### 5. æ—¥å¿—è½®è½¬é…ç½® âœ…

**Docker å±‚æ—¥å¿—è½®è½¬**:
- âœ… å·²åœ¨ `docker-compose.prod.yml` ä¸­é…ç½®ï¼š
  ```yaml
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  ```

**åº”ç”¨å±‚æ—¥å¿—è½®è½¬**:
- âœ… å·²åœ¨ `src/api/app.py` ä¸­é…ç½® `RotatingFileHandler`ï¼š
  ```python
  api_file_handler = RotatingFileHandler(
      "/app/logs/api.log",
      maxBytes=10 * 1024 * 1024,  # 10MB
      backupCount=5,  # ä¿ç•™5ä¸ªå¤‡ä»½
  )
  ```

---

### 6. Alpine é•œåƒé—®é¢˜ âœ…

**å½“å‰çŠ¶æ€**:
- âœ… **åç«¯é•œåƒ**: `python:3.10-slim-bookworm`ï¼ˆDebian åŸºç¡€ï¼Œä¸æ˜¯ Alpineï¼‰
- âš ï¸ **æ•°æ®åº“é•œåƒ**: `postgres:16-alpine`ï¼ˆå»ºè®®æ”¹ä¸ºæ ‡å‡†ç‰ˆï¼‰

**å»ºè®®**:
å¦‚æœæ•°æ®é‡å¤§æˆ–éœ€è¦æ›´å¥½çš„æ€§èƒ½ï¼Œå¯ä»¥æ”¹ä¸ºï¼š
```yaml
database:
  image: postgres:16  # æ ‡å‡†ç‰ˆï¼Œä¸æ˜¯ alpine
```

---

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒé…ç½®æ–‡ä»¶
1. âœ… `docker-compose.prod.yml` - æ·»åŠ æ–‡ä»¶æƒé™ä¿®å¤å’Œç«äº‰æ¡ä»¶ä¿®å¤
2. âœ… `docker-compose.prod.1panel.yml` - æ·»åŠ æ–‡ä»¶æƒé™ä¿®å¤å’Œç«äº‰æ¡ä»¶ä¿®å¤
3. âœ… `Dockerfile.prod` - æ·»åŠ  entrypoint è„šæœ¬å’Œ PostgreSQL å®¢æˆ·ç«¯

### è„šæœ¬æ–‡ä»¶
4. âœ… `scripts/docker-entrypoint.sh` - æ–°å»ºï¼Œæ•°æ®åº“è¿ç§»å’Œå¯åŠ¨è„šæœ¬
5. âœ… `scripts/prepare_minimal_deploy.sh` - æ›´æ–° Nginx é…ç½®æ¨¡æ¿
6. âœ… `scripts/generate_production_config.sh` - æ·»åŠ  HOST_UID/HOST_GID é…ç½®

### æ–‡æ¡£æ–‡ä»¶
7. âœ… `docs/ç¬¬2å¤©è¿ç»´é—®é¢˜ä¿®å¤æ–¹æ¡ˆ.md` - è¯¦ç»†ä¿®å¤æ–¹æ¡ˆ
8. âœ… `docs/ç¬¬2å¤©è¿ç»´ä¿®å¤å®æ–½æ€»ç»“.md` - æœ¬æ–‡æ¡£
9. âœ… `docs/ç«äº‰æ¡ä»¶ä¿®å¤è¯´æ˜.md` - ç«äº‰æ¡ä»¶ä¿®å¤è¯¦ç»†è¯´æ˜
10. âœ… `docs/FailFastè¿ç§»ç­–ç•¥è¯´æ˜.md` - Fail Fast è¿ç§»ç­–ç•¥è¯¦ç»†è¯´æ˜

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤æ›´æ–°

### é¦–æ¬¡éƒ¨ç½²

1. **ç”Ÿæˆé…ç½®æ–‡ä»¶**:
   ```bash
   bash scripts/generate_production_config.sh
   ```

2. **æ£€æŸ¥ HOST_UID/HOST_GID**ï¼ˆå¦‚æœéœ€è¦ï¼‰:
   ```bash
   # æŸ¥çœ‹å½“å‰ç”¨æˆ· UID/GID
   id -u
   id -g

   # å¦‚æœ UID/GID ä¸æ˜¯ 1000ï¼Œç¼–è¾‘ .env.production
   vim .env.production
   # è®¾ç½® HOST_UID=ä½ çš„UID, HOST_GID=ä½ çš„GID
   ```

3. **å¯åŠ¨æœåŠ¡**:
   ```bash
   docker-compose -f docker-compose.prod.yml --env-file .env.production up -d
   ```

4. **éªŒè¯**:
   ```bash
   # æ£€æŸ¥æ–‡ä»¶æƒé™
   ls -la frontend/dist/

   # æ£€æŸ¥æ•°æ®åº“è¿ç§»æ—¥å¿—
   docker logs pepgmp-api-prod | grep -i migration

   # æµ‹è¯•æµè§ˆå™¨ç¼“å­˜
   curl -I http://localhost/index.html | grep -i cache
   ```

### æ›´æ–°éƒ¨ç½²

1. **æ›´æ–°é•œåƒ**:
   ```bash
   docker load -i docker-images/pepgmp-backend-20250119.tar
   docker load -i docker-images/pepgmp-frontend-20250119.tar
   ```

2. **æ›´æ–°é…ç½®**:
   ```bash
   bash scripts/update_image_version.sh 20250119
   ```

3. **é‡æ–°æå–é™æ€æ–‡ä»¶**ï¼ˆå¦‚æœå‰ç«¯æ›´æ–°ï¼‰:
   ```bash
   docker-compose -f docker-compose.prod.yml --env-file .env.production up frontend-init
   ```

4. **é‡å¯æœåŠ¡**:
   ```bash
   docker-compose -f docker-compose.prod.yml --env-file .env.production restart api nginx
   ```

---

## âœ… éªŒè¯æ£€æŸ¥æ¸…å•

### æ–‡ä»¶æƒé™
- [ ] `frontend/dist/` ç›®å½•æ–‡ä»¶æ‰€æœ‰è€…æ˜¯å®¿ä¸»æœºç”¨æˆ·ï¼ˆä¸æ˜¯ rootï¼‰
- [ ] å¯ä»¥æ­£å¸¸åˆ é™¤/ä¿®æ”¹ `frontend/dist/` ä¸­çš„æ–‡ä»¶

### æ•°æ®åº“è¿ç§»
- [ ] API å®¹å™¨å¯åŠ¨æ—¥å¿—æ˜¾ç¤º "Database is ready!"
- [ ] å¦‚æœä½¿ç”¨ Alembicï¼Œæ—¥å¿—æ˜¾ç¤º "Database migrations completed successfully"
- [ ] æ•°æ®åº“è¡¨ç»“æ„æ­£ç¡®

### æµè§ˆå™¨ç¼“å­˜
- [ ] `curl -I http://localhost/index.html` æ˜¾ç¤º `Cache-Control: no-cache, no-store, must-revalidate`
- [ ] é™æ€èµ„æºï¼ˆå¦‚ `assets/index-xxx.js`ï¼‰æ˜¾ç¤º `Cache-Control: public, immutable`

### Nginx é…ç½®
- [ ] Nginx é…ç½®æµ‹è¯•é€šè¿‡ï¼š`docker exec pepgmp-nginx-prod nginx -t`
- [ ] å®‰å…¨å¤´å·²æ·»åŠ ï¼ˆæ£€æŸ¥å“åº”å¤´ï¼‰

### æ—¥å¿—è½®è½¬
- [ ] Docker æ—¥å¿—æ–‡ä»¶å¤§å°é™åˆ¶ä¸º 10MB
- [ ] åº”ç”¨æ—¥å¿—æ–‡ä»¶å¤§å°é™åˆ¶ä¸º 10MB

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ–‡ä»¶æƒé™ä»ç„¶ä¸æ­£ç¡®

**ç—‡çŠ¶**: `frontend/dist/` æ–‡ä»¶æ‰€æœ‰è€…ä»ç„¶æ˜¯ root

**è§£å†³**:
```bash
# æ‰‹åŠ¨ä¿®å¤æƒé™
sudo chown -R $(id -u):$(id -g) frontend/dist/

# æ£€æŸ¥ .env.production ä¸­çš„ HOST_UID/HOST_GID
grep HOST_UID .env.production

# é‡æ–°è¿è¡Œ frontend-init
docker-compose -f docker-compose.prod.yml --env-file .env.production up frontend-init
```

### é—®é¢˜ 2: æ•°æ®åº“è¿ç§»å¤±è´¥

**ç—‡çŠ¶**: API å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œæ—¥å¿—æ˜¾ç¤ºè¿ç§»é”™è¯¯

**è§£å†³**:
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs pepgmp-api-prod

# å¦‚æœä¸éœ€è¦è¿ç§»ï¼Œå¯ä»¥ä¸´æ—¶ç¦ç”¨
# ç¼–è¾‘ scripts/docker-entrypoint.shï¼Œæ³¨é‡Šæ‰è¿ç§»éƒ¨åˆ†

# æˆ–æ‰‹åŠ¨æ‰§è¡Œè¿ç§»
docker exec pepgmp-api-prod alembic upgrade head
```

### é—®é¢˜ 3: æµè§ˆå™¨ä»ç„¶ç¼“å­˜ index.html

**ç—‡çŠ¶**: æ›´æ–°åç”¨æˆ·ä»ç„¶çœ‹åˆ°æ—§é¡µé¢

**è§£å†³**:
```bash
# æ£€æŸ¥ Nginx é…ç½®
docker exec pepgmp-nginx-prod cat /etc/nginx/nginx.conf | grep -A 5 "index.html"

# é‡æ–°åŠ è½½ Nginx é…ç½®
docker exec pepgmp-nginx-prod nginx -s reload

# å¼ºåˆ¶é‡æ–°ç”Ÿæˆ Nginx é…ç½®
bash scripts/prepare_minimal_deploy.sh ~/projects/PEPGMPyes
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **HOST_UID/HOST_GID**: é»˜è®¤å€¼æ˜¯ 1000ï¼Œé€‚ç”¨äºå¤§å¤šæ•° Linux ç³»ç»Ÿã€‚å¦‚æœå®¿ä¸»æœºç”¨æˆ· UID ä¸åŒï¼Œéœ€è¦åœ¨ `.env.production` ä¸­è®¾ç½®ã€‚

2. **æ•°æ®åº“è¿ç§»**: å¦‚æœé¡¹ç›®ä¸ä½¿ç”¨ Alembicï¼Œè¿ç§»æ­¥éª¤ä¼šè¢«è·³è¿‡ï¼ˆéè‡´å‘½ï¼‰ã€‚å¦‚æœéœ€è¦ä½¿ç”¨å…¶ä»–è¿ç§»å·¥å…·ï¼Œå¯ä»¥ä¿®æ”¹ `docker-entrypoint.sh`ã€‚

3. **Nginx é…ç½®**: å¦‚æœæ‰‹åŠ¨ä¿®æ”¹äº† `nginx/nginx.conf`ï¼Œè¿è¡Œ `prepare_minimal_deploy.sh` æ—¶éœ€è¦æŒ‡å®š `force overwrite` å‚æ•°ã€‚

4. **æ—¥å¿—è½®è½¬**: Docker å±‚æ—¥å¿—è½®è½¬å·²é…ç½®ï¼Œä½†åº”ç”¨å±‚æ—¥å¿—è½®è½¬éœ€è¦ç¡®ä¿ Python ä»£ç ä¸­ä½¿ç”¨äº† `RotatingFileHandler`ã€‚

---

## ğŸ¯ æ€»ç»“

æ‰€æœ‰ç¬¬2å¤©è¿ç»´é—®é¢˜å·²ä¿®å¤ï¼š

- âœ… **ç«äº‰æ¡ä»¶ä¿®å¤** - ä½¿ç”¨ `service_completed_successfully` ç¡®ä¿ frontend-init å®Œæˆåå†å¯åŠ¨ Nginx
- âœ… æ–‡ä»¶æƒé™é—®é¢˜ - é€šè¿‡ `HOST_UID/HOST_GID` ç¯å¢ƒå˜é‡å’Œ `chown` ä¿®å¤
- âœ… **æ•°æ®åº“è¿ç§» Fail Fast** - è¿ç§»å¤±è´¥æ—¶å®¹å™¨ç«‹å³é€€å‡ºï¼Œé¿å…åº”ç”¨åœ¨é”™è¯¯çŠ¶æ€ä¸‹è¿è¡Œ
- âœ… æµè§ˆå™¨ç¼“å­˜ - é€šè¿‡ Nginx é…ç½®ç¦ç”¨ `index.html` ç¼“å­˜
- âœ… æ—¥å¿—è½®è½¬ - Docker å±‚å’Œåº”ç”¨å±‚éƒ½å·²é…ç½®
- âœ… Nginx ä¼˜åŒ– - æ·»åŠ å®‰å…¨å¤´å’Œä¼˜åŒ– Gzip
- âœ… Alpine é•œåƒ - åç«¯å·²ä½¿ç”¨ Debianï¼Œæ•°æ®åº“å»ºè®®ä½¿ç”¨æ ‡å‡†ç‰ˆ

**ä¸‹ä¸€æ­¥**: éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒï¼ŒéªŒè¯æ‰€æœ‰ä¿®å¤æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-18
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
