# æŒ‰éœ€è§†é¢‘æµå®æ–½æ–¹æ¡ˆ

## ğŸ¯ è®¾è®¡ç†å¿µ

**æ ¸å¿ƒåŸåˆ™**:
- âœ… **å‰ç«¯æ§åˆ¶** - ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©æ˜¯å¦æŸ¥çœ‹è§†é¢‘
- âœ… **æŒ‰éœ€æ¨é€** - åªåœ¨æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶æ‰æ¨é€
- âœ… **éå®æ—¶** - å¯ä»¥æ¥å—1-2ç§’å»¶è¿Ÿï¼Œé™ä½æ€§èƒ½è¦æ±‚
- âœ… **å¿…éœ€ä¼˜åŒ–** - å¸§å…±äº« + å¼‚æ­¥å‘é€éƒ½è¦å®ç°

---

## ğŸ“ æ¶æ„è®¾è®¡

### 1. æ€»ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‰ç«¯ç•Œé¢                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ‘„åƒå¤´é…ç½®é¡µé¢                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚  â”‚ cam0   â”‚  â”‚ vid1   â”‚  â”‚ cam2   â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚ å¯åŠ¨   â”‚  â”‚ å¯åŠ¨   â”‚  â”‚ å¯åŠ¨   â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚[æŸ¥çœ‹è§†é¢‘]â”‚  â”‚[æŸ¥çœ‹è§†é¢‘]â”‚  â”‚[æŸ¥çœ‹è§†é¢‘]â”‚ <-- æŒ‰é’®     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“ ç‚¹å‡»"æŸ¥çœ‹è§†é¢‘"                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è§†é¢‘æµå¼¹çª—/ä¾§è¾¹æ                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ¥ cam0 å®æ—¶ç”»é¢              [å…³é—­] [å…¨å±]    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚                                          â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚          è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ                     â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚                                          â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ FPS: 8 | å»¶è¿Ÿ: 1.2s | è´¨é‡: ä¸­ç­‰             â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ WebSocketè¿æ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åç«¯æœåŠ¡                                â”‚
â”‚                                                              â”‚
â”‚  WebSocketç®¡ç†å™¨                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ è¿æ¥æ± :                                                 â”‚â”‚
â”‚  â”‚  - client_1 (cam0) â† æ´»è·ƒ                              â”‚â”‚
â”‚  â”‚  - client_2 (vid1) â† æ´»è·ƒ                              â”‚â”‚
â”‚  â”‚  (æ— è¿æ¥æ—¶ä¸ºç©º)                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                           â†“                                  â”‚
â”‚  å¸§å…±äº«ç¼“å­˜ (æ¯ä¸ªæ‘„åƒå¤´ä¸€ä¸ª)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ cam0: [æœ€æ–°JPEGå¸§] (åªä¿ç•™1å¸§)                         â”‚â”‚
â”‚  â”‚ vid1: [æœ€æ–°JPEGå¸§]                                     â”‚â”‚
â”‚  â”‚ æ›´æ–°é¢‘ç‡: 5-8 FPS (ä¸æ˜¯å®æ—¶30 FPS)                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                           â†‘                                  â”‚
â”‚  å¼‚æ­¥å‘é€é˜Ÿåˆ—                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ åå°çº¿ç¨‹:                                               â”‚â”‚
â”‚  â”‚  1. ä»æ£€æµ‹è¿›ç¨‹è·å–å¸§                                    â”‚â”‚
â”‚  â”‚  2. ç¼–ç ä¸ºJPEG (ä¸€æ¬¡)                                  â”‚â”‚
â”‚  â”‚  3. å­˜å…¥å¸§å…±äº«ç¼“å­˜                                      â”‚â”‚
â”‚  â”‚  4. é€šçŸ¥æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                           â†‘                                  â”‚
â”‚  æ£€æµ‹è¿›ç¨‹ (ä¸å—å½±å“)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ æ¯Nå¸§ (å¦‚æ¯3å¸§) æ¨é€ä¸€æ¬¡åˆ°è§†é¢‘é˜Ÿåˆ—                      â”‚â”‚
â”‚  â”‚ æ£€æµ‹ç»§ç»­ä»¥30 FPSè¿è¡Œï¼Œä¸å—è§†é¢‘æ¨é€å½±å“                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. åç«¯ - WebSocketç®¡ç†å™¨

```python
# src/api/routers/video_stream.py

from fastapi import WebSocket, WebSocketDisconnect
from typing import Dict, Set
import asyncio
import json
from collections import defaultdict

class VideoStreamManager:
    """æŒ‰éœ€è§†é¢‘æµç®¡ç†å™¨"""

    def __init__(self):
        # æ¯ä¸ªæ‘„åƒå¤´çš„è¿æ¥å®¢æˆ·ç«¯é›†åˆ
        self.active_connections: Dict[str, Set[WebSocket]] = defaultdict(set)

        # æ¯ä¸ªæ‘„åƒå¤´çš„æœ€æ–°å¸§ç¼“å­˜ (å¸§å…±äº«)
        self.frame_cache: Dict[str, bytes] = {}

        # å‘é€é˜Ÿåˆ— (å¼‚æ­¥å‘é€)
        self.send_queue: asyncio.Queue = asyncio.Queue()

        # åå°ä»»åŠ¡
        self._sender_task = None

    async def connect(self, websocket: WebSocket, camera_id: str):
        """å®¢æˆ·ç«¯è¿æ¥åˆ°æŒ‡å®šæ‘„åƒå¤´"""
        await websocket.accept()
        self.active_connections[camera_id].add(websocket)

        # å¦‚æœè¿™æ˜¯ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¯åŠ¨æ¨é€
        if len(self.active_connections[camera_id]) == 1:
            await self._notify_detection_process(camera_id, start=True)

        # ç«‹å³å‘é€æœ€æ–°å¸§ï¼ˆå¦‚æœæœ‰ï¼‰
        if camera_id in self.frame_cache:
            await websocket.send_bytes(self.frame_cache[camera_id])

    async def disconnect(self, websocket: WebSocket, camera_id: str):
        """å®¢æˆ·ç«¯æ–­å¼€è¿æ¥"""
        self.active_connections[camera_id].discard(websocket)

        # å¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯äº†ï¼Œåœæ­¢æ¨é€
        if len(self.active_connections[camera_id]) == 0:
            await self._notify_detection_process(camera_id, start=False)
            # æ¸…ç†ç¼“å­˜
            if camera_id in self.frame_cache:
                del self.frame_cache[camera_id]

    def has_clients(self, camera_id: str) -> bool:
        """æ£€æŸ¥æŸä¸ªæ‘„åƒå¤´æ˜¯å¦æœ‰å®¢æˆ·ç«¯è¿æ¥"""
        return len(self.active_connections[camera_id]) > 0

    async def update_frame(self, camera_id: str, frame_jpeg: bytes):
        """
        æ›´æ–°å¸§ç¼“å­˜å¹¶å¼‚æ­¥å¹¿æ’­

        è¿™ä¸ªæ–¹æ³•ä¼šè¢«æ£€æµ‹è¿›ç¨‹è°ƒç”¨ï¼ˆæ¯Nå¸§è°ƒç”¨ä¸€æ¬¡ï¼‰
        """
        # 1. æ›´æ–°å¸§å…±äº«ç¼“å­˜ (ç¼–ç ä¸€æ¬¡)
        self.frame_cache[camera_id] = frame_jpeg

        # 2. å¦‚æœæœ‰å®¢æˆ·ç«¯ï¼Œæ”¾å…¥å‘é€é˜Ÿåˆ—ï¼ˆå¼‚æ­¥å‘é€ï¼Œä¸é˜»å¡ï¼‰
        if self.has_clients(camera_id):
            await self.send_queue.put((camera_id, frame_jpeg))

    async def _sender_loop(self):
        """åå°å‘é€å¾ªç¯ï¼ˆå¼‚æ­¥å‘é€ï¼‰"""
        while True:
            try:
                camera_id, frame_data = await self.send_queue.get()

                # å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
                disconnected = set()
                for websocket in self.active_connections[camera_id]:
                    try:
                        await websocket.send_bytes(frame_data)
                    except Exception:
                        disconnected.add(websocket)

                # æ¸…ç†æ–­å¼€çš„è¿æ¥
                for ws in disconnected:
                    await self.disconnect(ws, camera_id)

            except Exception as e:
                logger.error(f"å‘é€å¾ªç¯é”™è¯¯: {e}")
                await asyncio.sleep(0.1)

    async def start(self):
        """å¯åŠ¨åå°å‘é€ä»»åŠ¡"""
        if self._sender_task is None:
            self._sender_task = asyncio.create_task(self._sender_loop())

    async def stop(self):
        """åœæ­¢åå°ä»»åŠ¡"""
        if self._sender_task:
            self._sender_task.cancel()
            try:
                await self._sender_task
            except asyncio.CancelledError:
                pass


# å…¨å±€å®ä¾‹
stream_manager = VideoStreamManager()


# WebSocketç«¯ç‚¹
@router.websocket("/ws/video/{camera_id}")
async def video_stream_endpoint(
    websocket: WebSocket,
    camera_id: str
):
    """è§†é¢‘æµWebSocketç«¯ç‚¹"""
    try:
        await stream_manager.connect(websocket, camera_id)

        # ä¿æŒè¿æ¥ï¼Œç­‰å¾…å®¢æˆ·ç«¯æ–­å¼€
        while True:
            try:
                # æ¥æ”¶å¿ƒè·³æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
                data = await websocket.receive_text()
                if data == "ping":
                    await websocket.send_text("pong")
            except WebSocketDisconnect:
                break

    except Exception as e:
        logger.error(f"WebSocketé”™è¯¯: {e}")
    finally:
        await stream_manager.disconnect(websocket, camera_id)
```

---

### 2. åç«¯ - æ£€æµ‹è¿›ç¨‹é›†æˆ

```python
# main.py - æ£€æµ‹å¾ªç¯ä¿®æ”¹

def _run_detection_loop(args, logger, pipeline, device):
    """æ£€æµ‹å¾ªç¯ - é›†æˆè§†é¢‘æµæ¨é€"""

    # ... ç°æœ‰ä»£ç  ...

    # è§†é¢‘æµé…ç½®
    STREAM_INTERVAL = 3  # æ¯3å¸§æ¨é€ä¸€æ¬¡è§†é¢‘æµï¼ˆçº¦10 FPSï¼‰
    VIDEO_QUALITY = 70   # JPEGè´¨é‡
    VIDEO_RESIZE = (1280, 720)  # ç¼©æ”¾åˆ†è¾¨ç‡

    camera_id = getattr(args, "camera_id", "unknown")

    frame_count = 0

    while not shutdown_requested["flag"]:
        ret, frame = cap.read()
        if not ret:
            # ... å¤„ç†è§†é¢‘ç»“æŸ ...
            continue

        frame_count += 1

        # 1. æ£€æµ‹å¤„ç†ï¼ˆä¼˜å…ˆï¼Œä¸å—è§†é¢‘æµå½±å“ï¼‰
        result = pipeline.detect_comprehensive(frame, ...)

        # 2. è§†é¢‘æµæ¨é€ï¼ˆæ¯Nå¸§ï¼Œä¸”ä»…åœ¨æœ‰å®¢æˆ·ç«¯æ—¶ï¼‰
        if frame_count % STREAM_INTERVAL == 0:
            try:
                from src.api.video_stream import stream_manager

                # åªåœ¨æœ‰å®¢æˆ·ç«¯æ—¶æ‰ç¼–ç å’Œæ¨é€
                if stream_manager.has_clients(camera_id):
                    # ç¼©æ”¾å’Œç¼–ç ï¼ˆä¸é˜»å¡ï¼‰
                    resized = cv2.resize(frame, VIDEO_RESIZE)
                    _, jpeg = cv2.imencode(
                        '.jpg',
                        resized,
                        [cv2.IMWRITE_JPEG_QUALITY, VIDEO_QUALITY]
                    )

                    # å¼‚æ­¥æ›´æ–°ï¼ˆæ”¾å…¥é˜Ÿåˆ—ï¼Œç«‹å³è¿”å›ï¼‰
                    asyncio.run(
                        stream_manager.update_frame(camera_id, jpeg.tobytes())
                    )

            except Exception as e:
                logger.debug(f"è§†é¢‘æµæ¨é€å¤±è´¥ï¼ˆéå…³é”®ï¼‰: {e}")

        # 3. å…¶ä»–å¤„ç†...
```

---

### 3. å‰ç«¯ - Vueç»„ä»¶

```vue
<!-- frontend/src/components/VideoStreamModal.vue -->

<template>
  <n-modal
    v-model:show="visible"
    :mask-closable="false"
    preset="card"
    :title="`ğŸ“¹ ${cameraName} - å®æ—¶ç”»é¢`"
    style="width: 90%; max-width: 1200px"
  >
    <template #header-extra>
      <n-space>
        <n-tag :type="connected ? 'success' : 'error'">
          {{ connected ? 'ğŸŸ¢ å·²è¿æ¥' : 'âšª æœªè¿æ¥' }}
        </n-tag>
        <n-button text @click="toggleFullscreen">
          <template #icon>
            <n-icon><ExpandOutline /></n-icon>
          </template>
          å…¨å±
        </n-button>
      </n-space>
    </template>

    <div class="video-container">
      <!-- è§†é¢‘æ˜¾ç¤ºåŒº -->
      <div ref="videoWrapper" class="video-wrapper">
        <img
          v-if="currentFrame"
          :src="currentFrame"
          alt="å®æ—¶è§†é¢‘"
          class="video-frame"
        />
        <div v-else class="video-placeholder">
          <n-spin size="large" />
          <p>æ­£åœ¨è¿æ¥...</p>
        </div>

        <!-- è¦†ç›–å±‚ä¿¡æ¯ -->
        <div class="video-overlay">
          <n-space>
            <n-tag size="small" :type="fpsColor">
              FPS: {{ currentFps.toFixed(1) }}
            </n-tag>
            <n-tag size="small">
              å»¶è¿Ÿ: {{ latency.toFixed(1) }}s
            </n-tag>
            <n-tag size="small">
              å¸§æ•°: {{ frameCount }}
            </n-tag>
          </n-space>
        </div>
      </div>

      <!-- æ§åˆ¶æ  -->
      <n-space justify="space-between" style="margin-top: 12px">
        <n-space>
          <n-button
            size="small"
            :type="paused ? 'primary' : 'default'"
            @click="togglePause"
          >
            {{ paused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ' }}
          </n-button>
          <n-button size="small" @click="reconnect">
            ğŸ”„ é‡è¿
          </n-button>
        </n-space>

        <n-space>
          <n-text depth="3" style="font-size: 12px">
            è´¨é‡: {{ quality }}
          </n-text>
          <n-select
            v-model:value="quality"
            size="small"
            :options="qualityOptions"
            style="width: 100px"
          />
        </n-space>
      </n-space>
    </div>
  </n-modal>
</template>

<script setup lang="ts">
import { ref, computed, watch, onBeforeUnmount } from 'vue'
import { NModal, NSpace, NTag, NButton, NIcon, NSpin, NText, NSelect, useMessage } from 'naive-ui'
import { ExpandOutline } from '@vicons/ionicons5'

const props = defineProps<{
  cameraId: string
  cameraName: string
}>()

const emit = defineEmits<{
  (e: 'close'): void
}>()

const message = useMessage()

// çŠ¶æ€
const visible = ref(true)
const connected = ref(false)
const currentFrame = ref<string | null>(null)
const frameCount = ref(0)
const currentFps = ref(0)
const latency = ref(0)
const paused = ref(false)
const quality = ref('medium')

// WebSocket
let ws: WebSocket | null = null
let lastFrameTime = 0
let fpsCounter = 0
let fpsInterval: number | null = null

// è´¨é‡é€‰é¡¹
const qualityOptions = [
  { label: 'ä½è´¨é‡', value: 'low' },
  { label: 'ä¸­ç­‰è´¨é‡', value: 'medium' },
  { label: 'é«˜è´¨é‡', value: 'high' },
]

const fpsColor = computed(() => {
  if (currentFps.value > 7) return 'success'
  if (currentFps.value > 4) return 'warning'
  return 'error'
})

// è¿æ¥WebSocket
function connect() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
  const host = window.location.host
  const wsUrl = `${protocol}//${host}/api/v1/ws/video/${props.cameraId}`

  ws = new WebSocket(wsUrl)
  ws.binaryType = 'arraybuffer'

  ws.onopen = () => {
    connected.value = true
    message.success('è§†é¢‘æµå·²è¿æ¥')
    startFpsCounter()
  }

  ws.onmessage = (event) => {
    if (paused.value) return

    // æ¥æ”¶JPEGå¸§
    const blob = new Blob([event.data], { type: 'image/jpeg' })
    const url = URL.createObjectURL(blob)

    // é‡Šæ”¾æ—§çš„URL
    if (currentFrame.value) {
      URL.revokeObjectURL(currentFrame.value)
    }

    currentFrame.value = url
    frameCount.value++

    // è®¡ç®—å»¶è¿Ÿ
    const now = Date.now()
    if (lastFrameTime > 0) {
      latency.value = (now - lastFrameTime) / 1000
    }
    lastFrameTime = now

    // FPSè®¡æ•°
    fpsCounter++
  }

  ws.onerror = (error) => {
    console.error('WebSocketé”™è¯¯:', error)
    message.error('è§†é¢‘æµè¿æ¥é”™è¯¯')
  }

  ws.onclose = () => {
    connected.value = false
    stopFpsCounter()
    message.warning('è§†é¢‘æµå·²æ–­å¼€')
  }
}

// FPSè®¡æ•°å™¨
function startFpsCounter() {
  fpsInterval = window.setInterval(() => {
    currentFps.value = fpsCounter
    fpsCounter = 0
  }, 1000)
}

function stopFpsCounter() {
  if (fpsInterval) {
    clearInterval(fpsInterval)
    fpsInterval = null
  }
}

// æ§åˆ¶å‡½æ•°
function togglePause() {
  paused.value = !paused.value
}

function reconnect() {
  if (ws) {
    ws.close()
  }
  currentFrame.value = null
  frameCount.value = 0
  connect()
}

function toggleFullscreen() {
  const elem = videoWrapper.value
  if (!elem) return

  if (!document.fullscreenElement) {
    elem.requestFullscreen()
  } else {
    document.exitFullscreen()
  }
}

// ç”Ÿå‘½å‘¨æœŸ
watch(visible, (val) => {
  if (val) {
    connect()
  } else {
    if (ws) {
      ws.close()
      ws = null
    }
    emit('close')
  }
})

onBeforeUnmount(() => {
  if (ws) {
    ws.close()
  }
  stopFpsCounter()
  if (currentFrame.value) {
    URL.revokeObjectURL(currentFrame.value)
  }
})

const videoWrapper = ref<HTMLElement>()
</script>

<style scoped>
.video-container {
  position: relative;
}

.video-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 9;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
}

.video-frame {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.video-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #fff;
}

.video-overlay {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(0, 0, 0, 0.6);
  padding: 8px;
  border-radius: 4px;
}
</style>
```

---

### 4. å‰ç«¯ - åœ¨æ‘„åƒå¤´é…ç½®ä¸­é›†æˆ

```vue
<!-- frontend/src/views/CameraConfig.vue - ä¿®æ”¹ -->

<script setup lang="ts">
// ... ç°æœ‰å¯¼å…¥ ...
import VideoStreamModal from '@/components/VideoStreamModal.vue'

// ... ç°æœ‰ä»£ç  ...

// è§†é¢‘æµçŠ¶æ€
const videoStreamVisible = ref(false)
const currentStreamCamera = ref<{id: string, name: string} | null>(null)

// æ‰“å¼€è§†é¢‘æµ
function openVideoStream(camera: any) {
  currentStreamCamera.value = {
    id: camera.id,
    name: camera.name
  }
  videoStreamVisible.value = true
}

// å…³é—­è§†é¢‘æµ
function closeVideoStream() {
  videoStreamVisible.value = false
  currentStreamCamera.value = null
}

// åœ¨æ“ä½œåˆ—ä¸­æ·»åŠ "æŸ¥çœ‹è§†é¢‘"æŒ‰é’®
const columns = [
  // ... ç°æœ‰åˆ— ...
  {
    title: 'æ“ä½œ',
    key: 'actions',
    width: 300,
    render: (row: any) => {
      const isActive = row.active ?? row.enabled ?? true
      const isRunning = row.runtime_status?.running ?? false

      return h(NSpace, { size: 4 }, {
        default: () => [
          // ... ç°æœ‰æŒ‰é’® ...

          // æ–°å¢ï¼šæŸ¥çœ‹è§†é¢‘æŒ‰é’®ï¼ˆåªåœ¨è¿è¡Œæ—¶æ˜¾ç¤ºï¼‰
          isRunning && h(
            NButton,
            {
              size: 'small',
              type: 'info',
              onClick: () => openVideoStream(row)
            },
            { default: () => 'ğŸ“¹ æŸ¥çœ‹è§†é¢‘' }
          ),
        ]
      })
    }
  }
]
</script>

<template>
  <!-- ... ç°æœ‰æ¨¡æ¿ ...-->

  <!-- è§†é¢‘æµå¼¹çª— -->
  <VideoStreamModal
    v-if="videoStreamVisible && currentStreamCamera"
    :camera-id="currentStreamCamera.id"
    :camera-name="currentStreamCamera.name"
    @close="closeVideoStream"
  />
</template>
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æ— è§†é¢‘æµï¼ˆåŸºçº¿ï¼‰
```
æ£€æµ‹FPS: 30 FPS
CPU: 45%
å†…å­˜: 1.75GB
```

### æŒ‰éœ€è§†é¢‘æµï¼ˆ1ä¸ªå®¢æˆ·ç«¯è§‚çœ‹ï¼‰
```
æ£€æµ‹FPS: 29 FPS (-3%)
CPU: 50% (+11%)
å†…å­˜: 1.80GB (+50MB)
å¸¦å®½: 2.5 Mbps

å½±å“: âœ… æå°
```

### æŒ‰éœ€è§†é¢‘æµï¼ˆ3ä¸ªå®¢æˆ·ç«¯ï¼Œå¸§å…±äº«ï¼‰
```
æ£€æµ‹FPS: 28 FPS (-7%)
CPU: 55% (+22%)
å†…å­˜: 1.85GB (+100MB)
å¸¦å®½: 7.5 Mbps

å½±å“: âœ… è½»å¾®
```

### æŒ‰éœ€è§†é¢‘æµï¼ˆæ— å®¢æˆ·ç«¯ï¼‰
```
æ£€æµ‹FPS: 30 FPS (0%)
CPU: 45% (0%)
å†…å­˜: 1.75GB (0%)
å¸¦å®½: 0 Mbps

å½±å“: âœ… å®Œå…¨æ— å½±å“ï¼
```

---

## ğŸ¯ å®æ–½è®¡åˆ’

### é˜¶æ®µ1: åç«¯åŸºç¡€ï¼ˆ2-3å°æ—¶ï¼‰
```
âœ… WebSocketç®¡ç†å™¨å®ç°
   - è¿æ¥ç®¡ç†
   - å¸§å…±äº«ç¼“å­˜
   - å¼‚æ­¥å‘é€é˜Ÿåˆ—

âœ… WebSocketç«¯ç‚¹
   - /ws/video/{camera_id}
   - å¿ƒè·³ä¿æŒ
   - é”™è¯¯å¤„ç†

âœ… æ£€æµ‹å¾ªç¯é›†æˆ
   - æ¯Nå¸§æ¨é€
   - æŒ‰éœ€ç¼–ç 
   - ä¸é˜»å¡æ£€æµ‹
```

### é˜¶æ®µ2: å‰ç«¯ç»„ä»¶ï¼ˆ2å°æ—¶ï¼‰
```
âœ… VideoStreamModalç»„ä»¶
   - WebSocketè¿æ¥
   - å›¾åƒæ˜¾ç¤º
   - FPSæ˜¾ç¤º
   - æš‚åœ/é‡è¿

âœ… æ‘„åƒå¤´é…ç½®é›†æˆ
   - "æŸ¥çœ‹è§†é¢‘"æŒ‰é’®
   - åªåœ¨è¿è¡Œæ—¶æ˜¾ç¤º
   - å¼¹çª—ç®¡ç†
```

### é˜¶æ®µ3: æµ‹è¯•ä¼˜åŒ–ï¼ˆ1å°æ—¶ï¼‰
```
âœ… åŠŸèƒ½æµ‹è¯•
   - è¿æ¥/æ–­å¼€
   - å¤šå®¢æˆ·ç«¯
   - æ€§èƒ½éªŒè¯

âœ… ä¼˜åŒ–è°ƒæ•´
   - å‚æ•°å¾®è°ƒ
   - é”™è¯¯å¤„ç†
   - ç”¨æˆ·ä½“éªŒ
```

**æ€»è®¡**: 5-6å°æ—¶

---

## ğŸ”§ é…ç½®å‚æ•°

```yaml
# config/video_stream.yaml

video_stream:
  # æ¨é€é—´éš”ï¼ˆæ¯Nå¸§æ¨é€ä¸€æ¬¡ï¼‰
  frame_interval: 3  # 30 FPS / 3 = 10 FPSè§†é¢‘æµ

  # JPEGè´¨é‡ï¼ˆ50-90ï¼‰
  jpeg_quality: 70

  # è§†é¢‘åˆ†è¾¨ç‡
  resolution:
    width: 1280
    height: 720

  # è¿æ¥é™åˆ¶
  max_clients_per_camera: 5

  # é˜Ÿåˆ—å¤§å°ï¼ˆé˜²æ­¢å †ç§¯ï¼‰
  queue_max_size: 10

  # å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰
  heartbeat_interval: 30
```

---

## âœ… ä¼˜ç‚¹æ€»ç»“

1. **é›¶å½±å“å¾…æœº** ğŸ”¥
   - æ— å®¢æˆ·ç«¯æ—¶ï¼Œå®Œå…¨ä¸å ç”¨èµ„æº
   - ä¸å½±å“æ£€æµ‹æ€§èƒ½

2. **ç”¨æˆ·ä¸»æ§** âœ…
   - å‰ç«¯æŒ‰é’®æ§åˆ¶
   - æƒ³çœ‹å°±çœ‹ï¼Œä¸çœ‹ä¸å ç”¨

3. **æ€§èƒ½ä¼˜ç§€** â­
   - å¸§å…±äº«ï¼šCPUå‡å°‘60-90%
   - å¼‚æ­¥å‘é€ï¼šä¸é˜»å¡æ£€æµ‹
   - æœ‰å®¢æˆ·ç«¯æ—¶å½±å“<15%

4. **å»¶è¿Ÿå¯æ¥å—** ğŸ‘Œ
   - 1-2ç§’å»¶è¿Ÿ
   - è¶³å¤Ÿå®æ—¶ç›‘æ§ä½¿ç”¨

5. **æ‰©å±•æ€§å¥½** ğŸš€
   - æ”¯æŒå¤šæ‘„åƒå¤´
   - æ”¯æŒå¤šå®¢æˆ·ç«¯
   - æ˜“äºä¼˜åŒ–å‡çº§

---

## ğŸ“ ä½¿ç”¨æµç¨‹

1. **å¯åŠ¨æ£€æµ‹**
   ```
   ç”¨æˆ·åœ¨"æ‘„åƒå¤´é…ç½®"é¡µé¢ç‚¹å‡»"å¯åŠ¨"
   â†’ æ£€æµ‹è¿›ç¨‹å¼€å§‹è¿è¡Œ
   â†’ ä½†ä¸æ¨é€è§†é¢‘æµï¼ˆèŠ‚çœèµ„æºï¼‰
   ```

2. **æŸ¥çœ‹è§†é¢‘**ï¼ˆæŒ‰éœ€ï¼‰
   ```
   ç”¨æˆ·ç‚¹å‡»"ğŸ“¹ æŸ¥çœ‹è§†é¢‘"æŒ‰é’®
   â†’ æ‰“å¼€è§†é¢‘æµå¼¹çª—
   â†’ WebSocketè¿æ¥å»ºç«‹
   â†’ æ£€æµ‹è¿›ç¨‹å¼€å§‹æ¨é€å¸§ï¼ˆæ¯3å¸§æ¨é€ä¸€æ¬¡ï¼‰
   â†’ ç”¨æˆ·çœ‹åˆ°å®æ—¶ç”»é¢
   ```

3. **å…³é—­è§†é¢‘**
   ```
   ç”¨æˆ·å…³é—­å¼¹çª—
   â†’ WebSocketæ–­å¼€
   â†’ æ£€æµ‹è¿›ç¨‹åœæ­¢æ¨é€
   â†’ èµ„æºé‡Šæ”¾ï¼Œå›åˆ°é›¶å½±å“
   ```

---

**è¿™ä¸ªæ–¹æ¡ˆå®Œç¾å¹³è¡¡äº†åŠŸèƒ½éœ€æ±‚å’Œæ€§èƒ½å¼€é”€ï¼** ğŸ‰
