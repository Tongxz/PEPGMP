# 数据库配置历史分析

## 📋 问题确认

**用户问题**：旧的数据库配置是不是当前项目内配置文件配置的信息？

**答案**：✅ **是的**

---

## 🔍 历史追溯

### 1. 数据库 Volume 创建时间

```bash
docker volume inspect pyt_postgres_prod_data
# CreatedAt: 2025-10-20T03:12:23Z
```

### 2. 项目重命名提交

**提交**: `a246e0d` - `refactor: 项目重命名 Pyt -> pepGMP`

**变更内容**：
```diff
- container_name: pyt-postgres-prod
+ container_name: pepgmp-postgres-prod

- POSTGRES_DB: pyt_production
+ POSTGRES_DB: pepgmp_production

- POSTGRES_USER: pyt_prod
+ POSTGRES_USER: pepgmp_prod
```

### 3. 时间线

```
2025-10-20 03:12:23  ← 数据库 volume 创建（用 pyt_prod 用户初始化）
        ↓
    [项目重命名]
        ↓
2025-12-04           ← 当前时间（配置改为 pepgmp_prod，但数据库未重新初始化）
```

---

## 🎯 根本原因

1. **数据库在重命名前初始化**
   - 使用旧配置：`POSTGRES_USER: pyt_prod`
   - 使用旧数据库名：`pyt_production`

2. **项目重命名后配置变更**
   - 配置改为：`POSTGRES_USER: pepgmp_prod`
   - 数据库名改为：`pepgmp_production`

3. **PostgreSQL 不会重新初始化**
   - 检测到数据目录已存在
   - 跳过初始化步骤
   - **数据库中只有 `pyt_prod` 用户，没有 `pepgmp_prod` 用户**

---

## ✅ 解决方案

### 方案 1：删除 Volume 重新初始化（推荐）

```bash
cd /Users/zhou/projects/Pyt

# 停止服务
docker compose -f docker-compose.prod.yml down

# 删除旧数据库 volume
docker volume rm pyt_postgres_prod_data

# 重新启动（会用新配置 pepgmp_prod 初始化）
docker compose -f docker-compose.prod.yml up -d
```

**结果**：
- 数据库用 `pepgmp_prod` 用户初始化
- 数据库名为 `pepgmp_production`
- 密码使用 `.env.production` 中的配置

### 方案 2：使用旧用户名（如果知道旧密码）

如果数据库中有重要数据需要保留，可以：

1. **修改 `.env.production`**
   ```bash
   POSTGRES_USER=pyt_prod
   POSTGRES_DB=pyt_production
   DATABASE_URL=postgresql://pyt_prod:<旧密码>@database:5432/pyt_production
   ```

2. **重启服务**
   ```bash
   docker compose -f docker-compose.prod.yml restart api
   ```

**注意**：需要知道旧密码才能使用此方案。

---

## 📝 验证

修复后验证：

```bash
# 检查用户是否存在
docker exec -e PGPASSWORD='<密码>' \
  pepgmp-postgres-prod psql -U pepgmp_prod -d pepgmp_production -c "\du"

# 测试 API 连接
curl http://localhost:8000/api/v1/monitoring/health
# 应该返回 "status":"ok"
```

---

## 🛡️ 预防措施

1. **配置变更时重新初始化数据库**
   - 如果修改了 `POSTGRES_USER` 或 `POSTGRES_DB`
   - 需要删除 volume 重新初始化

2. **使用数据库迁移工具**
   - 使用 Alembic 管理 schema 变更
   - 避免手动修改数据库结构

3. **版本控制配置**
   - 将配置变更纳入版本控制
   - 记录配置变更历史

---

**结论**：
- ✅ 旧的数据库配置确实是项目内配置文件的信息
- ✅ 旧用户：`pyt_prod`，旧数据库：`pyt_production`
- ✅ 新用户：`pepgmp_prod`，新数据库：`pepgmp_production`
- ✅ 数据库在重命名前初始化，导致用户不匹配

**推荐操作**：删除 volume 重新初始化（方案 1）
