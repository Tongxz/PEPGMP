### 背景与目标

- **目标**: 统一开发/生产两端的运行配置，通过“档位(profile) + 设备自适应(device)”实现同一套代码在不同硬件(2019 Intel Mac、Apple Silicon M4 Pro、Windows+CUDA)下稳定运行，并可按需启用“级联”以在关键区域提升精度。
- **原则**: 脚本不分叉或尽量少分叉；通过配置与环境变量/CLI 覆盖完成差异化；设备选择自动回退。

### 方案总览

- **档位 profiles**（配置驱动，可通过 ENV/CLI 覆盖）：
  - **fast**（开发/M4 Pro 或低算力）: `yolov8n`、`imgsz=512/480`、`frame_skip=1~2`、最简 OSD、限流日志。
  - **balanced**（折中）: `yolov8s`、`imgsz=640`、`frame_skip=0~1`。
  - **accurate**（生产/Windows+CUDA）: `yolov8s/m`、`imgsz=640/736`、`frame_skip=0`、可选启用级联。
- **设备优先级**: `mps → cuda → cpu`，不可用则自动回退；可用 `HBD_DEVICE` 强制覆盖。
- **可选级联**（第二阶段）: 轻模型 YOLO 先筛选；对关键区域或低置信度目标，用重模型在 ROI 二次检测，兼顾速度与精度。

### 配置与代码改动点

- 修改 `config/unified_params.yaml`：
  - 新增 `inference.profile: fast|balanced|accurate`。
  - 为每个档位提供覆盖项（示例）：
    - `human_detection.model_path`（`models/yolo/yolov8n.pt|yolov8s.pt|yolov8m.pt`）
    - `human_detection.imgsz`（如 512/480/640/736）
    - `human_detection.confidence_threshold`
    - `human_detection.max_det`
    - `runtime.frame_skip`
    - `runtime.osd_minimal`
    - `cascade.enable`、`cascade.heavy_weights`、`cascade.trigger`、`cascade.roi_margin`（可选第二阶段）

- 修改 `src/config/unified_params.py`：
  - 为上述字段补充 dataclass 定义（或以嵌套 dict 形式处理），保证读取/校验。

- 修改 `src/config/model_config.py`：
  - 新增统一设备选择函数：
    - 逻辑：若 `HBD_DEVICE` 指定则使用；否则优先 `mps`（可用）→ `cuda`（可用）→ `cpu`。
    - 供入口脚本与各检测器统一调用。
  - 新增从 profile 解析权重/推理参数的帮助函数，用于在入口脚本集中应用覆盖。

- 修改 `demo_camera_direct.py`：
  - 新增 CLI：`--profile`、`--human-weights`、`--imgsz`、（可选）`--cascade-enable` 等；优先级：CLI > ENV > YAML。
  - 启动时：
    - 读取 `inference.profile` 并应用对应覆盖参数；
    - 通过 `model_config` 获取最终 `device`；
    - 在 OSD/日志显示：`device/profile/imgsz/weights`，便于排障和复现。
  - 若启用级联：对进入关键区域或置信度接近阈值的目标按 ROI 触发重模型检测，输出“级联命中/耗时”。

- 统一设备接入（轻改，按需分步）：
  - `src/core/detector.py`、`src/core/hairnet_detector.py`、`src/core/deep_behavior_recognizer.py`、`src/core/yolo_hairnet_detector.py`、`src/core/pose_detector.py`
  - 将各自的 `cuda/cpu` 判断替换为从入口传入的 `device`（该 `device` 由 `model_config` 统一决定），避免多处分叉。

### 环境变量与 CLI 参数

- 环境变量（可选）：
  - `HBD_PROFILE=fast|balanced|accurate`
  - `HBD_DEVICE=cpu|cuda|mps`（强制覆盖，通常不需要）

- 常用 CLI：
  - `--profile fast|balanced|accurate`
  - `--human-weights models/yolo/yolov8n.pt`
  - `--imgsz 512`
  - `--cascade-enable`（如启用级联）

优先级：`CLI > 环境变量 > YAML`。

### 多模型与自训练模型支持

- 原则：为每个模型按档位提供参数与权重路径，运行期按 `profile + device` 自动选择与回退。
  - 覆盖项建议：`model_path`、`imgsz`（如适用）、`confidence_threshold`、`max_det`、是否参与级联等。
  - 路径统一放 `models/` 且使用相对路径，YOLO 使用 `.pt`（Ultralytics），XGBoost 使用 `.joblib`。
- 设备适配：各检测器统一接收入口传入的 `device`（来自 `model_config` 的 `mps→cuda→cpu` 选择）；若某模型不支持当前设备则自动回退 CPU，并在日志提示。
- 开发环境切换：不需分叉脚本；保证各档位所需模型文件存在即可。训练尽量在 CUDA/服务器进行，Mac 侧进行推理联调与验证。
- 检查清单：
  - 配置补齐：为每个模型在 `fast/balanced/accurate` 下提供 `model_path/imgsz/阈值`；
  - 统一设备：调用统一设备选择函数；
  - 资源到位：对应 `.pt/.joblib` 就绪，Mac/Windows 各自能加载；
  - 回退验证：MPS/CUDA 不可用时回退 CPU 并打印 `device/profile/imgsz/weights`。

### 脚本适配建议（非必须但推荐）

- `development/start_dev.sh`、`start_dev_server.sh`：
  - 启动前导出 `HBD_PROFILE`（默认 `fast`），并在运行 Python 命令时透传 `--profile "$HBD_PROFILE"`。

- `deployment/deploy_win.bat`：
  - 首次部署时提示安装 CUDA 版 PyTorch（示例 cu121）：
    - `pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121`

- `scripts/setup_macos_arm64.sh`：
  - 已提供 Apple Silicon 一键安装与 MPS 可用性验证；无需再分叉脚本。

### 运行与验证

- 开发（M4 Pro / MPS）：
```bash
export HBD_PROFILE=fast
source venv/bin/activate
python demo_camera_direct.py \
  --source /path/to/video.mp4 \
  --profile fast --osd-minimal --log-interval 120
```

- 生产（Windows / CUDA）：
```powershell
# 建议先安装 CUDA 版 PyTorch（以 cu121 为例）
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
pip install -r requirements.txt

set HBD_PROFILE=accurate
python demo_camera_direct.py --source C:\path\to\video.mp4 --profile accurate
```

- 验证清单：
  - 在 `fast/accurate` 各跑一次，记录 FPS、总耗时、YOLO/关键点/OSD 占比、召回/误检；
  - 确认日志打印的 `device/profile/imgsz/weights` 与预期一致；
  - 若启用级联，统计“级联命中次数/平均额外耗时/精度收益”。

### 回滚与容错

- 任意时刻可通过 `--profile fast` 回到轻量配置；
- 设备不可用自动回退（`mps/cuda` 不可用则用 `cpu`），日志明确提示；
- CLI 覆盖优先确保紧急排障可行。

### 里程碑与实施顺序

1) 配置与入口改造（`unified_params.yaml`、`unified_params.py`、`model_config.py`、`demo_camera_direct.py`）
2) 统一设备透传（核心检测器依赖处）
3) 可选：级联策略与配置
4) 脚本轻改与文档补充（本文件 + Windows CUDA 安装指引）

### 附：推荐参数示例

- fast：`yolov8n`、`imgsz=512`、`frame_skip=1`、`osd_minimal=true`、`max_det=5`
- balanced：`yolov8s`、`imgsz=640`、`frame_skip=0~1`、`osd_minimal=true`
- accurate：`yolov8s/m`、`imgsz=640/736`、`frame_skip=0`、（可选）`cascade.enable=true`


### 优化实施细节（按采纳建议修订）

#### 1) 配置结构：profiles 字典 + 深合并

- 采用“基础配置 + profiles[profile] 深度覆盖 + ENV/CLI 再覆盖”的优先级模型：
  - 优先级：CLI > 环境变量 > profiles[当前档位] > 基础配置。
  - 通过深合并（deep merge）支持嵌套字段的选择性覆盖，未覆盖项继承基础配置。

示例（YAML）：

```yaml
# unified_params.yaml

# --- 基础配置 (作为默认值或各档位共享) ---
inference:
  profile: fast  # 默认档位

human_detection:
  model_path: models/yolo/yolov8n.pt
  imgsz: 512
  confidence_threshold: 0.4
  max_det: 10

runtime:
  frame_skip: 1
  osd_minimal: true
  log_interval: 120

cascade:
  enable: false

# --- 档位覆盖配置 ---
profiles:
  fast: {}

  balanced:
    human_detection:
      model_path: models/yolo/yolov8s.pt
      imgsz: 640
      confidence_threshold: 0.5
    runtime:
      frame_skip: 0

  accurate:
    human_detection:
      model_path: models/yolo/yolov8m.pt
      imgsz: 736
      max_det: 20
    runtime:
      osd_minimal: false
    cascade:
      enable: true
      heavy_weights: models/yolo/yolov8l.pt
      trigger_confidence_range: [0.4, 0.6]
      # 可选：在指定 ROI 内才触发
      # trigger_roi: [[x1,y1],[x2,y2],...]
```

实现要点：
- 在 `unified_params.py` 加入 profiles 解析与深合并逻辑；
- `demo_camera_direct.py` 启动时读取 YAML → 应用 profiles → 再应用 ENV/CLI 覆盖；
- OSD/日志打印最终 `device/profile/imgsz/weights` 以便复现。

#### 2) 设备选择与回退原因日志

- 统一设备选择：`mps → cuda → cpu`，支持 `HBD_DEVICE` 强制。
- 在回退时打印“请求设备/检测结果/回退原因/最终设备”。

示例日志：

```text
[INFO] Device selected: 'mps'. Profile: 'fast', Imgsz: 512, Weights: 'models/yolo/yolov8n.pt'.
[WARNING] MPS requested but not available. Reason: PyTorch not built with MPS support. Falling back to 'cpu'.
[WARNING] CUDA requested but not available. Reason: No CUDA-enabled GPU detected. Falling back to 'cpu'.
```

实施位置：`src/config/model_config.py` 新增 `select_device(requested: Optional[str]) -> (device, reason)`，入口统一调用并打印摘要。

#### 3) 级联（Cascade）触发参数化

- 在 YAML 中显式配置：
  - `cascade.enable: bool`
  - `cascade.heavy_weights: str`
  - `cascade.trigger_confidence_range: [low, high]`
  - `cascade.trigger_roi: [[x1,y1],[x2,y2], ...]`（可选）
- 推理逻辑：仅当目标置信度落入区间，且（如配置了 ROI）目标在 ROI 内时才执行重模型二次检测；记录“命中/耗时/收益”。

#### 4) 依赖管理与环境一致性

- 依赖文件拆分：
  - `requirements-base.txt`：通用依赖（numpy/opencv 等）；
  - `requirements-macos.txt`：基于 base，指定 macOS/MPS 版 torch；
  - `requirements-cuda.txt`：基于 base，指定 CUDA 版 torch（例如 cu121）。
- 可选锁定：使用 pip-tools 生成跨平台可复用的锁定文件（避免直接 freeze 引入平台标签）。

#### 5) 评估与测试自动化（evaluate.py）

- 目标：一键对固定验证集批量评估，输出 FPS、召回/误检、级联命中率与额外耗时；支持 `--profile/--device/--source-dir`。
- 输出：控制台摘要 + JSON/CSV 指标文件，便于回归对比与 CI 集成。

#### 6) 实施顺序（最小可行分步）

1. 修复 `demo_camera_direct.py` 缩进错误，确保可运行；
2. 统一设备选择与回退原因日志；
3. 加入 profiles 与深合并，入口与 CLI/ENV 覆盖；
4. 参数化级联触发；
5. 依赖拆分与文档更新；
6. 新增 `scripts/evaluate.py` 并接入验证集。
