# 发网检测调试指南

## 问题诊断

### 1. 模型是否被使用？

#### 检查模型加载
- 查看启动日志，应该看到：
  ```
  YOLOHairnetDetector初始化: conf_thres=0.25, model_path=/path/to/models/hairnet_detection/hairnet_detection.pt
  成功加载 YOLOv8 模型: /path/to/models/hairnet_detection/hairnet_detection.pt
  ```
- 如果看到 `模型文件不存在` 或 `加载 YOLOv8 模型失败`，说明模型加载失败

#### 检查模型文件
```bash
ls -lh models/hairnet_detection/hairnet_detection.pt
```
- 模型文件应该存在且大小约为50MB
- 如果文件不存在，需要训练模型或下载模型

#### 检查模型类别
- 模型应该支持以下类别：
  - `hairnet` (发网)
  - `head` (头部)
  - `person` (人体)

### 2. 检测逻辑是否正确？

#### 检测流程
1. **提取头部ROI**：
   - 头部高度比例：35%（从人体高度的35%）
   - Padding：20%（高度方向）+ 10%（宽度方向）
   - 向上扩展包含头顶区域

2. **图像预处理**：
   - 使用CLAHE增强对比度
   - LAB颜色空间亮度增强

3. **YOLO检测**：
   - 检测阈值：**0.25**（固定）
   - IoU阈值：0.45
   - 使用YOLO模型检测头部ROI区域

4. **后处理判断**：
   - 后处理阈值：`min(配置阈值, 0.3)` = `min(0.25, 0.3)` = **0.25**
   - 最低接受阈值：**0.2**（如果置信度 >= 0.2，标记为佩戴）
   - 如果置信度 < 0.2，标记为未佩戴
   - 如果没有检测到任何目标，标记为"不确定"

#### 检测阈值问题（已修复）
- **之前的问题**：
  - 如果配置阈值 <= 0.5，检测阈值 = 配置阈值（0.35）
  - 这导致检测时使用0.35的阈值，可能太高

- **修复后**：
  - 检测阈值：**0.25**（固定）
  - 后处理阈值：`min(配置阈值, 0.3)` = 0.25
  - 最低接受阈值：**0.2**

### 3. 日志分析

#### 关键日志信息
查看日志中的以下信息：

1. **模型加载日志**：
   ```
   YOLOHairnetDetector初始化: conf_thres=0.25, model_path=...
   成功加载 YOLOv8 模型: ...
   ```

2. **检测开始日志**：
   ```
   开始发网检测: human_bbox=..., ROI大小=..., 检测阈值=0.25, 配置阈值=0.25
   ```

3. **检测结果日志**：
   ```
   检测到的所有类别: [('hairnet', 0.35), ('head', 0.45), ...]
   ✅ 检测到发网: confidence=0.35, human_bbox=..., track_id=...
   ✅ 确认佩戴发网: hairnet_confidence=0.35, post_process_threshold=0.25
   ```

4. **未检测到日志**：
   ```
   ⚠️ 未检测到任何目标: human_bbox=..., track_id=..., ROI大小=..., 检测阈值=0.25
   ⚠️ 发网检测模型未检测到发网: human_bbox=..., track_id=..., 检测阈值=0.25
   ```

#### 日志级别
- **INFO**：重要信息（检测到发网、确认佩戴等）
- **WARNING**：警告信息（未检测到、置信度较低等）
- **DEBUG**：详细调试信息（检测过程、ROI大小等）
- **ERROR**：错误信息（检测失败、模型加载失败等）

### 4. 常见问题

#### 问题1：模型没有检测到任何目标
**可能原因**：
- ROI提取不准确（头部区域太小或位置不对）
- 检测阈值太高（已修复，现在使用0.25）
- 模型质量问题（需要重新训练）
- 图像质量问题（光照、模糊等）

**解决方法**：
1. 查看日志中的 `ROI大小`，确认ROI是否合理
2. 查看日志中的 `检测阈值`，确认是否为0.25
3. 检查模型文件是否存在且正确
4. 尝试降低检测阈值（修改代码中的 `detection_conf = 0.25` 为 `0.2` 或 `0.15`）

#### 问题2：检测到其他类别（head、person）但没有检测到hairnet
**可能原因**：
- 模型在头部ROI中检测到了head或person，但没有检测到hairnet
- 这可能说明：
  - 模型确实在工作（检测到了其他类别）
  - 但发网检测能力不足（需要重新训练模型）
  - 或者发网确实不存在（需要人工确认）

**解决方法**：
1. 查看日志中的 `检测到的所有类别`，确认是否检测到head或person
2. 如果检测到head或person但没有hairnet，说明模型在工作但发网检测能力不足
3. 考虑重新训练模型或使用更好的模型

#### 问题3：检测到hairnet但置信度太低
**可能原因**：
- 发网确实存在但置信度较低（<0.2）
- 检测阈值设置合理，但模型质量不够

**解决方法**：
1. 查看日志中的 `发网置信度`
2. 如果置信度 >= 0.2，会被标记为佩戴
3. 如果置信度 < 0.2，会被标记为未佩戴
4. 可以进一步降低最低接受阈值（修改代码中的 `0.2` 为 `0.15` 或 `0.1`）

#### 问题4：检测结果不一致
**可能原因**：
- 不同帧的检测结果不一致
- 光照、角度、距离等因素影响

**解决方法**：
1. 使用状态管理（StateManager）来平滑检测结果
2. 使用时间连续性判断（多帧结果融合）
3. 调整稳定性帧数要求

### 5. 调试步骤

1. **检查模型加载**：
   ```bash
   python -c "
   from src.detection.yolo_hairnet_detector import YOLOHairnetDetector
   detector = YOLOHairnetDetector()
   print(f'模型路径: {detector.model_path}')
   print(f'置信度阈值: {detector.conf_thres}')
   print(f'模型类别: {detector.model.names}')
   "
   ```

2. **检查配置**：
   ```bash
   python -c "
   from src.config.unified_params import get_unified_params
   params = get_unified_params()
   print(f'模型路径配置: {params.hairnet_detection.model_path}')
   print(f'置信度阈值: {params.hairnet_detection.confidence_threshold}')
   "
   ```

3. **查看日志**：
   - 启动检测服务后，查看日志输出
   - 关注以下日志：
     - `开始发网检测`
     - `检测到的所有类别`
     - `✅ 检测到发网`
     - `⚠️ 未检测到任何目标`
     - `✅ 确认佩戴发网`

4. **测试检测**：
   - 使用测试图像进行检测
   - 查看检测结果和日志
   - 确认模型是否正常工作

### 6. 优化建议

1. **如果检测不到发网**：
   - 降低检测阈值（已优化为0.25）
   - 降低最低接受阈值（已优化为0.2）
   - 增加头部ROI比例（已优化为35%）
   - 增加padding（已优化为20%）
   - 检查模型质量（可能需要重新训练）

2. **如果误报过多**：
   - 提高后处理阈值（修改 `post_process_threshold`）
   - 提高最低接受阈值（修改 `0.2` 为 `0.3` 或更高）
   - 检查模型质量（可能需要重新训练）

3. **如果检测不稳定**：
   - 使用状态管理（StateManager）
   - 使用时间连续性判断
   - 调整稳定性帧数要求

### 7. 当前配置

- **检测阈值**：0.25（固定）
- **后处理阈值**：min(配置阈值, 0.3) = 0.25
- **最低接受阈值**：0.2
- **配置阈值**：0.25（`config/unified_params.yaml`）
- **头部ROI比例**：35%
- **Padding**：20%（高度）+ 10%（宽度）
- **模型路径**：`models/hairnet_detection/hairnet_detection.pt`

### 8. 下一步

如果仍然检测不到发网，建议：

1. **检查日志**：
   - 查看是否有 `检测到的所有类别` 日志
   - 查看是否有 `✅ 检测到发网` 日志
   - 查看是否有 `⚠️ 未检测到任何目标` 日志

2. **检查模型**：
   - 确认模型文件是否存在
   - 确认模型是否正确加载
   - 确认模型类别是否正确

3. **检查ROI**：
   - 查看ROI大小是否合理
   - 查看ROI是否包含头部区域
   - 查看ROI图像质量

4. **检查检测阈值**：
   - 确认检测阈值是否为0.25
   - 可以尝试进一步降低（如0.2或0.15）
   - 查看检测结果和日志

5. **重新训练模型**：
   - 如果模型质量不够，考虑重新训练
   - 使用更多、更好的训练数据
   - 调整训练参数

