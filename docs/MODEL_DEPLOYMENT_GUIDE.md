# 模型部署指南

## 概述

模型部署是将训练完成的模型应用到检测系统中的过程。系统中有多个不同的检测任务，每个任务使用不同的模型：

- **发网检测模型** (`hairnet_detection`): 用于检测人员是否佩戴发网
- **人体检测模型** (`human_detection`): 用于检测图像中的人体目标
- **姿态检测模型** (`pose_detection`): 用于检测人体姿态关键点
- **行为检测模型** (`behavior_recognition`): 用于识别特定行为

**模型部署的本质**：将训练好的模型文件路径更新到对应的检测配置中，使检测系统在运行时使用最新的模型。

## 部署流程

### 步骤1：确认模型已训练完成

1. 进入 **模型管理** 页面
2. 查看模型列表，确认您要部署的模型状态为 **"ready"**（就绪）
3. 查看模型的训练指标（mAP50、mAP50-95等），确认模型性能满足要求

### 步骤2：进入模型部署页面

1. 在导航菜单中找到 **"模型部署"** 或 **"MLOps"** → **"模型部署"**
2. 点击 **"部署模型"** 按钮

### 步骤3：配置部署参数

在部署对话框中，您需要配置以下参数：

#### 必需参数

1. **模型选择**
   - 从下拉列表中选择要部署的模型
   - 列表会自动显示所有状态为 "ready" 的模型
   - 显示格式：`模型名称 v版本号`

2. **部署到检测任务**
   - **发网检测** (`hairnet_detection`): 用于发网佩戴检测
   - **人体检测** (`human_detection`): 用于人体目标检测（通常使用预训练模型，不常更新）
   - **姿态检测** (`pose_detection`): 用于人体姿态关键点检测（通常使用预训练模型，不常更新）
   - **行为检测** (`behavior_recognition`): 用于行为识别（如果支持）

3. **部署名称**
   - 输入一个描述性的部署名称
   - 例如：`hairnet-detection-v20251118`、`multi-behavior-v1`

#### 可选参数

4. **立即应用**
   - 如果启用，部署后会立即更新检测配置
   - 如果禁用，配置会在下次重启检测服务时生效
   - **注意**：模型路径更新后，检测服务需要重新加载模型才能生效

### 步骤4：提交部署

1. 检查所有配置参数
2. 点击 **"部署"** 按钮
3. 系统会：
   - 验证模型文件是否存在
   - 更新对应的检测配置（`config/unified_params.yaml` 或数据库）
   - 记录部署历史

### 步骤5：应用部署

部署完成后，您需要：

1. **如果启用了"立即应用"**：
   - 系统会尝试热更新检测配置
   - 如果热更新失败，需要重启检测服务

2. **如果未启用"立即应用"**：
   - 需要手动重启检测服务
   - 或者等待下次服务重启时自动应用

3. **验证部署**：
   - 运行一次检测，确认使用的是新模型
   - 查看检测日志，确认模型路径正确

## 部署配置示例

### 示例1：部署发网检测模型

```json
{
  "model_id": "model_20251118_070707",
  "deployment_name": "hairnet-detection-v20251118",
  "detection_task": "hairnet_detection",
  "apply_immediately": true
}
```

**效果**：
- 更新 `config/unified_params.yaml` 中的 `hairnet_detection.model_path`
- 从 `models/hairnet_detection/hairnet_detection.pt` 更新为 `models/multi_behavior/multi_behavior_20251118_070707.pt`
- 检测系统在下次检测时使用新模型

### 示例2：部署人体检测模型

```json
{
  "model_id": "model_20251118_070707",
  "deployment_name": "human-detection-v20251118",
  "detection_task": "human_detection",
  "apply_immediately": false
}
```

**效果**：
- 更新 `config/unified_params.yaml` 中的 `human_detection.model_path`
- 从 `models/yolo/yolov8s.pt` 更新为 `models/multi_behavior/multi_behavior_20251118_070707.pt`
- 配置在下次重启检测服务时生效

## 部署后操作

### 查看部署历史

1. 在部署列表中，查看所有部署记录
2. 每个部署记录包含：
   - 部署名称
   - 模型版本
   - 检测任务
   - 部署时间
   - 部署状态

### 回滚部署

1. 在部署列表中，找到要回滚的部署
2. 点击 **"回滚"** 按钮
3. 系统会：
   - 恢复到之前的模型路径
   - 更新检测配置
   - 记录回滚操作

### 查看当前部署的模型

1. 进入 **检测配置** 页面
2. 查看各个检测任务的模型路径
3. 确认当前使用的模型版本

## 技术细节

### 模型路径映射

系统将训练好的模型部署到检测任务时，会更新以下配置：

| 检测任务 | 配置路径 | 默认模型路径 |
|---------|---------|-------------|
| 发网检测 | `hairnet_detection.model_path` | `models/hairnet_detection/hairnet_detection.pt` |
| 人体检测 | `human_detection.model_path` | `models/yolo/yolov8s.pt` |
| 姿态检测 | `pose_detection.model_path` | `models/yolo/yolov8n-pose.pt` |

### 配置更新方式

1. **YAML配置文件** (`config/unified_params.yaml`)
   - 直接更新YAML文件中的模型路径
   - 适用于单机部署

2. **数据库配置** (如果启用)
   - 更新数据库中的检测配置
   - 适用于多实例部署

3. **热更新** (如果支持)
   - 动态重新加载检测器
   - 无需重启服务

### 模型文件要求

部署的模型文件必须满足以下要求：

1. **文件格式**：`.pt` (PyTorch模型文件)
2. **文件存在**：模型文件必须存在于指定路径
3. **模型兼容性**：模型必须与检测任务兼容
   - 发网检测模型：必须是YOLOv8格式，支持单类别检测
   - 人体检测模型：必须是YOLOv8格式，支持人体检测

## 常见问题

### Q: 部署后检测系统没有使用新模型？

A: 检查以下几点：
1. 确认模型文件路径正确且文件存在
2. 确认检测服务已重启或配置已热更新
3. 查看检测日志，确认加载的模型路径
4. 检查配置文件是否正确更新

### Q: 如何验证部署是否成功？

A: 
1. 查看检测配置页面，确认模型路径已更新
2. 运行一次检测，查看日志中的模型路径
3. 对比检测结果，确认使用的是新模型

### Q: 可以同时部署多个模型吗？

A: 
- 可以，每个检测任务可以独立部署模型
- 例如：发网检测使用模型A，人体检测使用模型B
- 不同检测任务之间互不影响

### Q: 部署失败怎么办？

A: 
1. 查看部署日志，确认失败原因
2. 检查：
   - 模型文件是否存在
   - 模型文件格式是否正确
   - 配置文件是否可写
   - 检测服务是否正在运行
3. 根据错误信息调整后重新部署

### Q: 如何回滚到之前的模型？

A: 
1. 在部署历史中找到之前的部署记录
2. 点击 **"回滚"** 按钮
3. 系统会自动恢复到之前的模型路径

## 最佳实践

1. **先测试后部署**
   - 先在测试环境部署新模型
   - 验证模型性能满足要求
   - 确认无误后再部署到生产环境

2. **保留模型版本**
   - 不要删除旧模型文件
   - 保留部署历史记录
   - 便于回滚和对比

3. **监控部署效果**
   - 部署后监控检测性能
   - 对比新旧模型的检测结果
   - 及时发现问题并处理

4. **文档化部署**
   - 记录每次部署的原因和变更
   - 记录模型性能指标
   - 便于后续维护和优化

## 下一步

部署完成后，您可以：
- 监控检测系统的性能
- 对比新旧模型的检测效果
- 根据实际使用情况调整模型参数
- 继续训练新模型以进一步提升性能
