# éƒ¨ç½² 502 é”™è¯¯é—®é¢˜åˆ†æ

## ğŸ“‹ é—®é¢˜ç°è±¡

- API å®¹å™¨çŠ¶æ€ï¼š`healthy` âœ…
- Nginx å®¹å™¨çŠ¶æ€ï¼š`health: starting`
- å‰ç«¯å’Œ API éƒ½è¿”å› HTTP 502
- API ç›´æ¥è®¿é—®ï¼ˆ8000 ç«¯å£ï¼‰æ­£å¸¸ï¼Œä½†çŠ¶æ€ä¸º `degraded`

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. **æ•°æ®åº“å¯†ç ä¸åŒ¹é…** âš ï¸ **ä¸»è¦é—®é¢˜**

**é—®é¢˜**ï¼š
- æ•°æ®åº“å®¹å™¨æ—¥å¿—æ˜¾ç¤ºï¼š`PostgreSQL Database directory appears to contain a database; Skipping initialization`
- è¿™æ„å‘³ç€æ•°æ®åº“å·²ç»ç”¨**æ—§å¯†ç **åˆå§‹åŒ–äº†
- å½“å‰ `.env.production` ä¸­çš„å¯†ç æ˜¯**æ–°å¯†ç **
- PostgreSQL ä¸ä¼šå› ä¸ºç¯å¢ƒå˜é‡æ”¹å˜è€Œé‡æ–°åˆå§‹åŒ–å·²å­˜åœ¨çš„æ•°æ®åº“

**è¯æ®**ï¼š
```
2025-12-04 02:42:32.608 UTC [40] FATAL:  password authentication failed for user "pepgmp_prod"
```

**å½±å“**ï¼š
- API æ— æ³•è¿æ¥æ•°æ®åº“
- å¥åº·æ£€æŸ¥è¿”å› `"status":"degraded"`
- è™½ç„¶ API æœåŠ¡è¿è¡Œæ­£å¸¸ï¼Œä½†åŠŸèƒ½å—é™

### 2. **Nginx ç«¯å£è®¿é—®é—®é¢˜**

**é—®é¢˜**ï¼š
- Nginx å®¹å™¨æ˜ å°„åˆ° 80 ç«¯å£
- éƒ¨ç½²è„šæœ¬æ£€æµ‹åˆ° 80 ç«¯å£è¢«å ç”¨ï¼Œä½¿ç”¨ 8080 ç«¯å£æµ‹è¯•
- ä½† Nginx å®é™…ç›‘å¬çš„æ˜¯ 80 ç«¯å£ï¼Œä¸æ˜¯ 8080

**è¯æ®**ï¼š
```bash
# Nginx ç«¯å£æ˜ å°„
80/tcp -> 0.0.0.0:80

# ä½†æµ‹è¯•è„šæœ¬ä½¿ç”¨ 8080
curl http://localhost:8080/api/v1/monitoring/health
# ç»“æœï¼šConnection refused
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šé‡ç½®æ•°æ®åº“ï¼ˆæ¨èç”¨äºå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰

**æ­¥éª¤**ï¼š

1. **åœæ­¢æœåŠ¡**
   ```bash
   docker compose -f docker-compose.prod.yml down
   ```

2. **åˆ é™¤æ•°æ®åº“ volume**
   ```bash
   docker volume rm pyt_postgres_prod_data
   ```

3. **é‡æ–°å¯åŠ¨**
   ```bash
   docker compose -f docker-compose.prod.yml up -d
   ```

**æ³¨æ„**ï¼šè¿™ä¼š**åˆ é™¤æ‰€æœ‰æ•°æ®**ï¼

### æ–¹æ¡ˆ 2ï¼šä¿®æ”¹æ•°æ®åº“å¯†ç ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

**æ­¥éª¤**ï¼š

1. **è¿›å…¥æ•°æ®åº“å®¹å™¨**
   ```bash
   docker exec -it pepgmp-postgres-prod psql -U postgres
   ```

2. **ä¿®æ”¹å¯†ç **
   ```sql
   ALTER USER pepgmp_prod WITH PASSWORD 'gvbW0-Abbtmb9Iu5f-KaHjuKsH43Kkz73NsuSi9MxE4';
   ```

3. **éªŒè¯**
   ```bash
   docker exec -e PGPASSWORD='gvbW0-Abbtmb9Iu5f-KaHjuKsH43Kkz73NsuSi9MxE4' pepgmp-api-prod psql -h database -U pepgmp_prod -d pepgmp_production -c "SELECT 1;"
   ```

### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨æ—§å¯†ç ï¼ˆå¦‚æœçŸ¥é“æ—§å¯†ç ï¼‰

**æ­¥éª¤**ï¼š

1. **ä¿®æ”¹ `.env.production`**
   ```bash
   # å°† DATABASE_PASSWORD æ”¹ä¸ºæ—§å¯†ç 
   ```

2. **é‡å¯æœåŠ¡**
   ```bash
   docker compose -f docker-compose.prod.yml restart api
   ```

---

## ğŸ”§ Nginx 502 é”™è¯¯ä¿®å¤

### é—®é¢˜
- Nginx å¯ä»¥è¿æ¥åˆ° APIï¼ˆç½‘ç»œæ­£å¸¸ï¼‰
- ä½†è¿”å› 502 é”™è¯¯

### å¯èƒ½åŸå› 
1. API è™½ç„¶è¿è¡Œï¼Œä½†å› ä¸ºæ•°æ®åº“è¿æ¥å¤±è´¥ï¼ŒæŸäº›è¯·æ±‚å¯èƒ½å¤±è´¥
2. Nginx é…ç½®ä¸­çš„ `proxy_pass` è·¯å¾„å¯èƒ½æœ‰é—®é¢˜

### æ£€æŸ¥æ­¥éª¤

1. **æµ‹è¯• Nginx åˆ° API çš„è¿æ¥**
   ```bash
   docker exec pepgmp-nginx-prod wget -O- http://api:8000/api/v1/monitoring/health
   ```

2. **æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—**
   ```bash
   docker logs pepgmp-nginx-prod | grep error
   ```

3. **æµ‹è¯•æ­£ç¡®çš„ç«¯å£**
   ```bash
   # ä½¿ç”¨ 80 ç«¯å£ï¼ˆä¸æ˜¯ 8080ï¼‰
   curl http://localhost/api/v1/monitoring/health
   ```

---

## ğŸ“ éªŒè¯æ­¥éª¤

ä¿®å¤åï¼ŒéªŒè¯ï¼š

1. **æ•°æ®åº“è¿æ¥**
   ```bash
   docker exec -e PGPASSWORD='<å¯†ç >' pepgmp-api-prod psql -h database -U pepgmp_prod -d pepgmp_production -c "SELECT 1;"
   ```

2. **API å¥åº·æ£€æŸ¥**
   ```bash
   curl http://localhost:8000/api/v1/monitoring/health
   # åº”è¯¥è¿”å› "status":"ok"
   ```

3. **é€šè¿‡ Nginx è®¿é—®**
   ```bash
   curl http://localhost/api/v1/monitoring/health
   # åº”è¯¥è¿”å› 200 OK
   ```

---

## ğŸ¯ å¿«é€Ÿä¿®å¤å‘½ä»¤

**å¦‚æœæ˜¯å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼ˆå¯ä»¥åˆ é™¤æ•°æ®ï¼‰**ï¼š

```bash
# åœæ­¢æœåŠ¡
docker compose -f docker-compose.prod.yml down

# åˆ é™¤æ•°æ®åº“ volume
docker volume rm pyt_postgres_prod_data

# é‡æ–°å¯åŠ¨
docker compose -f docker-compose.prod.yml up -d
```

**å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦ä¿ç•™æ•°æ®ï¼‰**ï¼š

```bash
# è¿›å…¥æ•°æ®åº“å®¹å™¨ä¿®æ”¹å¯†ç 
docker exec -it pepgmp-postgres-prod psql -U postgres -d postgres

# åœ¨ psql ä¸­æ‰§è¡Œ
ALTER USER pepgmp_prod WITH PASSWORD 'gvbW0-Abbtmb9Iu5f-KaHjuKsH43Kkz73NsuSi9MxE4';

# é‡å¯ API æœåŠ¡
docker compose -f docker-compose.prod.yml restart api
```

---

**é—®é¢˜å‘ç°æ—¥æœŸ**: 2025-12-04
**çŠ¶æ€**: âš ï¸ å¾…ä¿®å¤
