# 下一步工作计划

## 日期
2025-10-31

## 📊 当前状态总结

### ✅ 已完成
- ✅ **代码集成**: 13个新端点（告警规则写操作2个 + 摄像头操作11个）
- ✅ **单元测试**: 32个测试，100%通过
- ✅ **集成测试**: 2个端点验证通过（告警规则写操作）
- ✅ **代码质量**: 通过linter检查，无错误

### ⏳ 待完成
- ⏳ **完整集成测试**: 在包含摄像头数据的环境中测试所有端点
- ⏳ **灰度发布**: 逐步灰度发布新功能
- ⏳ **功能对比测试**: 新旧实现对比
- ⏳ **性能测试**: 响应时间对比和负载测试

## 🎯 下一步工作计划

### 阶段一：完整测试验证（高优先级）⭐⭐⭐

**时间**: 1-2天

#### 1.1 完整集成测试验证

**目标**: 在有摄像头数据的环境中测试所有11个摄像头操作端点

**工作内容**:
- [ ] 准备测试环境（确保有摄像头数据）
- [ ] 运行完整集成测试脚本
- [ ] 验证所有摄像头操作端点功能
- [ ] 记录测试结果和发现的问题

**验证脚本**: `tools/verify_new_endpoints.sh`

**测试端点**:
1. `POST /api/v1/cameras/{camera_id}/start` - 启动摄像头
2. `POST /api/v1/cameras/{camera_id}/stop` - 停止摄像头
3. `POST /api/v1/cameras/{camera_id}/restart` - 重启摄像头
4. `GET /api/v1/cameras/{camera_id}/status` - 获取状态
5. `POST /api/v1/cameras/batch-status` - 批量状态查询
6. `POST /api/v1/cameras/{camera_id}/activate` - 激活摄像头
7. `POST /api/v1/cameras/{camera_id}/deactivate` - 停用摄像头
8. `PUT /api/v1/cameras/{camera_id}/auto-start` - 切换自动启动
9. `GET /api/v1/cameras/{camera_id}/logs` - 获取日志
10. `POST /api/v1/cameras/refresh` - 刷新所有摄像头

#### 1.2 功能对比测试

**目标**: 对比新旧实现的行为一致性

**工作内容**:
- [ ] 对比新旧实现的响应格式
- [ ] 验证错误处理一致性
- [ ] 验证业务逻辑一致性
- [ ] 记录差异和问题

**测试方法**:
```bash
# 测试新实现（force_domain=true）
curl "http://localhost:8000/api/v1/endpoint?force_domain=true"

# 测试旧实现（force_domain=false或不设置）
curl "http://localhost:8000/api/v1/endpoint"
```

#### 1.3 灰度开关验证

**目标**: 验证灰度开关功能正常

**工作内容**:
- [ ] 测试 `force_domain=true` 时使用领域服务
- [ ] 测试 `force_domain=false` 时使用旧实现
- [ ] 测试 `USE_DOMAIN_SERVICE` 环境变量
- [ ] 测试 `ROLLOUT_PERCENT` 环境变量

### 阶段二：灰度发布（中优先级）⭐⭐

**时间**: 2-4周

#### 2.1 告警规则写操作灰度发布

**灰度计划**:
- [ ] **10%** (1-2天): 小范围验证
  - 监控错误率和性能
  - 收集用户反馈
  - 验证功能正确性

- [ ] **25%** (3-5天): 扩大范围
  - 继续监控
  - 修复发现的问题
  - 性能优化

- [ ] **50%** (1周): 半数用户
  - 深入验证
  - 收集更多反馈
  - 准备全量发布

- [ ] **100%** (1-2周): 全量发布
  - 所有用户使用新实现
  - 持续监控
  - 稳定运行

**灰度控制**:
- 使用 `ROLLOUT_PERCENT` 环境变量
- 使用 `force_domain` 查询参数（测试用途）

#### 2.2 摄像头操作端点灰度发布

**灰度计划**:
- [ ] **10%** (1-2天): 小范围验证
- [ ] **25%** (3-5天): 扩大范围
- [ ] **50%** (1周): 半数用户
- [ ] **100%** (1-2周): 全量发布

**注意事项**:
- 摄像头操作涉及进程控制，需要谨慎
- 建议先在测试环境验证
- 逐步扩大范围，密切监控

### 阶段三：性能测试和优化（中优先级）⭐⭐

**时间**: 1-2周

#### 3.1 性能测试

**测试内容**:
- [ ] 响应时间对比（新旧实现）
- [ ] 并发测试
- [ ] 负载测试
- [ ] 资源使用对比

**测试工具**: `tools/perf_probe.py`

**测试指标**:
- QPS（每秒查询数）
- P50/P95/P99延迟
- 错误率
- CPU/内存使用率

#### 3.2 性能优化

**优化内容**:
- [ ] 识别性能瓶颈
- [ ] 优化慢查询
- [ ] 优化数据库访问
- [ ] 添加缓存（如需要）

### 阶段四：监控和验证（持续）⭐

**时间**: 持续

#### 4.1 监控配置

**监控内容**:
- [ ] 错误率监控
- [ ] 响应时间监控
- [ ] 领域服务使用率监控
- [ ] 回退次数监控

**监控端点**:
- `GET /api/v1/monitoring/health` - 健康检查
- `GET /api/v1/monitoring/metrics` - 监控指标

#### 4.2 数据一致性监控

**监控内容**:
- [ ] 新旧实现数据一致性
- [ ] 数据库数据完整性
- [ ] YAML配置同步验证

## 📋 优先级排序

### 高优先级（立即执行）⭐⭐⭐

1. **完整集成测试验证** (1-2天)
   - 在有摄像头数据的环境中测试所有端点
   - 验证功能正确性
   - 修复发现的问题

2. **功能对比测试** (1天)
   - 对比新旧实现
   - 验证行为一致性

### 中优先级（近期执行）⭐⭐

1. **灰度发布** (2-4周)
   - 告警规则写操作
   - 摄像头操作端点

2. **性能测试和优化** (1-2周)
   - 响应时间对比
   - 并发测试
   - 性能优化

### 低优先级（后续执行）⭐

1. **监控和验证** (持续)
   - 错误率监控
   - 性能监控
   - 数据一致性监控

2. **文档完善** (1周)
   - 更新API文档
   - 编写使用指南
   - 架构文档更新

## 🎯 建议执行顺序

### 本周（立即执行）

1. **完整集成测试** (1-2天)
   - 在有摄像头数据的环境中运行完整测试
   - 验证所有端点功能
   - 修复发现的问题

2. **功能对比测试** (1天)
   - 对比新旧实现的行为
   - 验证灰度开关功能

### 下周（开始灰度）

1. **灰度发布准备** (2-3天)
   - 配置监控
   - 准备回滚方案
   - 制定灰度计划

2. **开始灰度发布** (2-4周)
   - 10% → 25% → 50% → 100%
   - 密切监控和验证

### 后续（优化和监控）

1. **性能测试** (1周)
   - 响应时间对比
   - 并发测试

2. **持续监控** (持续)
   - 错误率监控
   - 性能监控

## 📊 工作量估算

### 完整测试验证
- **完整集成测试**: 1-2天
- **功能对比测试**: 1天
- **灰度开关验证**: 0.5天
- **总计**: 2.5-3.5天

### 灰度发布
- **告警规则写操作**: 2-3周
- **摄像头操作端点**: 2-3周
- **总计**: 2-3周（可并行进行）

### 性能测试和优化
- **性能测试**: 3-5天
- **性能优化**: 3-5天
- **总计**: 1-2周

### 监控和验证
- **监控配置**: 1-2天
- **持续监控**: 持续
- **总计**: 持续

## 💡 建议

### 立即执行（本周）

1. **完成集成测试验证**
   - 在有摄像头数据的环境中测试所有端点
   - 这是后续工作的基础

2. **功能对比测试**
   - 确保新旧实现行为一致
   - 为灰度发布做准备

### 近期执行（下周）

1. **开始灰度发布**
   - 先发布告警规则写操作（相对安全）
   - 再发布摄像头操作端点

2. **配置监控**
   - 确保能够及时发现问题
   - 收集性能数据

### 后续执行（长期）

1. **性能优化**
   - 根据监控数据优化
   - 持续改进

2. **文档完善**
   - 更新API文档
   - 编写使用指南

## ✅ 总结

### 当前状态
- ✅ 代码集成完成
- ✅ 单元测试通过
- ⏳ 集成测试部分完成

### 下一步（高优先级）

1. **完整集成测试验证** (1-2天)
   - 在有摄像头数据的环境中测试所有端点

2. **功能对比测试** (1天)
   - 对比新旧实现的行为一致性

3. **灰度发布准备** (2-3天)
   - 配置监控
   - 准备回滚方案

4. **开始灰度发布** (2-4周)
   - 逐步灰度发布新功能

---

**建议**: 优先完成完整集成测试验证，确保所有端点功能正常后再开始灰度发布。
