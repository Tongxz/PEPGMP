# å‰ç«¯ç™½å±é—®é¢˜æ’æŸ¥æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å‰ç«¯ç™½å±é—®é¢˜çš„ç³»ç»ŸåŒ–æ’æŸ¥æ–¹æ³•ï¼Œæ”¯æŒåœ¨ WSL2 å’Œ macOS ç¯å¢ƒä¸‹è¿›è¡Œè¯Šæ–­ã€‚

---

## ğŸ” å¿«é€Ÿè¯Šæ–­ï¼ˆWSL2 ç¯å¢ƒï¼‰

### æ–¹æ³• 1ï¼šä½¿ç”¨è¯Šæ–­è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# åœ¨ WSL2 ä¸­è¿è¡Œ
cd ~/projects/Pyt
bash /mnt/c/Users/zhou/Code/Pyt/scripts/diagnose_frontend_whitescreen.sh ~/projects/Pyt
```

**è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥**ï¼š
- âœ… å®¹å™¨çŠ¶æ€
- âœ… å‰ç«¯é™æ€æ–‡ä»¶
- âœ… frontend-init æ—¥å¿—
- âœ… Nginx é…ç½®
- âœ… Nginx æ—¥å¿—
- âœ… HTTP ç«¯ç‚¹
- âœ… HTML å†…å®¹
- âœ… Docker Compose é…ç½®

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ£€æŸ¥æ­¥éª¤

#### æ­¥éª¤ 1ï¼šæ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
cd ~/projects/Pyt
docker compose -f docker-compose.prod.yml ps
```

**é¢„æœŸçŠ¶æ€**ï¼š
```
pepgmp-frontend-init-prod     Exited (0)  â† å¿…é¡»æˆåŠŸé€€å‡º
pepgmp-nginx-prod             Up (healthy)
pepgmp-api-prod              Up (healthy)
pepgmp-postgres-prod         Up (healthy)
pepgmp-redis-prod            Up (healthy)
```

**å¦‚æœ frontend-init çŠ¶æ€ä¸æ˜¯ Exited (0)**ï¼š
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs pepgmp-frontend-init-prod

# é‡æ–°è¿è¡Œ frontend-init
docker compose -f docker-compose.prod.yml up -d frontend-init

# ç­‰å¾…å®Œæˆ
sleep 10

# å†æ¬¡æ£€æŸ¥
docker logs pepgmp-frontend-init-prod
```

#### æ­¥éª¤ 2ï¼šæ£€æŸ¥é™æ€æ–‡ä»¶

```bash
# æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
ls -la frontend/dist/

# æ£€æŸ¥ index.html
ls -la frontend/dist/index.html

# æ£€æŸ¥æ–‡ä»¶æ•°é‡
find frontend/dist -type f | wc -l

# æ£€æŸ¥ assets ç›®å½•
ls -la frontend/dist/assets/
```

**é¢„æœŸç»“æœ**ï¼š
- `frontend/dist/index.html` å­˜åœ¨ä¸”å¤§å° > 1KB
- `frontend/dist/assets/` ç›®å½•å­˜åœ¨
- è‡³å°‘æœ‰å‡ ä¸ª `.js` å’Œ `.css` æ–‡ä»¶

**å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º**ï¼š
```bash
# æ‰‹åŠ¨é‡æ–°æå–é™æ€æ–‡ä»¶
docker compose -f docker-compose.prod.yml up -d frontend-init

# ç­‰å¾…å®Œæˆ
sleep 15

# æ£€æŸ¥æ–‡ä»¶
ls -la frontend/dist/
```

#### æ­¥éª¤ 3ï¼šæ£€æŸ¥ Nginx é…ç½®

```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la nginx/nginx.conf

# éªŒè¯ Nginx é…ç½®è¯­æ³•
docker exec pepgmp-nginx-prod nginx -t

# æ£€æŸ¥é…ç½®å†…å®¹ï¼ˆåº”è¯¥æ˜¯ Scheme Bï¼‰
grep -A 5 "root /usr/share/nginx/html" nginx/nginx.conf
```

**æ­£ç¡®é…ç½®ï¼ˆScheme Bï¼‰**ï¼š
```nginx
server {
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

**é”™è¯¯é…ç½®ï¼ˆScheme A æ®‹ç•™ï¼‰**ï¼š
```nginx
upstream frontend_backend {
    server frontend:80;  # âŒ è¿™ä¸ªä¸åº”è¯¥å­˜åœ¨
}
```

**å¦‚æœé…ç½®é”™è¯¯**ï¼š
```bash
# é‡æ–°å¤åˆ¶æ­£ç¡®çš„é…ç½®æ–‡ä»¶
cp /mnt/c/Users/zhou/Code/Pyt/nginx/nginx.conf nginx/nginx.conf

# é‡å¯ Nginx
docker compose -f docker-compose.prod.yml restart nginx
```

#### æ­¥éª¤ 4ï¼šæ£€æŸ¥ Nginx æ—¥å¿—

```bash
# æŸ¥çœ‹è®¿é—®æ—¥å¿—
docker logs pepgmp-nginx-prod | tail -50

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker logs pepgmp-nginx-prod 2>&1 | grep -i error | tail -20
```

**å¸¸è§é”™è¯¯**ï¼š
- `404 Not Found` - é™æ€æ–‡ä»¶è·¯å¾„é”™è¯¯
- `502 Bad Gateway` - API æœåŠ¡æœªå¯åŠ¨
- `403 Forbidden` - æ–‡ä»¶æƒé™é—®é¢˜

#### æ­¥éª¤ 5ï¼šæµ‹è¯• HTTP ç«¯ç‚¹

```bash
# æµ‹è¯•å‰ç«¯
curl -I http://localhost/

# æµ‹è¯• API
curl http://localhost/api/v1/monitoring/health

# æµ‹è¯• Nginx å¥åº·æ£€æŸ¥
curl http://localhost/health
```

**é¢„æœŸç»“æœ**ï¼š
- å‰ç«¯è¿”å› `200 OK` å’Œ HTML å†…å®¹
- API è¿”å› `{"status":"healthy"}`
- å¥åº·æ£€æŸ¥è¿”å› `healthy`

#### æ­¥éª¤ 6ï¼šæ£€æŸ¥ HTML å†…å®¹

```bash
# è·å– HTML å†…å®¹
curl http://localhost/ > /tmp/frontend.html

# æ£€æŸ¥ HTML ç»“æ„
head -20 /tmp/frontend.html

# æ£€æŸ¥è„šæœ¬å¼•ç”¨
grep -o 'src="[^"]*"' /tmp/frontend.html | head -5
```

**é¢„æœŸ HTML ç»“æ„**ï¼š
```html
<!DOCTYPE html>
<html>
<head>
  <script type="module" src="/assets/js/index-xxx.js"></script>
  <link rel="stylesheet" href="/assets/css/index-xxx.css">
</head>
<body>
  <div id="app"></div>
</body>
</html>
```

---

## ğŸ–¥ï¸ macOS ç¯å¢ƒåŒæ­¥éªŒè¯

### æ–¹æ³• 1ï¼šé€šè¿‡ WSL IP è®¿é—®ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1ï¼šè·å– WSL2 IP

åœ¨ WSL2 ä¸­è¿è¡Œï¼š
```bash
hostname -I | awk '{print $1}'
```

**ç¤ºä¾‹è¾“å‡º**ï¼š`172.20.10.2`

#### æ­¥éª¤ 2ï¼šåœ¨ macOS æµè§ˆå™¨ä¸­è®¿é—®

```
http://172.20.10.2/
```

#### æ­¥éª¤ 3ï¼šä½¿ç”¨éªŒè¯è„šæœ¬

```bash
# åœ¨ macOS ä¸­è¿è¡Œ
cd /Users/zhou/Code/Pyt

# ä½¿ç”¨éªŒè¯è„šæœ¬ï¼ˆéœ€è¦å…ˆè·å– WSL IPï¼‰
WSL_IP=$(wsl hostname -I | awk '{print $1}')
echo "WSL IP: $WSL_IP"

# æµ‹è¯•ç«¯ç‚¹
curl -I "http://$WSL_IP/"
curl "http://$WSL_IP/api/v1/monitoring/health"
```

### æ–¹æ³• 2ï¼šä½¿ç”¨è¿œç¨‹éªŒè¯è„šæœ¬

```bash
# åœ¨ macOS ä¸­è¿è¡Œ
cd /Users/zhou/Code/Pyt

# ç›´æ¥è¿è¡Œï¼ˆå¦‚æœ WSL å¯ä»¥ç›´æ¥è®¿é—®ï¼‰
bash scripts/verify_deployment_remote.sh

# æˆ–é€šè¿‡ SSHï¼ˆå¦‚æœé…ç½®äº† SSHï¼‰
bash scripts/verify_deployment_remote.sh user@wsl-ip
```

### æ–¹æ³• 3ï¼šæµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥

1. **æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·**ï¼ˆF12ï¼‰
2. **åˆ‡æ¢åˆ° Console æ ‡ç­¾**
3. **æ£€æŸ¥é”™è¯¯ä¿¡æ¯**ï¼š
   - `Uncaught ReferenceError` - è„šæœ¬åŠ è½½å¤±è´¥
   - `Failed to load resource` - èµ„æºæ–‡ä»¶ 404
   - `CORS error` - è·¨åŸŸé—®é¢˜

4. **åˆ‡æ¢åˆ° Network æ ‡ç­¾**ï¼š
   - å‹¾é€‰ "Disable cache"
   - åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
   - æ£€æŸ¥æ‰€æœ‰è¯·æ±‚çš„çŠ¶æ€ç 
   - æŸ¥çœ‹å¤±è´¥çš„è¯·æ±‚ï¼ˆçº¢è‰²ï¼‰

**å¸¸è§é—®é¢˜**ï¼š
- `index.html` è¿”å› 200ï¼Œä½† JS æ–‡ä»¶è¿”å› 404
  - **åŸå› **ï¼šé™æ€æ–‡ä»¶è·¯å¾„é”™è¯¯
  - **è§£å†³**ï¼šæ£€æŸ¥ `frontend/dist/assets/` ç›®å½•

- æ‰€æœ‰æ–‡ä»¶è¿”å› 200ï¼Œä½†é¡µé¢ç™½å±
  - **åŸå› **ï¼šJavaScript æ‰§è¡Œé”™è¯¯
  - **è§£å†³**ï¼šæŸ¥çœ‹ Console é”™è¯¯ä¿¡æ¯

---

## ğŸ› ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šfrontend-init å®¹å™¨å¤±è´¥

**ç—‡çŠ¶**ï¼š
```bash
docker ps -a | grep frontend-init
# æ˜¾ç¤º: Exited (1) æˆ–å…¶ä»–é 0 é€€å‡ºç 
```

**æ’æŸ¥**ï¼š
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs pepgmp-frontend-init-prod

# æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
docker images | grep pepgmp-frontend

# æ£€æŸ¥é•œåƒæ ‡ç­¾
grep IMAGE_TAG .env.production
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. ç¡®ä¿é•œåƒæ ‡ç­¾åŒ¹é…
cd ~/projects/Pyt
grep IMAGE_TAG .env.production
docker images | grep pepgmp-frontend

# 2. å¦‚æœæ ‡ç­¾ä¸åŒ¹é…ï¼Œæ›´æ–°é…ç½®
sed -i 's/IMAGE_TAG=.*/IMAGE_TAG=20251202/' .env.production

# 3. é‡æ–°è¿è¡Œ frontend-init
docker compose -f docker-compose.prod.yml up -d frontend-init

# 4. ç­‰å¾…å®Œæˆå¹¶æ£€æŸ¥
sleep 15
docker logs pepgmp-frontend-init-prod
ls -la frontend/dist/
```

### é—®é¢˜ 2ï¼šé™æ€æ–‡ä»¶ä¸å­˜åœ¨

**ç—‡çŠ¶**ï¼š
```bash
ls frontend/dist/
# ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. ç¡®ä¿ frontend/dist ç›®å½•å­˜åœ¨
mkdir -p frontend/dist

# 2. æ£€æŸ¥æƒé™
ls -ld frontend/dist

# 3. é‡æ–°è¿è¡Œ frontend-init
docker compose -f docker-compose.prod.yml up -d frontend-init

# 4. ç­‰å¾…å®Œæˆ
sleep 15

# 5. æ£€æŸ¥æ–‡ä»¶
ls -la frontend/dist/
find frontend/dist -type f | wc -l
```

### é—®é¢˜ 3ï¼šNginx é…ç½®é”™è¯¯

**ç—‡çŠ¶**ï¼š
- Nginx æ—¥å¿—æ˜¾ç¤º 404 æˆ– 502
- æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºèµ„æºåŠ è½½å¤±è´¥

**æ’æŸ¥**ï¼š
```bash
# æ£€æŸ¥ Nginx é…ç½®
docker exec pepgmp-nginx-prod nginx -t

# æŸ¥çœ‹ Nginx é…ç½®å†…å®¹
docker exec pepgmp-nginx-prod cat /etc/nginx/nginx.conf | grep -A 10 "server {"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„é…ç½®æ–‡ä»¶
cp /mnt/c/Users/zhou/Code/Pyt/nginx/nginx.conf nginx/nginx.conf

# 2. éªŒè¯é…ç½®è¯­æ³•
docker exec pepgmp-nginx-prod nginx -t

# 3. é‡å¯ Nginx
docker compose -f docker-compose.prod.yml restart nginx

# 4. æ£€æŸ¥æ—¥å¿—
docker logs pepgmp-nginx-prod | tail -20
```

### é—®é¢˜ 4ï¼šæ–‡ä»¶æƒé™é—®é¢˜

**ç—‡çŠ¶**ï¼š
- æ–‡ä»¶å­˜åœ¨ä½†æ— æ³•è®¿é—®
- Nginx æ—¥å¿—æ˜¾ç¤º 403 Forbidden

**æ’æŸ¥**ï¼š
```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la frontend/dist/
ls -ld frontend/dist

# æ£€æŸ¥æ–‡ä»¶æ‰€æœ‰è€…
stat frontend/dist/index.html
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥å½“å‰ç”¨æˆ· UID/GID
id -u
id -g

# 2. æ›´æ–° .env.production ä¸­çš„ HOST_UID å’Œ HOST_GID
nano .env.production
# è®¾ç½®: HOST_UID=ä½ çš„UID, HOST_GID=ä½ çš„GID

# 3. é‡æ–°è¿è¡Œ frontend-initï¼ˆä¼šè‡ªåŠ¨è®¾ç½®æƒé™ï¼‰
docker compose -f docker-compose.prod.yml up -d frontend-init

# 4. æˆ–æ‰‹åŠ¨è®¾ç½®æƒé™
sudo chown -R $(id -u):$(id -g) frontend/dist/
chmod -R 755 frontend/dist/
```

### é—®é¢˜ 5ï¼šæµè§ˆå™¨ç¼“å­˜é—®é¢˜

**ç—‡çŠ¶**ï¼š
- æ–‡ä»¶å·²æ›´æ–°ä½†æµè§ˆå™¨ä»æ˜¾ç¤ºæ—§å†…å®¹
- æ§åˆ¶å°æ˜¾ç¤ºæ—§çš„é”™è¯¯ä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

**Chrome/Edge**ï¼š
1. æŒ‰ `Ctrl + Shift + Delete`
2. é€‰æ‹©"å…¨éƒ¨æ—¶é—´"
3. å‹¾é€‰"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
4. ç‚¹å‡»"æ¸…é™¤æ•°æ®"
5. æˆ–ä½¿ç”¨éšèº«æ¨¡å¼ï¼ˆ`Ctrl + Shift + N`ï¼‰

**Firefox**ï¼š
1. æŒ‰ `Ctrl + Shift + Delete`
2. é€‰æ‹©"å…¨éƒ¨"
3. å‹¾é€‰"ç¼“å­˜"
4. ç‚¹å‡»"ç«‹å³æ¸…é™¤"

**æˆ–ä½¿ç”¨å¼€å‘è€…å·¥å…·**ï¼š
1. æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
2. å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®
3. é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"

---

## ğŸ“Š è¯Šæ–­æ£€æŸ¥æ¸…å•

### å®¹å™¨æ£€æŸ¥
- [ ] frontend-init å®¹å™¨çŠ¶æ€ä¸º `Exited (0)`
- [ ] nginx å®¹å™¨çŠ¶æ€ä¸º `Up (healthy)`
- [ ] api å®¹å™¨çŠ¶æ€ä¸º `Up (healthy)`
- [ ] database å®¹å™¨çŠ¶æ€ä¸º `Up (healthy)`
- [ ] redis å®¹å™¨çŠ¶æ€ä¸º `Up (healthy)`

### æ–‡ä»¶æ£€æŸ¥
- [ ] `frontend/dist/` ç›®å½•å­˜åœ¨
- [ ] `frontend/dist/index.html` å­˜åœ¨ä¸”å¤§å° > 1KB
- [ ] `frontend/dist/assets/` ç›®å½•å­˜åœ¨
- [ ] è‡³å°‘æœ‰å‡ ä¸ª `.js` æ–‡ä»¶
- [ ] æ–‡ä»¶æƒé™æ­£ç¡®ï¼ˆå¯è¯»ï¼‰

### é…ç½®æ£€æŸ¥
- [ ] `nginx/nginx.conf` ä½¿ç”¨ Scheme B é…ç½®
- [ ] Nginx é…ç½®è¯­æ³•æ­£ç¡®
- [ ] `docker-compose.prod.yml` ä¸­ nginx ä¾èµ– `frontend-init`
- [ ] `IMAGE_TAG` ä¸å¯¼å…¥çš„é•œåƒæ ‡ç­¾åŒ¹é…

### ç½‘ç»œæ£€æŸ¥
- [ ] `http://localhost/` è¿”å› 200
- [ ] `http://localhost/api/v1/monitoring/health` è¿”å› 200
- [ ] `http://localhost/health` è¿”å› 200
- [ ] HTML å†…å®¹åŒ…å«æœ‰æ•ˆçš„è„šæœ¬æ ‡ç­¾

### æµè§ˆå™¨æ£€æŸ¥
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯
- [ ] ç½‘ç»œè¯·æ±‚å…¨éƒ¨æˆåŠŸï¼ˆ200ï¼‰
- [ ] é¡µé¢æ­£å¸¸æ¸²æŸ“ï¼ˆä¸æ˜¯ç™½å±ï¼‰

---

## ğŸ”§ å¿«é€Ÿä¿®å¤å‘½ä»¤

### å®Œå…¨é‡æ–°éƒ¨ç½²

```bash
cd ~/projects/Pyt

# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
docker compose -f docker-compose.prod.yml down

# 2. æ¸…ç†é™æ€æ–‡ä»¶
rm -rf frontend/dist/*

# 3. é‡æ–°å¯åŠ¨
docker compose -f docker-compose.prod.yml --env-file .env.production up -d

# 4. ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 30

# 5. æ£€æŸ¥çŠ¶æ€
docker compose -f docker-compose.prod.yml ps

# 6. éªŒè¯
curl http://localhost/
```

### ä»…ä¿®å¤å‰ç«¯

```bash
cd ~/projects/Pyt

# 1. åœæ­¢ Nginx
docker compose -f docker-compose.prod.yml stop nginx

# 2. æ¸…ç†é™æ€æ–‡ä»¶
rm -rf frontend/dist/*

# 3. é‡æ–°è¿è¡Œ frontend-init
docker compose -f docker-compose.prod.yml up -d frontend-init

# 4. ç­‰å¾…å®Œæˆ
sleep 15

# 5. æ£€æŸ¥æ–‡ä»¶
ls -la frontend/dist/

# 6. é‡å¯ Nginx
docker compose -f docker-compose.prod.yml start nginx

# 7. éªŒè¯
curl http://localhost/
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆè¯´æ˜](./å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆè¯´æ˜.md) - æ¶æ„è¯¦ç»†è¯´æ˜
- [WSL2 ç”Ÿäº§éƒ¨ç½²è¯¦ç»†æ­¥éª¤](./WSL2ç”Ÿäº§éƒ¨ç½²è¯¦ç»†æ­¥éª¤.md) - éƒ¨ç½²æ­¥éª¤
- [ç«äº‰æ¡ä»¶ä¿®å¤è¯´æ˜](./ç«äº‰æ¡ä»¶ä¿®å¤è¯´æ˜.md) - Nginx å¯åŠ¨é¡ºåºé—®é¢˜

---

**æœ€åæ›´æ–°**: 2025-12-02
