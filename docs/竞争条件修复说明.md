# Nginx å¯åŠ¨ç«äº‰æ¡ä»¶ä¿®å¤è¯´æ˜

## ğŸ” é—®é¢˜æè¿°

### ç«äº‰æ¡ä»¶ï¼ˆRace Conditionï¼‰

åœ¨ä¹‹å‰çš„é…ç½®ä¸­ï¼ŒNginx æœåŠ¡çš„ `depends_on` åªä½¿ç”¨äº†ç®€å•çš„æœåŠ¡åˆ—è¡¨ï¼š

```yaml
nginx:
  depends_on:
    - api
    - frontend-init
```

**é—®é¢˜**ï¼š
- Docker Compose çš„é»˜è®¤ `depends_on` è¡Œä¸ºæ˜¯ `service_started`ï¼Œåªç­‰å¾…å®¹å™¨å¯åŠ¨
- `frontend-init` å®¹å™¨å¯åŠ¨åéœ€è¦æ—¶é—´å¤åˆ¶æ–‡ä»¶ï¼ˆå¯èƒ½å‡ ç§’åˆ°å‡ åç§’ï¼‰
- Nginx å¯èƒ½åœ¨ `frontend-init` è¿˜åœ¨å¤åˆ¶æ–‡ä»¶æ—¶å°±å¯åŠ¨äº†
- å¦‚æœ Nginx å¯åŠ¨æ—¶ `./frontend/dist` ç›®å½•è¿˜ä¸å­˜åœ¨æˆ–æ–‡ä»¶ä¸å®Œæ•´ï¼Œä¼šå¯¼è‡´ï¼š
  - Nginx å¯åŠ¨å¤±è´¥ï¼ˆæ‰¾ä¸åˆ°æ–‡ä»¶ï¼‰
  - æˆ–åŠ è½½ä¸å®Œæ•´çš„é™æ€æ–‡ä»¶ï¼ˆç™½å±æˆ– 404 é”™è¯¯ï¼‰

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä½¿ç”¨æ¡ä»¶ä¾èµ–ï¼ˆConditional Dependenciesï¼‰

æ›´æ–° `depends_on` é…ç½®ï¼Œä½¿ç”¨æ˜ç¡®çš„æ¡ä»¶ï¼š

```yaml
nginx:
  depends_on:
    api:
      condition: service_healthy  # ç­‰å¾… API æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
    frontend-init:
      condition: service_completed_successfully  # å…³é”®ï¼å¿…é¡»ç­‰å¾… frontend-init è¿è¡Œå®Œæˆå¹¶æˆåŠŸé€€å‡º
```

### æ¡ä»¶è¯´æ˜

#### 1. `api: condition: service_healthy`
- **å«ä¹‰**: ç­‰å¾… API æœåŠ¡çš„å¥åº·æ£€æŸ¥é€šè¿‡
- **åŸå› **: ç¡®ä¿ API æœåŠ¡å®Œå…¨å°±ç»ªï¼Œå¯ä»¥å¤„ç†è¯·æ±‚
- **æ›¿ä»£æ–¹æ¡ˆ**: å¦‚æœä¸éœ€è¦å¥åº·æ£€æŸ¥ï¼Œå¯ä»¥ä½¿ç”¨ `service_started`

#### 2. `frontend-init: condition: service_completed_successfully`
- **å«ä¹‰**: ç­‰å¾… `frontend-init` å®¹å™¨æˆåŠŸå®Œæˆå¹¶é€€å‡ºï¼ˆé€€å‡ºç ä¸º 0ï¼‰
- **åŸå› **: ç¡®ä¿é™æ€æ–‡ä»¶å·²ç»å®Œå…¨æå–åˆ° `./frontend/dist` ç›®å½•
- **å…³é”®**: è¿™æ˜¯é˜²æ­¢ç«äº‰æ¡ä»¶çš„æ ¸å¿ƒä¿®å¤

---

## ğŸ“‹ Docker Compose ä¾èµ–æ¡ä»¶ç±»å‹

Docker Compose æ”¯æŒä»¥ä¸‹ä¾èµ–æ¡ä»¶ï¼š

| æ¡ä»¶ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| `service_started` | å®¹å™¨å¯åŠ¨ï¼ˆé»˜è®¤ï¼‰ | ç®€å•ä¾èµ–ï¼Œä¸éœ€è¦ç­‰å¾…æœåŠ¡å°±ç»ª |
| `service_healthy` | å¥åº·æ£€æŸ¥é€šè¿‡ | éœ€è¦ç­‰å¾…æœåŠ¡å®Œå…¨å°±ç»ªï¼ˆå¦‚æ•°æ®åº“ã€APIï¼‰ |
| `service_completed_successfully` | å®¹å™¨æˆåŠŸå®Œæˆå¹¶é€€å‡ºï¼ˆé€€å‡ºç  0ï¼‰ | ä¸€æ¬¡æ€§ä»»åŠ¡å®¹å™¨ï¼ˆå¦‚åˆå§‹åŒ–ã€è¿ç§»ï¼‰ |

---

## ğŸ”§ ä¿®å¤åçš„é…ç½®

### docker-compose.prod.yml

```yaml
nginx:
  image: nginx:alpine
  container_name: pepgmp-nginx-prod
  ports:
    - "80:80"
    - "443:443"
  volumes:
    - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    - ./nginx/ssl:/etc/nginx/ssl:ro
    - ./frontend/dist:/usr/share/nginx/html:ro
  networks:
    - frontend
  depends_on:
    api:
      condition: service_healthy  # ç­‰å¾… API æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
    frontend-init:
      condition: service_completed_successfully  # å…³é”®ï¼å¿…é¡»ç­‰å¾… frontend-init è¿è¡Œå®Œæˆå¹¶æˆåŠŸé€€å‡º
  restart: unless-stopped
```

### docker-compose.prod.1panel.yml

åŒæ ·çš„é…ç½®å·²åº”ç”¨åˆ° 1Panel ç‰ˆæœ¬ã€‚

---

## âœ… éªŒè¯ä¿®å¤

### å¯åŠ¨é¡ºåºéªŒè¯

å¯åŠ¨æœåŠ¡åï¼Œæ£€æŸ¥å¯åŠ¨é¡ºåºï¼š

```bash
# å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.prod.yml --env-file .env.production up -d

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
docker-compose -f docker-compose.prod.yml logs | grep -E "(frontend-init|nginx)" | head -20
```

**é¢„æœŸç»“æœ**ï¼š
1. `frontend-init` å®¹å™¨å¯åŠ¨å¹¶å¼€å§‹å¤åˆ¶æ–‡ä»¶
2. `frontend-init` å®¹å™¨å®Œæˆå¹¶é€€å‡ºï¼ˆçŠ¶æ€ä¸º `Exited (0)`ï¼‰
3. `nginx` å®¹å™¨å¯åŠ¨ï¼ˆæ­¤æ—¶é™æ€æ–‡ä»¶å·²å®Œå…¨å°±ç»ªï¼‰

### æ–‡ä»¶å®Œæ•´æ€§éªŒè¯

```bash
# æ£€æŸ¥é™æ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la frontend/dist/

# æ£€æŸ¥ index.html æ˜¯å¦å­˜åœ¨
test -f frontend/dist/index.html && echo "âœ“ index.html exists" || echo "âœ— index.html missing"

# æ£€æŸ¥æ–‡ä»¶æ•°é‡
find frontend/dist -type f | wc -l
```

### Nginx å¯åŠ¨éªŒè¯

```bash
# æ£€æŸ¥ Nginx å®¹å™¨çŠ¶æ€
docker ps | grep nginx

# æ£€æŸ¥ Nginx æ—¥å¿—ï¼ˆåº”è¯¥æ²¡æœ‰æ–‡ä»¶æ‰¾ä¸åˆ°çš„é”™è¯¯ï¼‰
docker logs pepgmp-nginx-prod | grep -i error

# æµ‹è¯• Nginx é…ç½®
docker exec pepgmp-nginx-prod nginx -t
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: frontend-init é€€å‡ºç ä¸ä¸º 0

**ç—‡çŠ¶**: Nginx ä¸€ç›´ç­‰å¾…ï¼Œæ— æ³•å¯åŠ¨

**åŸå› **: `frontend-init` å®¹å™¨æ‰§è¡Œå¤±è´¥ï¼ˆé€€å‡ºç é 0ï¼‰

**è§£å†³**:
```bash
# æŸ¥çœ‹ frontend-init æ—¥å¿—
docker logs pepgmp-frontend-init

# æ£€æŸ¥é€€å‡ºç 
docker inspect pepgmp-frontend-init | grep -A 5 "State"

# æ‰‹åŠ¨è¿è¡Œ frontend-init æŸ¥çœ‹é”™è¯¯
docker-compose -f docker-compose.prod.yml --env-file .env.production run --rm frontend-init
```

### é—®é¢˜ 2: Nginx ä»ç„¶åœ¨ frontend-init å®Œæˆå‰å¯åŠ¨

**ç—‡çŠ¶**: Nginx å¯åŠ¨æ—¶æ‰¾ä¸åˆ°æ–‡ä»¶

**åŸå› **: Docker Compose ç‰ˆæœ¬å¯èƒ½ä¸æ”¯æŒ `service_completed_successfully`

**è§£å†³**:
```bash
# æ£€æŸ¥ Docker Compose ç‰ˆæœ¬ï¼ˆéœ€è¦ 1.27.0+ï¼‰
docker-compose --version

# å¦‚æœç‰ˆæœ¬è¿‡ä½ï¼Œå‡çº§ Docker Compose
# æˆ–ä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆï¼šåœ¨ frontend-init å®Œæˆåæ‰‹åŠ¨å¯åŠ¨ nginx
```

### é—®é¢˜ 3: API å¥åº·æ£€æŸ¥å¤±è´¥

**ç—‡çŠ¶**: Nginx ä¸€ç›´ç­‰å¾… API æœåŠ¡

**åŸå› **: API æœåŠ¡å¥åº·æ£€æŸ¥æœªé€šè¿‡

**è§£å†³**:
```bash
# æ£€æŸ¥ API å®¹å™¨çŠ¶æ€
docker ps | grep api

# æŸ¥çœ‹ API æ—¥å¿—
docker logs pepgmp-api-prod

# æ‰‹åŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥
docker exec pepgmp-api-prod curl -f http://localhost:8000/api/v1/monitoring/health
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æ¡ä»¶ä¾èµ–

å¯¹äºæ‰€æœ‰å…³é”®ä¾èµ–ï¼Œéƒ½åº”è¯¥ä½¿ç”¨æ˜ç¡®çš„æ¡ä»¶ï¼š

```yaml
depends_on:
  service_name:
    condition: service_healthy  # æˆ– service_completed_successfully
```

### 2. ä¸€æ¬¡æ€§ä»»åŠ¡å®¹å™¨

å¯¹äºåˆå§‹åŒ–ã€è¿ç§»ç­‰ä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œä½¿ç”¨ï¼š
- `restart: "no"` - ä¸è‡ªåŠ¨é‡å¯
- `condition: service_completed_successfully` - ç­‰å¾…æˆåŠŸå®Œæˆ

### 3. å¥åº·æ£€æŸ¥

ä¸ºæ‰€æœ‰éœ€è¦ç­‰å¾…çš„æœåŠ¡é…ç½®å¥åº·æ£€æŸ¥ï¼š

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

---

## ğŸ¯ æ€»ç»“

**ä¿®å¤å†…å®¹**:
- âœ… æ›´æ–°äº† `docker-compose.prod.yml` ä¸­çš„ nginx `depends_on`
- âœ… æ›´æ–°äº† `docker-compose.prod.1panel.yml` ä¸­çš„ nginx `depends_on`
- âœ… ä½¿ç”¨ `service_completed_successfully` ç¡®ä¿ `frontend-init` å®Œæˆåå†å¯åŠ¨ Nginx
- âœ… ä½¿ç”¨ `service_healthy` ç¡®ä¿ API æœåŠ¡å°±ç»ªåå†å¯åŠ¨ Nginx

**æ•ˆæœ**:
- âœ… æ¶ˆé™¤äº† Nginx å’Œ frontend-init ä¹‹é—´çš„ç«äº‰æ¡ä»¶
- âœ… ç¡®ä¿é™æ€æ–‡ä»¶å®Œå…¨å°±ç»ªå Nginx æ‰å¯åŠ¨
- âœ… é¿å…ç™½å±å’Œ 404 é”™è¯¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-18
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
