# prepare_minimal_deploy.sh è„šæœ¬ä¼˜åŒ–è¯´æ˜Ž

## ðŸ” ä¼˜åŒ–èƒŒæ™¯

è„šæœ¬ä¹‹å‰å­˜åœ¨é…ç½®æ¼‚ç§»é—®é¢˜ï¼š
- ç¡¬ç¼–ç ç”Ÿæˆ nginx.confï¼Œè¦†ç›–æºç ä¸­çš„ä¼˜åŒ–é…ç½®
- æ‰‹åŠ¨æå–å‰ç«¯æ–‡ä»¶ï¼Œä¸Ž frontend-init å®¹å™¨é€»è¾‘é‡å¤
- ç¼ºå°‘ docker-entrypoint.sh çš„åˆ†å‘

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. ç§»é™¤ Nginx é…ç½®çš„ç¡¬ç¼–ç ç”Ÿæˆ âœ…

**é—®é¢˜**: è„šæœ¬ä¸­åŒ…å«å¤§é‡ç¡¬ç¼–ç çš„ `cat > nginx.conf` é€»è¾‘ï¼Œä¼šè¦†ç›–æºç ä¸­ç²¾å¿ƒé…ç½®çš„ä¼˜åŒ–é¡¹ã€‚

**ä¿®å¤**:
- âœ… ç§»é™¤äº†æ‰€æœ‰ç¡¬ç¼–ç ç”Ÿæˆé€»è¾‘ï¼ˆ~200 è¡Œä»£ç ï¼‰
- âœ… æ”¹ä¸ºæ£€æŸ¥æºç ä¸­çš„ `nginx/nginx.conf` æ˜¯å¦å­˜åœ¨
- âœ… å¦‚æžœä¸å­˜åœ¨ï¼Œè„šæœ¬ä¼šæŠ¥é”™é€€å‡ºï¼ˆFail Fastï¼‰
- âœ… é…ç½®æ–‡ä»¶é€šè¿‡åŽç»­çš„ `safe_copy_dir` ä»Žæºç å¤åˆ¶

**æ•ˆæžœ**:
- âœ… é…ç½®çš„å”¯ä¸€çœŸç†æ¥æºæ˜¯æºç ä¸­çš„ `nginx/nginx.conf`
- âœ… é¿å…è„šæœ¬å’Œæºç é…ç½®ä¸ä¸€è‡´
- âœ… æ‰€æœ‰ä¼˜åŒ–ï¼ˆGzipã€ç¼“å­˜ã€å®‰å…¨å¤´ï¼‰éƒ½æ¥è‡ªæºç 

**ä»£ç å˜æ›´**:
```bash
# ä¿®å¤å‰ï¼šç¡¬ç¼–ç ç”Ÿæˆ
cat > "$PROJECT_ROOT/nginx/nginx.conf" << 'NGINX_EOF'
# ... å¤§é‡ç¡¬ç¼–ç é…ç½® ...
NGINX_EOF

# ä¿®å¤åŽï¼šæ£€æŸ¥å¹¶å¤åˆ¶
if [ ! -f "$PROJECT_ROOT/nginx/nginx.conf" ]; then
    print_error "nginx/nginx.conf not found in source code!"
    exit 1
fi
# åŽç»­é€šè¿‡ safe_copy_dir å¤åˆ¶
```

---

### 2. ä¸Ž frontend-init é€»è¾‘å¯¹é½ âœ…

**é—®é¢˜**: è„šæœ¬è¯•å›¾åœ¨éƒ¨ç½²é˜¶æ®µæ‰‹åŠ¨æå–å‰ç«¯æ–‡ä»¶ï¼Œä¸Ž Scheme B æž¶æž„ä¸­çš„ `frontend-init` å®¹å™¨é€»è¾‘é‡å¤ã€‚

**ä¿®å¤**:
- âœ… è„šæœ¬çš„æ ¸å¿ƒä»»åŠ¡æ”¹ä¸ºï¼š**ç¡®ä¿ç›®å½•å­˜åœ¨**ï¼ˆé˜²æ­¢ Docker æŒ‚è½½æŠ¥é”™ï¼‰
- âœ… ç§»é™¤äº†å¼ºåˆ¶æå–æ–‡ä»¶çš„é€»è¾‘
- âœ… å¯é€‰ï¼šå¦‚æžœæºç ä¸­æœ‰é™æ€æ–‡ä»¶ï¼Œå¯ä»¥å¤åˆ¶ä½œä¸ºåŠ é€Ÿæ‰‹æ®µï¼ˆä½†éžå¿…éœ€ï¼‰
- âœ… æ˜Žç¡®è¯´æ˜Žï¼š`frontend-init` å®¹å™¨ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨æå–æ–‡ä»¶

**æ•ˆæžœ**:
- âœ… è„šæœ¬å’Œ Docker å®¹å™¨èŒè´£æ¸…æ™°
- âœ… é¿å…é‡å¤å·¥ä½œ
- âœ… æ”¯æŒé¢„å¡«å……ï¼ˆåŠ é€Ÿï¼‰ä½†ä¸å¼ºåˆ¶

**ä»£ç å˜æ›´**:
```bash
# ä¿®å¤å‰ï¼šå¼ºåˆ¶æå–æ–‡ä»¶
if [ -d "$PROJECT_ROOT/frontend/dist" ]; then
    # å¼ºåˆ¶å¤åˆ¶...
else
    # å°è¯•ä»Žé•œåƒæå–...
fi

# ä¿®å¤åŽï¼šç¡®ä¿ç›®å½•å­˜åœ¨ï¼Œå¯é€‰é¢„å¡«å……
mkdir -p "$FRONTEND_DIST_TARGET"  # æ ¸å¿ƒä»»åŠ¡
# å¯é€‰ï¼šå¦‚æžœæºç æœ‰æ–‡ä»¶ï¼Œå¤åˆ¶ä½œä¸ºåŠ é€Ÿ
if [ -d "$PROJECT_ROOT/frontend/dist" ]; then
    # å¯é€‰å¤åˆ¶ï¼ˆéžå¿…éœ€ï¼‰
fi
```

---

### 3. å¢žåŠ  docker-entrypoint.sh çš„åˆ†å‘ âœ…

**é—®é¢˜**: æ–°å¢žçš„ `scripts/docker-entrypoint.sh` æ²¡æœ‰è¢«å¤åˆ¶åˆ°éƒ¨ç½²ç›®å½•ï¼Œå¯¼è‡´ API å®¹å™¨å¯åŠ¨å¤±è´¥ã€‚

**ä¿®å¤**:
- âœ… æ·»åŠ äº† `docker-entrypoint.sh` çš„å¤åˆ¶é€»è¾‘
- âœ… å¦‚æžœæºç ä¸­ä¸å­˜åœ¨ï¼Œè„šæœ¬ä¼šæŠ¥é”™é€€å‡ºï¼ˆFail Fastï¼‰
- âœ… ç¡®ä¿æ–‡ä»¶è¢«æ­£ç¡®å¤åˆ¶åˆ°éƒ¨ç½²ç›®å½•

**ä»£ç **:
```bash
# å¤åˆ¶ Docker Entrypoint è„šæœ¬ï¼ˆAPI å®¹å™¨å¯åŠ¨éœ€è¦ï¼‰
print_info "Copying docker-entrypoint.sh..."
if [ ! -f "$PROJECT_ROOT/scripts/docker-entrypoint.sh" ]; then
    print_error "docker-entrypoint.sh not found in source code!"
    exit 1
fi
safe_copy_file \
    "$PROJECT_ROOT/scripts/docker-entrypoint.sh" \
    "$DEPLOY_DIR/scripts/docker-entrypoint.sh" \
    "scripts/docker-entrypoint.sh"
```

---

### 4. ç¡®ä¿æºç ä¸­æœ‰ nginx é…ç½®æ–‡ä»¶ âœ…

**é—®é¢˜**: éœ€è¦ç¡®ä¿æºç ä¸­æœ‰ `nginx/nginx.conf` æ–‡ä»¶ã€‚

**ä¿®å¤**:
- âœ… å·²æ›´æ–°æºç ä¸­çš„ `nginx/nginx.conf`ï¼ŒåŒ…å«æ‰€æœ‰ä¼˜åŒ–ï¼š
  - å®‰å…¨å¤´ï¼ˆX-Frame-Options, X-Content-Type-Options, X-XSS-Protectionï¼‰
  - ä¼˜åŒ–çš„ Gzip é…ç½®
  - `index.html` ç¼“å­˜æŽ§åˆ¶
  - é™æ€èµ„æºå¼ºç¼“å­˜
  - `client_max_body_size` é™åˆ¶

---

## ðŸ“‹ ä¼˜åŒ–å‰åŽå¯¹æ¯”

### Nginx é…ç½®å¤„ç†

| é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ |
|------|--------|--------|
| **é…ç½®æ¥æº** | è„šæœ¬ç¡¬ç¼–ç ç”Ÿæˆ | æºç  `nginx/nginx.conf` |
| **é…ç½®æ›´æ–°** | éœ€è¦ä¿®æ”¹è„šæœ¬ | ç›´æŽ¥ä¿®æ”¹æºç æ–‡ä»¶ |
| **é…ç½®ä¸€è‡´æ€§** | è„šæœ¬å’Œæºç å¯èƒ½ä¸ä¸€è‡´ | å•ä¸€çœŸç†æ¥æº |
| **ä»£ç è¡Œæ•°** | ~200 è¡Œç¡¬ç¼–ç  | ~10 è¡Œæ£€æŸ¥é€»è¾‘ |

### å‰ç«¯æ–‡ä»¶å¤„ç†

| é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ |
|------|--------|--------|
| **æå–æ–¹å¼** | è„šæœ¬å¼ºåˆ¶æå– | frontend-init å®¹å™¨è‡ªåŠ¨æå– |
| **ç›®å½•å‡†å¤‡** | æå–æ–‡ä»¶ | ç¡®ä¿ç›®å½•å­˜åœ¨ |
| **é¢„å¡«å……** | ä¸æ”¯æŒ | æ”¯æŒï¼ˆå¯é€‰ï¼‰ |
| **èŒè´£åˆ’åˆ†** | è„šæœ¬è´Ÿè´£ | å®¹å™¨è´Ÿè´£ |

### è„šæœ¬æ–‡ä»¶åˆ†å‘

| æ–‡ä»¶ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ |
|------|--------|--------|
| `docker-entrypoint.sh` | âŒ æœªå¤åˆ¶ | âœ… å·²å¤åˆ¶ |
| `init_db.sql` | âœ… å·²å¤åˆ¶ | âœ… å·²å¤åˆ¶ |
| `generate_production_config.sh` | âœ… å·²å¤åˆ¶ | âœ… å·²å¤åˆ¶ |

---

## ðŸ”§ ä½¿ç”¨æ–¹å¼

### é¦–æ¬¡éƒ¨ç½²

```bash
# 1. ç¡®ä¿æºç ä¸­æœ‰ nginx/nginx.conf
ls -la nginx/nginx.conf

# 2. ç¡®ä¿æºç ä¸­æœ‰ scripts/docker-entrypoint.sh
ls -la scripts/docker-entrypoint.sh

# 3. è¿è¡Œéƒ¨ç½²å‡†å¤‡è„šæœ¬
bash scripts/prepare_minimal_deploy.sh ~/projects/Pyt

# 4. è„šæœ¬ä¼šï¼š
#    - æ£€æŸ¥ nginx.conf æ˜¯å¦å­˜åœ¨ï¼ˆä¸å­˜åœ¨åˆ™æŠ¥é”™ï¼‰
#    - æ£€æŸ¥ docker-entrypoint.sh æ˜¯å¦å­˜åœ¨ï¼ˆä¸å­˜åœ¨åˆ™æŠ¥é”™ï¼‰
#    - å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
#    - ç¡®ä¿ frontend/dist ç›®å½•å­˜åœ¨
```

### æ›´æ–°éƒ¨ç½²

```bash
# 1. æ›´æ–°æºç ä¸­çš„ nginx.confï¼ˆå¦‚æžœéœ€è¦ï¼‰
vim nginx/nginx.conf

# 2. è¿è¡Œéƒ¨ç½²å‡†å¤‡è„šæœ¬ï¼ˆä¼šè‡ªåŠ¨æ£€æµ‹å·®å¼‚ï¼‰
bash scripts/prepare_minimal_deploy.sh ~/projects/Pyt

# 3. è„šæœ¬ä¼šï¼š
#    - æ£€æµ‹ nginx.conf æ˜¯å¦æœ‰å˜åŒ–ï¼ˆMD5/Diffï¼‰
#    - åªå¤åˆ¶å˜åŒ–çš„æ–‡ä»¶
#    - ä¿æŒå…¶ä»–æ–‡ä»¶ä¸å˜
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æºç æ–‡ä»¶å¿…é¡»å­˜åœ¨

ä»¥ä¸‹æ–‡ä»¶å¿…é¡»åœ¨æºç ä¸­å­˜åœ¨ï¼Œå¦åˆ™è„šæœ¬ä¼šæŠ¥é”™é€€å‡ºï¼š

- âœ… `nginx/nginx.conf` - Nginx é…ç½®æ–‡ä»¶
- âœ… `scripts/docker-entrypoint.sh` - API å®¹å™¨å¯åŠ¨è„šæœ¬

**æ£€æŸ¥æ–¹æ³•**:
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
test -f nginx/nginx.conf && echo "âœ“ nginx.conf exists" || echo "âœ— nginx.conf missing"
test -f scripts/docker-entrypoint.sh && echo "âœ“ docker-entrypoint.sh exists" || echo "âœ— docker-entrypoint.sh missing"
```

### 2. é…ç½®ä¿®æ”¹æµç¨‹

**ä¿®æ”¹ Nginx é…ç½®**:
1. ç›´æŽ¥ç¼–è¾‘æºç ä¸­çš„ `nginx/nginx.conf`
2. æäº¤åˆ° Git
3. è¿è¡Œ `prepare_minimal_deploy.sh` è‡ªåŠ¨å¤åˆ¶åˆ°éƒ¨ç½²ç›®å½•

**ä¸è¦**:
- âŒ åœ¨éƒ¨ç½²ç›®å½•ç›´æŽ¥ä¿®æ”¹ `nginx/nginx.conf`ï¼ˆä¼šè¢«è¦†ç›–ï¼‰
- âŒ åœ¨è„šæœ¬ä¸­ç¡¬ç¼–ç é…ç½®ï¼ˆå·²ç§»é™¤ï¼‰

### 3. å‰ç«¯æ–‡ä»¶å¤„ç†

**Scheme B æž¶æž„**:
- `frontend-init` å®¹å™¨ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨æå–é™æ€æ–‡ä»¶
- è„šæœ¬åªç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆé˜²æ­¢ Docker æŒ‚è½½æŠ¥é”™ï¼‰
- å¦‚æžœæºç ä¸­æœ‰é™æ€æ–‡ä»¶ï¼Œå¯ä»¥é¢„å¡«å……ï¼ˆåŠ é€Ÿï¼‰ï¼Œä½†éžå¿…éœ€

**é¦–æ¬¡å¯åŠ¨æµç¨‹**:
```
1. docker-compose up -d
2. frontend-init å®¹å™¨å¯åŠ¨
3. ä»Žé•œåƒæå–é™æ€æ–‡ä»¶åˆ° ./frontend/dist
4. frontend-init å®¹å™¨é€€å‡º
5. nginx å®¹å™¨å¯åŠ¨ï¼ˆä¾èµ– frontend-init å®Œæˆï¼‰
6. nginx æŒ‚è½½ ./frontend/dist ç›®å½•
```

---

## ðŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `scripts/prepare_minimal_deploy.sh` - ç§»é™¤ç¡¬ç¼–ç ç”Ÿæˆï¼Œæ”¹ä¸ºå¤åˆ¶æºç é…ç½®
2. âœ… `nginx/nginx.conf` - æ›´æ–°ä¸ºåŒ…å«æ‰€æœ‰ä¼˜åŒ–çš„å®Œæ•´é…ç½®
3. âœ… `docs/è„šæœ¬ä¼˜åŒ–è¯´æ˜Ž.md` - æœ¬æ–‡æ¡£

---

## ðŸŽ¯ æ€»ç»“

**ä¼˜åŒ–æˆæžœ**:
- âœ… é…ç½®å•ä¸€çœŸç†æ¥æºï¼ˆæºç ï¼‰
- âœ… é¿å…é…ç½®æ¼‚ç§»
- âœ… è„šæœ¬å’Œ Docker å®¹å™¨èŒè´£æ¸…æ™°
- âœ… æ”¯æŒå¢žé‡æ›´æ–°å’Œé¢„å¡«å……ä¼˜åŒ–

**å…³é”®åŽŸåˆ™**:
- ðŸŽ¯ **æºç æ˜¯é…ç½®çš„å”¯ä¸€çœŸç†æ¥æº**
- ðŸŽ¯ **è„šæœ¬åªè´Ÿè´£å¤åˆ¶ï¼Œä¸ç”Ÿæˆé…ç½®**
- ðŸŽ¯ **å®¹å™¨è´Ÿè´£è¿è¡Œæ—¶é€»è¾‘ï¼ˆæ–‡ä»¶æå–ã€è¿ç§»ï¼‰**
- ðŸŽ¯ **è„šæœ¬è´Ÿè´£éƒ¨ç½²å‡†å¤‡ï¼ˆç›®å½•ã€æ–‡ä»¶å¤åˆ¶ï¼‰**

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-18
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
