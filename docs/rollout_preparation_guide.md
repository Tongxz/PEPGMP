# 灰度发布准备指南

## 日期
2025-10-31

## 📊 准备状态

### ✅ 已完成准备

1. **代码集成**: 13个新端点已集成
2. **单元测试**: 32个测试，100%通过
3. **集成测试**: 告警规则写操作已验证
4. **测试工具**: 集成测试和对比测试脚本已创建

### ⏳ 待完成准备

1. **完整集成测试**: 摄像头操作端点待验证
2. **功能对比测试**: 新旧实现对比验证
3. **监控配置**: 监控指标和告警规则配置
4. **回滚验证**: 回滚机制验证

## 🎯 灰度发布准备步骤

### 步骤一：完整测试验证（必须）⭐⭐⭐

**时间**: 1-2天

#### 1.1 完整集成测试

**执行命令**:
```bash
./tools/verify_new_endpoints.sh
```

**验证内容**:
- ✅ 告警规则创建和更新
- ⏳ 摄像头操作端点（需要摄像头数据）

**预期结果**: 所有端点功能正常

#### 1.2 功能对比测试

**执行命令**:
```bash
./tools/functionality_comparison_test.sh
```

**验证内容**:
- 新旧实现响应格式一致性
- 新旧实现错误处理一致性
- 灰度开关功能正常

**预期结果**: 新旧实现行为一致

### 步骤二：监控配置（必须）⭐⭐⭐

**时间**: 2-3小时

#### 2.1 监控端点验证

**检查命令**:
```bash
# 健康检查
curl http://localhost:8000/api/v1/monitoring/health

# 监控指标
curl http://localhost:8000/api/v1/monitoring/metrics
```

**验证内容**:
- ✅ 健康检查端点可用
- ✅ 监控指标端点可用
- ✅ 指标数据正常

#### 2.2 告警规则配置

**监控指标**:
- **错误率**: 目标 < 1%，阈值 > 5% 立即告警
- **响应时间**: P95延迟无明显增加，阈值 > 50% 告警
- **成功率**: 目标 > 99%，阈值 < 95% 立即告警
- **领域服务使用率**: 跟踪使用情况

**配置方法**:
```bash
# 使用监控端点收集指标
curl http://localhost:8000/api/v1/monitoring/metrics | jq
```

### 步骤三：回滚方案准备（必须）⭐⭐⭐

**时间**: 1-2小时

#### 3.1 回滚机制验证

**验证命令**:
```bash
# 测试回滚（force_domain=false）
curl "http://localhost:8000/api/v1/alerts/rules?force_domain=false"

# 或设置环境变量（需要重启服务）
export USE_DOMAIN_SERVICE=false
```

**验证内容**:
- ✅ 所有端点都能回退到旧实现
- ✅ 回退后功能正常
- ✅ 响应格式一致

#### 3.2 回滚脚本准备

**回滚方法**:
```bash
# 方法1: 环境变量（需要重启服务）
export USE_DOMAIN_SERVICE=false
export ROLLOUT_PERCENT=0
# 重启后端服务

# 方法2: 使用 force_domain=false 参数（即时生效）
# 前端或调用方在请求时添加 ?force_domain=false
```

**回滚检查清单**:
- [ ] 验证回滚机制工作正常
- [ ] 准备回滚脚本
- [ ] 文档化回滚流程
- [ ] 测试回滚速度（应在5分钟内完成）

### 步骤四：灰度发布配置（必须）⭐⭐

**时间**: 1小时

#### 4.1 环境变量配置

**灰度发布配置**:
```bash
# 启用领域服务
export USE_DOMAIN_SERVICE=true

# 设置灰度比例
export ROLLOUT_PERCENT=10  # 10%灰度

# 重启后端服务
```

**验证命令**:
```bash
./tools/rollout_preparation_check.sh
```

#### 4.2 灰度发布脚本

**启动灰度发布**:
```bash
# 10%灰度
./tools/rollout_start.sh 10

# 25%灰度
./tools/rollout_start.sh 25

# 50%灰度
./tools/rollout_start.sh 50

# 100%全量
./tools/rollout_start.sh 100
```

## 📋 准备检查清单

### 测试验证检查清单

- [ ] 完整集成测试通过（所有端点功能正常）
- [ ] 功能对比测试通过（新旧实现行为一致）
- [ ] 灰度开关验证通过（force_domain参数工作正常）
- [ ] 回滚机制验证通过（可以正常回退到旧实现）

### 监控配置检查清单

- [ ] 健康检查端点可用
- [ ] 监控指标端点可用
- [ ] 告警规则配置完成
- [ ] 监控仪表板配置完成（如需要）

### 回滚方案检查清单

- [ ] 回滚机制验证通过
- [ ] 回滚脚本准备完成
- [ ] 回滚流程文档化完成
- [ ] 回滚速度测试通过（< 5分钟）

### 灰度发布配置检查清单

- [ ] 环境变量配置说明完成
- [ ] 灰度发布脚本准备完成
- [ ] 灰度发布计划制定完成
- [ ] 灰度发布时间表制定完成

## 🎯 灰度发布计划

### 告警规则写操作灰度发布

**阶段一：10%灰度** (1-2天)
- 时间: Day 1-2
- 配置: `ROLLOUT_PERCENT=10`
- 监控: 密切监控错误率和性能
- 验证: 功能正确性验证

**阶段二：25%灰度** (3-5天)
- 时间: Day 3-7
- 配置: `ROLLOUT_PERCENT=25`
- 监控: 继续监控
- 验证: 修复发现的问题

**阶段三：50%灰度** (1周)
- 时间: Week 2
- 配置: `ROLLOUT_PERCENT=50`
- 监控: 深入验证
- 验证: 准备全量发布

**阶段四：100%全量** (1-2周)
- 时间: Week 3-4
- 配置: `ROLLOUT_PERCENT=100`
- 监控: 持续监控
- 验证: 稳定运行

### 摄像头操作端点灰度发布

**计划**: 在告警规则写操作灰度成功后再开始

**阶段**: 同告警规则写操作（10% → 25% → 50% → 100%）

**注意事项**:
- 摄像头操作涉及进程控制，需要更谨慎
- 建议先在测试环境验证
- 逐步扩大范围，密切监控

## 📊 监控指标

### 关键指标

1. **错误率**
   - 目标: < 1%
   - 阈值: > 5% 立即告警
   - 监控: 每分钟检查

2. **响应时间**
   - 目标: P95延迟无明显增加
   - 阈值: > 50% 需要检查
   - 监控: 实时监控

3. **成功率**
   - 目标: > 99%
   - 阈值: < 95% 立即告警
   - 监控: 实时监控

4. **领域服务使用率**
   - 目标: 跟踪使用情况
   - 监控: 实时监控

### 监控端点

- `GET /api/v1/monitoring/health` - 健康检查
- `GET /api/v1/monitoring/metrics` - 监控指标

## 🚨 风险控制

### 灰度发布风险

1. **功能风险**
   - 风险: 新实现功能异常
   - 控制: 完整测试验证
   - 回滚: 立即回滚到旧实现

2. **性能风险**
   - 风险: 响应时间增加
   - 控制: 性能测试和监控
   - 回滚: 性能下降超过阈值时回滚

3. **数据风险**
   - 风险: 数据不一致
   - 控制: 数据一致性监控
   - 回滚: 发现数据问题时回滚

### 回滚触发条件

以下情况应立即回滚：
- 错误率 > 5%
- 成功率 < 95%
- P95延迟增加 > 50%
- 发现严重功能问题
- 数据一致性问题

## 💡 执行建议

### 立即执行（本周）

1. **完成测试验证** (1-2天)
   - 运行完整集成测试
   - 运行功能对比测试
   - 验证灰度开关功能

2. **配置监控** (2-3小时)
   - 配置监控指标
   - 配置告警规则
   - 验证监控端点

3. **准备回滚** (1-2小时)
   - 验证回滚机制
   - 准备回滚脚本
   - 文档化回滚流程

### 下周执行

1. **开始灰度发布** (2-4周)
   - 10%灰度（1-2天）
   - 25%灰度（3-5天）
   - 50%灰度（1周）
   - 100%全量（1-2周）

2. **持续监控** (持续)
   - 监控错误率和性能
   - 收集用户反馈
   - 根据反馈优化

## ✅ 总结

### 准备状态

- ✅ **代码集成**: 完成
- ✅ **单元测试**: 完成
- ⏳ **集成测试**: 部分完成
- ⏳ **监控配置**: 待配置
- ⏳ **回滚方案**: 待验证

### 下一步

1. **完成测试验证** (1-2天) - 立即执行
2. **配置监控** (2-3小时) - 立即执行
3. **准备回滚** (1-2小时) - 立即执行
4. **开始灰度发布** (2-4周) - 下周开始

---

**状态**: ⏳ **准备中**  
**下一步**: 完成测试验证和监控配置  
**详细指南**: 请查看本文档

