# å‰ç«¯ç™½å±é”™è¯¯åˆ†æ

## ğŸ“‹ é—®é¢˜ç°è±¡

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Uncaught ReferenceError: Cannot access 'ql' before initialization
    at Vl (vue-vendor-qUiHyQJ2.js:13:12907)
    at Bl (vue-vendor-qUiHyQJ2.js:13:12831)
    at vendor-_PLq5c2t.js:1:20318
```

**è¡¨ç°**ï¼š
- å‰ç«¯é¡µé¢ç™½å±
- æµè§ˆå™¨æ§åˆ¶å°æŠ¥é”™
- JavaScript æ¨¡å—åˆå§‹åŒ–å¤±è´¥

---

## ğŸ” é—®é¢˜åˆ†æ

### é”™è¯¯ç±»å‹

è¿™æ˜¯ä¸€ä¸ª **Temporal Dead Zone (TDZ)** é”™è¯¯ï¼Œé€šå¸¸ç”±ä»¥ä¸‹åŸå› å¯¼è‡´ï¼š

1. **å¾ªç¯ä¾èµ–**
   - æ¨¡å— A å¯¼å…¥æ¨¡å— B
   - æ¨¡å— B å¯¼å…¥æ¨¡å— A
   - å¯¼è‡´åˆå§‹åŒ–é¡ºåºé”™è¯¯

2. **ä»£ç åˆ†å‰²ç­–ç•¥é—®é¢˜**
   - Vite çš„ `manualChunks` é…ç½®å¯èƒ½å¯¼è‡´å¾ªç¯ä¾èµ–
   - æ¨¡å—è¢«é”™è¯¯åœ°åˆ†å‰²åˆ°ä¸åŒçš„ chunk ä¸­

3. **æ¨¡å—åŠ è½½é¡ºåºé—®é¢˜**
   - ES6 æ¨¡å—çš„åŠ è½½é¡ºåºä¸é¢„æœŸä¸ç¬¦
   - ä¾èµ–çš„æ¨¡å—åœ¨ä¾èµ–è€…ä¹‹å‰æ²¡æœ‰å®Œå…¨åˆå§‹åŒ–

### å½“å‰ä»£ç åˆ†å‰²é…ç½®

ä» `vite.config.ts` çœ‹ï¼Œä»£ç åˆ†å‰²ç­–ç•¥ï¼š

```typescript
manualChunks: (id) => {
  // Vue æ ¸å¿ƒåº“
  if (id.includes('vue') && !id.includes('naive-ui')) {
    return 'vue-vendor'
  }

  // å…¶ä»–ç¬¬ä¸‰æ–¹åº“
  if (id.includes('node_modules')) {
    return 'vendor'
  }
}
```

**æ½œåœ¨é—®é¢˜**ï¼š
- `vue-vendor` å’Œ `vendor` å¯èƒ½å­˜åœ¨äº¤å‰ä¾èµ–
- `vue-vendor` å¯èƒ½ä¾èµ–äº `vendor` ä¸­çš„æŸäº›æ¨¡å—
- ä½†åŠ è½½é¡ºåºå¯èƒ½å¯¼è‡´ `vendor` ä¸­çš„æ¨¡å—åœ¨ `vue-vendor` ä¹‹ååˆå§‹åŒ–

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç®€åŒ–ä»£ç åˆ†å‰²ç­–ç•¥ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `vite.config.ts`ï¼Œå‡å°‘ä»£ç åˆ†å‰²ï¼Œé¿å…å¾ªç¯ä¾èµ–ï¼š

```typescript
manualChunks: (id) => {
  // åªåˆ†å‰²å¤§å‹åº“ï¼Œå‡å°‘å¾ªç¯ä¾èµ–é£é™©
  if (id.includes('node_modules')) {
    // å°† Vue ç›¸å…³åº“æ”¾åœ¨ä¸€èµ·
    if (id.includes('vue') || id.includes('vue-router') || id.includes('@vicons/')) {
      return 'vue-vendor'
    }
    // å…¶ä»–ç¬¬ä¸‰æ–¹åº“æ”¾åœ¨ä¸€èµ·
    return 'vendor'
  }
}
```

### æ–¹æ¡ˆ 2ï¼šç¦ç”¨ä»£ç åˆ†å‰²ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœæ–¹æ¡ˆ 1 æ— æ•ˆï¼Œå¯ä»¥ä¸´æ—¶ç¦ç”¨ä»£ç åˆ†å‰²ï¼š

```typescript
build: {
  rollupOptions: {
    output: {
      // ä¸æ‰‹åŠ¨åˆ†å‰²ï¼Œè®© Vite è‡ªåŠ¨å¤„ç†
      // manualChunks: undefined
    }
  }
}
```

### æ–¹æ¡ˆ 3ï¼šé‡æ–°æ„å»ºå‰ç«¯é•œåƒ

å¦‚æœæ„å»ºäº§ç‰©æœ‰é—®é¢˜ï¼Œé‡æ–°æ„å»ºï¼š

```bash
cd /Users/zhou/Code/Pyt
./scripts/build_prod_only.sh
```

ç„¶åé‡æ–°æå–é™æ€æ–‡ä»¶ï¼š

```bash
cd /Users/zhou/projects/Pyt
docker run --rm \
  -v $(pwd)/frontend/dist:/target \
  pepgmp-frontend:20251204 \
  sh -c "cp -r /usr/share/nginx/html/* /target/ && chown -R $(id -u):$(id -g) /target"
```

---

## ğŸ”§ å¿«é€Ÿä¿®å¤æ­¥éª¤

### 1. æ£€æŸ¥å‰ç«¯ä»£ç æ˜¯å¦æœ‰å˜æ›´

```bash
cd /Users/zhou/Code/Pyt
git status frontend/
```

### 2. é‡æ–°æ„å»ºå‰ç«¯é•œåƒï¼ˆå¦‚æœä»£ç æœ‰å˜æ›´ï¼‰

```bash
./scripts/build_prod_only.sh
```

### 3. é‡æ–°æå–é™æ€æ–‡ä»¶

```bash
cd /Users/zhou/projects/Pyt
docker compose -f docker-compose.prod.yml --env-file .env.production restart frontend-init
```

æˆ–æ‰‹åŠ¨æå–ï¼š

```bash
docker run --rm \
  -v $(pwd)/frontend/dist:/target \
  -e HOST_UID=$(id -u) \
  -e HOST_GID=$(id -g) \
  pepgmp-frontend:20251204 \
  sh -c "cp -r /usr/share/nginx/html/* /target/ && chown -R \${HOST_UID}:\${HOST_GID} /target"
```

### 4. é‡å¯ Nginx

```bash
docker compose -f docker-compose.prod.yml --env-file .env.production restart nginx
```

---

## ğŸ“ éªŒè¯

ä¿®å¤åéªŒè¯ï¼š

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   - ç¡¬åˆ·æ–°ï¼š`Ctrl+Shift+R` (Windows/Linux) æˆ– `Cmd+Shift+R` (Mac)
   - æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼è®¿é—®

2. **æ£€æŸ¥æ§åˆ¶å°**
   - åº”è¯¥æ²¡æœ‰ `ReferenceError` é”™è¯¯
   - åº”ç”¨åº”è¯¥æ­£å¸¸åŠ è½½

3. **æ£€æŸ¥ç½‘ç»œè¯·æ±‚**
   - æ‰€æœ‰ JS æ–‡ä»¶åº”è¯¥è¿”å› 200
   - æ²¡æœ‰ 404 é”™è¯¯

---

## ğŸ¯ æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

é•¿æœŸæ¥çœ‹ï¼Œåº”è¯¥ï¼š

1. **ä¼˜åŒ–ä»£ç åˆ†å‰²ç­–ç•¥**
   - ç¡®ä¿æ²¡æœ‰å¾ªç¯ä¾èµ–
   - æ¨¡å—åŠ è½½é¡ºåºæ­£ç¡®

2. **ä½¿ç”¨æ›´ç®€å•çš„åˆ†å‰²ç­–ç•¥**
   - åªåˆ†å‰²å¤§å‹åº“
   - è®© Vite è‡ªåŠ¨å¤„ç†å¤§éƒ¨åˆ†åˆ†å‰²

3. **æ·»åŠ æ„å»ºéªŒè¯**
   - æ„å»ºæ—¶æ£€æŸ¥å¾ªç¯ä¾èµ–
   - ä½¿ç”¨å·¥å…·åˆ†ææ¨¡å—ä¾èµ–å…³ç³»

---

**é—®é¢˜å‘ç°æ—¥æœŸ**: 2025-12-04
**çŠ¶æ€**: âš ï¸ å¾…ä¿®å¤
