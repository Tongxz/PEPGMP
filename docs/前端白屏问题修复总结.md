# å‰ç«¯ç™½å±é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜ç°è±¡

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Uncaught ReferenceError: Cannot access 'ql' before initialization
    at Vl (vue-vendor-qUiHyQJ2.js:13:12907)
    at Bl (vue-vendor-qUiHyQJ2.js:13:12831)
    at vendor-_PLq5c2t.js:1:20318
```

**è¡¨ç°**ï¼š
- å‰ç«¯é¡µé¢ç™½å±
- æµè§ˆå™¨æ§åˆ¶å°æŠ¥é”™
- JavaScript æ¨¡å—åˆå§‹åŒ–å¤±è´¥

---

## ğŸ” æ ¹æœ¬åŸå› 

**ä»£ç åˆ†å‰²ç­–ç•¥å¯¼è‡´çš„å¾ªç¯ä¾èµ–**

åœ¨ `vite.config.ts` ä¸­ï¼Œä»£ç åˆ†å‰²ç­–ç•¥å­˜åœ¨é—®é¢˜ï¼š

1. **Vue ç›¸å…³åº“è¢«åˆ†å‰²åˆ°ä¸åŒ chunk**
   - `vue-vendor` åŒ…å« vue, vue-router
   - `vendor` åŒ…å«å…¶ä»–ç¬¬ä¸‰æ–¹åº“
   - ä½† `vue-vendor` å¯èƒ½ä¾èµ– `vendor` ä¸­çš„æŸäº›æ¨¡å—

2. **æ¨¡å—åŠ è½½é¡ºåºé”™è¯¯**
   - ES6 æ¨¡å—çš„ TDZ (Temporal Dead Zone) é”™è¯¯
   - æ¨¡å—åœ¨åˆå§‹åŒ–å‰è¢«è®¿é—®

3. **Pinia è¢«å•ç‹¬åˆ†å‰²**
   - Pinia è¢«åˆ†å‰²åˆ° `state-vendor`
   - ä½† Vue å’Œ Pinia ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ä»£ç åˆ†å‰²ç­–ç•¥

**ä¿®æ”¹æ–‡ä»¶**: `frontend/vite.config.ts`

**å…³é”®ä¿®æ”¹**ï¼š
- ç¡®ä¿ Vue ç›¸å…³åº“ï¼ˆvue, vue-router, pinia, @viconsï¼‰éƒ½åœ¨ `vue-vendor` chunk
- é¿å… `vue-vendor` å’Œ `vendor` ä¹‹é—´çš„å¾ªç¯ä¾èµ–
- ä¼˜åŒ–æ¨¡å—åŠ è½½é¡ºåº

**ä¿®æ”¹å‰**ï¼š
```typescript
if (id.includes('vue') && !id.includes('naive-ui')) {
  return 'vue-vendor'
}
if (id.includes('pinia')) {
  return 'state-vendor'  // âŒ å•ç‹¬åˆ†å‰²ï¼Œå¯èƒ½å¯¼è‡´å¾ªç¯ä¾èµ–
}
if (id.includes('node_modules')) {
  return 'vendor'  // âŒ å¯èƒ½åŒ…å« Vue ä¾èµ–çš„æ¨¡å—
}
```

**ä¿®æ”¹å**ï¼š
```typescript
// ç¡®ä¿ Vue ç›¸å…³åº“éƒ½åœ¨åŒä¸€ä¸ª chunk
if (
  id.includes('vue') ||
  id.includes('vue-router') ||
  id.includes('@vicons/') ||
  id.includes('pinia')
) {
  return 'vue-vendor'  // âœ… éƒ½åœ¨åŒä¸€ä¸ª chunk
}

// å…¶ä»–ç¬¬ä¸‰æ–¹åº“
if (id.includes('node_modules')) {
  return 'vendor'  // âœ… ä¸ä¼šä¸ vue-vendor å†²çª
}
```

### 2. é‡æ–°æ„å»ºå‰ç«¯é•œåƒ

```bash
cd /Users/zhou/Code/Pyt
export DOCKER_BUILDKIT=1
docker build -f Dockerfile.frontend \
  --build-arg VITE_API_BASE=/api/v1 \
  --build-arg BASE_URL=/ \
  --build-arg SKIP_TYPE_CHECK=true \
  -t pepgmp-frontend:20251204 \
  -t pepgmp-frontend:latest \
  .
```

### 3. é‡æ–°æå–é™æ€æ–‡ä»¶

```bash
cd /Users/zhou/projects/Pyt
docker run --rm \
  -v $(pwd)/frontend/dist:/target \
  -e HOST_UID=$(id -u) \
  -e HOST_GID=$(id -g) \
  pepgmp-frontend:20251204 \
  sh -c "cp -r /usr/share/nginx/html/* /target/ && chown -R \${HOST_UID}:\${HOST_GID} /target"
```

### 4. é‡å¯ Nginx

```bash
docker compose -f docker-compose.prod.yml --env-file .env.production restart nginx
```

---

## ğŸ”§ éªŒè¯æ­¥éª¤

### 1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

**é‡è¦**ï¼šå¿…é¡»æ¸…é™¤ç¼“å­˜ï¼Œå¦åˆ™æµè§ˆå™¨å¯èƒ½ä½¿ç”¨æ—§çš„ JS æ–‡ä»¶

- **ç¡¬åˆ·æ–°**: `Ctrl+Shift+R` (Windows/Linux) æˆ– `Cmd+Shift+R` (Mac)
- **æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼**: `Ctrl+Shift+N` (Chrome) æˆ– `Cmd+Shift+N` (Safari)

### 2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

- åº”è¯¥æ²¡æœ‰ `ReferenceError` é”™è¯¯
- åº”è¯¥æ²¡æœ‰ `Cannot access 'ql' before initialization` é”™è¯¯

### 3. æ£€æŸ¥ç½‘ç»œè¯·æ±‚

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network æ ‡ç­¾ï¼š
- æ‰€æœ‰ JS æ–‡ä»¶åº”è¯¥è¿”å› 200
- æ²¡æœ‰ 404 é”™è¯¯
- æ–‡ä»¶åŠ è½½é¡ºåºæ­£ç¡®

### 4. éªŒè¯åº”ç”¨åŠŸèƒ½

- é¡µé¢åº”è¯¥æ­£å¸¸æ˜¾ç¤º
- è·¯ç”±åº”è¯¥æ­£å¸¸å·¥ä½œ
- API è°ƒç”¨åº”è¯¥æ­£å¸¸

---

## ğŸ“ ä¿®å¤åçš„ä»£ç åˆ†å‰²ç­–ç•¥

**æ–°çš„åˆ†å‰²ç­–ç•¥**ï¼š

1. **vue-vendor**: Vue æ ¸å¿ƒåº“åŠå…¶ç›´æ¥ä¾èµ–
   - vue
   - vue-router
   - pinia
   - @vicons/*

2. **ui-***: Naive UI ç»„ä»¶ï¼ˆæŒ‰åŠŸèƒ½åˆ†ç»„ï¼‰
   - ui-basic, ui-layout, ui-data, ui-feedback, etc.

3. **utils-vendor**: å·¥å…·åº“
   - axios

4. **vendor**: å…¶ä»–ç¬¬ä¸‰æ–¹åº“

**ä¼˜ç‚¹**ï¼š
- âœ… é¿å…å¾ªç¯ä¾èµ–
- âœ… æ¨¡å—åŠ è½½é¡ºåºæ­£ç¡®
- âœ… ä¿æŒä»£ç åˆ†å‰²çš„ä¼˜åŠ¿ï¼ˆå‡å°‘åˆå§‹åŠ è½½å¤§å°ï¼‰

---

## ğŸ¯ é¢„é˜²æªæ–½

1. **ä»£ç åˆ†å‰²ç­–ç•¥åŸåˆ™**
   - ç¡®ä¿ç›¸å…³åº“åœ¨åŒä¸€ä¸ª chunk
   - é¿å…å¾ªç¯ä¾èµ–
   - æµ‹è¯•æ¨¡å—åŠ è½½é¡ºåº

2. **æ„å»ºéªŒè¯**
   - æ„å»ºåæ£€æŸ¥æ˜¯å¦æœ‰å¾ªç¯ä¾èµ–è­¦å‘Š
   - ä½¿ç”¨å·¥å…·åˆ†ææ¨¡å—ä¾èµ–å…³ç³»

3. **æµ‹è¯•**
   - æ¸…é™¤ç¼“å­˜åæµ‹è¯•
   - åœ¨ä¸åŒæµè§ˆå™¨ä¸­æµ‹è¯•
   - æ£€æŸ¥æ§åˆ¶å°é”™è¯¯

---

## âœ… ä¿®å¤çŠ¶æ€

- [x] ä¿®å¤ `vite.config.ts` ä»£ç åˆ†å‰²ç­–ç•¥
- [x] é‡æ–°æ„å»ºå‰ç«¯é•œåƒ
- [x] é‡æ–°æå–é™æ€æ–‡ä»¶
- [x] é‡å¯ Nginx
- [ ] éªŒè¯å‰ç«¯æ­£å¸¸æ˜¾ç¤ºï¼ˆéœ€è¦æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼‰

---

**ä¿®å¤æ—¥æœŸ**: 2025-12-04
**çŠ¶æ€**: âœ… å·²ä¿®å¤ï¼Œå¾…éªŒè¯
