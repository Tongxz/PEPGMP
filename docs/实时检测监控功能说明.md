# 实时检测监控功能说明

## 📋 功能概述

为了解决"前端启动检测后无法直观看到检测是否在运行"的问题，我们实现了完整的实时检测监控功能。

---

## ✨ 主要功能

### 1. 实时统计监控弹窗

点击摄像头列表中的**「查看统计」**按钮，可以打开实时监控弹窗，显示：

#### 📊 **进程信息**
- 摄像头ID
- 进程PID
- 日志文件路径
- 最后更新时间

#### 📈 **检测统计**
- **检测人数**: 当前帧检测到的人数
- **发网检测**: 检测到的发网佩戴情况
- **洗手检测**: 检测到的洗手行为
- **处理帧数**: 已处理的视频帧数量

#### ⚡ **性能指标**
- **处理FPS**: 实际处理速度（帧/秒）
- **平均检测时间**: 单帧检测耗时（秒）
- **总帧数**: 视频总帧数

#### 📜 **实时日志**
- 支持查看最新20/50/100/200行日志
- 带行号显示
- 支持手动刷新
- 自动换行

---

## 🔧 新增API接口

### 1. 获取详细统计信息
```http
GET /api/v1/cameras/{camera_id}/stats
```

**响应示例:**
```json
{
  "camera_id": "vid1",
  "running": true,
  "pid": 3931,
  "log_file": "/path/to/detect_vid1.log",
  "stats": {
    "total_frames": 807,
    "processed_frames": 120,
    "detected_persons": 2,
    "detected_hairnets": 1,
    "detected_handwash": 0,
    "avg_fps": 4.14,
    "avg_detection_time": 0.27,
    "last_detection_time": "2025-10-13 15:04:07"
  }
}
```

### 2. 获取实时日志
```http
GET /api/v1/cameras/{camera_id}/logs?lines=100
```

**响应示例:**
```json
{
  "camera_id": "vid1",
  "log_file": "/path/to/detect_vid1.log",
  "total_lines": 23169,
  "lines": [
    "2025-10-13 15:04:03 - INFO - 视频文件播放完成，重新开始循环播放...",
    "2025-10-13 15:04:04 - INFO - 帧 720/807 | 检测: 人=0, 发网=0, 洗手=0, 消毒=0 | 耗时: 0.000s | 处理FPS: 4.14"
  ]
}
```

### 3. 获取运行状态
```http
GET /api/v1/cameras/{camera_id}/status
```

---

## 🎯 使用方法

### 步骤1：启动检测
1. 进入 **摄像头配置** 页面
2. 找到要启动的摄像头
3. 点击**「启动」**按钮

### 步骤2：查看实时监控
1. 点击**「查看统计」**按钮
2. 实时监控弹窗自动打开
3. 查看检测统计和日志

### 步骤3：自动刷新（可选）
1. 在弹窗底部打开**「自动刷新」**开关
2. 系统每5秒自动更新数据
3. 无需手动刷新

---

## 💡 功能亮点

### ✅ **实时性**
- 数据每5秒自动更新（可选）
- 支持手动刷新
- 日志实时展示

### ✅ **直观性**
- 数字动画效果
- 运行状态标签（绿色=运行中，灰色=已停止）
- 清晰的统计分类

### ✅ **便捷性**
- 一键查看所有信息
- 无需离开当前页面
- 支持多个摄像头同时监控

### ✅ **可配置**
- 日志显示行数可选（20/50/100/200）
- 自动刷新开关
- 响应式布局（适配不同屏幕）

---

## 📱 界面展示

### 摄像头列表 - 新增「查看统计」按钮

```
┌────────────────────────────────────────────────────┐
│ ID    │ 名称   │ 来源    │ 启用 │ 状态   │ 操作      │
├────────────────────────────────────────────────────┤
│ vid1  │ 测试视频│ video.mp4│  ✓  │ 已启用 │ [查看统计] │
│                                        │ [编辑]     │
│                                        │ [启动]     │
│                                        │ [停止]     │
│                                        │ [删除]     │
└────────────────────────────────────────────────────┘
```

### 实时监控弹窗

```
┌──────────────── 实时检测监控 ─────────────────────┐
│  🟢 运行中                              [刷新]    │
├────────────────────────────────────────────────────┤
│ 基本信息:                                          │
│  摄像头ID: vid1          进程PID: 3931            │
│  日志文件: /path/to/log  最后更新: 15:04:07       │
├────────────────────────────────────────────────────┤
│ 检测统计:                                          │
│  ┌──────┬──────┬──────┬──────┐                    │
│  │ 检测人数│ 发网检测│ 洗手检测│ 处理帧数│           │
│  │   2    │   1    │   0    │  120   │           │
│  └──────┴──────┴──────┴──────┘                    │
│                                                    │
│  处理FPS: 4.14  │  平均检测时间: 0.27s  │  总帧数: 807│
├────────────────────────────────────────────────────┤
│ 实时日志:                      [最新50行▼] [刷新]  │
│  ┌─────────────────────────────────────────────┐  │
│  │ 1  2025-10-13 15:04:03 - 视频播放完成...   │  │
│  │ 2  2025-10-13 15:04:04 - 帧 720 | 人=0... │  │
│  │ 3  ...                                      │  │
│  └─────────────────────────────────────────────┘  │
│                                                    │
│  共 23169 行，显示最新 50 行                       │
├────────────────────────────────────────────────────┤
│             [自动刷新 ○]              [关闭]        │
└────────────────────────────────────────────────────┘
```

---

## 🔍 数据来源

### 统计数据提取逻辑

系统通过解析检测日志文件自动提取统计信息：

```python
# 从日志中提取的正则表达式模式
检测结果: r'检测: 人=(\d+), 发网=(\d+), 洗手=(\d+)'
处理FPS:  r'处理FPS: ([\d.]+)'
处理帧数: r'处理帧数: (\d+)'
总帧数:   r'总帧数: (\d+)'
检测时间: r'耗时: ([\d.]+)s'
时间戳:   r'(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})'
```

### 日志文件位置

```
logs/
├── detect_cam0.log    # cam0 的检测日志
├── detect_vid1.log    # vid1 的检测日志
└── pids/
    ├── cam0.pid       # cam0 的进程ID
    └── vid1.pid       # vid1 的进程ID
```

---

## 🚀 技术实现

### 前端组件

- **CameraStatsModal.vue**: 统计监控弹窗组件
  - 使用 Naive UI 组件库
  - 支持数字动画效果
  - 响应式布局

### API层

- **frontend/src/api/camera.ts**: 新增3个API调用方法
  - `getCameraStats(id)`: 获取统计信息
  - `getCameraLogs(id, lines)`: 获取日志
  - `getCameraStatus(id)`: 获取状态

### 后端接口

- **src/api/routers/cameras.py**: 新增3个路由
  - `/cameras/{id}/stats`: 统计接口
  - `/cameras/{id}/logs`: 日志接口
  - `/cameras/{id}/status`: 状态接口（已存在）

---

## 📊 性能影响

### 后端

- **统计查询**: ~10-50ms（读取并解析日志最后100行）
- **日志查询**: ~5-20ms（读取日志文件）
- **内存占用**: 可忽略（无额外缓存）

### 前端

- **弹窗加载**: ~100-300ms（包含2个API调用）
- **自动刷新**: 每5秒2个API调用
- **内存占用**: ~1-2MB（单个弹窗）

### 优化建议

1. 如果日志文件很大（>100MB），考虑使用 `tail` 命令代替Python读取
2. 可以添加Redis缓存统计数据，减少日志解析频率
3. WebSocket推送可以减少轮询请求

---

## 🎓 使用场景

### 场景1：启动后验证检测是否正常
```
1. 点击「启动」
2. 立即点击「查看统计」
3. 观察运行状态是否为「运行中」
4. 查看处理FPS是否正常
5. 查看日志是否有错误
```

### 场景2：监控检测性能
```
1. 开启「自动刷新」
2. 观察FPS变化趋势
3. 监控检测结果统计
4. 分析处理瓶颈
```

### 场景3：调试检测问题
```
1. 查看实时日志
2. 查找错误信息
3. 分析检测结果异常
4. 调整配置参数
```

---

## ❓ 常见问题

### Q: 为什么显示"检测进程未运行"？
**A:** 进程可能已经停止或崩溃，请尝试：
1. 检查日志是否有错误
2. 重新启动检测进程
3. 查看系统资源是否充足

### Q: 统计数据为什么都是0？
**A:** 可能的原因：
1. 检测刚启动，还未处理帧
2. 日志文件格式异常
3. 检测进程初始化失败

### Q: 自动刷新消耗流量吗？
**A:** 每5秒约2KB数据，一小时约1.4MB，消耗很小。

### Q: 可以同时查看多个摄像头吗？
**A:** 可以，每个弹窗是独立的，可以打开多个。

---

## 📝 更新日志

### v1.0.0 (2025-10-13)
- ✅ 实现基础统计监控功能
- ✅ 添加实时日志查看
- ✅ 支持自动刷新
- ✅ 数字动画效果
- ✅ 响应式布局

### 未来计划
- [ ] WebSocket实时推送
- [ ] 统计图表可视化
- [ ] 检测结果时间线
- [ ] 导出统计报告
- [ ] 检测画面实时预览

---

## 🎉 总结

通过本次功能实现，用户可以：

1. ✅ **直观看到**检测是否在运行
2. ✅ **实时监控**检测状态和结果
3. ✅ **快速调试**检测问题
4. ✅ **性能分析**检测效率

**问题完全解决！** 🚀

