<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ‘„åƒå¤´é…ç½®ç®¡ç†</title>
    <link rel="stylesheet" href="/frontend/nav.css">
    <link rel="stylesheet" href="/frontend/theme.css">
    <script defer src="/frontend/nav.js"></script>
</head>

<body>
    <div class="layout-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header class="layout-header">
            <h1>ğŸ“· æ‘„åƒå¤´é…ç½®ç®¡ç†</h1>
            <p>ç®¡ç†æ‘„åƒå¤´å‚æ•°ã€è¿›ç¨‹çŠ¶æ€ä¸åŒºåŸŸæ–‡ä»¶æ˜ å°„</p>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒº -->
        <main class="layout-content">
            <!-- åŒæ å¸ƒå±€ï¼šé…ç½®è¡¨å• & æ‘„åƒå¤´åˆ—è¡¨ -->
            <div class="camera-layout">
                <!-- é…ç½®è¡¨å• - å›ºå®šå®½åº¦ -->
                <div class="camera-form-section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">æ·»åŠ /ç¼–è¾‘æ‘„åƒå¤´</h2>
                        </div>

                        <form class="space-y-4">
                            <div class="form-group">
                                <label for="id" class="form-label">IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰</label>
                                <input id="id" type="text" class="form-input" placeholder="ä¾‹å¦‚: cam0">
                            </div>

                            <div class="form-group">
                                <label for="name" class="form-label">åç§°</label>
                                <input id="name" type="text" class="form-input" placeholder="ä¾‹å¦‚: å¤§é—¨å£ USB0">
                            </div>

                            <div class="form-group">
                                <label for="source" class="form-label">æ¥æº</label>
                                <input id="source" type="text" class="form-input"
                                    placeholder="0 æˆ– rtsp://user:pass@ip:554/stream">
                            </div>

                            <div class="form-group">
                                <label for="resolution" class="form-label">åˆ†è¾¨ç‡ï¼ˆå¯é€‰ï¼‰</label>
                                <input id="resolution" type="text" class="form-input" placeholder="1280x720">
                            </div>

                            <div class="form-group">
                                <label for="fps" class="form-label">å¸§ç‡ï¼ˆå¯é€‰ï¼‰</label>
                                <input id="fps" type="number" class="form-input" min="1" max="120" placeholder="20">
                            </div>

                            <div class="form-group">
                                <label for="regions_file" class="form-label">åŒºåŸŸæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                                <input id="regions_file" type="text" class="form-input"
                                    placeholder="config/regions_site_sink.json">
                            </div>

                            <div class="flex gap-2">
                                <button type="button" class="btn btn-primary flex-1" onclick="createCam()">åˆ›å»º</button>
                                <button type="button" class="btn btn-secondary flex-1" onclick="updateCam()">æ›´æ–°</button>
                            </div>

                            <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
                                <strong>æç¤ºï¼š</strong>æ›´æ–°æ—¶åªéœ€å¡«å†™è¦ä¿®æ”¹çš„å­—æ®µï¼Œæœªå¡«å†™çš„å­—æ®µä¿ç•™åŸå€¼ã€‚
                            </div>
                        </form>
                    </div>
                </div>

                <!-- æ‘„åƒå¤´åˆ—è¡¨ - å æ»¡å‰©ä½™ç©ºé—´ -->
                <div class="camera-table-section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">å·²é…ç½®æ‘„åƒå¤´</h2>
                        </div>

                        <div class="table-container">
                            <table class="table" id="cameraTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>åç§°</th>
                                        <th>æ¥æº</th>
                                        <th>åˆ†è¾¨ç‡</th>
                                        <th>FPS</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="cameraTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-gray-500 py-8">æ­£åœ¨åŠ è½½æ‘„åƒå¤´åˆ—è¡¨...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-600">
                                <strong>é…ç½®æ–‡ä»¶ï¼š</strong> <code>config/cameras.yaml</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </main>
    </div>

    <script>
        // API è°ƒç”¨å°è£…
        async function api(path, options = {}) {
            const res = await fetch(path, {
                headers: { 'Content-Type': 'application/json' },
                ...options
            });
            if (!res.ok) {
                throw new Error('HTTP ' + res.status);
            }
            const ct = res.headers.get('content-type') || '';
            return ct.includes('application/json') ? res.json() : res.text();
        }

        // åŠ è½½æ‘„åƒå¤´åˆ—è¡¨
        async function loadList() {
            try {
                const data = await api('/api/v1/cameras');
                const tbody = document.getElementById('cameraTableBody');

                if (!data.cameras || data.cameras.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-8">æš‚æ— é…ç½®çš„æ‘„åƒå¤´</td></tr>';
                    return;
                }

                tbody.innerHTML = data.cameras.map(cam => `
                    <tr>
                        <td class="font-mono text-sm">${cam.id || ''}</td>
                        <td>${cam.name || ''}</td>
                        <td class="font-mono text-xs text-gray-600 truncate max-w-xs" title="${cam.source || ''}">${cam.source || ''}</td>
                        <td class="text-sm">${cam.resolution || '-'}</td>
                        <td class="text-sm">${cam.fps ?? '-'}</td>
                        <td><span class="badge badge-gray" id="status-${cam.id}">æ£€æµ‹ä¸­</span></td>
                        <td>
                            <div class="camera-actions">
                                <button class="btn btn-sm btn-secondary" onclick='fillForm(${JSON.stringify(cam)})'>ç¼–è¾‘</button>
                                <button class="btn btn-sm btn-primary" onclick='startCam(${JSON.stringify(cam.id)})'>å¯åŠ¨</button>
                                <button class="btn btn-sm btn-secondary" onclick='stopCam(${JSON.stringify(cam.id)})'>åœæ­¢</button>
                                <button class="btn btn-sm btn-danger" onclick='delCam(${JSON.stringify(cam.id)})'>åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                await refreshStatus();
            } catch (e) {
                console.error('åŠ è½½æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥:', e);
                showMessage('åŠ è½½å¤±è´¥: ' + e.message, 'error');
            }
        }

        // è¡¨å•å€¼è·å–/è®¾ç½®
        function val(id) {
            return document.getElementById(id).value.trim();
        }

        function setVal(id, v) {
            document.getElementById(id).value = v ?? '';
        }

        // å¡«å……è¡¨å•
        function fillForm(cam) {
            setVal('id', cam.id);
            setVal('name', cam.name);
            setVal('source', cam.source);
            setVal('resolution', cam.resolution || '');
            setVal('fps', cam.fps ?? '');
            setVal('regions_file', cam.regions_file || '');
        }

        // æ”¶é›†è¡¨å•æ•°æ®
        function collectPayload(requireId) {
            const id = val('id');
            const name = val('name');
            const source = val('source');
            const resolution = val('resolution');
            const fps = val('fps');
            const regions_file = val('regions_file');

            if (requireId && !id) throw new Error('ID ä¸èƒ½ä¸ºç©º');
            if (!name) throw new Error('åç§° ä¸èƒ½ä¸ºç©º');
            if (!source) throw new Error('æ¥æº ä¸èƒ½ä¸ºç©º');

            const payload = { id, name, source };
            if (resolution) payload.resolution = resolution;
            if (fps) payload.fps = Number(fps);
            if (regions_file) payload.regions_file = regions_file;

            return payload;
        }

        // åˆ›å»ºæ‘„åƒå¤´
        async function createCam() {
            try {
                const payload = collectPayload(true);
                await api('/api/v1/cameras', { method: 'POST', body: JSON.stringify(payload) });
                await loadList();
                clearForm();
                showMessage('æ‘„åƒå¤´åˆ›å»ºæˆåŠŸ', 'success');
            } catch (e) {
                showMessage('åˆ›å»ºå¤±è´¥: ' + e.message, 'error');
            }
        }

        // æ›´æ–°æ‘„åƒå¤´
        async function updateCam() {
            try {
                const payload = collectPayload(false);
                const id = val('id');
                if (!id) return showMessage('è¯·å…ˆå¡«å†™ ID', 'error');

                await api('/api/v1/cameras/' + encodeURIComponent(id), {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                await loadList();
                clearForm();
                showMessage('æ‘„åƒå¤´æ›´æ–°æˆåŠŸ', 'success');
            } catch (e) {
                showMessage('æ›´æ–°å¤±è´¥: ' + e.message, 'error');
            }
        }

        // åˆ é™¤æ‘„åƒå¤´
        async function delCam(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤æ‘„åƒå¤´ ' + id + ' ?')) return;
            try {
                await api('/api/v1/cameras/' + encodeURIComponent(id), { method: 'DELETE' });
                await loadList();
                showMessage('æ‘„åƒå¤´åˆ é™¤æˆåŠŸ', 'success');
            } catch (e) {
                showMessage('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }

        // æ‘„åƒå¤´æ§åˆ¶
        async function startCam(id) {
            try {
                await api('/api/v1/cameras/' + encodeURIComponent(id) + '/start', { method: 'POST' });
                await refreshStatus();
                showMessage('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ', 'success');
            } catch (e) {
                showMessage('å¯åŠ¨å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function stopCam(id) {
            try {
                await api('/api/v1/cameras/' + encodeURIComponent(id) + '/stop', { method: 'POST' });
                await refreshStatus();
                showMessage('æ‘„åƒå¤´åœæ­¢æˆåŠŸ', 'success');
            } catch (e) {
                showMessage('åœæ­¢å¤±è´¥: ' + e.message, 'error');
            }
        }

        // åˆ·æ–°çŠ¶æ€
        async function refreshStatus() {
            const tbody = document.getElementById('cameraTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            for (const tr of rows) {
                const id = tr.children[0]?.textContent?.trim();
                if (!id) continue;

                try {
                    const s = await api('/api/v1/cameras/' + encodeURIComponent(id) + '/status');
                    const badge = tr.querySelector(`#status-${CSS.escape(id)}`);
                    if (badge) {
                        if (s.running) {
                            badge.className = 'badge badge-success';
                            badge.textContent = `è¿è¡Œä¸­ (PID ${s.pid})`;
                        } else {
                            badge.className = 'badge badge-gray';
                            badge.textContent = 'å·²åœæ­¢';
                        }
                    }
                } catch (e) {
                    // çŠ¶æ€è·å–å¤±è´¥ï¼Œä¿æŒåŸæ ·
                }
            }
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            ['id', 'name', 'source', 'resolution', 'fps', 'regions_file'].forEach(id => setVal(id, ''));
        }

        // æ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            // ç®€å•çš„æ¶ˆæ¯æç¤º
            if (type === 'error') {
                alert('âŒ ' + message);
            } else if (type === 'success') {
                alert('âœ… ' + message);
            } else {
                alert('â„¹ï¸ ' + message);
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            loadList();
            // æ¯5ç§’åˆ·æ–°çŠ¶æ€
            setInterval(refreshStatus, 5000);
        });
    </script>

    <style>
        /* æ‘„åƒå¤´æ“ä½œæŒ‰é’®æ ·å¼ */
        .camera-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
        }

        .camera-actions button {
            flex-shrink: 0;
            font-size: 0.75rem;
            padding: 4px 8px;
            min-width: 44px;
            white-space: nowrap;
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 1024px) {
            .camera-actions {
                gap: 4px;
            }
            
            .camera-actions button {
                font-size: 0.7rem;
                padding: 3px 6px;
                min-width: 40px;
            }
        }

        /* ä¿®å¤è¡¨æ ¼ä¸­å…¶ä»–Tailwindç±»å */
        .font-mono {
            font-family: monospace;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-gray-600 {
            color: var(--gray-600);
        }

        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .max-w-xs {
            max-width: 20rem;
        }

        .text-center {
            text-align: center;
        }

        .text-gray-500 {
            color: var(--gray-500);
        }

        .py-8 {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .p-3 {
            padding: 0.75rem;
        }

        .bg-gray-50 {
            background-color: var(--gray-50);
        }

        .rounded-lg {
            border-radius: var(--radius-lg);
        }
    </style>
</body>

</html>