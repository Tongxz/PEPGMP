<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿä¿¡æ¯ - æ‰‹éƒ¨è¡Œä¸ºæ£€æµ‹ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="nav.css">
    <style>
        .system-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-3);
        }

        .info-table th,
        .info-table td {
            padding: var(--space-2) var(--space-3);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .info-table th {
            background-color: var(--gray-50);
            font-weight: 600;
            color: var(--text-primary);
        }

        .info-table td {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-healthy {
            background-color: var(--success-light, #e8f5e8);
            color: var(--success-dark, #2e7d32);
        }

        .status-warning {
            background-color: var(--warning-light, #fff8e1);
            color: var(--warning-dark, #f57c00);
        }

        .status-error {
            background-color: var(--error-light, #ffebee);
            color: var(--error-dark, #c62828);
        }

        .config-section {
            margin-top: var(--space-4);
        }

        .config-file {
            background-color: var(--gray-50);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .config-file h4 {
            margin: 0 0 var(--space-2) 0;
            color: var(--text-primary);
        }

        .config-meta {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-2);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .refresh-btn {
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            z-index: 1000;
        }

        .loading {
            text-align: center;
            padding: var(--space-8);
            color: var(--text-secondary);
        }

        .error-message {
            background-color: var(--error-light, #ffebee);
            border: 1px solid var(--error, #f44336);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            color: var(--error-dark, #c62828);
            margin: var(--space-4) 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--gray-200);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-top: var(--space-1);
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-low {
            background-color: var(--success);
        }

        .progress-medium {
            background-color: var(--warning);
        }

        .progress-high {
            background-color: var(--error);
        }

        .json-viewer {
            background-color: var(--gray-900);
            color: var(--gray-100);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="topnav">
        <div class="nav-container">
            <div class="nav-left">
                <div class="nav-title">æ‰‹éƒ¨è¡Œä¸ºæ£€æµ‹ç³»ç»Ÿ</div>
            </div>
            <div class="nav-right">
                <a href="/" class="nav-link">æ£€æµ‹</a>
                <a href="camera_config.html" class="nav-link">æ‘„åƒå¤´</a>
                <a href="region_config.html" class="nav-link">åŒºåŸŸé…ç½®</a>
                <a href="statistics.html" class="nav-link">ç»Ÿè®¡</a>
                <a href="system_info.html" class="nav-link active">ç³»ç»Ÿä¿¡æ¯</a>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="layout-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="layout-header">
            <h1>ç³»ç»Ÿä¿¡æ¯</h1>
            <p>æŸ¥çœ‹å½“å‰æœåŠ¡å™¨çš„ç¡¬ä»¶é…ç½®ã€è¿è¡ŒçŠ¶æ€å’Œç³»ç»Ÿé…ç½®</p>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="layout-content">
            <!-- åŠ è½½ä¸­çŠ¶æ€ -->
            <div id="loadingState" class="loading">
                <div>æ­£åœ¨åŠ è½½ç³»ç»Ÿä¿¡æ¯...</div>
            </div>

            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div id="errorMessage" class="error-message" style="display: none;">
            </div>

            <!-- ç³»ç»Ÿä¿¡æ¯ç½‘æ ¼ -->
            <div id="systemContent" class="system-grid" style="display: none;">
                <!-- ç³»ç»Ÿå¥åº·çŠ¶æ€å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header">
                        <h3>ç³»ç»Ÿå¥åº·çŠ¶æ€</h3>
                    </div>
                    <div id="healthStatus">
                        <!-- å¥åº·çŠ¶æ€å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- ç¡¬ä»¶ä¿¡æ¯å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header">
                        <h3>ç¡¬ä»¶ä¿¡æ¯</h3>
                    </div>
                    <div id="hardwareInfo">
                        <!-- ç¡¬ä»¶ä¿¡æ¯å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- èµ„æºä½¿ç”¨ç‡å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header">
                        <h3>èµ„æºä½¿ç”¨ç‡</h3>
                    </div>
                    <div id="resourceUsage">
                        <!-- èµ„æºä½¿ç”¨ç‡å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>

            <!-- é…ç½®ä¿¡æ¯åŒºåŸŸ -->
            <div id="configSection" class="config-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>ç³»ç»Ÿé…ç½®</h3>
                        <p>å½“å‰æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶çŠ¶æ€å’Œç¯å¢ƒä¿¡æ¯</p>
                    </div>
                    <div id="configContent">
                        <!-- é…ç½®å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <button id="refreshBtn" class="btn btn-primary refresh-btn" onclick="loadSystemInfo()">
        ğŸ”„ åˆ·æ–°
    </button>

    <script>
        let autoRefreshTimer = null;

        // é¡µé¢åŠ è½½æ—¶è·å–ç³»ç»Ÿä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function () {
            loadSystemInfo();
            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
            startAutoRefresh();
        });

        async function loadSystemInfo() {
            try {
                showLoading();
                hideError();

                // å¹¶è¡Œè·å–ç³»ç»Ÿä¿¡æ¯ã€å¥åº·çŠ¶æ€å’Œé…ç½®ä¿¡æ¯
                const [systemInfo, healthInfo, configInfo] = await Promise.all([
                    fetchWithTimeout('/api/v1/system/info'),
                    fetchWithTimeout('/api/v1/system/health'),
                    fetchWithTimeout('/api/v1/system/config')
                ]);

                // æ¸²æŸ“ç³»ç»Ÿä¿¡æ¯
                renderSystemInfo(systemInfo);
                renderHealthStatus(healthInfo);
                renderConfigInfo(configInfo);

                showSystemContent();
            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', error);
                showError('åŠ è½½ç³»ç»Ÿä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        async function fetchWithTimeout(url, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('è¯·æ±‚è¶…æ—¶');
                }
                throw error;
            }
        }

        function renderSystemInfo(data) {
            const hardwareInfo = document.getElementById('hardwareInfo');
            const resourceUsage = document.getElementById('resourceUsage');

            // ç¡¬ä»¶ä¿¡æ¯è¡¨æ ¼
            hardwareInfo.innerHTML = `
                <table class="info-table">
                    <tr><th>æ“ä½œç³»ç»Ÿ</th><td>${data.system.platform}</td></tr>
                    <tr><th>ç³»ç»Ÿç‰ˆæœ¬</th><td>${data.system.system} ${data.system.version}</td></tr>
                    <tr><th>æ¶æ„</th><td>${data.system.architecture.join(', ')}</td></tr>
                    <tr><th>å¤„ç†å™¨</th><td>${data.system.processor || 'N/A'}</td></tr>
                    <tr><th>ä¸»æœºå</th><td>${data.system.hostname}</td></tr>
                    <tr><th>Pythonç‰ˆæœ¬</th><td>${data.system.python_version}</td></tr>
                    <tr><th>CPUæ ¸å¿ƒæ•°</th><td>${data.cpu.count} (ç‰©ç†: ${data.cpu.physical_count || 'N/A'})</td></tr>
                    ${data.cpu.current_frequency ? `<tr><th>CPUé¢‘ç‡</th><td>${data.cpu.current_frequency.toFixed(0)} MHz</td></tr>` : ''}
                </table>
            `;

            // èµ„æºä½¿ç”¨ç‡
            resourceUsage.innerHTML = `
                <div style="margin-bottom: var(--space-3);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1);">
                        <span>CPUä½¿ç”¨ç‡</span>
                        <span>${data.cpu.usage_percent.toFixed(1)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${getProgressClass(data.cpu.usage_percent)}" 
                             style="width: ${data.cpu.usage_percent}%"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: var(--space-3);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1);">
                        <span>å†…å­˜ä½¿ç”¨ç‡</span>
                        <span>${data.memory.percentage.toFixed(1)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${getProgressClass(data.memory.percentage)}" 
                             style="width: ${data.memory.percentage}%"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: var(--space-1);">
                        ${formatBytes(data.memory.used)} / ${formatBytes(data.memory.total)}
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1);">
                        <span>ç£ç›˜ä½¿ç”¨ç‡</span>
                        <span>${data.disk.percentage.toFixed(1)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${getProgressClass(data.disk.percentage)}" 
                             style="width: ${data.disk.percentage}%"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: var(--space-1);">
                        ${formatBytes(data.disk.used)} / ${formatBytes(data.disk.total)}
                    </div>
                </div>
            `;
        }

        function renderHealthStatus(data) {
            const healthStatus = document.getElementById('healthStatus');

            let statusClass = '';
            let statusText = '';
            let statusIcon = '';

            switch (data.status) {
                case 'healthy':
                    statusClass = 'status-healthy';
                    statusText = 'ç³»ç»Ÿå¥åº·';
                    statusIcon = 'âœ…';
                    break;
                case 'warning':
                    statusClass = 'status-warning';
                    statusText = 'è­¦å‘ŠçŠ¶æ€';
                    statusIcon = 'âš ï¸';
                    break;
                case 'error':
                    statusClass = 'status-error';
                    statusText = 'é”™è¯¯çŠ¶æ€';
                    statusIcon = 'âŒ';
                    break;
                default:
                    statusClass = 'status-warning';
                    statusText = 'æœªçŸ¥çŠ¶æ€';
                    statusIcon = 'â“';
            }

            let issuesHtml = '';
            if (data.issues && data.issues.length > 0) {
                issuesHtml = `
                    <div style="margin-top: var(--space-3);">
                        <h4>å‘ç°çš„é—®é¢˜:</h4>
                        <ul style="margin: var(--space-2) 0; padding-left: var(--space-4);">
                            ${data.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            healthStatus.innerHTML = `
                <div class="status-indicator ${statusClass}">
                    ${statusIcon} ${statusText}
                </div>
                ${issuesHtml}
                <div style="margin-top: var(--space-3); font-size: 0.9rem; color: var(--text-secondary);">
                    æœ€åæ£€æŸ¥: ${new Date(data.timestamp).toLocaleString('zh-CN')}
                </div>
            `;
        }

        function renderConfigInfo(data) {
            const configContent = document.getElementById('configContent');

            let configFilesHtml = '';
            for (const [name, info] of Object.entries(data.config_files)) {
                const exists = info.exists;
                const statusIcon = exists ? 'âœ…' : 'âŒ';
                const statusText = exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨';

                configFilesHtml += `
                    <div class="config-file">
                        <h4>${name} ${statusIcon}</h4>
                        <div class="config-meta">
                            <span>çŠ¶æ€: ${statusText}</span>
                            ${exists ? `<span>å¤§å°: ${formatBytes(info.size)}</span>` : ''}
                            ${exists && info.modified_time ? `<span>ä¿®æ”¹æ—¶é—´: ${new Date(info.modified_time).toLocaleString('zh-CN')}</span>` : ''}
                        </div>
                        <div style="font-size: 0.85rem; font-family: monospace; color: var(--text-secondary);">
                            ${info.path}
                        </div>
                        ${info.error ? `<div style="color: var(--error); font-size: 0.85rem; margin-top: var(--space-1);">é”™è¯¯: ${info.error}</div>` : ''}
                    </div>
                `;
            }

            configContent.innerHTML = `
                <div style="margin-bottom: var(--space-4);">
                    <h4>é¡¹ç›®è·¯å¾„</h4>
                    <div style="font-family: monospace; font-size: 0.9rem; background-color: var(--gray-100); padding: var(--space-2); border-radius: var(--radius-sm);">
                        ${data.project_root}
                    </div>
                </div>
                
                <div style="margin-bottom: var(--space-4);">
                    <h4>é…ç½®æ–‡ä»¶çŠ¶æ€</h4>
                    ${configFilesHtml}
                </div>
                
                <div style="margin-bottom: var(--space-4);">
                    <h4>ç¯å¢ƒå˜é‡</h4>
                    <table class="info-table">
                        ${Object.entries(data.environment).map(([key, value]) =>
                `<tr><th>${key}</th><td>${value || '(æœªè®¾ç½®)'}</td></tr>`
            ).join('')}
                    </table>
                </div>
                
                <div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        æ›´æ–°æ—¶é—´: ${new Date(data.timestamp).toLocaleString('zh-CN')}
                    </div>
                </div>
            `;
        }

        function getProgressClass(percentage) {
            if (percentage < 50) return 'progress-low';
            if (percentage < 80) return 'progress-medium';
            return 'progress-high';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('systemContent').style.display = 'none';
            document.getElementById('configSection').style.display = 'none';
        }

        function showSystemContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('systemContent').style.display = 'grid';
            document.getElementById('configSection').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('systemContent').style.display = 'none';
            document.getElementById('configSection').style.display = 'none';
            document.getElementById('errorMessage').innerHTML = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function startAutoRefresh() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }

            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            autoRefreshTimer = setInterval(() => {
                loadSystemInfo();
            }, 30000);
        }

        // é¡µé¢éšè—æ—¶åœæ­¢è‡ªåŠ¨åˆ·æ–°ï¼Œæ˜¾ç¤ºæ—¶æ¢å¤
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                    autoRefreshTimer = null;
                }
            } else {
                startAutoRefresh();
                loadSystemInfo(); // ç«‹å³åˆ·æ–°ä¸€æ¬¡
            }
        });
    </script>
</body>

</html>