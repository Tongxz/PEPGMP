<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘ç½‘æ£€æµ‹ç»Ÿè®¡åˆ†æ</title>
    <link rel="stylesheet" href="/frontend/nav.css">
    <link rel="stylesheet" href="/frontend/theme.css">
    <script defer src="/frontend/nav.js"></script>
</head>

<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="topnav">
        <div class="nav-container">
            <div class="nav-left">
                <div class="nav-title">æ‰‹éƒ¨è¡Œä¸ºæ£€æµ‹ç³»ç»Ÿ</div>
            </div>
            <div class="nav-right">
                <a href="index.html" class="nav-link">æ£€æµ‹</a>
                <a href="camera_config.html" class="nav-link">æ‘„åƒå¤´</a>
                <a href="region_config.html" class="nav-link">åŒºåŸŸé…ç½®</a>
                <a href="statistics.html" class="nav-link active">ç»Ÿè®¡</a>
                <a href="system_info.html" class="nav-link">ç³»ç»Ÿä¿¡æ¯</a>
            </div>
        </div>
    </div>

    <div class="layout-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header class="layout-header">
            <h1>ğŸ¥½ å‘ç½‘æ£€æµ‹ç»Ÿè®¡åˆ†æ</h1>
            <p>å®æ—¶ç›‘æ§å‘ç½‘ä½©æˆ´åˆè§„æƒ…å†µï¼Œæä¾›è¯¦ç»†çš„ç»Ÿè®¡åˆ†æå’Œå†å²è®°å½•</p>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒº -->
        <main class="layout-content">
            <!-- æ§åˆ¶æ  -->
            <div class="card card-compact">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label for="cameraSelect" class="text-sm font-semibold text-gray-700 flex-none">æ‘„åƒå¤´:</label>
                        <select id="cameraSelect" onchange="refreshData()" class="form-select" style="width: 180px;">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-primary btn-sm" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
                        <a class="btn btn-secondary btn-sm" href="/api/v1/download/overlay?name=overlay_debug"
                            target="_blank">
                            ğŸ–¼ï¸ ä¸‹è½½å åŠ å›¾
                        </a>
                    </div>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tabs">
                <div class="tabs-nav">
                    <button class="tabs-tab active" onclick="showTab('overview')">ğŸ“Š æ¦‚è§ˆ</button>
                    <button class="tabs-tab" onclick="showTab('trends')">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</button>
                    <button class="tabs-tab" onclick="showTab('history')">ğŸ“‹ å†å²è®°å½•</button>
                </div>
            </div>

            <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
            <div id="overview" class="tabs-content active">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div id="statsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6">
                    <div class="card card-compact text-center">
                        <div class="text-2xl font-bold text-primary">0</div>
                        <div class="text-xs text-gray-600">äº‹ä»¶æ€»æ•°</div>
                    </div>
                </div>

                <!-- ä»Šæ—¥è¶‹åŠ¿å›¾ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ä»Šæ—¥æ£€æµ‹è¶‹åŠ¿</h3>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="todayChart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
            </div>

            <!-- è¶‹åŠ¿åˆ†ææ ‡ç­¾é¡µ -->
            <div id="trends" class="tabs-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- äº‹ä»¶æ€»é‡è¶‹åŠ¿ -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">7å¤©äº‹ä»¶æ€»é‡è¶‹åŠ¿</h3>
                        </div>
                        <div style="height: 300px; position: relative;">
                            <canvas id="complianceChart" style="width: 100%; height: 100%;"></canvas>
                        </div>
                    </div>

                    <!-- äº‹ä»¶ç±»å‹åˆ†å¸ƒ -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">æŒ‰ç±»å‹äº‹ä»¶ç»Ÿè®¡</h3>
                        </div>
                        <div style="height: 300px; position: relative;">
                            <canvas id="volumeChart" style="width: 100%; height: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å†å²è®°å½•æ ‡ç­¾é¡µ -->
            <div id="history" class="tabs-content">
                <div class="table-container">
                    <table class="table" id="historyTable">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>æ‘„åƒå¤´</th>
                                <th>äº‹ä»¶ç±»å‹</th>
                                <th>TrackID</th>
                                <th>åŒºåŸŸ</th>
                                <th>è¯¦æƒ…</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-gray-500 py-8">æ­£åœ¨åŠ è½½å†å²è®°å½•...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let charts = {};
        let currentData = {};

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tabs-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tabs-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”æ•°æ®
            if (tabName === 'trends') {
                loadTrendsData();
            } else if (tabName === 'history') {
                loadHistoryData();
            }
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            await loadOverviewData();
            if (document.getElementById('trends').classList.contains('active')) {
                await loadTrendsData();
            }
            if (document.getElementById('history').classList.contains('active')) {
                await loadHistoryData();
            }
        }

        // åŠ è½½æ¦‚è§ˆæ•°æ®
        async function loadOverviewData() {
            try {
                const cam = document.getElementById('cameraSelect').value.trim();
                const qs = cam ? ('?camera_id=' + encodeURIComponent(cam)) : '';
                const response = await fetch('/api/v1/statistics/summary' + qs);
                const data = await response.json();
                currentData.overview = data;

                renderStatsCards(data);
                renderTodayChart(data);
            } catch (error) {
                console.error('åŠ è½½æ¦‚è§ˆæ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½æ¦‚è§ˆæ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
        function renderStatsCards(summary) {
            const statsGrid = document.getElementById('statsGrid');
            const total = summary.total_events || 0;
            const byType = summary.counts_by_type || {};
            const get = (k) => (byType[k] || 0);
            const nh = get('NO_HAIRNET_AT_SINK');
            const dwell = get('INSUFFICIENT_DWELL_TIME');
            const washing = get('HANDWASHING_ACTIVE');
            const others = Math.max(0, total - nh - dwell - washing);

            statsGrid.innerHTML = `
                <div class="card card-compact text-center">
                    <div class="text-2xl font-bold text-primary">${total}</div>
                    <div class="text-xs text-gray-600">äº‹ä»¶æ€»æ•°</div>
                </div>
                <div class="card card-compact text-center">
                    <div class="text-2xl font-bold text-error">${nh}</div>
                    <div class="text-xs text-gray-600">æœªæˆ´å‘ç½‘</div>
                </div>
                <div class="card card-compact text-center">
                    <div class="text-2xl font-bold text-warning">${dwell}</div>
                    <div class="text-xs text-gray-600">é©»ç•™ä¸è¶³</div>
                </div>
                <div class="card card-compact text-center">
                    <div class="text-2xl font-bold text-success">${washing}</div>
                    <div class="text-xs text-gray-600">æ´—æ‰‹æ£€æµ‹</div>
                </div>
                <div class="card card-compact text-center">
                    <div class="text-2xl font-bold text-gray-600">${others}</div>
                    <div class="text-xs text-gray-600">å…¶ä»–äº‹ä»¶</div>
                </div>
            `;
        }

        // æ¦‚è§ˆå°å›¾ï¼šå½“å‰çª—å£å„äº‹ä»¶ç±»å‹å æ¯”
        function renderTodayChart(summary) {
            const ctx = document.getElementById('todayChart').getContext('2d');
            if (charts.today) charts.today.destroy();
            const byType = summary.counts_by_type || {};
            const labels = Object.keys(byType);
            const data = labels.map(k => byType[k] || 0);
            charts.today = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'äº‹ä»¶æ•°',
                        data,
                        backgroundColor: 'rgba(0, 92, 180, 0.8)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // åŠ è½½è¶‹åŠ¿æ•°æ®
        async function loadTrendsData() {
            try {
                const cam = document.getElementById('cameraSelect').value.trim();
                const qs = cam ? ('?days=7&camera_id=' + encodeURIComponent(cam)) : '?days=7';
                const response = await fetch('/api/v1/statistics/daily' + qs);
                const data = await response.json();

                renderComplianceChart(data);
                renderVolumeChart(data);
            } catch (error) {
                console.error('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // æ¸²æŸ“åˆè§„ç‡è¶‹åŠ¿å›¾
        function renderComplianceChart(data) {
            const ctx = document.getElementById('complianceChart').getContext('2d');
            if (charts.compliance) charts.compliance.destroy();

            const labels = data.map(d => d.date);
            const totals = data.map(d => d.total_events || 0);

            charts.compliance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ€»äº‹ä»¶é‡',
                        data: totals,
                        borderColor: '#3A7AFE',
                        backgroundColor: 'rgba(58, 122, 254, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'äº‹ä»¶æ•°' }
                        }
                    }
                }
            });
        }

        // æ¸²æŸ“æ£€æµ‹é‡ç»Ÿè®¡å›¾
        function renderVolumeChart(data) {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            if (charts.volume) charts.volume.destroy();

            const labels = data.map(d => d.date);
            const typeSet = new Set();
            data.forEach(d => {
                const m = d.counts_by_type || {};
                Object.keys(m).forEach(t => typeSet.add(t));
            });
            const types = Array.from(typeSet);
            const palette = ['#3A7AFE', '#52C41A', '#FAAD14', '#FF7A45', '#722ED1', '#FF4D4F'];
            const color = (i) => palette[i % palette.length];

            const datasets = types.map((t, idx) => ({
                label: t,
                data: data.map(d => (d.counts_by_type && d.counts_by_type[t]) ? d.counts_by_type[t] : 0),
                backgroundColor: color(idx),
            }));

            charts.volume = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'äº‹ä»¶æ•°' } }
                    }
                }
            });
        }

        // åŠ è½½å†å²è®°å½•
        async function loadHistoryData() {
            try {
                const cam = document.getElementById('cameraSelect').value.trim();
                const qs = cam ? ('?minutes=60&limit=50&camera_id=' + encodeURIComponent(cam)) : '?minutes=60&limit=50';
                const response = await fetch('/api/v1/statistics/history' + qs);
                const data = await response.json();

                renderHistoryTable(data);
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                showError('åŠ è½½å†å²è®°å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // æ¸²æŸ“å†å²è®°å½•è¡¨æ ¼
        function renderHistoryTable(data) {
            const tbody = document.getElementById('historyTableBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">æš‚æ— å†å²è®°å½•</td></tr>';
                return;
            }

            const esc = (s) => (s == null ? '' : String(s)).replace(/[&<>]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c]));
            tbody.innerHTML = data.map(rec => {
                const when = new Date((rec.ts || 0) * 1000).toLocaleString('zh-CN');
                const detail = rec.detail ? esc(JSON.stringify(rec.detail)) : '';
                return `
                    <tr>
                        <td class="text-sm">${when}</td>
                        <td><span class="badge badge-info">${esc(rec.camera_id)}</span></td>
                        <td><span class="badge badge-gray text-xs">${esc(rec.type)}</span></td>
                        <td class="font-mono text-sm">${esc(rec.track_id)}</td>
                        <td class="text-sm">${esc(rec.region)}</td>
                        <td class="truncate max-w-xs text-xs" title="${detail}">${detail}</td>
                    </tr>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            // ç®€å•çš„é”™è¯¯æç¤º
            console.error(message);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        async function loadCameras() {
            try {
                const res = await fetch('/api/v1/cameras');
                const data = await res.json();
                const sel = document.getElementById('cameraSelect');
                sel.innerHTML = '<option value="">å…¨éƒ¨</option>' + (data.cameras || []).map(c =>
                    `<option value="${c.id}">${c.id} - ${c.name || ''}</option>`
                ).join('');
            } catch (e) {
                console.error('åŠ è½½æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            await loadCameras();
            await loadOverviewData();

            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°æ¦‚è§ˆæ•°æ®
            setInterval(() => {
                if (document.getElementById('overview').classList.contains('active')) {
                    loadOverviewData();
                }
            }, 30000);
        });
    </script>
</body>

</html>